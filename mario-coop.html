<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ„ CoopRun</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Nunito:wght@400;700;900&display=swap');
* { margin:0; padding:0; box-sizing:border-box; }
body { background:#1a1a2e; font-family:'Nunito',sans-serif; overflow:hidden; user-select:none; height:100vh; display:flex; flex-direction:column; }

.screen { display:none; width:100%; height:100vh; }
.screen.active { display:flex; flex-direction:column; }

/* â”€â”€ LOBBY â”€â”€ */
#lobbyScreen {
background: linear-gradient(180deg,#0f0c29,#302b63,#24243e);
align-items:center; justify-content:center; position:relative; overflow:hidden;
}
.stars-bg { position:absolute; inset:0; pointer-events:none; }
.star { position:absolute; background:white; border-radius:50%; animation:twinkle 2s infinite alternate; }
@keyframes twinkle { from{opacity:.2} to{opacity:1} }

.lobby-wrap { display:flex; flex-direction:column; align-items:center; padding:16px; gap:12px; z-index:10; width:100%; overflow-y:auto; max-height:100vh; }
.lobby-title {
font-family:â€˜Press Start 2Pâ€™,monospace; font-size:clamp(18px,3.5vw,36px);
color:#FFD700; text-shadow:4px 4px 0 #b8860b;
animation:bounce 2s ease-in-out infinite; text-align:center;
}
@keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
.lobby-sub { font-size:15px; color:#a8d8ea; text-align:center; }

.lobby-panel {
background:rgba(255,255,255,.07); border:2px solid rgba(255,255,255,.15);
border-radius:22px; padding:24px; width:min(96vw,680px); backdrop-filter:blur(12px);
}
.section-lbl {
font-family:â€˜Press Start 2Pâ€™,monospace; font-size:10px; color:#FFD700;
text-align:center; letter-spacing:2px; margin-bottom:14px;
}

.avatar-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:22px; }
.av-slot {
background:rgba(255,255,255,.05); border:2px solid rgba(255,255,255,.1);
border-radius:14px; padding:12px 6px; text-align:center; cursor:pointer; transition:all .2s; position:relative;
}
.av-slot:hover { transform:scale(1.05); border-color:rgba(255,215,0,.5); }
.av-slot.selected { border-color:#FFD700; background:rgba(255,215,0,.1); }
.av-emoji { font-size:36px; display:block; margin-bottom:4px; }
.av-name { font-size:11px; font-weight:700; color:white; }
.av-dot { width:10px; height:10px; border-radius:50%; margin:4px auto 0; }
.av-badge {
position:absolute; top:-7px; right:-7px; width:20px; height:20px; border-radius:50%;
display:flex; align-items:center; justify-content:center; font-size:9px; font-weight:900; color:white;
}

.level-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:22px; }
.lvl-btn {
padding:12px; background:rgba(255,255,255,.05); border:2px solid rgba(255,255,255,.12);
border-radius:12px; color:white; font-family:â€˜Nunitoâ€™,sans-serif; font-size:14px; font-weight:700;
cursor:pointer; transition:all .2s; text-align:center;
}
.lvl-btn:hover { border-color:rgba(78,205,196,.5); }
.lvl-btn.selected { border-color:#4ec9b0; background:rgba(78,205,196,.15); }
.lvl-icon { font-size:22px; display:block; margin-bottom:3px; }
.lvl-sub { font-size:11px; color:#a8d8ea; margin-top:2px; }

.tuto-panel {
background:rgba(0,0,0,.3); border:1px solid rgba(255,255,255,.1);
border-radius:14px; padding:14px 18px; margin-bottom:18px;
}
.tuto-row { display:flex; align-items:flex-start; gap:10px; margin-bottom:8px; font-size:12px; color:white; line-height:1.5; }
.tuto-row:last-child { margin-bottom:0; }
.tuto-icon { font-size:18px; width:26px; text-align:center; flex-shrink:0; margin-top:1px; }

.start-btn {
width:100%; padding:16px;
background:linear-gradient(135deg,#FFD700,#ff8c00);
border:none; border-radius:14px;
font-family:â€˜Press Start 2Pâ€™,monospace; font-size:13px; color:#1a1a0a;
cursor:pointer; transition:all .3s; box-shadow:0 6px 20px rgba(255,215,0,.4);
}
.start-btn:hover { transform:translateY(-2px); box-shadow:0 10px 28px rgba(255,215,0,.6); }
.start-btn:disabled { opacity:.35; cursor:not-allowed; transform:none; }
.player-info { text-align:center; color:#a8d8ea; font-size:13px; margin-bottom:14px; }

/* â”€â”€ GAME â”€â”€ */
#gameScreen { position:relative; }
canvas { display:block; width:100%; height:100%; }

.g-hud {
position:absolute; top:0; left:0; right:0; z-index:20;
padding:8px 14px;
background:linear-gradient(to bottom,rgba(0,0,0,.65),transparent);
display:flex; align-items:center; justify-content:space-between; pointer-events:none;
}
.hud-players { display:flex; gap:8px; }
.hud-p {
display:flex; align-items:center; gap:5px;
background:rgba(0,0,0,.5); border-radius:20px; padding:4px 10px;
border:2px solid transparent; transition:all .3s;
}
.hud-p.alive { border-color:rgba(255,255,255,.25); }
.hud-p.dead  { opacity:.4; border-color:rgba(255,0,0,.3); }
.hud-p.done  { border-color:#FFD700; }
.hud-av { font-size:18px; }
.hud-name { font-size:10px; font-weight:700; color:white; }
.hud-st   { font-size:9px; color:#a8d8ea; }
.hud-lv   { font-family:â€˜Press Start 2Pâ€™,monospace; font-size:9px; color:#FFD700; }

/* â”€â”€ ZONES TACTILES INVISIBLES â”€â”€ */
.touch-zone-left, .touch-zone-right {
position:absolute; top:0; bottom:120px; z-index:15;
width:50%; pointer-events:auto;
-webkit-tap-highlight-color:transparent;
touch-action:none;
}
.touch-zone-left  { left:0; }
.touch-zone-right { right:0; left:50%; }

/* Indicateurs discrets coins */
.touch-hint {
position:absolute; bottom:130px; z-index:16;
font-size:11px; color:rgba(255,255,255,.25); font-weight:700;
pointer-events:none; letter-spacing:1px;
}
.touch-hint-left  { left:14px; }
.touch-hint-right { right:14px; }

/* â”€â”€ JOYSTICK â”€â”€ */
.joystick-wrap {
position:absolute; bottom:16px; left:16px; z-index:25;
width:130px; height:130px;
-webkit-tap-highlight-color:transparent; touch-action:none;
}
.joystick-base {
position:absolute; inset:0; border-radius:50%;
background:rgba(255,255,255,.08);
border:3px solid rgba(255,255,255,.18);
}
.joystick-stick {
position:absolute;
width:52px; height:52px; border-radius:50%;
background:radial-gradient(circle at 35% 35%, rgba(255,255,255,.9), rgba(180,180,220,.7));
border:3px solid rgba(255,255,255,.5);
box-shadow:0 4px 16px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.6);
top:50%; left:50%;
transform:translate(-50%,-50%);
transition:none;
pointer-events:none;
}
/* FlÃ¨ches directionnelles sur la base */
.joystick-arrows {
position:absolute; inset:0; border-radius:50%;
display:flex; align-items:center; justify-content:center;
pointer-events:none;
}
.joystick-arrows::before { content:â€˜â†â€™; position:absolute; left:6px; color:rgba(255,255,255,.3); font-size:14px; font-weight:900; }
.joystick-arrows::after  { content:â€˜â†’â€™; position:absolute; right:6px; color:rgba(255,255,255,.3); font-size:14px; font-weight:900; }

/* â”€â”€ BOUTONS DROITE (saut + action) â”€â”€ */
.right-btns {
position:absolute; bottom:16px; right:16px; z-index:25;
display:flex; flex-direction:column; gap:10px; align-items:center;
}
.cb {
width:60px; height:60px; border-radius:50%;
border:3px solid rgba(255,255,255,.4);
display:flex; align-items:center; justify-content:center;
font-size:20px; cursor:pointer; color:white; transition:all .12s;
-webkit-tap-highlight-color:transparent; touch-action:none; font-weight:900;
box-shadow:0 4px 12px rgba(0,0,0,.3);
}
.cb:active,.cb.pressed { transform:scale(.88); filter:brightness(1.4); }
.cb-jump { background:rgba(231,76,60,.85); border-color:#e74c3c; width:66px; height:66px; }
.cb-act  { background:rgba(255,165,0,.9); border-color:#FFD700; font-size:24px; box-shadow:0 0 20px rgba(255,165,0,.6); }
.cb-act.pressed { box-shadow:0 0 36px rgba(255,165,0,.95); }

/* Label joueur actif */
.active-player-tag {
position:absolute; bottom:155px; left:50%; transform:translateX(-50%);
z-index:26; pointer-events:none;
font-size:11px; font-weight:700; color:white;
background:rgba(0,0,0,.55); padding:3px 12px; border-radius:10px;
border:1px solid rgba(255,255,255,.2);
white-space:nowrap;
}

/* Panneau de sÃ©lection joueur (multi) */
.player-switcher {
position:absolute; bottom:155px; left:50%; transform:translateX(-50%);
z-index:26; display:flex; gap:8px; align-items:center;
}
.psw-btn {
width:40px; height:40px; border-radius:50%;
border:3px solid rgba(255,255,255,.3);
display:flex; align-items:center; justify-content:center;
font-size:18px; cursor:pointer;
-webkit-tap-highlight-color:transparent; touch-action:none;
background:rgba(0,0,0,.4); transition:all .2s;
}
.psw-btn.active { border-color:#FFD700; background:rgba(255,215,0,.2); transform:scale(1.15); }

/* Masquer le ctrl-hud ancien */
.ctrl-hud { display:none !important; }

.ov {
position:absolute; inset:0; z-index:50;
background:rgba(0,0,0,.82); backdrop-filter:blur(10px);
display:none; flex-direction:column; align-items:center; justify-content:center; gap:14px;
}
.ov.show { display:flex; }
.ov-emoji { font-size:70px; }
.ov-title { font-family:â€˜Press Start 2Pâ€™,monospace; font-size:clamp(20px,4vw,42px); text-align:center; }
.ov-sub { font-size:16px; color:rgba(255,255,255,.7); text-align:center; max-width:400px; }
.ov-btns { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
.ov-btn { padding:14px 32px; border:none; border-radius:14px; font-family:â€˜Press Start 2Pâ€™,monospace; font-size:12px; cursor:pointer; transition:all .2s; }
.ov-btn-y { background:linear-gradient(135deg,#FFD700,#ff8c00); color:#1a1a0a; box-shadow:0 4px 16px rgba(255,215,0,.4); }
.ov-btn-y:hover { transform:translateY(-2px); }
.ov-btn-n { background:rgba(255,255,255,.1); color:white; border:2px solid rgba(255,255,255,.2); }
.ov-btn-n:hover { background:rgba(255,255,255,.2); }
</style>

</head>
<body>

<!-- LOBBY -->

<div class="screen active" id="lobbyScreen">
  <div class="stars-bg" id="starsEl"></div>
  <div class="lobby-wrap">
    <div class="lobby-title">ğŸ„ COOP RUN ğŸ„</div>
    <div class="lobby-sub">Plateforme coopÃ©ratif â€” jusqu'Ã  4 joueurs</div>

```
<div class="lobby-panel">
  <div class="tuto-panel">
    <div class="tuto-row"><span class="tuto-icon">ğŸŒ‰</span><span><b>Pont :</b> Les boutons ğŸ”´ sont toujours <b>au sol</b> Ã  gauche et Ã  droite du vide. Approche-toi et <b>maintiens âš¡</b> pour ouvrir le pont. LÃ¢che = il se referme !</span></div>
    <div class="tuto-row"><span class="tuto-icon">ğŸŸ£</span><span><b>Dernier joueur :</b> ceux qui ont dÃ©jÃ  traversÃ© utilisent le bouton violet ğŸŸ£ de l'autre cÃ´tÃ© pour rouvrir le pont.</span></div>
    <div class="tuto-row"><span class="tuto-icon">ğŸˆ</span><span><b>Ballon :</b> marche sur le ballon pour monter dessus. Un <b>autre joueur</b> maintient âš¡ sur la pompe ğŸ”µ (au sol, Ã  gauche) pour faire monter le ballon !</span></div>
    <div class="tuto-row"><span class="tuto-icon">ğŸ•¹ï¸</span><span><b>Mobile :</b> Joystick gauche pour avancer Â· Tape Ã  gauche/droite de l'Ã©cran Â· <b>â†‘</b> pour sauter Â· <b>âš¡</b> pour actionner. Si multi : change de joueur avec les emojis en bas.</span></div>
    <div class="tuto-row"><span class="tuto-icon">ğŸ®</span><span><b>Clavier :</b> J1=flÃ¨ches+Z Â· J2=WASD+Q Â· J3=IJKL+U</span></div>
  </div>

  <div class="section-lbl">ğŸ­ CHOISIS TON AVATAR</div>
  <div class="avatar-grid" id="avGrid"></div>

  <div class="section-lbl">ğŸ—ºï¸ LONGUEUR DU NIVEAU</div>
  <div class="level-grid">
    <button class="lvl-btn selected" data-len="short"  onclick="pickLevel('short',this)"><span class="lvl-icon">âš¡</span>Court<div class="lvl-sub">~1 min Â· 2 ponts</div></button>
    <button class="lvl-btn"          data-len="medium" onclick="pickLevel('medium',this)"><span class="lvl-icon">ğŸŒŸ</span>Moyen<div class="lvl-sub">~2 min Â· 3 ponts</div></button>
    <button class="lvl-btn"          data-len="long"   onclick="pickLevel('long',this)"><span class="lvl-icon">ğŸ†</span>Long<div class="lvl-sub">~4 min Â· 5 ponts</div></button>
  </div>

  <div class="player-info" id="pInfo">SÃ©lectionne au moins 1 avatar</div>
  <button class="start-btn" id="startBtn" disabled onclick="startGame()">â–¶ LANCER !</button>
</div>
```

  </div>
</div>

<!-- GAME -->

<div class="screen" id="gameScreen">
  <div class="g-hud">
    <div class="hud-players" id="hudPlayers"></div>
    <div class="hud-lv" id="hudLv">COURT</div>
  </div>
  <canvas id="gc"></canvas>
  <div class="ctrl-hud" id="ctrlHud"></div>

  <!-- ZONES TACTILES INVISIBLES -->

  <div class="touch-zone-left"  id="tzLeft"></div>
  <div class="touch-zone-right" id="tzRight"></div>
  <div class="touch-hint touch-hint-left">â—€ GAUCHE</div>
  <div class="touch-hint touch-hint-right">DROITE â–¶</div>

  <!-- JOYSTICK -->

  <div class="joystick-wrap" id="joyWrap">
    <div class="joystick-base">
      <div class="joystick-arrows"></div>
    </div>
    <div class="joystick-stick" id="joyStick"></div>
  </div>

  <!-- SÃ©lecteur joueur actif (si multi) -->

  <div class="player-switcher" id="playerSwitcher"></div>
  <div class="active-player-tag" id="activeTag" style="display:none"></div>

  <!-- BOUTONS DROITE -->

  <div class="right-btns">
    <button class="cb cb-act" id="btnAct">âš¡</button>
    <button class="cb cb-jump" id="btnJump">â†‘</button>
  </div>

  <div class="ov" id="winOv">
    <div class="ov-emoji">ğŸ†</div>
    <div class="ov-title" style="color:#FFD700">VICTOIRE !</div>
    <div class="ov-sub" id="winMsg"></div>
    <div class="ov-btns">
      <button class="ov-btn ov-btn-y" onclick="restart()">ğŸ”„ Rejouer</button>
      <button class="ov-btn ov-btn-n" onclick="goLobby()">ğŸ  Lobby</button>
    </div>
  </div>
  <div class="ov" id="deathOv">
    <div class="ov-emoji">ğŸ’€</div>
    <div class="ov-title" style="color:#e74c3c">GAME OVER</div>
    <div class="ov-sub">Tout le monde est tombÃ© dans le vide !</div>
    <div class="ov-btns">
      <button class="ov-btn ov-btn-y" onclick="restart()">ğŸ”„ RÃ©essayer</button>
      <button class="ov-btn ov-btn-n" onclick="goLobby()">ğŸ  Lobby</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const T = 48;
const GRAV   = 0.52;
const JFORCE = -12.5;
const SPD    = 3.2;
const GAP_W  = 4;   // largeur du vide en tuiles (franchissable uniquement avec le pont)

const AVATARS = [
  {e:'ğŸ§‘â€ğŸš€',n:'Astro',    c:'#e74c3c',d:'#c0392b'},
  {e:'ğŸ§™',  n:'Mago',    c:'#3498db',d:'#2980b9'},
  {e:'ğŸ¦Š',  n:'Renard',  c:'#f39c12',d:'#d68910'},
  {e:'ğŸ¸',  n:'Grenouille',c:'#2ecc71',d:'#27ae60'},
  {e:'ğŸ¤–',  n:'Robot',   c:'#9b59b6',d:'#8e44ad'},
  {e:'ğŸ±',  n:'Chat',    c:'#e91e63',d:'#c2185b'},
  {e:'âš¡',  n:'Ã‰clair',  c:'#ff9800',d:'#e65100'},
  {e:'ğŸŒ™',  n:'Lune',    c:'#00bcd4',d:'#0097a7'},
];

const LEVEL_CFG = {
  short:  {bridges:2, balloons:1, worldCells:55},
  medium: {bridges:3, balloons:2, worldCells:95},
  long:   {bridges:5, balloons:3, worldCells:170},
};

const GROUND_Y = 13;   // tuile Y du sol (en partant du haut, monde = 18 tuiles haut)
const WORLD_H  = 18;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOBBY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let chosen    = [];
let chosenLen = 'short';

(function makeStars(){
  const el=document.getElementById('starsEl');
  for(let i=0;i<70;i++){
    const s=document.createElement('div');
    s.className='star';
    const z=Math.random()*3+1;
    s.style.cssText=`width:${z}px;height:${z}px;left:${Math.random()*100}%;top:${Math.random()*100}%;animation-delay:${Math.random()*2}s;animation-duration:${1+Math.random()*2}s`;
    el.appendChild(s);
  }
})();

(function makeAvGrid(){
  const g=document.getElementById('avGrid');
  AVATARS.forEach((av,i)=>{
    const d=document.createElement('div');
    d.className='av-slot'; d.id='av'+i;
    d.innerHTML=`<span class="av-emoji">${av.e}</span><div class="av-name">${av.n}</div><div class="av-dot" style="background:${av.c}"></div>`;
    d.onclick=()=>toggleAv(i);
    g.appendChild(d);
  });
})();

function toggleAv(i){
  const ex=chosen.findIndex(a=>a.idx===i);
  const el=document.getElementById('av'+i);
  if(ex>=0){
    chosen.splice(ex,1);
    el.classList.remove('selected');
    el.querySelector('.av-badge')?.remove();
    chosen.forEach((a,j)=>{
      a.slot=j+1;
      const b=document.getElementById('av'+a.idx).querySelector('.av-badge');
      if(b) b.textContent='P'+(j+1);
    });
  } else {
    if(chosen.length>=4) return;
    chosen.push({idx:i,slot:chosen.length+1});
    el.classList.add('selected');
    const b=document.createElement('div');
    b.className='av-badge'; b.style.background=AVATARS[i].c;
    b.textContent='P'+chosen.length;
    el.appendChild(b);
  }
  const n=chosen.length;
  document.getElementById('startBtn').disabled=n===0;
  document.getElementById('pInfo').textContent=
    n===0?'SÃ©lectionne au moins 1 avatar':n===1?'1 joueur â€” mode solo':`${n} joueurs ğŸ€`;
}

function pickLevel(k,el){
  chosenLen=k;
  document.querySelectorAll('.lvl-btn').forEach(b=>b.classList.remove('selected'));
  el.classList.add('selected');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GENERATEUR DE NIVEAU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateLevel(key){
  const cfg = LEVEL_CFG[key];
  const W   = cfg.worldCells;

  const plats   = [];
  const bridges = [];
  const balloons= [];
  const coins   = [];

  const numB  = cfg.bridges;
  const numBal= cfg.balloons;
  const total = numB + numBal;

  // Positions des obstacles, bien espacÃ©s
  const startX=10, endX=W-10;
  const obsX=[];
  for(let i=0;i<total;i++) obsX.push(Math.round(startX+(endX-startX)*(i+1)/(total+1)));

  // Ponts
  const bridgeXs = obsX.slice(0,numB);
  const gapZones = [];

  bridgeXs.forEach((cx,idx)=>{
    const gL=cx-2, gR=cx+2;  // 4 tuiles de vide
    const groundTopY = GROUND_Y * T;           // Y pixel du dessus du sol
    const btnY = groundTopY - T * 0.9;          // bouton posÃ© sur le sol

    bridges.push({
      id:idx,
      // Dalle du pont (apparaÃ®t quand ouvert)
      bx: gL*T, by: groundTopY - T*0.3, bw: GAP_W*T, bh: T*0.35,
      open:false,
      // Bouton GAUCHE (ğŸ”´) â€” au sol, 2 tuiles avant le vide
      btn1x:(gL-2)*T, btn1y:btnY, btn1w:T*0.85, btn1h:T*0.85,
      pressed1:false, presser1:-1,
      // Bouton DROITE (ğŸŸ£) â€” au sol, 1 tuile aprÃ¨s le vide
      btn2x:(gR+1)*T, btn2y:btnY, btn2w:T*0.85, btn2h:T*0.85,
      pressed2:false, presser2:-1,
      gL, gR,
    });
    gapZones.push({gL,gR});
  });

  // Ballons
  const balloonXs = obsX.slice(numB);
  balloonXs.forEach((cx,idx)=>{
    const highTileY = GROUND_Y - 5;  // plateforme haute 5 tuiles au-dessus du sol
    const highX     = cx+1;
    const highW     = 4;

    // Plateforme haute (destination du ballon)
    plats.push({x:highX*T, y:highTileY*T, w:highW*T, h:T, type:'high'});
    coins.push({x:(highX+1)*T+8, y:(highTileY-1)*T+4, col:false, bonus:true});

    // Position initiale du ballon : posÃ© sur le sol
    const initBalloonY = (GROUND_Y-3)*T;

    balloons.push({
      id:idx,
      // Position X fixe du ballon
      bx: (cx-1)*T,
      bw: T*1.4, bh: T*2,
      floatY: initBalloonY,
      initY:  initBalloonY,
      // Pompe : au sol, 3 tuiles Ã  gauche du ballon
      pumpX: (cx-4)*T, pumpY: GROUND_Y*T - T*0.9,
      pumpW: T*0.85, pumpH: T*0.85,
      pumper:-1, rider:-1,
    });
  });

  // Sol : segments (avec trous aux vides des ponts)
  const sortedGaps=[...gapZones].sort((a,b)=>a.gL-b.gL);
  let cur=0;
  sortedGaps.forEach(g=>{
    if(cur<g.gL) plats.push({x:cur*T, y:GROUND_Y*T, w:(g.gL-cur)*T, h:(WORLD_H-GROUND_Y)*T, type:'ground'});
    cur=g.gR;
  });
  plats.push({x:cur*T, y:GROUND_Y*T, w:(W-cur)*T, h:(WORLD_H-GROUND_Y)*T, type:'ground'});

  // Quelques plateformes flottantes accessibles (2-3 tuiles de haut max)
  for(let i=0;i<Math.floor(W/14);i++){
    const fx=7+i*14+Math.floor(Math.random()*4);
    if(sortedGaps.some(g=>fx>=g.gL-2&&fx<=g.gR+3)) continue;
    if(balloonXs.some(bx=>Math.abs(fx-bx)<5)) continue;
    const fw=3+Math.floor(Math.random()*2);
    const fy=GROUND_Y-2-Math.floor(Math.random()*2);
    plats.push({x:fx*T, y:fy*T, w:fw*T, h:T, type:'platform'});
    for(let c=0;c<fw;c++) if(Math.random()<.5) coins.push({x:(fx+c)*T+8,y:(fy-1)*T+6,col:false,bonus:false});
  }

  // PiÃ¨ces sur le sol
  for(let i=0;i<8;i++){
    const cx=3+Math.floor(Math.random()*(W-6));
    if(!sortedGaps.some(g=>cx>=g.gL&&cx<g.gR)) coins.push({x:cx*T+8,y:(GROUND_Y-1)*T+4,col:false,bonus:false});
  }

  // Drapeau fin
  const flagX=(W-4)*T;
  plats.push({x:(W-4)*T, y:GROUND_Y*T, w:T, h:(WORLD_H-GROUND_Y)*T, type:'flag'});

  return { plats, bridges, balloons, coins, flagX, worldW:W*T, worldH:WORLD_H*T };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PLAYER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mkPlayer(avIdx, slot, startX){
  return {
    id:slot, av:AVATARS[avIdx],
    x:startX, y:(GROUND_Y-2)*T,
    w:34, h:40, vx:0, vy:0,
    onGround:false, alive:true, finished:false,
    riding:null, score:0, facing:1,
    wf:0, wt:0, jp:false,
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CTRL=[
  {left:'ArrowLeft', right:'ArrowRight', jump:'ArrowUp',  act:'KeyZ'},
  {left:'KeyA',      right:'KeyD',       jump:'KeyW',     act:'KeyQ'},
  {left:'KeyJ',      right:'KeyL',       jump:'KeyI',     act:'KeyU'},
  {left:'Numpad4',   right:'Numpad6',    jump:'Numpad8',  act:'Numpad5'},
];
let keys={};
document.addEventListener('keydown',e=>{keys[e.code]=true; e.preventDefault();});
document.addEventListener('keyup',  e=>{keys[e.code]=false;});
function held(pid,a){ return !!keys[CTRL[pid][a]]; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COLLISIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function overlap(ax,ay,aw,ah,bx,by,bw,bh){ return ax<bx+bw&&ax+aw>bx&&ay<by+bh&&ay+ah>by; }

function resolvePlat(p,pl){
  if(!overlap(p.x,p.y,p.w,p.h,pl.x,pl.y,pl.w,pl.h)) return;
  const ol=p.x+p.w-pl.x, or2=pl.x+pl.w-p.x, ot=p.y+p.h-pl.y, ob=pl.y+pl.h-p.y;
  const mn=Math.min(ol,or2,ot,ob);
  if(mn===ot&&p.vy>=0){p.y=pl.y-p.h;p.vy=0;p.onGround=true;}
  else if(mn===ob&&p.vy<0){p.y=pl.y+pl.h;p.vy=0;}
  else if(mn===ol){p.x=pl.x-p.w;p.vx=0;}
  else{p.x=pl.x+pl.w;p.vx=0;}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POPUPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const pops=[];
function pop(x,y,txt,col){pops.push({x,y,txt,col,life:60});}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME STATE & LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let canvas,ctx,gs,raf;

function startGame(){
  document.getElementById('lobbyScreen').classList.remove('active');
  document.getElementById('gameScreen').classList.add('active');
  canvas=document.getElementById('gc');
  ctx=canvas.getContext('2d');
  fitCanvas();
  window.addEventListener('resize',fitCanvas);
  const lv=generateLevel(chosenLen);
  gs={
    lv,
    players:chosen.map((c,i)=>mkPlayer(c.idx,i,60+i*55)),
    cam:{x:0},
    tick:0, over:false,
  };
  pops.length=0;
  buildHUD(); buildCtrl();
  if(raf) cancelAnimationFrame(raf);
  loop();
}

function fitCanvas(){ if(!canvas)return; canvas.width=canvas.offsetWidth; canvas.height=canvas.offsetHeight; }

function loop(){
  if(!gs||gs.over) return;
  gs.tick++;
  update(); draw(); updateHUD();
  raf=requestAnimationFrame(loop);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function update(){
  const {lv,players}=gs;

  // Bridges
  lv.bridges.forEach(br=>{ br.open=br.pressed1||br.pressed2; });

  // Balloons rise/fall
  lv.balloons.forEach(bal=>{
    if(bal.pumper>=0){ bal.floatY-=2.0; if(bal.floatY<80)bal.floatY=80; }
    else              { bal.floatY+=1.3; if(bal.floatY>bal.initY)bal.floatY=bal.initY; }
  });

  players.forEach((p,pid)=>updatePlayer(p,pid));
  checkEnd();
}

function updatePlayer(p,pid){
  if(!p.alive||p.finished) return;
  const {lv}=gs;
  const t=gs.tick;

  // â”€â”€ Riding balloon â”€â”€
  if(p.riding!==null){
    const bal=lv.balloons[p.riding];
    p.x=bal.bx+bal.bw/2-p.w/2;
    p.y=bal.floatY-p.h-4;
    p.vx=0; p.vy=0; p.onGround=false;
    // Sauter pour descendre du ballon
    const jp=held(pid,'jump');
    if(jp&&!p.jp){p.vy=JFORCE*0.7;p.riding=null;bal.rider=-1;}
    p.jp=jp;
    if(p.y>lv.worldH) killP(p,pid);
    checkFlag(p);
    return;
  }

  // â”€â”€ Mouvement horizontal â”€â”€
  p.vx=0;
  if(held(pid,'left')) {p.vx=-SPD;p.facing=-1;}
  if(held(pid,'right')){p.vx= SPD;p.facing= 1;}

  // â”€â”€ Saut â”€â”€
  const jp=held(pid,'jump');
  if(jp&&!p.jp&&p.onGround){p.vy=JFORCE;p.onGround=false;}
  p.jp=jp;

  // â”€â”€ GravitÃ© â”€â”€
  p.vy+=GRAV;

  // â”€â”€ DÃ©placement â”€â”€
  p.x+=p.vx; if(p.x<0)p.x=0;
  p.y+=p.vy;

  // â”€â”€ Collisions sol/plateformes â”€â”€
  p.onGround=false;
  lv.plats.forEach(pl=>resolvePlat(p,pl));

  // â”€â”€ Collision pont (seulement si ouvert) â”€â”€
  lv.bridges.forEach(br=>{
    if(br.open) resolvePlat(p,{x:br.bx,y:br.by,w:br.bw,h:br.bh+4});
  });

  // â”€â”€ ACTION â”€â”€
  const act=held(pid,'act');

  lv.bridges.forEach(br=>{
    // Bouton gauche
    const on1=overlap(p.x,p.y,p.w,p.h,br.btn1x,br.btn1y,br.btn1w,br.btn1h);
    if(on1&&act){br.pressed1=true;br.presser1=pid;}
    else if(br.presser1===pid){br.pressed1=false;br.presser1=-1;}
    // Bouton droite
    const on2=overlap(p.x,p.y,p.w,p.h,br.btn2x,br.btn2y,br.btn2w,br.btn2h);
    if(on2&&act){br.pressed2=true;br.presser2=pid;}
    else if(br.presser2===pid){br.pressed2=false;br.presser2=-1;}
  });

  lv.balloons.forEach(bal=>{
    // Pompe
    const onP=overlap(p.x,p.y,p.w,p.h,bal.pumpX,bal.pumpY,bal.pumpW,bal.pumpH);
    if(onP&&act)bal.pumper=pid;
    else if(bal.pumper===pid)bal.pumper=-1;
    // Monter dans le ballon en marchant dessus
    if(bal.rider<0&&overlap(p.x,p.y,p.w,p.h,bal.bx,bal.floatY,bal.bw,bal.bh)&&p.vy>=0){
      p.riding=bal.id; bal.rider=pid; p.vy=0;
    }
  });

  // â”€â”€ PiÃ¨ces â”€â”€
  lv.coins.forEach(c=>{
    if(!c.col&&overlap(p.x,p.y,p.w,p.h,c.x,c.y,28,28)){
      c.col=true; p.score+=c.bonus?3:1;
      pop(c.x,c.y,c.bonus?'+3â­':'+1ğŸª™','#FFD700');
    }
  });

  // â”€â”€ Mort â”€â”€
  if(p.y>lv.worldH+100) killP(p,pid);

  // â”€â”€ Anim â”€â”€
  if(Math.abs(p.vx)>.1){p.wt++;if(p.wt>7){p.wt=0;p.wf=(p.wf+1)%4;}}else p.wf=0;

  checkFlag(p);
}

function killP(p,pid){
  p.alive=false;
  if(p.riding!==null){gs.lv.balloons[p.riding].rider=-1;p.riding=null;}
  gs.lv.bridges.forEach(br=>{
    if(br.presser1===pid){br.pressed1=false;br.presser1=-1;}
    if(br.presser2===pid){br.pressed2=false;br.presser2=-1;}
  });
  gs.lv.balloons.forEach(b=>{if(b.pumper===pid)b.pumper=-1;});
  pop(p.x,p.y,'ğŸ’€ MORT!','#ff4444');
}

function checkFlag(p){
  if(!p.finished&&p.x+p.w>gs.lv.flagX){
    p.finished=true; p.score+=10;
    pop(p.x,p.y-40,'+10 ğŸ','#FFD700');
  }
}

function checkEnd(){
  const alive   =gs.players.filter(p=>p.alive);
  const finished=gs.players.filter(p=>p.finished);
  const living  =gs.players.filter(p=>p.alive&&!p.finished);
  if(alive.length===0&&finished.length===0){
    gs.over=true;
    setTimeout(()=>document.getElementById('deathOv').classList.add('show'),500);
    return;
  }
  if(living.length===0&&finished.length>0){
    gs.over=true;
    const names=finished.map(p=>p.av.n).join(', ');
    const tot=gs.players.reduce((a,p)=>a+p.score,0);
    document.getElementById('winMsg').textContent=`${names} ${finished.length>1?'ont':'a'} passÃ© la ligne ! Score : ${tot}â­`;
    setTimeout(()=>document.getElementById('winOv').classList.add('show'),500);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CAMERA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateCam(){
  const alive=gs.players.filter(p=>p.alive);
  if(!alive.length)return;
  const lx=Math.max(...alive.map(p=>p.x));
  const tx=lx-canvas.width*.35;
  gs.cam.x+=(tx-gs.cam.x)*.1;
  gs.cam.x=Math.max(0,Math.min(gs.cam.x,gs.lv.worldW-canvas.width));
}
function sx(wx){return wx-gs.cam.x;}
function sy(wy){return wy;}   // pas de scroll vertical

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DRAW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function draw(){
  updateCam();
  const CW=canvas.width, CH=canvas.height;
  const t=gs.tick;

  // Ciel
  const sky=ctx.createLinearGradient(0,0,0,CH);
  sky.addColorStop(0,'#1e6ea8'); sky.addColorStop(.6,'#87CEEB'); sky.addColorStop(1,'#b8e4f9');
  ctx.fillStyle=sky; ctx.fillRect(0,0,CW,CH);

  // Nuages
  [[140,50,30],[420,38,42],[800,62,26],[1350,44,36],[2000,58,30],[2700,42,44]].forEach(([x,y,r])=>{
    const ddx=x-gs.cam.x*.35;
    if(ddx<-80||ddx>CW+80)return;
    ctx.fillStyle='rgba(255,255,255,.82)';
    ctx.beginPath();ctx.arc(ddx,y,r,0,Math.PI*2);ctx.arc(ddx+r*.7,y-r*.3,r*.8,0,Math.PI*2);ctx.arc(ddx+r*1.4,y,r*.7,0,Math.PI*2);ctx.fill();
  });

  const lv=gs.lv;

  // Plateformes
  lv.plats.forEach(pl=>{
    const x=sx(pl.x), y=pl.y;
    if(x>CW+T||x+pl.w<-T)return;
    if(pl.type==='ground'){
      ctx.fillStyle='#5DBB4B';ctx.fillRect(x,y,pl.w,10);
      ctx.fillStyle='#8B5E3C';ctx.fillRect(x,y+10,pl.w,pl.h-10);
      ctx.fillStyle='#7A4F30';for(let gx=0;gx<pl.w;gx+=T)ctx.fillRect(x+gx,y+18,2,12);
    }else if(pl.type==='platform'){
      ctx.fillStyle='#c0842a';ctx.fillRect(x,y,pl.w,pl.h);
      ctx.fillStyle='#d99a3f';ctx.fillRect(x,y,pl.w,5);
      ctx.fillStyle='#a06622';for(let bx=0;bx<pl.w;bx+=T/2)ctx.fillRect(x+bx,y,2,pl.h);
    }else if(pl.type==='high'){
      ctx.fillStyle='rgba(255,255,255,.9)';ctx.fillRect(x,y,pl.w,pl.h);
      ctx.fillStyle='rgba(180,220,255,.7)';ctx.fillRect(x,y,pl.w,5);
      ctx.font='11px Nunito,sans-serif';ctx.fillStyle='#2980b9';ctx.textAlign='center';
      ctx.fillText('â†‘ ATTERRIR ICI',x+pl.w/2,y-8);ctx.textAlign='left';
    }else if(pl.type==='flag'){
      ctx.fillStyle='#aaa';ctx.fillRect(x+4,y,6,CH);
      ctx.fillStyle='#e74c3c';ctx.beginPath();ctx.moveTo(x+10,y);ctx.lineTo(x+52,y+17);ctx.lineTo(x+10,y+34);ctx.fill();
      ctx.font='20px sans-serif';ctx.fillText('ğŸ',x-8,y-6);
    }
  });

  // Ponts
  lv.bridges.forEach(br=>drawBridge(br,t));

  // Ballons
  lv.balloons.forEach(bal=>drawBalloon(bal,t));

  // PiÃ¨ces
  lv.coins.forEach(c=>{
    if(c.col)return;
    const cx=sx(c.x);if(cx<-30||cx>CW+30)return;
    const bob=Math.sin(t/20+c.x)*3;
    ctx.font='22px sans-serif';ctx.fillText(c.bonus?'â­':'ğŸª™',cx,c.y+bob+22);
  });

  // Joueurs
  gs.players.forEach(p=>drawPlayer(p,t));

  // Popups
  for(let i=pops.length-1;i>=0;i--){
    const p=pops[i];
    const alpha=p.life/60, rise=(1-alpha)*50;
    const ppx=sx(p.x);
    ctx.save();ctx.globalAlpha=alpha;
    ctx.font='bold 14px Nunito,sans-serif';
    ctx.strokeStyle='black';ctx.lineWidth=3;ctx.textAlign='center';
    ctx.strokeText(p.txt,ppx,p.y-rise);
    ctx.fillStyle=p.col;ctx.fillText(p.txt,ppx,p.y-rise);
    ctx.textAlign='left';ctx.restore();
    p.life--;if(p.life<=0)pops.splice(i,1);
  }

  // Barre de progression
  const bW=CW-40;
  ctx.fillStyle='rgba(0,0,0,.35)';rr(ctx,20,14,bW,6,3);ctx.fill();
  gs.players.forEach(p=>{
    if(!p.alive)return;
    const pct=Math.min(1,p.x/lv.flagX);
    ctx.fillStyle=p.av.c;ctx.beginPath();ctx.arc(20+pct*bW,17,5,0,Math.PI*2);ctx.fill();
    ctx.font='11px sans-serif';ctx.textAlign='center';ctx.fillText(p.av.e,20+pct*bW,30);ctx.textAlign='left';
  });
  ctx.font='12px sans-serif';ctx.textAlign='center';ctx.fillText('ğŸ',20+bW,30);ctx.textAlign='left';
}

function drawBridge(br,t){
  const CW=canvas.width;
  const bsx=sx(br.bx);

  // Dalle du pont
  if(bsx<CW+br.bw&&bsx+br.bw>-T){
    if(br.open){
      ctx.fillStyle='#c8952a';ctx.fillRect(bsx,br.by,br.bw,br.bh+2);
      ctx.fillStyle='#b07820';for(let x=0;x<br.bw;x+=14)ctx.fillRect(bsx+x,br.by+2,4,br.bh-4);
      ctx.shadowColor='#FFD700';ctx.shadowBlur=8;
      ctx.fillStyle='rgba(255,215,0,.15)';ctx.fillRect(bsx,br.by,br.bw,br.bh);
      ctx.shadowBlur=0;
    }else{
      // Vide (danger visuel)
      const grad=ctx.createLinearGradient(0,br.by,0,br.by+60);
      grad.addColorStop(0,'rgba(0,0,150,.15)');grad.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=grad;ctx.fillRect(bsx,br.by,br.bw,60);
      ctx.strokeStyle='rgba(255,60,60,.4)';ctx.lineWidth=2;ctx.setLineDash([5,4]);
      ctx.strokeRect(bsx+2,br.by,br.bw-4,br.bh);ctx.setLineDash([]);
      // "VIDE" indicateur
      ctx.font='bold 11px Nunito,sans-serif';ctx.fillStyle='rgba(255,80,80,.7)';ctx.textAlign='center';
      ctx.fillText('â˜  VIDE',bsx+br.bw/2,br.by+br.bh+14);ctx.textAlign='left';
    }
  }

  // Bouton 1 â€” GAUCHE (ğŸ”´)
  drawBtn(br.btn1x,br.btn1y,br.btn1w,br.btn1h,br.pressed1,'ğŸ”´ MAINTENIR âš¡','#e74c3c','#27ae60',t,false);
  // Bouton 2 â€” DROITE (ğŸŸ£)
  drawBtn(br.btn2x,br.btn2y,br.btn2w,br.btn2h,br.pressed2,'ğŸŸ£ AUTRE CÃ”TÃ‰ âš¡','#8e44ad','#27ae60',t,true);
}

function drawBtn(bx,by,bw,bh,pressed,label,colOff,colOn,t,isRight){
  const x=sx(bx), CW=canvas.width;
  if(x<-80||x>CW+80)return;
  // Corps
  ctx.fillStyle=pressed?colOn:colOff;
  rr(ctx,x,by,bw,bh,6);ctx.fill();
  // Bord bas (effet 3D)
  ctx.fillStyle=pressed?'#1e8449':(isRight?'#6c3483':'#c0392b');
  rr(ctx,x,by+bh-5,bw,5,[0,0,6,6]);ctx.fill();
  // IcÃ´ne
  ctx.font='20px sans-serif';ctx.textAlign='center';
  ctx.fillText(pressed?'âœ…':'âš¡',x+bw/2,by+bh*.65);
  ctx.textAlign='left';
  // Label (clignotant si pas pressÃ©)
  const alpha2=pressed?1:.5+.5*Math.sin(t/10);
  ctx.globalAlpha=alpha2;
  ctx.font='bold 10px Nunito,sans-serif';
  ctx.fillStyle=pressed?'#2ecc71':'white';
  ctx.textAlign='center';
  if(!pressed){
    ctx.fillText('â–¼',x+bw/2,by-20);
    ctx.fillText(label,x+bw/2,by-8);
  }else{
    ctx.fillText('âœ… OUVERT!',x+bw/2,by-8);
  }
  ctx.textAlign='left';ctx.globalAlpha=1;
}

function drawBalloon(bal,t){
  const CW=canvas.width;
  const bx2=sx(bal.bx), by2=bal.floatY;
  const wobble=Math.sin(t/16)*4;

  // Pompe
  const px=sx(bal.pumpX), py=bal.pumpY;
  if(px>-80&&px<CW+80){
    const pumping=bal.pumper>=0;
    ctx.fillStyle=pumping?'#27ae60':'#2980b9';
    rr(ctx,px,py,bal.pumpW,bal.pumpH,6);ctx.fill();
    ctx.fillStyle=pumping?'#1e8449':'#1a6ca0';
    rr(ctx,px,py+bal.pumpH-5,bal.pumpW,5,[0,0,6,6]);ctx.fill();
    ctx.font='20px sans-serif';ctx.textAlign='center';
    ctx.fillText('ğŸˆ',px+bal.pumpW/2,py+bal.pumpH*.65);ctx.textAlign='left';
    // Label
    const a2=pumping?1:.5+.5*Math.sin(t/10+2);
    ctx.globalAlpha=a2;
    ctx.font='bold 10px Nunito,sans-serif';
    ctx.fillStyle=pumping?'#2ecc71':'#74b9ff';
    ctx.textAlign='center';
    ctx.fillText('â–¼',px+bal.pumpW/2,py-20);
    ctx.fillText(pumping?'âœ… MONTE!':'ğŸ”µ POMPE âš¡',px+bal.pumpW/2,py-8);
    ctx.textAlign='left';ctx.globalAlpha=1;

    // Corde pompe â†’ ballon
    if(bx2>-80&&bx2<CW+80){
      ctx.strokeStyle='rgba(80,80,80,.5)';ctx.lineWidth=1.5;ctx.setLineDash([4,3]);
      ctx.beginPath();ctx.moveTo(px+bal.pumpW/2,py);ctx.lineTo(bx2+bal.bw/2,by2+bal.bh*.9+wobble);
      ctx.stroke();ctx.setLineDash([]);
    }
  }

  // Ballon
  if(bx2>-80&&bx2<CW+80){
    ctx.fillStyle='#e74c3c';
    ctx.beginPath();ctx.ellipse(bx2+bal.bw/2,by2+bal.bh*.45+wobble,bal.bw*.55,bal.bh*.52,0,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='rgba(255,255,255,.35)';
    ctx.beginPath();ctx.ellipse(bx2+bal.bw*.33,by2+bal.bh*.3+wobble,bal.bw*.17,bal.bh*.17,-.5,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#555';ctx.lineWidth=2;
    ctx.beginPath();ctx.moveTo(bx2+bal.bw/2,by2+bal.bh*.9+wobble);ctx.lineTo(bx2+bal.bw/2,by2+bal.bh+8);ctx.stroke();
    ctx.font='bold 10px Nunito,sans-serif';ctx.fillStyle='white';ctx.textAlign='center';
    ctx.fillText(bal.rider>=0?'ğŸˆ Wheee!':'â† MONTE ICI',bx2+bal.bw/2,by2+bal.bh*.48+wobble+4);
    ctx.textAlign='left';
  }
}

function drawPlayer(p,t){
  if(!p.alive)return;
  const x=sx(p.x),y=p.y;
  if(x<-60||x>canvas.width+60)return;
  // Ombre
  ctx.fillStyle='rgba(0,0,0,.18)';
  ctx.beginPath();ctx.ellipse(x+p.w/2,y+p.h+3,12,4,0,0,Math.PI*2);ctx.fill();
  // Corps
  ctx.save();
  if(p.facing<0){ctx.translate(x+p.w,0);ctx.scale(-1,1);ctx.translate(-x,0);}
  ctx.fillStyle=p.av.c;rr(ctx,x+3,y+6,p.w-6,p.h-8,7);ctx.fill();
  ctx.fillStyle=p.av.d;rr(ctx,x+3,y+6+(p.h-8)*.5,p.w-6,(p.h-8)*.5,[0,0,7,7]);ctx.fill();
  const bob=p.onGround&&p.vx!==0?Math.abs(Math.sin(t/5))*2:0;
  ctx.font=`${p.w-4}px sans-serif`;ctx.textAlign='center';
  ctx.fillText(p.av.e,x+p.w/2,y+p.h-1-bob);ctx.textAlign='left';
  ctx.restore();
  // Nom
  ctx.font='bold 9px Nunito,sans-serif';ctx.textAlign='center';
  ctx.strokeStyle='rgba(0,0,0,.7)';ctx.lineWidth=3;
  ctx.strokeText(p.av.n,x+p.w/2,y-4);ctx.fillStyle='white';ctx.fillText(p.av.n,x+p.w/2,y-4);
  ctx.textAlign='left';
}

function rr(ctx,x,y,w,h,r){
  if(typeof r==='number')r=[r,r,r,r];
  ctx.beginPath();
  ctx.moveTo(x+r[0],y);ctx.lineTo(x+w-r[1],y);ctx.quadraticCurveTo(x+w,y,x+w,y+r[1]);
  ctx.lineTo(x+w,y+h-r[2]);ctx.quadraticCurveTo(x+w,y+h,x+w-r[2],y+h);
  ctx.lineTo(x+r[3],y+h);ctx.quadraticCurveTo(x,y+h,x,y+h-r[3]);
  ctx.lineTo(x,y+r[0]);ctx.quadraticCurveTo(x,y,x+r[0],y);
  ctx.closePath();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HUD & CONTROLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildHUD(){
  const h=document.getElementById('hudPlayers');h.innerHTML='';
  gs.players.forEach((p,i)=>{
    const d=document.createElement('div');d.className='hud-p alive';d.id='hudp'+i;
    d.innerHTML=`<div class="hud-av">${p.av.e}</div><div><div class="hud-name">${p.av.n}</div><div class="hud-st" id="hudst${i}">â¤ï¸ En vie</div></div>`;
    h.appendChild(d);
  });
  document.getElementById('hudLv').textContent=chosenLen.toUpperCase();
}
function updateHUD(){
  gs.players.forEach((p,i)=>{
    const el=document.getElementById('hudp'+i),st=document.getElementById('hudst'+i);
    if(!el)return;
    if(!p.alive){el.className='hud-p dead';st.textContent='ğŸ’€ Mort';}
    else if(p.finished){el.className='hud-p done';st.textContent='ğŸ† ArrivÃ©!';}
    else{el.className='hud-p alive';st.textContent='â­'+p.score;}
  });
}

// â”€â”€ INDEX DU JOUEUR ACTUELLEMENT CONTRÃ”LÃ‰ EN TACTILE â”€â”€
let touchPid = 0;  // par dÃ©faut joueur 0

// Joystick state
const joy = { active:false, id:null, baseX:0, baseY:0, dx:0, dy:0 };
const JOY_R = 52;   // rayon max du stick
const JOY_DEAD = 10; // dead zone

function buildCtrl(){
  // Couleur du joystick selon joueur actif
  styleJoystick();

  // â”€â”€ SÃ©lecteur de joueur (si plusieurs joueurs) â”€â”€
  const sw = document.getElementById('playerSwitcher');
  const tag= document.getElementById('activeTag');
  sw.innerHTML='';
  if(gs.players.length > 1){
    gs.players.forEach((p,i)=>{
      const btn=document.createElement('div');
      btn.className='psw-btn'+(i===0?' active':'');
      btn.id='psw'+i;
      btn.textContent=p.av.e;
      btn.style.borderColor=p.av.c;
      btn.addEventListener('touchstart',e=>{e.preventDefault();setTouchPid(i);},{passive:false});
      btn.addEventListener('mousedown',()=>setTouchPid(i));
      sw.appendChild(btn);
    });
    sw.style.display='flex';
    tag.style.display='none';
  } else {
    sw.style.display='none';
    tag.style.display='block';
    tag.textContent=gs.players[0].av.e+' '+gs.players[0].av.n;
    tag.style.borderColor=gs.players[0].av.c;
  }

  // â”€â”€ JOYSTICK â”€â”€
  const jw = document.getElementById('joyWrap');
  const js = document.getElementById('joyStick');
  const jRect = ()=>jw.getBoundingClientRect();

  function joyStart(e){
    e.preventDefault();
    const touch=e.changedTouches?e.changedTouches[0]:e;
    const r=jRect();
    joy.active=true; joy.id=touch.identifier??null;
    joy.baseX=r.left+r.width/2; joy.baseY=r.top+r.height/2;
    joyMove(e);
  }
  function joyMove(e){
    if(!joy.active)return;
    e.preventDefault();
    const touch=e.changedTouches
      ? Array.from(e.changedTouches).find(t=>t.identifier===joy.id)||e.changedTouches[0]
      : e;
    const dx=touch.clientX-joy.baseX;
    const dy=touch.clientY-joy.baseY;
    const dist=Math.min(Math.sqrt(dx*dx+dy*dy),JOY_R);
    const angle=Math.atan2(dy,dx);
    joy.dx=dx; joy.dy=dy;
    // DÃ©placer le stick visuellement
    const sx=Math.cos(angle)*dist, sy2=Math.sin(angle)*dist;
    js.style.transform=`translate(calc(-50% + ${sx}px), calc(-50% + ${sy2}px))`;
    // Mapper aux touches
    const p=gs.players[touchPid];
    if(!p||!p.alive)return;
    const absDx=Math.abs(dx);
    keys[CTRL[touchPid].left]  = dx < -JOY_DEAD;
    keys[CTRL[touchPid].right] = dx >  JOY_DEAD;
  }
  function joyEnd(e){
    joy.active=false;
    js.style.transform='translate(-50%,-50%)';
    keys[CTRL[touchPid].left]=false;
    keys[CTRL[touchPid].right]=false;
  }

  jw.addEventListener('touchstart',joyStart,{passive:false});
  jw.addEventListener('touchmove', joyMove, {passive:false});
  jw.addEventListener('touchend',  joyEnd,  {passive:false});
  jw.addEventListener('touchcancel',joyEnd, {passive:false});
  // Mouse fallback
  jw.addEventListener('mousedown', joyStart);
  window.addEventListener('mousemove', e=>{if(joy.active)joyMove(e);});
  window.addEventListener('mouseup',   e=>{if(joy.active)joyEnd(e);});

  // â”€â”€ ZONES TACTILES INVISIBLES (gauche/droite) â”€â”€
  // Tap gauche â†’ avance gauche, tap droite â†’ avance droite
  // Tap n'importe oÃ¹ (hors boutons) â†’ saut
  const tzL=document.getElementById('tzLeft');
  const tzR=document.getElementById('tzRight');

  function zoneTouch(dir, e){
    e.preventDefault();
    if(e.type==='touchstart'||e.type==='mousedown'){
      keys[CTRL[touchPid][dir]]=true;
    } else {
      keys[CTRL[touchPid][dir]]=false;
    }
  }
  // Tap rapide (touchend sans dÃ©placement) = saut aussi
  let zTapTime={};
  ['touchstart','touchend','mousedown','mouseup'].forEach(ev=>{
    tzL.addEventListener(ev,e=>zoneTouch('left',e),{passive:false});
    tzR.addEventListener(ev,e=>zoneTouch('right',e),{passive:false});
  });
  // Tap court = saut
  function makeTapJump(el){
    let tStart=0;
    el.addEventListener('touchstart',e=>{tStart=Date.now();},{passive:false});
    el.addEventListener('touchend',e=>{
      if(Date.now()-tStart<200){
        keys[CTRL[touchPid].jump]=true;
        setTimeout(()=>{keys[CTRL[touchPid].jump]=false;},120);
      }
    },{passive:false});
  }
  makeTapJump(tzL); makeTapJump(tzR);

  // â”€â”€ BOUTON SAUT â”€â”€
  const bj=document.getElementById('btnJump');
  bj.style.borderColor=gs.players[touchPid]?.av.c||'#e74c3c';
  const jDn=e=>{e.preventDefault();keys[CTRL[touchPid].jump]=true;bj.classList.add('pressed');};
  const jUp=e=>{e.preventDefault();keys[CTRL[touchPid].jump]=false;bj.classList.remove('pressed');};
  bj.addEventListener('touchstart',jDn,{passive:false});
  bj.addEventListener('touchend',  jUp,{passive:false});
  bj.addEventListener('mousedown',jDn);
  bj.addEventListener('mouseup',  jUp);
  bj.addEventListener('mouseleave',jUp);

  // â”€â”€ BOUTON ACTION âš¡ â”€â”€
  const ba=document.getElementById('btnAct');
  const aDn=e=>{e.preventDefault();keys[CTRL[touchPid].act]=true;ba.classList.add('pressed');};
  const aUp=e=>{e.preventDefault();keys[CTRL[touchPid].act]=false;ba.classList.remove('pressed');};
  ba.addEventListener('touchstart',aDn,{passive:false});
  ba.addEventListener('touchend',  aUp,{passive:false});
  ba.addEventListener('mousedown',aDn);
  ba.addEventListener('mouseup',  aUp);
  ba.addEventListener('mouseleave',aUp);
}

function setTouchPid(i){
  // LibÃ©rer les touches de l'ancien joueur
  keys[CTRL[touchPid].left]=false;
  keys[CTRL[touchPid].right]=false;
  keys[CTRL[touchPid].jump]=false;
  keys[CTRL[touchPid].act]=false;
  touchPid=i;
  // Mise Ã  jour visuels
  document.querySelectorAll('.psw-btn').forEach((b,j)=>b.classList.toggle('active',j===i));
  styleJoystick();
  const bj=document.getElementById('btnJump');
  if(bj) bj.style.borderColor=gs.players[i]?.av.c||'#e74c3c';
  const ba=document.getElementById('btnAct');
  if(ba) ba.style.borderColor=gs.players[i]?.av.c||'#FFD700';
}

function styleJoystick(){
  const p=gs?.players?.[touchPid];
  const c=p?.av.c||'rgba(255,255,255,.5)';
  const jw=document.getElementById('joyWrap');
  if(jw){
    const base=jw.querySelector('.joystick-base');
    if(base) base.style.borderColor=c;
    const stick=document.getElementById('joyStick');
    if(stick) stick.style.boxShadow=`0 4px 16px rgba(0,0,0,.4), 0 0 12px ${c}66, inset 0 1px 0 rgba(255,255,255,.6)`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function restart(){
  document.getElementById('winOv').classList.remove('show');
  document.getElementById('deathOv').classList.remove('show');
  pops.length=0; keys={}; touchPid=0;
  startGame();
}
function goLobby(){
  if(raf)cancelAnimationFrame(raf);
  document.getElementById('winOv').classList.remove('show');
  document.getElementById('deathOv').classList.remove('show');
  document.getElementById('gameScreen').classList.remove('active');
  document.getElementById('lobbyScreen').classList.add('active');
  pops.length=0; keys={}; touchPid=0;
}
</script>

</body>
</html>

<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üå¥ CoopRun Jungle üå¥</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Nunito:wght@400;700;900&display=swap');
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#1a1a2e;font-family:'Nunito',sans-serif;overflow:hidden;user-select:none;height:100vh;display:flex;flex-direction:column;}
.screen{display:none;width:100%;height:100vh;}
.screen.active{display:flex;flex-direction:column;}

/* ‚îÄ‚îÄ LOBBY ‚îÄ‚îÄ */
#lobbyScreen{background:linear-gradient(180deg,#0f0c29,#302b63,#24243e);align-items:center;justify-content:center;position:relative;overflow:hidden;}
.stars-bg{position:absolute;inset:0;pointer-events:none;}
.star{position:absolute;background:white;border-radius:50%;animation:twinkle 2s infinite alternate;}
@keyframes twinkle{from{opacity:.2}to{opacity:1}}
.lobby-wrap{display:flex;flex-direction:column;align-items:center;padding:16px;gap:10px;z-index:10;width:100%;overflow-y:auto;max-height:100vh;}
.lobby-title{font-family:‚ÄòPress Start 2P‚Äô,monospace;font-size:clamp(16px,3vw,34px);color:#FFD700;text-shadow:4px 4px 0 #b8860b;animation:bounce 2s ease-in-out infinite;text-align:center;}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.lobby-sub{font-size:14px;color:#a8d8ea;text-align:center;}

.lobby-panel{background:rgba(255,255,255,.07);border:2px solid rgba(255,255,255,.15);border-radius:22px;padding:20px;width:min(96vw,680px);backdrop-filter:blur(12px);}
.section-lbl{font-family:‚ÄòPress Start 2P‚Äô,monospace;font-size:10px;color:#FFD700;text-align:center;letter-spacing:2px;margin-bottom:12px;}

.mode-tabs{display:flex;gap:8px;margin-bottom:18px;}
.mode-tab{flex:1;padding:12px;background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.12);border-radius:12px;color:white;font-family:‚ÄòNunito‚Äô,sans-serif;font-size:14px;font-weight:700;cursor:pointer;text-align:center;transition:all .2s;}
.mode-tab:hover{border-color:rgba(255,215,0,.4);}
.mode-tab.active{border-color:#FFD700;background:rgba(255,215,0,.15);}
.mode-tab .tab-icon{font-size:20px;display:block;margin-bottom:3px;}

.tab-content{display:none;}
.tab-content.active{display:block;}

.avatar-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:18px;}
.av-slot{background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.1);border-radius:12px;padding:10px 4px;text-align:center;cursor:pointer;transition:all .2s;position:relative;}
.av-slot:hover{transform:scale(1.05);border-color:rgba(255,215,0,.4);}
.av-slot.selected{border-color:#FFD700;background:rgba(255,215,0,.1);}
.av-emoji{font-size:32px;display:block;margin-bottom:3px;}
.av-name{font-size:10px;font-weight:700;color:white;}
.av-dot{width:8px;height:8px;border-radius:50%;margin:3px auto 0;}

.level-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:18px;}
.lvl-btn{padding:10px;background:rgba(255,255,255,.05);border:2px solid rgba(255,255,255,.12);border-radius:12px;color:white;font-family:‚ÄòNunito‚Äô,sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .2s;text-align:center;}
.lvl-btn:hover{border-color:rgba(78,205,196,.5);}
.lvl-btn.selected{border-color:#4ec9b0;background:rgba(78,205,196,.15);}
.lvl-icon{font-size:20px;display:block;margin-bottom:2px;}
.lvl-sub{font-size:10px;color:#a8d8ea;margin-top:1px;}

.tuto-panel{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px 14px;margin-bottom:14px;}
.tuto-row{display:flex;align-items:flex-start;gap:8px;margin-bottom:6px;font-size:11px;color:white;line-height:1.5;}
.tuto-row:last-child{margin-bottom:0;}
.tuto-icon{font-size:16px;width:22px;text-align:center;flex-shrink:0;margin-top:1px;}

.start-btn{width:100%;padding:14px;background:linear-gradient(135deg,#FFD700,#ff8c00);border:none;border-radius:14px;font-family:‚ÄòPress Start 2P‚Äô,monospace;font-size:12px;color:#1a1a0a;cursor:pointer;transition:all .3s;box-shadow:0 6px 20px rgba(255,215,0,.4);}
.start-btn:hover{transform:translateY(-2px);box-shadow:0 10px 28px rgba(255,215,0,.6);}
.start-btn:disabled{opacity:.35;cursor:not-allowed;transform:none;}
.player-info{text-align:center;color:#a8d8ea;font-size:12px;margin-bottom:12px;}

/* ‚îÄ‚îÄ GAME ‚îÄ‚îÄ */
#gameScreen{position:relative;background:#1a4d2e;}
canvas{display:block;width:100%;height:100%;}
.g-hud{position:absolute;top:0;left:0;right:0;z-index:20;padding:8px 14px;background:linear-gradient(to bottom,rgba(0,0,0,.65),transparent);display:flex;align-items:center;justify-content:space-between;pointer-events:none;}
.hud-players{display:flex;gap:6px;flex-wrap:wrap;}
.hud-p{display:flex;align-items:center;gap:5px;background:rgba(0,0,0,.5);border-radius:20px;padding:3px 9px;border:2px solid transparent;transition:all .3s;}
.hud-p.alive{border-color:rgba(255,255,255,.25);}
.hud-p.dead{opacity:.4;border-color:rgba(255,0,0,.3);}
.hud-p.done{border-color:#FFD700;}
.hud-av{font-size:16px;}
.hud-name{font-size:9px;font-weight:700;color:white;}
.hud-st{font-size:8px;color:#a8d8ea;}
.hud-lv{font-family:‚ÄòPress Start 2P‚Äô,monospace;font-size:8px;color:#FFD700;}

/* Jauge trampoline */
.trampoline-gauge{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:30;display:none;flex-direction:column;align-items:center;gap:8px;}
.trampoline-gauge.show{display:flex;}
.gauge-title{font-family:‚ÄòPress Start 2P‚Äô,monospace;font-size:11px;color:#FFD700;text-shadow:2px 2px 0 #000;}
.gauge-bar{width:200px;height:30px;background:rgba(0,0,0,.7);border:3px solid #FFD700;border-radius:8px;position:relative;overflow:hidden;}
.gauge-fill{height:100%;background:linear-gradient(90deg,#ff0000,#ff6600,#FFD700,#00ff00);transition:width .05s linear;}
.gauge-target{position:absolute;top:0;bottom:0;width:40px;background:rgba(255,255,255,.3);border-left:3px solid #fff;border-right:3px solid #fff;}
.gauge-hint{font-size:12px;color:#a8d8ea;text-align:center;}

.joystick-wrap{position:absolute;bottom:12px;left:12px;z-index:25;width:120px;height:120px;-webkit-tap-highlight-color:transparent;touch-action:none;}
.joystick-base{position:absolute;inset:0;border-radius:50%;background:rgba(255,255,255,.07);border:3px solid rgba(255,255,255,.16);}
.joystick-arrows{position:absolute;inset:0;border-radius:50%;}
.joystick-arrows::before{content:‚Äò‚Üê‚Äô;position:absolute;left:7px;top:50%;transform:translateY(-50%);color:rgba(255,255,255,.28);font-size:13px;font-weight:900;}
.joystick-arrows::after{content:‚Äò‚Üí‚Äô;position:absolute;right:7px;top:50%;transform:translateY(-50%);color:rgba(255,255,255,.28);font-size:13px;font-weight:900;}
.joystick-stick{position:absolute;width:48px;height:48px;border-radius:50%;background:radial-gradient(circle at 35% 35%,rgba(255,255,255,.9),rgba(180,180,220,.7));border:3px solid rgba(255,255,255,.5);box-shadow:0 4px 14px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.6);top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;}

.right-btns{position:absolute;bottom:12px;right:12px;z-index:25;display:flex;flex-direction:column;gap:8px;align-items:center;}
.cb{width:56px;height:56px;border-radius:50%;border:3px solid rgba(255,255,255,.4);display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;color:white;transition:all .12s;-webkit-tap-highlight-color:transparent;touch-action:none;font-weight:900;box-shadow:0 4px 12px rgba(0,0,0,.3);}
.cb:active,.cb.pressed{transform:scale(.88);filter:brightness(1.4);}
.cb-jump{background:rgba(231,76,60,.85);border-color:#e74c3c;width:62px;height:62px;}
.cb-act{background:rgba(255,165,0,.9);border-color:#FFD700;font-size:22px;box-shadow:0 0 18px rgba(255,165,0,.6);}
.cb-act.pressed{box-shadow:0 0 34px rgba(255,165,0,.95);}

.ov{position:absolute;inset:0;z-index:50;background:rgba(0,0,0,.82);backdrop-filter:blur(10px);display:none;flex-direction:column;align-items:center;justify-content:center;gap:12px;}
.ov.show{display:flex;}
.ov-emoji{font-size:64px;}
.ov-title{font-family:‚ÄòPress Start 2P‚Äô,monospace;font-size:clamp(18px,4vw,40px);text-align:center;}
.ov-sub{font-size:15px;color:rgba(255,255,255,.7);text-align:center;max-width:380px;}
.ov-btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;}
.ov-btn{padding:12px 28px;border:none;border-radius:12px;font-family:‚ÄòPress Start 2P‚Äô,monospace;font-size:11px;cursor:pointer;transition:all .2s;}
.ov-btn-y{background:linear-gradient(135deg,#FFD700,#ff8c00);color:#1a1a0a;box-shadow:0 4px 16px rgba(255,215,0,.4);}
.ov-btn-y:hover{transform:translateY(-2px);}
.ov-btn-n{background:rgba(255,255,255,.1);color:white;border:2px solid rgba(255,255,255,.2);}
</style>

</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOBBY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<div class="screen active" id="lobbyScreen">
  <div class="stars-bg" id="starsEl"></div>
  <div class="lobby-wrap">
    <div class="lobby-title">üå¥ COOP RUN JUNGLE üå¥</div>
    <div class="lobby-sub">Aventure dans la jungle ‚Äî solo ou multi</div>

```
<div class="lobby-panel">
  <div class="tuto-panel">
    <div class="tuto-row"><span class="tuto-icon">üåâ</span><span><b>Pont :</b> maintiens ‚ö° sur bouton rouge ¬∑ solo : un seul suffit</span></div>
    <div class="tuto-row"><span class="tuto-icon">üéà</span><span><b>Ballon :</b> pompe ‚ö° pour monter ¬∑ saute dessus</span></div>
    <div class="tuto-row"><span class="tuto-icon">üöÄ</span><span><b>Catapulte :</b> monte dessus ¬∑ solo : elle se lance auto</span></div>
    <div class="tuto-row"><span class="tuto-icon">üéØ</span><span><b>Trampoline :</b> tape ‚ö° quand jauge est verte = passage secret !</span></div>
    <div class="tuto-row"><span class="tuto-icon">‚≠ê</span><span><b>√âtoiles :</b> r√©cup√®re-les pour le score</span></div>
    <div class="tuto-row"><span class="tuto-icon">üïπÔ∏è</span><span><b>Contr√¥les :</b> Joystick/Fl√®ches ¬∑ ‚Üë sauter ¬∑ ‚ö° action</span></div>
  </div>
  
  <div class="section-lbl">üé≠ AVATAR</div>
  <div class="avatar-grid" id="avGridSolo"></div>
  
  <div class="section-lbl">üó∫Ô∏è NIVEAU</div>
  <div class="level-grid" id="lvlGridSolo">
    <button class="lvl-btn selected" onclick="pickLevel('short',this)"><span class="lvl-icon">‚ö°</span>Court<div class="lvl-sub">~1 min</div></button>
    <button class="lvl-btn" onclick="pickLevel('medium',this)"><span class="lvl-icon">üåü</span>Moyen<div class="lvl-sub">~2 min</div></button>
    <button class="lvl-btn" onclick="pickLevel('long',this)"><span class="lvl-icon">üèÜ</span>Long<div class="lvl-sub">~4 min</div></button>
  </div>
  
  <div class="player-info" id="pInfoSolo">S√©lectionne un avatar</div>
  <button class="start-btn" id="startSoloBtn" disabled onclick="startSolo()">‚ñ∂ JOUER SOLO</button>
</div>
```

  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<div class="screen" id="gameScreen">
  <div class="g-hud">
    <div class="hud-players" id="hudPlayers"></div>
    <div class="hud-lv" id="hudLv">SOLO</div>
  </div>

<canvas id="gc"></canvas>

  <!-- Jauge trampoline -->

  <div class="trampoline-gauge" id="trampolineGauge">
    <div class="gauge-title">üéØ TIMING !</div>
    <div class="gauge-bar">
      <div class="gauge-fill" id="gaugeFill"></div>
      <div class="gauge-target" id="gaugeTarget"></div>
    </div>
    <div class="gauge-hint">Tape ‚ö° dans la zone verte !</div>
  </div>

  <div class="joystick-wrap" id="joyWrap">
    <div class="joystick-base"><div class="joystick-arrows"></div></div>
    <div class="joystick-stick" id="joyStick"></div>
  </div>

  <div class="right-btns">
    <button class="cb cb-act" id="btnAct">‚ö°</button>
    <button class="cb cb-jump" id="btnJump">‚Üë</button>
  </div>

  <div class="ov" id="winOv">
    <div class="ov-emoji">üèÜ</div>
    <div class="ov-title" style="color:#FFD700">VICTOIRE !</div>
    <div class="ov-sub" id="winMsg"></div>
    <div class="ov-btns">
      <button class="ov-btn ov-btn-y" onclick="restartGame()">üîÑ Rejouer</button>
      <button class="ov-btn ov-btn-n" onclick="goLobby()">üè† Lobby</button>
    </div>
  </div>
  <div class="ov" id="deathOv">
    <div class="ov-emoji">üíÄ</div>
    <div class="ov-title" style="color:#e74c3c">GAME OVER</div>
    <div class="ov-sub">Tu es tomb√© !</div>
    <div class="ov-btns">
      <button class="ov-btn ov-btn-y" onclick="restartGame()">üîÑ R√©essayer</button>
      <button class="ov-btn ov-btn-n" onclick="goLobby()">üè† Lobby</button>
    </div>
  </div>
</div>

<script type="module">
// ‚úÖ Vitesse √©quilibr√©e
const T=48, GRAV=0.55, JFORCE=-12.0, SPD=4.0, GAP_W=4;
const GROUND_Y=13, WORLD_H=18, SKY_Y=3;
const AVATARS=[
  {e:'üßë‚ÄçüöÄ',n:'Astro',c:'#e74c3c',d:'#c0392b'},
  {e:'üßô',n:'Mago',c:'#3498db',d:'#2980b9'},
  {e:'ü¶ä',n:'Renard',c:'#f39c12',d:'#d68910'},
  {e:'üê∏',n:'Grenouille',c:'#2ecc71',d:'#27ae60'},
  {e:'ü§ñ',n:'Robot',c:'#9b59b6',d:'#8e44ad'},
  {e:'üê±',n:'Chat',c:'#e91e63',d:'#c2185b'},
  {e:'‚ö°',n:'√âclair',c:'#ff9800',d:'#e65100'},
  {e:'üåô',n:'Lune',c:'#00bcd4',d:'#0097a7'},
];

const LEVEL_CFG={ 
  short:{bridges:2,balloons:1,catapults:1,trampolines:1,worldCells:130}, 
  medium:{bridges:3,balloons:2,catapults:2,trampolines:2,worldCells:220}, 
  long:{bridges:5,balloons:3,catapults:3,trampolines:3,worldCells:400} 
};

const CTRL=[
  {left:'ArrowLeft',right:'ArrowRight',jump:'ArrowUp',act:'KeyZ'},
  {left:'KeyA',right:'KeyD',jump:'KeyW',act:'KeyQ'},
  {left:'KeyJ',right:'KeyL',jump:'KeyI',act:'KeyU'},
];

let chosenSolo=null, chosenLen='short';
let canvas,ctx,gs,raf,touchPid=0;
const keys={};
const pops=[];
const joy={active:false,id:null,baseX:0,baseY:0,dx:0};
const JOY_R=50,JOY_DEAD=12;

document.addEventListener('keydown',e=>{keys[e.code]=true;e.preventDefault();});
document.addEventListener('keyup',e=>{keys[e.code]=false;});

// ‚îÄ‚îÄ STARS ‚îÄ‚îÄ
(()=>{
  const el=document.getElementById('starsEl');
  for(let i=0;i<70;i++){
    const s=document.createElement('div'); s.className='star';
    const z=Math.random()*3+1;
    s.style.cssText=`width:${z}px;height:${z}px;left:${Math.random()*100}%;top:${Math.random()*100}%;animation-delay:${Math.random()*2}s;animation-duration:${1+Math.random()*2}s`;
    el.appendChild(s);
  }
})();

function makeAvGrid(gridId,onSelect){
  const g=document.getElementById(gridId); g.innerHTML='';
  AVATARS.forEach((av,i)=>{
    const d=document.createElement('div'); d.className='av-slot'; d.id=gridId+'_av'+i;
    d.innerHTML=`<span class="av-emoji">${av.e}</span><div class="av-name">${av.n}</div><div class="av-dot" style="background:${av.c}"></div>`;
    d.onclick=()=>onSelect(i,gridId);
    g.appendChild(d);
  });
}

makeAvGrid('avGridSolo',(i,gid)=>{
  chosenSolo=i; 
  document.querySelectorAll(`#${gid} .av-slot`).forEach((el,j)=>el.classList.toggle('selected',j===i));
  document.getElementById('startSoloBtn').disabled=false;
  document.getElementById('pInfoSolo').textContent=`${AVATARS[i].e} ${AVATARS[i].n} s√©lectionn√© !`;
});

window.pickLevel=function(k,el){ 
  chosenLen=k; 
  document.querySelectorAll('#lvlGridSolo .lvl-btn').forEach(b=>b.classList.remove('selected')); 
  el.classList.add('selected'); 
};

window.startSolo=function(){
  if(chosenSolo===null) return;
  launchGame(chosenLen,[{idx:chosenSolo,slot:0}]);
};

function overlap(ax,ay,aw,ah,bx,by,bw,bh){return ax<bx+bw&&ax+aw>bx&&ay<by+bh&&ay+ah>by;}
function resolvePlat(p,pl){
  if(!overlap(p.x,p.y,p.w,p.h,pl.x,pl.y,pl.w,pl.h))return;
  const ol=p.x+p.w-pl.x,or2=pl.x+pl.w-p.x,ot=p.y+p.h-pl.y,ob=pl.y+pl.h-p.y;
  const mn=Math.min(ol,or2,ot,ob);
  if(mn===ot&&p.vy>=0){p.y=pl.y-p.h;p.vy=0;p.onGround=true;}
  else if(mn===ob&&p.vy<0){p.y=pl.y+pl.h;p.vy=0;}
  else if(mn===ol){p.x=pl.x-p.w;p.vx=0;}
  else{p.x=pl.x+pl.w;p.vx=0;}
}
function pop(x,y,txt,col){pops.push({x,y,txt,col,life:60});}

function seededRand(seed){let s=seed%2147483647;if(s<=0)s+=2147483646;return ()=>{s=s*16807%2147483647;return(s-1)/2147483646;};}

// ‚úÖ G√©n√©ration de niveau avec trampolines
function generateLevel(key,seed=12345){
  const cfg=LEVEL_CFG[key], W=cfg.worldCells, rand=seededRand(seed);
  const plats=[],bridges=[],balloons=[],coins=[],catapults=[],trampolines=[],skyPlatforms=[];
  const numBr=cfg.bridges,numBal=cfg.balloons,numCat=cfg.catapults,numTr=cfg.trampolines||0;
  const total=numBr+numBal+numCat+numTr;
  const startX=10,endX=W-10,span=endX-startX;
  const obsX=[];
  for(let i=0;i<total;i++) obsX.push(Math.round(startX+span*(i+1)/(total+1)));
  
  const types=[];
  for(let i=0;i<numBr;i++) types.push('bridge');
  for(let i=0;i<numBal;i++) types.push('balloon');
  for(let i=0;i<numCat;i++) types.push('catapult');
  for(let i=0;i<numTr;i++) types.push('trampoline');
  for(let i=types.length-1;i>0;i--){const j=Math.floor(rand()*(i+1));[types[i],types[j]]=[types[j],types[i]];}
  
  const gapZones=[];
  let bridgeIdx=0,balloonIdx=0,catapultIdx=0,trampolineIdx=0;
  
  obsX.forEach((cx,i)=>{
    const type=types[i];
    if(type==='bridge'){
      const gL=cx-2,gR=cx+2,groundTopY=GROUND_Y*T,btnY=groundTopY-T*0.9;
      bridges.push({
        id:bridgeIdx++,bx:gL*T,by:groundTopY-T*0.3,bw:GAP_W*T,bh:T*0.35,open:false,
        btnX:(gL-2)*T,btnY,btnW:T*0.85,btnH:T*0.85,pressed:false,presser:-1,gL,gR
      });
      gapZones.push({gL,gR});
    } else if(type==='balloon'){
      const highTileY=GROUND_Y-5,highX=cx+1,highW=4;
      plats.push({x:highX*T,y:highTileY*T,w:highW*T,h:T,type:'high'});
      coins.push({x:(highX+1)*T+8,y:(highTileY-1)*T+4,col:false,bonus:true});
      const initBalloonY=(GROUND_Y-3)*T;
      balloons.push({
        id:balloonIdx++,bx:(cx-1)*T,bw:T*1.4,bh:T*2,floatY:initBalloonY,initY:initBalloonY,
        pumpX:(cx-4)*T,pumpY:GROUND_Y*T-T*0.9,pumpW:T*0.85,pumpH:T*0.85,pumper:-1,rider:-1
      });
    } else if(type==='catapult'){
      const gY=GROUND_Y*T, cupX=(cx-2)*T;
      const highPlatX=(cx+7)*T, highPlatY=(GROUND_Y-7)*T;
      plats.push({x:highPlatX,y:highPlatY,w:T*3,h:T,type:'catapult-target'});
      coins.push({x:highPlatX+T,y:highPlatY-T+4,col:false,bonus:true});
      catapults.push({
        id:catapultIdx++,cupX,cupY:gY-T*0.7,cupW:T*1.2,cupH:T*0.5,
        fired:false,fireTimer:0,rider:-1,autoTimer:0
      });
    } else if(type==='trampoline'){
      // üéØ Trampoline avec passage secret dans le ciel
      const padX=cx*T, padY=GROUND_Y*T-T*0.8;
      // Plateforme secr√®te dans le ciel
      const skyPlatX=(cx-2)*T, skyPlatY=SKY_Y*T;
      skyPlatforms.push({x:skyPlatX,y:skyPlatY,w:T*6,h:T,type:'sky-secret'});
      // √âtoiles sur la plateforme
      for(let s=0;s<5;s++){
        coins.push({x:skyPlatX+(s+0.5)*T+8,y:skyPlatY-T+4,col:false,bonus:true,star:true});
      }
      trampolines.push({
        id:trampolineIdx++,padX,padY,padW:T*1.2,padH:T*0.7,
        gaugeActive:false,gaugeValue:0,gaugeSpeed:2.5,targetX:skyPlatX+T*3,targetY:skyPlatY-T
      });
    }
  });
  
  // Sol
  const sortedGaps=[...gapZones].sort((a,b)=>a.gL-b.gL);
  let cur=0;
  sortedGaps.forEach(g=>{
    if(cur<g.gL)plats.push({x:cur*T,y:GROUND_Y*T,w:(g.gL-cur)*T,h:(WORLD_H-GROUND_Y)*T,type:'ground'});
    cur=g.gR;
  });
  plats.push({x:cur*T,y:GROUND_Y*T,w:(W-cur)*T,h:(WORLD_H-GROUND_Y)*T,type:'ground'});
  
  // Plateformes d√©coratives
  for(let i=0;i<Math.floor(W/14);i++){
    const fx=7+i*14+Math.floor(rand()*4);
    if(sortedGaps.some(g=>fx>=g.gL-2&&fx<=g.gR+3))continue;
    if(obsX.some(ox=>Math.abs(fx-ox)<6))continue;
    const fw=3+Math.floor(rand()*2),fy=GROUND_Y-2-Math.floor(rand()*2);
    plats.push({x:fx*T,y:fy*T,w:fw*T,h:T,type:'platform'});
    for(let c=0;c<fw;c++) if(rand()<.5) coins.push({x:(fx+c)*T+8,y:(fy-1)*T+6,col:false,bonus:false});
  }
  
  // Pi√®ces au sol
  for(let i=0;i<8;i++){
    const cx2=3+Math.floor(rand()*(W-6));
    if(!sortedGaps.some(g=>cx2>=g.gL&&cx2<g.gR)) coins.push({x:cx2*T+8,y:(GROUND_Y-1)*T+4,col:false,bonus:false});
  }
  
  // Ajouter plateformes secr√®tes
  plats.push(...skyPlatforms);
  
  const flagX=(W-4)*T;
  plats.push({x:(W-4)*T,y:GROUND_Y*T,w:T,h:(WORLD_H-GROUND_Y)*T,type:'flag'});
  return{plats,bridges,balloons,coins,catapults,trampolines,flagX,worldW:W*T,worldH:WORLD_H*T};
}

function mkPlayer(avIdx,slot,startX){
  return{
    id:slot,av:AVATARS[Math.min(Math.max(avIdx,0),AVATARS.length-1)],
    x:startX,y:(GROUND_Y-2)*T,w:34,h:40,vx:0,vy:0,onGround:false,
    alive:true,finished:false,riding:null,onTrampoline:null,
    score:0,facing:1,wf:0,wt:0,jp:false
  };
}

function launchGame(levelKey,chosenPlayers){
  if(raf) cancelAnimationFrame(raf);
  document.getElementById('lobbyScreen').classList.remove('active');
  document.getElementById('gameScreen').classList.add('active');
  canvas=document.getElementById('gc'); ctx=canvas.getContext('2d');
  fitCanvas(); window.addEventListener('resize',fitCanvas);
  const seed=Date.now(), lv=generateLevel(levelKey,seed);
  const players=chosenPlayers.map((c,i)=>mkPlayer(c.idx,c.slot??i,60+i*55));
  touchPid=0;
  gs={lv,players,cam:{x:0},tick:0,over:false,levelKey,seed};
  pops.length=0;
  buildHUD(); buildTouchControls();
  document.getElementById('hudLv').textContent=levelKey.toUpperCase();
  gameLoop();
}

function fitCanvas(){if(!canvas)return;canvas.width=canvas.offsetWidth;canvas.height=canvas.offsetHeight;}

function gameLoop(){
  if(!gs||gs.over)return;
  gs.tick++;
  update();
  draw();
  updateHUD();
  raf=requestAnimationFrame(gameLoop);
}

function update(){
  const{lv,players}=gs;
  
  // Ponts
  lv.bridges.forEach(br=>{br.open=br.pressed;});
  
  // Ballons
  lv.balloons.forEach(bal=>{
    if(bal.pumper>=0){bal.floatY-=2.2;if(bal.floatY<80)bal.floatY=80;}
    else{bal.floatY+=0.3;if(bal.floatY>bal.initY)bal.floatY=bal.initY;}
  });
  
  // Catapultes (solo: auto-launch apr√®s 2 secondes)
  lv.catapults.forEach(cat=>{
    if(cat.fired&&--cat.fireTimer<=0)cat.fired=false;
    if(cat.rider>=0&&!cat.fired){
      cat.autoTimer++;
      if(cat.autoTimer>120){ // 2 secondes
        cat.fired=true;cat.fireTimer=50;
        const p=players[cat.rider];
        if(p){p.vx=5;p.vy=-16;p.onGround=false;pop(p.x,p.y,'üöÄ CATAPULTE!','#FF6B35');}
        cat.rider=-1;cat.autoTimer=0;
      }
    }
  });
  
  // Trampolines - mise √† jour de la jauge
  lv.trampolines.forEach(tr=>{
    if(tr.gaugeActive){
      tr.gaugeValue+=tr.gaugeSpeed;
      if(tr.gaugeValue>100){tr.gaugeValue=0;}
    }
  });
  
  players.forEach((p,pid)=>updatePlayer(p,pid));
  checkEnd();
}

function updatePlayer(p,pid){
  if(!p.alive||p.finished)return;
  const{lv}=gs;
  
  // Ballon
  if(p.riding!==null){
    const bal=lv.balloons[p.riding];
    p.x=bal.bx+bal.bw/2-p.w/2;p.y=bal.floatY-p.h-4;p.vx=0;p.vy=0;p.onGround=false;
    const jp=held(pid,'jump');
    if(jp&&!p.jp){p.vy=JFORCE*0.7;p.riding=null;bal.rider=-1;}
    p.jp=jp;
    if(p.y>lv.worldH)killP(p,pid);
    checkFlag(p,pid);
    return;
  }
  
  // Mouvement
  p.vx=0;
  if(held(pid,'left')){p.vx=-SPD;p.facing=-1;}
  if(held(pid,'right')){p.vx=SPD;p.facing=1;}
  const jp=held(pid,'jump');
  if(jp&&!p.jp&&p.onGround){p.vy=JFORCE;p.onGround=false;}
  p.jp=jp;
  p.vy+=GRAV;
  p.x+=p.vx;if(p.x<0)p.x=0;
  p.y+=p.vy;
  p.onGround=false;
  
  // Collisions
  lv.plats.forEach(pl=>resolvePlat(p,pl));
  lv.bridges.forEach(br=>{if(br.open)resolvePlat(p,{x:br.bx,y:br.by,w:br.bw,h:br.bh+4});});
  
  const act=held(pid,'act');
  
  // ‚úÖ Ponts - mode solo : un seul bouton suffit
  lv.bridges.forEach(br=>{
    const onBtn=overlap(p.x,p.y,p.w,p.h,br.btnX,br.btnY,br.btnW,br.btnH);
    if(onBtn&&act&&!br.pressed){
      br.pressed=true;br.presser=pid;
    } else if(!act&&br.pressed&&br.presser===pid){
      br.pressed=false;br.presser=-1;
    }
  });
  
  // Ballons
  lv.balloons.forEach(bal=>{
    const onP=overlap(p.x,p.y,p.w,p.h,bal.pumpX,bal.pumpY,bal.pumpW,bal.pumpH);
    const wasPump=bal.pumper===pid;
    if(onP&&act&&bal.pumper===-1){bal.pumper=pid;}
    else if(!act&&wasPump){bal.pumper=-1;}
    if(bal.rider<0&&overlap(p.x,p.y,p.w,p.h,bal.bx,bal.floatY,bal.bw,bal.bh)&&p.vy>=0){
      p.riding=bal.id;bal.rider=pid;p.vy=0;
    }
  });
  
  // ‚úÖ Catapultes - mode solo : auto-launch
  lv.catapults.forEach(cat=>{
    if(!cat.fired&&cat.rider<0&&p.vy>=0&&overlap(p.x,p.y,p.w,p.h,cat.cupX,cat.cupY,cat.cupW,cat.cupH)){
      cat.rider=pid;p.y=cat.cupY-p.h;p.vy=0;p.onGround=true;cat.autoTimer=0;
    }
    if(cat.rider===pid&&!cat.fired){
      p.x=cat.cupX+cat.cupW/2-p.w/2;p.y=cat.cupY-p.h;p.vx=0;p.onGround=true;
    }
  });
  
  // üéØ Trampolines avec jauge
  lv.trampolines.forEach(tr=>{
    const onPad=overlap(p.x,p.y,p.w,p.h,tr.padX,tr.padY,tr.padW,tr.padH);
    
    if(onPad&&p.vy>=0){
      p.y=tr.padY-p.h;p.vy=0;p.onGround=true;p.onTrampoline=tr.id;
      
      // Activer la jauge
      if(!tr.gaugeActive){
        tr.gaugeActive=true;
        tr.gaugeValue=0;
        showGauge(tr);
      }
      
      // Si on tape ‚ö° au bon moment
      if(act&&tr.gaugeActive){
        const success=isGaugeInTarget(tr.gaugeValue);
        if(success){
          // Succ√®s : t√©l√©portation vers le ciel
          p.x=tr.targetX-p.w/2;
          p.y=tr.targetY;
          p.vy=0;
          p.onGround=false;
          pop(p.x,p.y,'‚≠ê PASSAGE SECRET !','#FFD700');
        } else {
          // √âchec : petit rebond
          p.vy=JFORCE*0.3;
          pop(p.x,p.y,'‚ùå Rat√© !','#ff4444');
        }
        tr.gaugeActive=false;
        hideGauge();
        p.onTrampoline=null;
      }
    } else if(p.onTrampoline===tr.id){
      // Le joueur a quitt√© le pad
      p.onTrampoline=null;
      tr.gaugeActive=false;
      hideGauge();
    }
  });
  
  // Pi√®ces et √©toiles
  lv.coins.forEach(c=>{
    if(!c.col&&overlap(p.x,p.y,p.w,p.h,c.x,c.y,28,28)){
      c.col=true;
      p.score+=c.bonus?3:1;
      pop(c.x,c.y,c.star?'+3‚≠ê':c.bonus?'+3‚≠ê':'+1ü™ô','#FFD700');
    }
  });
  
  if(Math.abs(p.vx)>.1){p.wt++;if(p.wt>7){p.wt=0;p.wf=(p.wf+1)%4;}}else p.wf=0;
  if(p.y>lv.worldH+100)killP(p,pid);
  checkFlag(p,pid);
}

function held(pid,a){return!!keys[CTRL[Math.min(pid,2)][a]];}

function killP(p,pid){
  p.alive=false;
  if(p.riding!==null){const b=gs.lv.balloons[p.riding];if(b)b.rider=-1;p.riding=null;}
  gs.lv.bridges.forEach(br=>{if(br.presser===pid){br.pressed=false;br.presser=-1;}});
  gs.lv.balloons.forEach(b=>{if(b.pumper===pid)b.pumper=-1;});
  pop(p.x,p.y,'üíÄ MORT!','#ff4444');
}

function checkFlag(p,pid){
  if(!p.finished&&p.x+p.w>gs.lv.flagX){
    p.finished=true;p.score+=10;
    pop(p.x,p.y-40,'+10 üèÅ','#FFD700');
  }
}

function checkEnd(){
  const alive=gs.players.filter(p=>p.alive),finished=gs.players.filter(p=>p.finished);
  if(alive.length===0&&finished.length===0){
    gs.over=true;
    setTimeout(()=>document.getElementById('deathOv').classList.add('show'),500);
    return;
  }
  if(finished.length>0&&alive.length===finished.length){
    gs.over=true;
    const tot=gs.players.reduce((a,p)=>a+p.score,0);
    document.getElementById('winMsg').textContent=`Bravo ! Score total : ${tot}‚≠ê`;
    setTimeout(()=>document.getElementById('winOv').classList.add('show'),500);
  }
}

// Jauge trampoline
function showGauge(tr){
  const gauge=document.getElementById('trampolineGauge');
  const target=document.getElementById('gaugeTarget');
  // Zone verte al√©atoire entre 30% et 70%
  const targetPos=30+Math.random()*40;
  target.style.left=targetPos+'%';
  gauge.classList.add('show');
}

function hideGauge(){
  document.getElementById('trampolineGauge').classList.remove('show');
}

function isGaugeInTarget(value){
  const target=document.getElementById('gaugeTarget');
  const targetPos=parseFloat(target.style.left);
  return value>=targetPos&&value<=(targetPos+20); // Zone de 20%
}

function updateGaugeFill(){
  if(!gs)return;
  const tr=gs.lv.trampolines.find(t=>t.gaugeActive);
  if(tr){
    document.getElementById('gaugeFill').style.width=tr.gaugeValue+'%';
  }
}

function updateCam(){
  const alive=gs.players.filter(p=>p.alive);
  if(!alive.length)return;
  const target=Math.max(...alive.map(p=>p.x))-canvas.width*.35;
  gs.cam.x+=(target-gs.cam.x)*.1;
  gs.cam.x=Math.max(0,Math.min(gs.cam.x,gs.lv.worldW-canvas.width));
}
const sc=wx=>wx-gs.cam.x;

function draw(){
  updateCam();
  updateGaugeFill();
  const CW=canvas.width,CH=canvas.height,t=gs.tick,lv=gs.lv;
  
  // üå¥ Arri√®re-plan jungle
  const jungleGrad=ctx.createLinearGradient(0,0,0,CH);
  jungleGrad.addColorStop(0,'#1a4d2e');
  jungleGrad.addColorStop(.3,'#2d5f3f');
  jungleGrad.addColorStop(.6,'#3a7d44');
  jungleGrad.addColorStop(1,'#4a9d5f');
  ctx.fillStyle=jungleGrad;
  ctx.fillRect(0,0,CW,CH);
  
  // Feuillages en arri√®re-plan
  const leaves=[
    [120,40,'#2d5f3f',35],[380,65,'#1a4d2e',42],[680,38,'#3a7d44',38],
    [950,52,'#2d5f3f',40],[1280,45,'#4a9d5f',36],[1650,58,'#1a4d2e',44],
    [2100,48,'#3a7d44',38],[2500,62,'#2d5f3f',41]
  ];
  leaves.forEach(([x,y,col,r])=>{
    const dx=x-gs.cam.x*.25;
    if(dx<-100||dx>CW+100)return;
    const wobble=Math.sin(t/30+x)*3;
    ctx.fillStyle=col;
    ctx.globalAlpha=0.4;
    ctx.beginPath();
    ctx.ellipse(dx,y+wobble,r,r*.7,0,0,Math.PI*2);
    ctx.fill();
    ctx.globalAlpha=1;
  });
  
  // Lianes
  const vines=[[200,0,6],[550,0,5],[1100,0,7],[1800,0,6],[2400,0,5]];
  vines.forEach(([x,yy,w])=>{
    const vx=sc(x);
    if(vx<-50||vx>CW+50)return;
    ctx.strokeStyle='rgba(60,90,50,.5)';
    ctx.lineWidth=w;
    ctx.beginPath();
    ctx.moveTo(vx,0);
    for(let vy=0;vy<CH;vy+=20){
      const swing=Math.sin((t+vy)/15)*8;
      ctx.lineTo(vx+swing,vy);
    }
    ctx.stroke();
  });
  
  lv.plats.forEach(pl=>drawPlat(pl,CW,t));
  lv.bridges.forEach(br=>drawBridge(br,t,CW));
  lv.balloons.forEach(bal=>drawBalloon(bal,t,CW));
  lv.catapults.forEach(cat=>drawCatapult(cat,t,CW));
  lv.trampolines.forEach(tr=>drawTrampoline(tr,t,CW));
  
  lv.coins.forEach(c=>{
    if(c.col)return;
    const cx=sc(c.x);
    if(cx<-30||cx>CW+30)return;
    const bob=Math.sin(t/20+c.x)*3;
    ctx.font='22px sans-serif';
    ctx.fillText(c.star?'‚≠ê':c.bonus?'‚≠ê':'ü™ô',cx,c.y+bob+22);
  });
  
  gs.players.forEach(p=>drawPlayer(p,t,CW));
  
  // Pops
  for(let i=pops.length-1;i>=0;i--){
    const p=pops[i],alpha=p.life/60,rise=(1-alpha)*50,ppx=sc(p.x);
    ctx.save();ctx.globalAlpha=alpha;ctx.font='bold 13px Nunito,sans-serif';
    ctx.strokeStyle='black';ctx.lineWidth=3;ctx.textAlign='center';
    ctx.strokeText(p.txt,ppx,p.y-rise);ctx.fillStyle=p.col;
    ctx.fillText(p.txt,ppx,p.y-rise);ctx.textAlign='left';ctx.restore();
    p.life--;if(p.life<=0)pops.splice(i,1);
  }
  
  // Minimap
  const bW=CW-40;
  ctx.fillStyle='rgba(0,0,0,.3)';
  rr(ctx,20,14,bW,5,3);ctx.fill();
  gs.players.forEach(p=>{
    if(!p.alive)return;
    const pct=Math.min(1,p.x/lv.flagX);
    ctx.fillStyle=p.av.c;
    ctx.beginPath();ctx.arc(20+pct*bW,16,4,0,Math.PI*2);ctx.fill();
    ctx.font='10px sans-serif';ctx.textAlign='center';
    ctx.fillText(p.av.e,20+pct*bW,28);ctx.textAlign='left';
  });
  ctx.font='11px sans-serif';ctx.textAlign='center';
  ctx.fillText('üèÅ',20+bW,28);ctx.textAlign='left';
}

function drawPlat(pl,CW,t){
  const x=sc(pl.x),y=pl.y;
  if(x>CW+T||x+pl.w<-T)return;
  
  if(pl.type==='ground'){
    // Sol jungle
    ctx.fillStyle='#5DBB4B';ctx.fillRect(x,y,pl.w,10);
    ctx.fillStyle='#4a3820';ctx.fillRect(x,y+10,pl.w,pl.h-10);
    ctx.fillStyle='#3a2810';
    for(let gx=0;gx<pl.w;gx+=T)ctx.fillRect(x+gx,y+18,2,12);
  } else if(pl.type==='platform'){
    // Plateforme bois
    ctx.fillStyle='#8B4513';ctx.fillRect(x,y,pl.w,pl.h);
    ctx.fillStyle='#A0522D';ctx.fillRect(x,y,pl.w,5);
    ctx.fillStyle='#654321';
    for(let bx=0;bx<pl.w;bx+=T/2)ctx.fillRect(x+bx,y,2,pl.h);
  } else if(pl.type==='high'||pl.type==='catapult-target'){
    ctx.fillStyle='rgba(139,69,19,.9)';ctx.fillRect(x,y,pl.w,pl.h);
    ctx.fillStyle='rgba(160,82,45,.7)';ctx.fillRect(x,y,pl.w,5);
    ctx.font='10px Nunito';ctx.fillStyle='#FFD700';ctx.textAlign='center';
    ctx.fillText('üéØ CIBLE',x+pl.w/2,y-7);ctx.textAlign='left';
  } else if(pl.type==='sky-secret'){
    // Plateforme secr√®te avec effet brillant
    const glow=.6+.4*Math.sin(t/15);
    ctx.globalAlpha=glow;
    ctx.fillStyle='#FFD700';ctx.fillRect(x,y,pl.w,pl.h);
    ctx.fillStyle='#FFA500';ctx.fillRect(x,y,pl.w,5);
    ctx.globalAlpha=1;
    ctx.font='bold 11px Nunito';ctx.fillStyle='#FFD700';
    ctx.strokeStyle='black';ctx.lineWidth=3;ctx.textAlign='center';
    ctx.strokeText('‚≠ê SECRET ‚≠ê',x+pl.w/2,y-8);
    ctx.fillText('‚≠ê SECRET ‚≠ê',x+pl.w/2,y-8);ctx.textAlign='left';
  } else if(pl.type==='flag'){
    ctx.fillStyle='#654321';ctx.fillRect(x+4,y,6,canvas.height);
    ctx.fillStyle='#e74c3c';ctx.beginPath();ctx.moveTo(x+10,y);
    ctx.lineTo(x+52,y+17);ctx.lineTo(x+10,y+34);ctx.fill();
    ctx.font='20px sans-serif';ctx.fillText('üèÅ',x-8,y-6);
  }
}

function drawBridge(br,t,CW){
  const bsx=sc(br.bx);
  if(bsx<CW+br.bw&&bsx+br.bw>-T){
    if(br.open){
      ctx.fillStyle='#8B4513';ctx.fillRect(bsx,br.by,br.bw,br.bh+2);
      ctx.fillStyle='#654321';
      for(let x=0;x<br.bw;x+=14)ctx.fillRect(bsx+x,br.by+2,4,br.bh-4);
      ctx.shadowColor='#FFD700';ctx.shadowBlur=8;
      ctx.fillStyle='rgba(255,215,0,.15)';ctx.fillRect(bsx,br.by,br.bw,br.bh);
      ctx.shadowBlur=0;
    } else {
      const g=ctx.createLinearGradient(0,br.by,0,br.by+60);
      g.addColorStop(0,'rgba(0,0,150,.15)');g.addColorStop(1,'rgba(0,0,0,0)');
      ctx.fillStyle=g;ctx.fillRect(bsx,br.by,br.bw,60);
      ctx.strokeStyle='rgba(255,60,60,.4)';ctx.lineWidth=2;ctx.setLineDash([5,4]);
      ctx.strokeRect(bsx+2,br.by,br.bw-4,br.bh);ctx.setLineDash([]);
      ctx.font='bold 10px Nunito';ctx.fillStyle='rgba(255,80,80,.7)';
      ctx.textAlign='center';ctx.fillText('‚ò† VIDE',bsx+br.bw/2,br.by+br.bh+13);
      ctx.textAlign='left';
    }
  }
  drawBtn(br.btnX,br.btnY,br.btnW,br.btnH,br.pressed,'‚ö° MAINTENIR','#e74c3c','#27ae60',t);
}

function drawBtn(bx,by,bw,bh,pressed,label,colOff,colOn,t){
  const x=sc(bx),CW=canvas.width;
  if(x<-80||x>CW+80)return;
  ctx.fillStyle=pressed?colOn:colOff;rr(ctx,x,by,bw,bh,6);ctx.fill();
  ctx.fillStyle=pressed?'#1e8449':'#c0392b';
  rr(ctx,x,by+bh-5,bw,5,[0,0,6,6]);ctx.fill();
  ctx.font='18px sans-serif';ctx.textAlign='center';
  ctx.fillText(pressed?'‚úÖ':'‚ö°',x+bw/2,by+bh*.65);ctx.textAlign='left';
  const a2=pressed?1:.5+.5*Math.sin(t/10);
  ctx.globalAlpha=a2;ctx.font='bold 9px Nunito,sans-serif';
  ctx.fillStyle=pressed?'#2ecc71':'white';ctx.textAlign='center';
  ctx.fillText(pressed?'‚úÖ OUVERT!':label,x+bw/2,by-7);
  if(!pressed)ctx.fillText('‚ñº',x+bw/2,by-19);
  ctx.textAlign='left';ctx.globalAlpha=1;
}

function drawCatapult(cat,t,CW){
  const cx=sc(cat.cupX);
  if(cx>CW+200||cx<-200)return;
  const gY=cat.cupY+cat.cupH;
  ctx.fillStyle='#654321';ctx.fillRect(cx-6,gY,cat.cupW+12,8);
  ctx.strokeStyle='#3a2810';ctx.lineWidth=6;ctx.beginPath();
  ctx.moveTo(cx+cat.cupW/2,gY);ctx.lineTo(cx+cat.cupW/2,cat.cupY+cat.cupH);
  ctx.stroke();
  ctx.fillStyle=cat.fired?'#e74c3c':'#8B4513';
  rr(ctx,cx,cat.cupY,cat.cupW,cat.cupH,4);ctx.fill();
  ctx.font='14px sans-serif';ctx.textAlign='center';
  ctx.fillText(cat.rider>=0?'üßë':'‚¨ÜÔ∏è',cx+cat.cupW/2,cat.cupY+cat.cupH*.75);
  ctx.textAlign='left';
  
  if(cat.rider>=0&&!cat.fired){
    const countdown=Math.ceil((120-cat.autoTimer)/60);
    ctx.font='bold 12px Nunito';ctx.fillStyle='#FFD700';
    ctx.strokeStyle='black';ctx.lineWidth=3;ctx.textAlign='center';
    ctx.strokeText(`LANCEMENT: ${countdown}s`,cx+cat.cupW/2,cat.cupY-12);
    ctx.fillText(`LANCEMENT: ${countdown}s`,cx+cat.cupW/2,cat.cupY-12);
    ctx.textAlign='left';
  }
}

function drawBalloon(bal,t,CW){
  const bx2=sc(bal.bx),by2=bal.floatY,wobble=Math.sin(t/16)*4;
  const px=sc(bal.pumpX),py=bal.pumpY;
  
  if(px>-80&&px<CW+80){
    const pumping=bal.pumper>=0;
    ctx.fillStyle=pumping?'#27ae60':'#2980b9';
    rr(ctx,px,py,bal.pumpW,bal.pumpH,6);ctx.fill();
    ctx.fillStyle=pumping?'#1e8449':'#1a6ca0';
    rr(ctx,px,py+bal.pumpH-5,bal.pumpW,5,[0,0,6,6]);ctx.fill();
    ctx.font='18px sans-serif';ctx.textAlign='center';
    ctx.fillText('üéà',px+bal.pumpW/2,py+bal.pumpH*.65);ctx.textAlign='left';
    const a2=(pumping)?1:.5+.5*Math.sin(t/10+2);
    ctx.globalAlpha=a2;ctx.font='bold 9px Nunito,sans-serif';
    ctx.fillStyle=pumping?'#2ecc71':'#74b9ff';ctx.textAlign='center';
    ctx.fillText('‚ñº',px+bal.pumpW/2,py-19);
    ctx.fillText(pumping?'‚úÖ MONTE!':'‚ö° POMPE',px+bal.pumpW/2,py-7);
    ctx.textAlign='left';ctx.globalAlpha=1;
    
    if(bx2>-80&&bx2<CW+80){
      ctx.strokeStyle='rgba(80,80,80,.5)';ctx.lineWidth=1.5;
      ctx.setLineDash([4,3]);ctx.beginPath();
      ctx.moveTo(px+bal.pumpW/2,py);
      ctx.lineTo(bx2+bal.bw/2,by2+bal.bh*.9+wobble);
      ctx.stroke();ctx.setLineDash([]);
    }
  }
  
  if(bx2>-80&&bx2<CW+80){
    ctx.fillStyle='#e74c3c';ctx.beginPath();
    ctx.ellipse(bx2+bal.bw/2,by2+bal.bh*.45+wobble,bal.bw*.55,bal.bh*.52,0,0,Math.PI*2);
    ctx.fill();
    ctx.fillStyle='rgba(255,255,255,.35)';ctx.beginPath();
    ctx.ellipse(bx2+bal.bw*.33,by2+bal.bh*.3+wobble,bal.bw*.17,bal.bh*.17,-.5,0,Math.PI*2);
    ctx.fill();
    ctx.strokeStyle='#555';ctx.lineWidth=2;ctx.beginPath();
    ctx.moveTo(bx2+bal.bw/2,by2+bal.bh*.9+wobble);
    ctx.lineTo(bx2+bal.bw/2,by2+bal.bh+8);ctx.stroke();
    ctx.font='bold 9px Nunito,sans-serif';ctx.fillStyle='white';
    ctx.textAlign='center';
    ctx.fillText(bal.rider>=0?'üéà Wheee!':'‚Üê MONTE',bx2+bal.bw/2,by2+bal.bh*.48+wobble+4);
    ctx.textAlign='left';
  }
}

function drawTrampoline(tr,t,CW){
  const px=sc(tr.padX),py=tr.padY;
  if(px<-80||px>CW+80)return;
  
  const bounce=Math.abs(Math.sin(t/10))*5;
  ctx.fillStyle='#FFD700';
  ctx.beginPath();
  ctx.ellipse(px+tr.padW/2,py+bounce+tr.padH/2,tr.padW*.5,tr.padH*.8,0,0,Math.PI*2);
  ctx.fill();
  
  ctx.fillStyle='#FFA500';
  ctx.beginPath();
  ctx.ellipse(px+tr.padW/2,py+bounce+tr.padH/2,tr.padW*.3,tr.padH*.5,0,0,Math.PI*2);
  ctx.fill();
  
  ctx.font='24px sans-serif';ctx.textAlign='center';
  ctx.fillText('üéØ',px+tr.padW/2,py+bounce+tr.padH*.7);
  
  const pulse=.7+.3*Math.sin(t/12);
  ctx.globalAlpha=pulse;
  ctx.font='bold 10px Nunito';ctx.fillStyle='#FFD700';
  ctx.strokeStyle='black';ctx.lineWidth=3;
  ctx.strokeText('‚ö° TRAMPOLINE',px+tr.padW/2,py-10);
  ctx.fillText('‚ö° TRAMPOLINE',px+tr.padW/2,py-10);
  ctx.globalAlpha=1;
  ctx.textAlign='left';
}

function drawPlayer(p,t,CW){
  if(!p.alive)return;
  const x=sc(p.x),y=p.y;
  if(x<-60||x>CW+60)return;
  
  ctx.fillStyle='rgba(0,0,0,.18)';ctx.beginPath();
  ctx.ellipse(x+p.w/2,y+p.h+3,12,4,0,0,Math.PI*2);ctx.fill();
  
  ctx.save();
  if(p.facing<0){ctx.translate(x+p.w,0);ctx.scale(-1,1);ctx.translate(-x,0);}
  ctx.fillStyle=p.av.c;rr(ctx,x+3,y+6,p.w-6,p.h-8,7);ctx.fill();
  ctx.fillStyle=p.av.d;rr(ctx,x+3,y+6+(p.h-8)*.5,p.w-6,(p.h-8)*.5,[0,0,7,7]);ctx.fill();
  const bob=p.onGround&&Math.abs(p.vx)>.1?Math.abs(Math.sin(t/5))*2:0;
  ctx.font=`${p.w-4}px sans-serif`;ctx.textAlign='center';
  ctx.fillText(p.av.e,x+p.w/2,y+p.h-1-bob);ctx.textAlign='left';
  ctx.restore();
  
  ctx.font='bold 8px Nunito,sans-serif';ctx.textAlign='center';
  ctx.strokeStyle='rgba(0,0,0,.7)';ctx.lineWidth=3;
  ctx.strokeText(p.av.n,x+p.w/2,y-4);
  ctx.fillStyle='white';ctx.fillText(p.av.n,x+p.w/2,y-4);
  ctx.textAlign='left';
}

function rr(ctx,x,y,w,h,r){
  if(typeof r==='number')r=[r,r,r,r];
  ctx.beginPath();ctx.moveTo(x+r[0],y);ctx.lineTo(x+w-r[1],y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r[1]);ctx.lineTo(x+w,y+h-r[2]);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r[2],y+h);ctx.lineTo(x+r[3],y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r[3]);ctx.lineTo(x,y+r[0]);
  ctx.quadraticCurveTo(x,y,x+r[0],y);ctx.closePath();
}

function buildHUD(){
  const h=document.getElementById('hudPlayers');h.innerHTML='';
  gs.players.forEach((p,i)=>{
    const d=document.createElement('div');d.className='hud-p alive';d.id='hudp'+i;
    d.innerHTML=`<div class="hud-av">${p.av.e}</div><div><div class="hud-name">${p.av.n}</div><div class="hud-st" id="hudst${i}">‚ù§Ô∏è</div></div>`;
    h.appendChild(d);
  });
}

function updateHUD(){
  gs.players.forEach((p,i)=>{
    const el=document.getElementById('hudp'+i),st=document.getElementById('hudst'+i);
    if(!el)return;
    if(!p.alive){el.className='hud-p dead';st.textContent='üíÄ';}
    else if(p.finished){el.className='hud-p done';st.textContent='üèÜ';}
    else{el.className='hud-p alive';st.textContent='‚≠ê'+p.score;}
  });
}

function buildTouchControls(){
  const jw=document.getElementById('joyWrap'),js=document.getElementById('joyStick');
  const p=gs.players[touchPid];const c=p?.av.c||'rgba(255,255,255,.5)';
  jw.querySelector('.joystick-base').style.borderColor=c;
  js.style.boxShadow=`0 4px 14px rgba(0,0,0,.4),0 0 10px ${c}66,inset 0 1px 0 rgba(255,255,255,.6)`;

  function joyStart(e){
    e.preventDefault();
    const t=e.changedTouches?e.changedTouches[0]:e;
    const r=jw.getBoundingClientRect();
    joy.active=true;joy.id=t.identifier??null;
    joy.baseX=r.left+r.width/2;joy.baseY=r.top+r.height/2;
    joyMove(e);
  }
  
  function joyMove(e){
    if(!joy.active)return;
    e.preventDefault();
    const t=e.changedTouches?Array.from(e.changedTouches).find(t2=>t2.identifier===joy.id)||e.changedTouches[0]:e;
    const dx=t.clientX-joy.baseX,dy=t.clientY-joy.baseY;
    const dist=Math.min(Math.sqrt(dx*dx+dy*dy),JOY_R);
    const ang=Math.atan2(dy,dx);
    js.style.transform=`translate(calc(-50% + ${Math.cos(ang)*dist}px),calc(-50% + ${Math.sin(ang)*dist}px))`;
    keys[CTRL[touchPid].left]=dx<-JOY_DEAD;
    keys[CTRL[touchPid].right]=dx>JOY_DEAD;
  }
  
  function joyEnd(){
    joy.active=false;
    js.style.transform='translate(-50%,-50%)';
    keys[CTRL[touchPid].left]=false;
    keys[CTRL[touchPid].right]=false;
  }
  
  jw.addEventListener('touchstart',joyStart,{passive:false});
  jw.addEventListener('touchmove',joyMove,{passive:false});
  jw.addEventListener('touchend',joyEnd,{passive:false});
  jw.addEventListener('touchcancel',joyEnd,{passive:false});
  jw.addEventListener('mousedown',joyStart);
  window.addEventListener('mousemove',e=>{if(joy.active)joyMove(e);});
  window.addEventListener('mouseup',e=>{if(joy.active)joyEnd();});

  const bj=document.getElementById('btnJump');bj.style.borderColor=c;
  const jDn=e=>{e.preventDefault();keys[CTRL[touchPid].jump]=true;bj.classList.add('pressed');};
  const jUp=e=>{e.preventDefault();keys[CTRL[touchPid].jump]=false;bj.classList.remove('pressed');};
  bj.addEventListener('touchstart',jDn,{passive:false});
  bj.addEventListener('touchend',jUp,{passive:false});
  bj.addEventListener('mousedown',jDn);
  bj.addEventListener('mouseup',jUp);
  bj.addEventListener('mouseleave',jUp);

  const ba=document.getElementById('btnAct');ba.style.borderColor=c;
  const aDn=e=>{e.preventDefault();keys[CTRL[touchPid].act]=true;ba.classList.add('pressed');};
  const aUp=e=>{e.preventDefault();keys[CTRL[touchPid].act]=false;ba.classList.remove('pressed');};
  ba.addEventListener('touchstart',aDn,{passive:false});
  ba.addEventListener('touchend',aUp,{passive:false});
  ba.addEventListener('mousedown',aDn);
  ba.addEventListener('mouseup',aUp);
  ba.addEventListener('mouseleave',aUp);
}

window.restartGame=function(){
  document.getElementById('winOv').classList.remove('show');
  document.getElementById('deathOv').classList.remove('show');
  pops.length=0;
  Object.keys(keys).forEach(k=>keys[k]=false);
  startSolo();
};

window.goLobby=function(){
  if(raf)cancelAnimationFrame(raf);
  document.getElementById('winOv').classList.remove('show');
  document.getElementById('deathOv').classList.remove('show');
  document.getElementById('trampolineGauge').classList.remove('show');
  document.getElementById('gameScreen').classList.remove('active');
  document.getElementById('lobbyScreen').classList.add('active');
  pops.length=0;
  Object.keys(keys).forEach(k=>keys[k]=false);
};
</script>

</body>
</html>

<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BubbleChat - Cr√©ation</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 40px 20px;
  color: white;
}
.container { max-width: 1200px; margin: 0 auto; }
h1 {
  text-align: center; font-size: 42px; font-weight: 300;
  letter-spacing: 2px; margin-bottom: 40px;
  text-shadow: 2px 2px 10px rgba(0,0,0,0.3);
}
.admin-card {
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(20px);
  border-radius: 25px; padding: 40px; margin-bottom: 30px;
  border: 1px solid rgba(255,255,255,0.2);
  box-shadow: 0 8px 32px rgba(0,0,0,0.1);
}
h2 { font-size: 28px; font-weight: 300; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
.stat-box { background: rgba(255,255,255,0.1); padding: 25px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.2); }
.stat-number { font-size: 48px; font-weight: 700; margin-bottom: 10px; }
.stat-label { font-size: 14px; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }
.users-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
.users-table th { background: rgba(255,255,255,0.1); padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid rgba(255,255,255,0.2); }
.users-table td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); }
.users-table tr:hover { background: rgba(255,255,255,0.05); }
.user-photo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.4); }
.status-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
.status-online  { background: rgba(74,222,128,0.3); border: 1px solid rgba(74,222,128,0.6); }
.status-offline { background: rgba(239,68,68,0.3);  border: 1px solid rgba(239,68,68,0.6);  }
.btn {
  padding: 12px 25px; border: none; border-radius: 15px; font-size: 15px; font-weight: 600;
  cursor: pointer; transition: all 0.3s ease; background: rgba(255,255,255,0.2); color: white;
  border: 2px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px); margin: 5px;
}
.btn:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
.btn-danger { background: rgba(239,68,68,0.3); border-color: rgba(239,68,68,0.6); }
.btn-danger:hover { background: rgba(239,68,68,0.5); }
.actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 30px; }
.messages-list { max-height: 400px; overflow-y: auto; margin-top: 20px; }
.message-item { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.2); }
.message-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; opacity: 0.8; }
.message-text { font-size: 15px; line-height: 1.5; }
.back-btn {
  position: fixed; top: 20px; left: 20px; padding: 10px 20px;
  background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3);
  border-radius: 20px; color: white; cursor: pointer; backdrop-filter: blur(10px);
  transition: all 0.3s ease; z-index: 1000; font-weight: 600;
}
.back-btn:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
</style>
</head>
<body>

<button class="back-btn" onclick="window.location.href='chat.html'">‚Üê Retour au chat</button>

<div class="container">
  <h1>üé® Espace Cr√©ation - Admin</h1>

  <div class="admin-card">
    <h2>üìä Statistiques</h2>
    <div class="stats-grid">
      <div class="stat-box"><div class="stat-number" id="totalUsers">0</div><div class="stat-label">Utilisateurs</div></div>
      <div class="stat-box"><div class="stat-number" id="onlineUsers">0</div><div class="stat-label">En ligne</div></div>
      <div class="stat-box"><div class="stat-number" id="totalMessages">0</div><div class="stat-label">Messages</div></div>
    </div>
  </div>

  <div class="admin-card">
    <h2>üë• Gestion des utilisateurs</h2>
    <table class="users-table">
      <thead><tr><th>Photo</th><th>Pr√©nom</th><th>Statut</th><th>Inscrit le</th><th>Actions</th></tr></thead>
      <tbody id="usersTableBody"></tbody>
    </table>
  </div>

  <div class="admin-card">
    <h2>üí¨ Messages r√©cents</h2>
    <div class="messages-list" id="messagesList"></div>
  </div>

  <div class="admin-card">
    <h2>‚öôÔ∏è Actions</h2>
    <div class="actions">
      <button class="btn" onclick="location.reload()">üîÑ Actualiser</button>
      <button class="btn btn-danger" id="clearMessagesBtn">üóëÔ∏è Effacer tous les messages</button>
      <button class="btn" onclick="window.location.href='chat.html'">üí¨ Aller au chat</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://eeikriwrwuynwpzodbbt.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlaWtyaXdyd3V5bndwem9kYmJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NzQ3NjYsImV4cCI6MjA4NjE1MDc2Nn0.MJ6CSmrttEWcrdfy5C7nP4sE_pe19sGNE-WasASPDNc"
);

if (localStorage.getItem('prenom') !== 'Steph') {
  window.location.href = 'chat.html';
}

// ‚îÄ‚îÄ Stats ‚îÄ‚îÄ
async function loadStats() {
  const { data: users }    = await supabase.from('profiles').select('*');
  const { data: messages } = await supabase.from('messages').select('*');
  document.getElementById('totalUsers').textContent    = users?.length || 0;
  document.getElementById('onlineUsers').textContent   = users?.filter(u => u.is_online).length || 0;
  document.getElementById('totalMessages').textContent = messages?.length || 0;
}

// ‚îÄ‚îÄ Supprimer un utilisateur ‚îÄ‚îÄ
async function deleteUser(prenom, id) {
  if (!confirm(`Supprimer "${prenom}" et tous ses messages ?`)) return;

  // Supprimer les messages de cet utilisateur
  await supabase.from('messages').delete().eq('prenom', prenom);

  // Supprimer le profil par son UUID
  const { error } = await supabase.from('profiles').delete().eq('id', id);
  if (error) {
    alert('Erreur suppression profil : ' + error.message);
    return;
  }

  await loadUsers();
  await loadStats();
  await loadMessages();
}

// ‚îÄ‚îÄ Charger utilisateurs ‚îÄ‚îÄ
async function loadUsers() {
  const { data: users, error } = await supabase
    .from('profiles').select('*').order('created_at', { ascending: false });

  if (error) {
    document.getElementById('usersTableBody').innerHTML =
      `<tr><td colspan="5" style="color:#fca5a5;padding:20px;text-align:center">${error.message}</td></tr>`;
    return;
  }

  const tbody = document.getElementById('usersTableBody');
  tbody.innerHTML = '';

  (users || []).forEach(user => {
    const row = document.createElement('tr');

    const tdPhoto = document.createElement('td');
    if (user.photo_url) {
      const img = document.createElement('img');
      img.className = 'user-photo';
      img.src = user.photo_url;
      img.alt = user.prenom;
      img.onerror = () => img.style.display = 'none';
      tdPhoto.appendChild(img);
    }

    const tdPrenom = document.createElement('td');
    tdPrenom.innerHTML = `<strong>${user.prenom}</strong>`;

    const tdStatus = document.createElement('td');
    tdStatus.innerHTML = `<span class="status-badge status-${user.is_online ? 'online' : 'offline'}">
      ${user.is_online ? 'En ligne' : 'Hors ligne'}</span>`;

    const tdDate = document.createElement('td');
    tdDate.textContent = new Date(user.created_at).toLocaleDateString('fr-FR');

    const tdActions = document.createElement('td');
    const btn = document.createElement('button');
    btn.className = 'btn btn-danger';
    btn.textContent = 'Supprimer';
    // On passe l'UUID (user.id) pour √©viter tout probl√®me de type
    btn.addEventListener('click', () => deleteUser(user.prenom, user.id));
    tdActions.appendChild(btn);

    row.append(tdPhoto, tdPrenom, tdStatus, tdDate, tdActions);
    tbody.appendChild(row);
  });
}

// ‚îÄ‚îÄ Charger messages ‚îÄ‚îÄ
async function loadMessages() {
  const { data: messages, error } = await supabase
    .from('messages').select('*').order('created_at', { ascending: false }).limit(20);

  if (error) {
    document.getElementById('messagesList').innerHTML =
      `<div style="color:#fca5a5;padding:20px;text-align:center">${error.message}</div>`;
    return;
  }

  const container = document.getElementById('messagesList');
  container.innerHTML = '';

  if (!messages?.length) {
    container.innerHTML = '<div style="opacity:0.6;text-align:center;padding:20px">Aucun message.</div>';
    return;
  }

  messages.forEach(msg => {
    const item = document.createElement('div');
    item.className = 'message-item';

    const header = document.createElement('div');
    header.className = 'message-header';
    header.innerHTML = `<strong>${msg.prenom}</strong><span>${new Date(msg.created_at).toLocaleString('fr-FR')}</span>`;

    const text = document.createElement('div');
    text.className = 'message-text';
    text.textContent = msg.message;

    item.append(header, text);
    container.appendChild(item);
  });
}

// ‚îÄ‚îÄ Effacer tous les messages ‚îÄ‚îÄ
// FIX : on r√©cup√®re d'abord les IDs (UUID) puis on supprime un par un
async function clearAllMessages() {
  if (!confirm('Effacer TOUS les messages ? Irr√©versible.')) return;

  // R√©cup√©rer tous les IDs
  const { data: rows, error: fetchErr } = await supabase
    .from('messages').select('id');

  if (fetchErr) {
    alert('Erreur : ' + fetchErr.message);
    return;
  }

  if (!rows || rows.length === 0) {
    alert('Aucun message √† supprimer.');
    return;
  }

  // Supprimer par liste d'UUIDs
  const ids = rows.map(r => r.id);
  const { error } = await supabase.from('messages').delete().in('id', ids);

  if (error) {
    alert('Erreur suppression : ' + error.message);
    return;
  }

  await loadMessages();
  await loadStats();
  alert('‚úÖ Tous les messages ont √©t√© supprim√©s');
}

document.getElementById('clearMessagesBtn').addEventListener('click', clearAllMessages);

// Init
loadStats();
loadUsers();
loadMessages();
setInterval(() => { loadStats(); loadUsers(); loadMessages(); }, 10000);
</script>

</body>
</html>

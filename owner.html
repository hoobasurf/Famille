<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BubbleChat - Admin</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 40px 20px;
  color: white;
}
.container { max-width: 1200px; margin: 0 auto; }
h1 { text-align: center; font-size: 42px; font-weight: 300; letter-spacing: 2px; margin-bottom: 40px; text-shadow: 2px 2px 10px rgba(0,0,0,0.3); }
.admin-card { background: rgba(255,255,255,0.15); backdrop-filter: blur(20px); border-radius: 25px; padding: 40px; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
h2 { font-size: 28px; font-weight: 300; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
.stat-box { background: rgba(255,255,255,0.1); padding: 25px; border-radius: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.2); }
.stat-number { font-size: 48px; font-weight: 700; margin-bottom: 10px; }
.stat-label { font-size: 14px; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }
.users-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
.users-table th { background: rgba(255,255,255,0.1); padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid rgba(255,255,255,0.2); }
.users-table td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); vertical-align: middle; }
.users-table tr:hover { background: rgba(255,255,255,0.05); }
.user-photo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.4); }
.status-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
.status-online  { background: rgba(74,222,128,0.3); border: 1px solid rgba(74,222,128,0.6); }
.status-offline { background: rgba(239,68,68,0.3);  border: 1px solid rgba(239,68,68,0.6); }
.btn { padding: 12px 25px; border: none; border-radius: 15px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); backdrop-filter: blur(10px); margin: 5px; }
.btn:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
.btn-danger { background: rgba(239,68,68,0.3); border-color: rgba(239,68,68,0.6); }
.btn-danger:hover { background: rgba(239,68,68,0.5); }
.btn-small { padding: 7px 14px; font-size: 13px; margin: 2px; border-radius: 10px; }
.actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 30px; }
.messages-list { max-height: 400px; overflow-y: auto; margin-top: 20px; }
.message-item { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.2); }
.message-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; opacity: 0.8; }
.message-text { font-size: 15px; line-height: 1.5; }
.back-btn { position: fixed; top: 20px; left: 20px; padding: 10px 20px; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); border-radius: 20px; color: white; cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s ease; z-index: 1000; font-weight: 600; }
.back-btn:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }

/* â”€â”€ Styles conversations privÃ©es â”€â”€ */
.conv-list { margin-top: 20px; }
.conv-item { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); border-radius: 18px; margin-bottom: 14px; overflow: hidden; }
.conv-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 20px; cursor: pointer; transition: background 0.2s; }
.conv-header:hover { background: rgba(255,255,255,0.08); }
.conv-title { font-weight: 600; font-size: 16px; }
.conv-meta { font-size: 13px; opacity: 0.7; }
.conv-actions { display: flex; gap: 8px; align-items: center; }
.conv-toggle { font-size: 18px; transition: transform 0.3s; }
.conv-toggle.open { transform: rotate(180deg); }
.conv-messages { display: none; padding: 0 20px 16px; max-height: 350px; overflow-y: auto; }
.conv-messages.open { display: block; }
.pm-item { background: rgba(255,255,255,0.07); padding: 10px 14px; border-radius: 12px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.12); display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
.pm-body { flex: 1; }
.pm-from { font-size: 12px; opacity: 0.7; margin-bottom: 3px; }
.pm-text { font-size: 14px; line-height: 1.4; }
.pm-time { font-size: 12px; opacity: 0.6; white-space: nowrap; margin-top: 3px; }
.pm-delete { background: rgba(239,68,68,0.3); border: 1px solid rgba(239,68,68,0.5); color: white; border-radius: 8px; padding: 4px 10px; font-size: 12px; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
.pm-delete:hover { background: rgba(239,68,68,0.6); transform: scale(1.05); }
.empty-msg { opacity: 0.55; text-align: center; padding: 15px; font-size: 14px; }
.loading-msg { opacity: 0.7; text-align: center; padding: 15px; }
</style>

</head>
<body>

<button class="back-btn" onclick="window.location.href='chat.html'">â† Retour au chat</button>

<div class="container">
  <h1>ğŸ¨ Espace CrÃ©ation - Admin</h1>

  <!-- Stats -->

  <div class="admin-card">
    <h2>ğŸ“Š Statistiques</h2>
    <div class="stats-grid">
      <div class="stat-box"><div class="stat-number" id="totalUsers">0</div><div class="stat-label">Utilisateurs</div></div>
      <div class="stat-box"><div class="stat-number" id="onlineUsers">0</div><div class="stat-label">En ligne</div></div>
      <div class="stat-box"><div class="stat-number" id="totalMessages">0</div><div class="stat-label">Messages</div></div>
      <div class="stat-box"><div class="stat-number" id="totalPrivate">0</div><div class="stat-label">Messages privÃ©s</div></div>
    </div>
  </div>

  <!-- Utilisateurs -->

  <div class="admin-card">
    <h2>ğŸ‘¥ Gestion des utilisateurs</h2>
    <table class="users-table">
      <thead><tr><th>Photo</th><th>PrÃ©nom</th><th>Statut</th><th>Inscrit le</th><th>Actions</th></tr></thead>
      <tbody id="usersTableBody"></tbody>
    </table>
  </div>

  <!-- Messages rÃ©cents -->

  <div class="admin-card">
    <h2>ğŸ’¬ Messages rÃ©cents (chat gÃ©nÃ©ral)</h2>
    <div class="messages-list" id="messagesList"></div>
  </div>

  <!-- Conversations privÃ©es -->

  <div class="admin-card">
    <h2>ğŸ”’ Conversations privÃ©es</h2>
    <div id="convList" class="conv-list">
      <div class="loading-msg">Chargement des conversationsâ€¦</div>
    </div>
  </div>

  <!-- Actions -->

  <div class="admin-card">
    <h2>âš™ï¸ Actions</h2>
    <div class="actions">
      <button class="btn" onclick="location.reload()">ğŸ”„ Actualiser</button>
      <button class="btn btn-danger" id="clearMessagesBtn">ğŸ—‘ï¸ Effacer tous les messages publics</button>
      <button class="btn btn-danger" id="clearAllPrivateBtn">ğŸ” Effacer tous les messages privÃ©s</button>
      <button class="btn" onclick="window.location.href='chat.html'">ğŸ’¬ Aller au chat</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabase = createClient(
  'https://eeikriwrwuynwpzodbbt.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlaWtyaXdyd3V5bndwem9kYmJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NzQ3NjYsImV4cCI6MjA4NjE1MDc2Nn0.MJ6CSmrttEWcrdfy5C7nP4sE_pe19sGNE-WasASPDNc'
);

if (localStorage.getItem('prenom') !== 'Steph') {
  window.location.href = 'chat.html';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Stats
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadStats() {
  const [{ data: users }, { data: online }, { data: messages }, { data: privates }] = await Promise.all([
    supabase.from('profiles').select('id'),
    supabase.from('profiles').select('id').eq('is_online', true),
    supabase.from('messages').select('id'),
    supabase.from('private_messages').select('id'),
  ]);
  document.getElementById('totalUsers').textContent    = users?.length    || 0;
  document.getElementById('onlineUsers').textContent   = online?.length   || 0;
  document.getElementById('totalMessages').textContent = messages?.length || 0;
  document.getElementById('totalPrivate').textContent  = privates?.length || 0;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Utilisateurs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadUsers() {
  const { data: users, error } = await supabase
    .from('profiles')
    .select('id, unique_id, prenom, photo_url, is_online, created_at')
    .order('created_at', { ascending: false });

  if (error) {
    document.getElementById('usersTableBody').innerHTML =
      `<tr><td colspan="5" style="color:#fca5a5;padding:20px;text-align:center">${error.message}</td></tr>`;
    return;
  }

  const tbody = document.getElementById('usersTableBody');
  tbody.innerHTML = '';

  (users || []).forEach(user => {
    const row = document.createElement('tr');

    const tdPhoto = document.createElement('td');
    if (user.photo_url) {
      const img = document.createElement('img');
      img.className = 'user-photo';
      img.src = user.photo_url;
      img.alt = user.prenom || '';
      img.onerror = () => img.style.display = 'none';
      tdPhoto.appendChild(img);
    }

    const tdPrenom = document.createElement('td');
    const strong = document.createElement('strong');
    strong.textContent = user.prenom || '(inconnu)';
    tdPrenom.appendChild(strong);

    const tdStatus = document.createElement('td');
    const badge = document.createElement('span');
    badge.className = 'status-badge ' + (user.is_online ? 'status-online' : 'status-offline');
    badge.textContent = user.is_online ? 'En ligne' : 'Hors ligne';
    tdStatus.appendChild(badge);

    const tdDate = document.createElement('td');
    tdDate.textContent = user.created_at ? new Date(user.created_at).toLocaleDateString('fr-FR') : 'â€”';

    const tdActions = document.createElement('td');
    const btn = document.createElement('button');
    btn.className = 'btn btn-danger';
    btn.textContent = 'Supprimer';
    btn.addEventListener('click', () => deleteUser(user));
    tdActions.appendChild(btn);

    row.append(tdPhoto, tdPrenom, tdStatus, tdDate, tdActions);
    tbody.appendChild(row);
  });
}

async function deleteUser(user) {
  const prenom = user.prenom || '?';
  if (!confirm(`Supprimer "${prenom}" et tous ses messages ?`)) return;

  await supabase.from('messages').delete().eq('prenom', prenom);
  if (user.unique_id) {
    await supabase.from('private_messages').delete().eq('sender_unique_id',   user.unique_id);
    await supabase.from('private_messages').delete().eq('receiver_unique_id', user.unique_id);
  }
  const { error } = await supabase.from('profiles').delete().eq('id', user.id);
  if (error) { alert('âŒ Erreur suppression profil : ' + error.message); return; }

  await Promise.all([loadUsers(), loadStats(), loadMessages(), loadPrivateConversations()]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Messages publics
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadMessages() {
  const { data: messages, error } = await supabase
    .from('messages')
    .select('id, prenom, message, created_at')
    .order('created_at', { ascending: false })
    .limit(20);

  const container = document.getElementById('messagesList');
  if (error) { container.innerHTML = `<div style="color:#fca5a5;padding:20px;text-align:center">${error.message}</div>`; return; }
  container.innerHTML = '';

  if (!messages?.length) {
    container.innerHTML = '<div class="empty-msg">Aucun message.</div>';
    return;
  }

  messages.forEach(msg => {
    const item = document.createElement('div');
    item.className = 'message-item';
    const header = document.createElement('div');
    header.className = 'message-header';
    const s = document.createElement('strong');
    s.textContent = msg.prenom || '?';
    const t = document.createElement('span');
    t.textContent = msg.created_at ? new Date(msg.created_at).toLocaleString('fr-FR') : '';
    header.append(s, t);
    const text = document.createElement('div');
    text.className = 'message-text';
    text.textContent = msg.message || '';
    item.append(header, text);
    container.appendChild(item);
  });
}

async function clearAllMessages() {
  if (!confirm('Effacer TOUS les messages du chat gÃ©nÃ©ral ? IrrÃ©versible.')) return;
  const { error } = await supabase.from('messages').delete().not('created_at', 'is', null);
  if (error) { alert('âŒ Erreur : ' + error.message); return; }
  await Promise.all([loadMessages(), loadStats()]);
  alert('âœ… Tous les messages publics ont Ã©tÃ© supprimÃ©s');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Conversations privÃ©es
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadPrivateConversations() {
  const container = document.getElementById('convList');
  container.innerHTML = '<div class="loading-msg">Chargementâ€¦</div>';

  // RÃ©cupÃ©rer tous les messages privÃ©s
  const { data: allPM, error } = await supabase
    .from('private_messages')
    .select('id, sender_unique_id, receiver_unique_id, message, created_at, sender_prenom, receiver_prenom')
    .order('created_at', { ascending: false });

  if (error) {
    container.innerHTML = `<div style="color:#fca5a5;padding:20px;text-align:center">${error.message}</div>`;
    return;
  }

  if (!allPM?.length) {
    container.innerHTML = '<div class="empty-msg">Aucun message privÃ©.</div>';
    return;
  }

  // Regrouper par paire (clÃ© = sorted unique_ids pour Ã©viter les doublons Aâ†”B)
  const convsMap = new Map();
  allPM.forEach(msg => {
    const ids   = [msg.sender_unique_id, msg.receiver_unique_id].sort();
    const key   = ids.join('__');
    const names = [
      msg.sender_prenom   || msg.sender_unique_id   || '?',
      msg.receiver_prenom || msg.receiver_unique_id || '?'
    ];
    // Toujours dans le mÃªme ordre que les ids triÃ©s
    const sortedNames = msg.sender_unique_id <= msg.receiver_unique_id
      ? [msg.sender_prenom || '?', msg.receiver_prenom || '?']
      : [msg.receiver_prenom || '?', msg.sender_prenom || '?'];

    if (!convsMap.has(key)) {
      convsMap.set(key, {
        key,
        id1: ids[0], id2: ids[1],
        name1: sortedNames[0], name2: sortedNames[1],
        messages: []
      });
    }
    convsMap.get(key).messages.push(msg);
  });

  container.innerHTML = '';

  convsMap.forEach(conv => {
    // Trier les messages par date dÃ©croissante
    conv.messages.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

    const item = document.createElement('div');
    item.className = 'conv-item';

    // â”€â”€ En-tÃªte cliquable â”€â”€
    const header = document.createElement('div');
    header.className = 'conv-header';

    const titleWrap = document.createElement('div');
    const title = document.createElement('div');
    title.className = 'conv-title';
    title.textContent = `ğŸ’¬ ${conv.name1} â†” ${conv.name2}`;
    const meta = document.createElement('div');
    meta.className = 'conv-meta';
    meta.textContent = `${conv.messages.length} message${conv.messages.length > 1 ? 's' : ''}`;
    titleWrap.append(title, meta);

    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'conv-actions';

    // Bouton supprimer toute la conversation
    const delConvBtn = document.createElement('button');
    delConvBtn.className = 'btn btn-danger btn-small';
    delConvBtn.textContent = 'ğŸ—‘ï¸ Supprimer la conversation';
    delConvBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      if (!confirm(`Supprimer toute la conversation entre ${conv.name1} et ${conv.name2} ?`)) return;
      const ids = conv.messages.map(m => m.id);
      const { error } = await supabase.from('private_messages').delete().in('id', ids);
      if (error) { alert('âŒ ' + error.message); return; }
      item.remove();
      await Promise.all([loadStats()]);
      // Recalcule le compteur total
      const remaining = document.querySelectorAll('.conv-item').length;
      if (remaining === 0) container.innerHTML = '<div class="empty-msg">Aucun message privÃ©.</div>';
    });

    const toggle = document.createElement('span');
    toggle.className = 'conv-toggle';
    toggle.textContent = 'â–¼';

    actionsDiv.append(delConvBtn, toggle);
    header.append(titleWrap, actionsDiv);

    // â”€â”€ Liste des messages â”€â”€
    const msgContainer = document.createElement('div');
    msgContainer.className = 'conv-messages';

    conv.messages.forEach(msg => {
      const pmItem = document.createElement('div');
      pmItem.className = 'pm-item';
      pmItem.dataset.id = msg.id;

      const body = document.createElement('div');
      body.className = 'pm-body';

      const from = document.createElement('div');
      from.className = 'pm-from';
      from.textContent = `De : ${msg.sender_prenom || msg.sender_unique_id || '?'} â†’ ${msg.receiver_prenom || msg.receiver_unique_id || '?'}`;

      const text = document.createElement('div');
      text.className = 'pm-text';
      text.textContent = msg.message || '';

      const time = document.createElement('div');
      time.className = 'pm-time';
      time.textContent = msg.created_at ? new Date(msg.created_at).toLocaleString('fr-FR') : '';

      body.append(from, text, time);

      // Bouton supprimer message individuel
      const delBtn = document.createElement('button');
      delBtn.className = 'pm-delete';
      delBtn.textContent = 'âœ•';
      delBtn.title = 'Supprimer ce message';
      delBtn.addEventListener('click', async () => {
        if (!confirm('Supprimer ce message privÃ© ?')) return;
        const { error } = await supabase.from('private_messages').delete().eq('id', msg.id);
        if (error) { alert('âŒ ' + error.message); return; }
        pmItem.remove();
        // Mise Ã  jour compteur
        const remaining = msgContainer.querySelectorAll('.pm-item').length;
        meta.textContent = `${remaining} message${remaining > 1 ? 's' : ''}`;
        if (remaining === 0) {
          item.remove();
          if (document.querySelectorAll('.conv-item').length === 0)
            container.innerHTML = '<div class="empty-msg">Aucun message privÃ©.</div>';
        }
        await loadStats();
      });

      pmItem.append(body, delBtn);
      msgContainer.appendChild(pmItem);
    });

    // Toggle ouverture
    header.addEventListener('click', (e) => {
      if (e.target === delConvBtn || delConvBtn.contains(e.target)) return;
      const isOpen = msgContainer.classList.toggle('open');
      toggle.classList.toggle('open', isOpen);
    });

    item.append(header, msgContainer);
    container.appendChild(item);
  });
}

// â”€â”€ Effacer tous les messages privÃ©s â”€â”€
async function clearAllPrivate() {
  if (!confirm('Effacer TOUS les messages privÃ©s ? IrrÃ©versible.')) return;
  const { error } = await supabase.from('private_messages').delete().not('created_at', 'is', null);
  if (error) { alert('âŒ Erreur : ' + error.message); return; }
  await Promise.all([loadPrivateConversations(), loadStats()]);
  alert('âœ… Tous les messages privÃ©s ont Ã©tÃ© supprimÃ©s');
}

// â”€â”€ Listeners â”€â”€
document.getElementById('clearMessagesBtn').addEventListener('click', clearAllMessages);
document.getElementById('clearAllPrivateBtn').addEventListener('click', clearAllPrivate);

// â”€â”€ Init â”€â”€
loadStats();
loadUsers();
loadMessages();
loadPrivateConversations();
setInterval(() => { loadStats(); }, 15000);
</script>

</body>
</html>

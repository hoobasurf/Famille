<!DOCTYPE html>

<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BubbleChat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; min-height: 100vh; position: relative; overflow-x: hidden; transition: background 0.8s ease; }
        body.theme-zen { background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 50%, #80deea 100%); }
        body.theme-plage { background: linear-gradient(135deg, #ffd89b 0%, #f4a460 50%, #19547b 100%); }
        body.theme-foret { background: linear-gradient(135deg, #134e5e 0%, #3a7e6f 50%, #71b280 100%); }
        body.theme-futuriste { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        body.theme-bonbon { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ff9a9e 100%); }
        body.theme-bar { background: linear-gradient(135deg, #2c003e 0%, #4b0082 50%, #8b008b 100%); }
        body.theme-chasse { background: linear-gradient(135deg, #3e2723 0%, #5d4037 50%, #795548 100%); }
        body.theme-aquarium { background: linear-gradient(135deg, #00416a 0%, #1976d2 33%, #4caf50 66%, #ffe000 100%); }
        body.custom-bg { background-size: cover !important; background-position: center !important; background-attachment: fixed !important; }
        .particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .particle { position: absolute; width: 3px; height: 3px; background: rgba(255, 255, 255, 0.5); border-radius: 50%; animation: float 20s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateY(0) translateX(0); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-100vh) translateX(50px); opacity: 0; } }
        .chat-container { position: relative; max-width: 1200px; margin: 0 auto; padding: 20px; min-height: 100vh; z-index: 1; }
        .chat-header { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(30px); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.2); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .theme-selector { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .theme-label { color: white; font-weight: 600; text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); }
        .theme-options { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        .theme-btn { width: 45px; height: 45px; border-radius: 50%; border: 3px solid rgba(255, 255, 255, 0.5); cursor: pointer; transition: all 0.3s ease; }
        .theme-btn:hover { transform: scale(1.15); border-color: white; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3); }
        .theme-btn.active { border-color: white; box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.3); }
        .theme-btn-custom { width: 45px; height: 45px; border-radius: 50%; border: 3px solid rgba(255, 255, 255, 0.5); background: linear-gradient(135deg, #ffffff 0%, #cccccc 100%); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all 0.3s ease; position: relative; }
        .theme-btn-custom:hover { transform: scale(1.15); border-color: white; }
        .theme-btn-custom input[type="file"] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .user-profile-photo { width: 45px; height: 45px; border-radius: 50%; border: 3px solid rgba(255, 255, 255, 0.6); overflow: hidden; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #ff6b9d 0%, #c06fff 100%); font-size: 20px; color: white; box-shadow: 0 4px 15px rgba(255, 107, 157, 0.4); transition: all 0.3s ease; cursor: pointer; }
        .user-profile-photo:hover { transform: scale(1.15); box-shadow: 0 6px 25px rgba(255, 107, 157, 0.6); border-color: white; }
        .user-profile-photo img { width: 100%; height: 100%; object-fit: cover; }
        .messages-area { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(30px); border-radius: 20px; padding: 20px; height: 500px; overflow-y: auto; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.2); }
        .message { background: rgba(255, 255, 255, 0.08); padding: 12px 18px; border-radius: 15px; margin-bottom: 12px; color: white; animation: slideIn 0.3s ease; display: flex; gap: 12px; align-items: flex-start; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-avatar { width: 40px; height: 40px; border-radius: 50%; overflow: hidden; flex-shrink: 0; background: linear-gradient(135deg, #ff6b9d 0%, #c06fff 100%); display: flex; align-items: center; justify-content: center; font-size: 18px; border: 2px solid rgba(255, 255, 255, 0.3); }
        .message-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .message-content { flex: 1; }
        .message-author { font-weight: bold; margin-bottom: 5px; font-size: 14px; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3); }
        .message-text { font-size: 16px; }
        .message-time { font-size: 11px; opacity: 0.7; text-align: right; margin-top: 5px; }
        .input-area { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(30px); border-radius: 20px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.2); display: flex; gap: 10px; }
        .message-input { flex: 1; padding: 15px 20px; background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 15px; color: white; font-size: 16px; transition: all 0.3s ease; }
        .message-input:focus { outline: none; background: rgba(255, 255, 255, 0.3); border-color: rgba(255, 255, 255, 0.5); }
        .message-input::placeholder { color: rgba(255, 255, 255, 0.6); }
        .send-btn { padding: 15px 35px; background: linear-gradient(135deg, #ff6b9d 0%, #c06fff 100%); border: none; border-radius: 15px; color: white; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 20px rgba(192, 111, 255, 0.4); }
        .send-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 30px rgba(192, 111, 255, 0.6); }
        #profileSidebar { position: fixed; top: 0; left: -300px; width: 300px; height: 100vh; background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(20px); border-right: 1px solid rgba(255, 255, 255, 0.15); padding: 20px 10px; transition: left 0.3s ease; z-index: 999; overflow-y: auto; }
        #profileSidebar.open { left: 0; }
        #toggleProfileSidebar { position: fixed; top: 20px; left: 20px; width: 50px; height: 50px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(8px); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 15px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1000; font-size: 24px; transition: all 0.3s ease; color: white; }
        #toggleProfileSidebar:hover { background: rgba(255, 255, 255, 0.2); transform: scale(1.05); }
        .sidebar-header { color: white; font-weight: 600; font-size: 20px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid rgba(255, 255, 255, 0.2); text-align: center; }
        .profile-count { font-size: 14px; opacity: 0.8; font-weight: 400; }
        .profile-list { display: flex; flex-direction: column; gap: 12px; margin-top: 15px; }
        .profile-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 15px; transition: all 0.3s ease; cursor: pointer; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); }
        .profile-item:hover { background: rgba(255, 255, 255, 0.15); transform: translateX(5px); }
        .profile-photo { width: 50px; height: 50px; border-radius: 50%; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.4); overflow: hidden; flex-shrink: 0; position: relative; display: flex; align-items: center; justify-content: center; font-size: 22px; }
        .profile-photo img { width: 100%; height: 100%; object-fit: cover; }
        .status-dot { position: absolute; bottom: 0; right: 0; width: 14px; height: 14px; border-radius: 50%; border: 2px solid rgba(0, 0, 0, 0.4); }
        .status-dot.online { background: #4caf50; box-shadow: 0 0 10px #4caf50; animation: pulse-online 2s infinite; }
        .status-dot.offline { background: #f44336; }
        @keyframes pulse-online { 0%, 100% { box-shadow: 0 0 10px #4caf50; } 50% { box-shadow: 0 0 20px #4caf50; } }
        .profile-info { flex: 1; }
        .profile-name { color: white; font-weight: 600; font-size: 16px; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4); }
        .profile-status-text { color: rgba(255, 255, 255, 0.7); font-size: 12px; margin-top: 2px; }
        #profileSidebar::-webkit-scrollbar, .messages-area::-webkit-scrollbar { width: 6px; }
        #profileSidebar::-webkit-scrollbar-track, .messages-area::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 10px; }
        #profileSidebar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        .messages-area::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #ff6b9d 0%, #c06fff 100%); border-radius: 10px; }
        @media (max-width: 768px) { .chat-header { flex-direction: column; align-items: flex-start; } .theme-selector { width: 100%; } #profileSidebar { width: 280px; left: -280px; } }
    </style>
</head>
<body class="theme-futuriste">
    <div id="toggleProfileSidebar">ðŸ‘¥</div>
    <div id="profileSidebar">
        <div class="sidebar-header">ðŸ’¬ Utilisateurs<div class="profile-count" id="profileCount">Chargement...</div></div>
        <div class="profile-list" id="profileList"></div>
    </div>
    <div class="particles" id="particles"></div>
    <div class="chat-container">
        <div class="chat-header">
            <div class="theme-selector">
                <span class="theme-label">ThÃ¨me :</span>
                <div class="theme-options">
                    <div class="theme-btn" data-theme="zen" style="background: linear-gradient(135deg, #e0f7fa 0%, #80deea 100%);" title="Zen"></div>
                    <div class="theme-btn" data-theme="plage" style="background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);" title="Plage"></div>
                    <div class="theme-btn" data-theme="foret" style="background: linear-gradient(135deg, #134e5e 0%, #71b280 100%);" title="ForÃªt"></div>
                    <div class="theme-btn active" data-theme="futuriste" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" title="Futuriste"></div>
                    <div class="theme-btn" data-theme="bonbon" style="background: linear-gradient(135deg, #ffecd2 0%, #ff9a9e 100%);" title="Bonbon"></div>
                    <div class="theme-btn" data-theme="bar" style="background: linear-gradient(135deg, #2c003e 0%, #8b008b 100%);" title="Bar"></div>
                    <div class="theme-btn" data-theme="chasse" style="background: linear-gradient(135deg, #3e2723 0%, #795548 100%);" title="Chasse"></div>
                    <div class="theme-btn" data-theme="aquarium" style="background: linear-gradient(135deg, #00416a 0%, #ffe000 100%);" title="Aquarium"></div>
                    <div class="theme-btn-custom" title="Photo personnalisÃ©e">ðŸ“·<input type="file" id="customBgInput" accept="image/*"></div>
                    <div class="user-profile-photo" id="userProfilePhoto" title="Mon profil">ðŸ’¬</div>
                </div>
            </div>
        </div>
        <div class="messages-area" id="messagesArea"></div>
        <div class="input-area">
            <input type="text" class="message-input" id="messageInput" placeholder="Tapez votre message...">
            <button class="send-btn" id="sendBtn">Envoyer ðŸš€</button>
        </div>
    </div>

```
<script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = window.supabase.createClient(
  'https://eeikriwrwuynwpzodbbt.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlaWtyaXdyd3V5bndwem9kYmJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NzQ3NjYsImV4cCI6MjA4NjE1MDc2Nn0.MJ6CSmrttEWcrdfy5C7nP4sE_pe19sGNE-WasASPDNc'
);

    let currentUserPhoto = null;
    let currentUserPrenom = localStorage.getItem('prenom') || 'InvitÃ©';
    const savedPhotoUrl = localStorage.getItem('userPhotoUrl') || localStorage.getItem('tempPhotoPreview');
    
    function displayUserPhoto() {
        const userPhotoElement = document.getElementById('userProfilePhoto');
        if (savedPhotoUrl) {
            userPhotoElement.innerHTML = `<img src="${savedPhotoUrl}" alt="Profil">`;
            currentUserPhoto = savedPhotoUrl;
        } else {
            userPhotoElement.textContent = 'ðŸ’¬';
        }
    }
    displayUserPhoto();

    // METTRE Ã€ JOUR LE STATUT EN LIGNE
    async function setOnlineStatus(isOnline) {
        try {
            await supabase
                .from('profiles')
                .update({ is_online: isOnline })
                .eq('prenom', currentUserPrenom);
        } catch (err) {
            // Erreur silencieuse
        }
    }

    // Se mettre en ligne au chargement
    setOnlineStatus(true);

    // Se mettre hors ligne Ã  la fermeture
    window.addEventListener('beforeunload', () => {
        setOnlineStatus(false);
    });

    let profiles = [];

    async function loadProfiles() {
        try {
            const { data, error } = await supabase
                .from('profiles')
                .select('prenom, photo_url, is_online');
            
            if (error) {
                document.getElementById('profileCount').textContent = 'Erreur DB';
                return;
            }
            
            profiles = (data || []).map(p => ({
                prenom: p.prenom || '',
                photo_url: p.photo_url || null,
                is_online: p.is_online || false
            }));
            
            renderProfiles();
        } catch (err) {
            document.getElementById('profileCount').textContent = 'Erreur rÃ©seau';
        }
    }

    function renderProfiles() {
        const container = document.getElementById('profileList');
        const countElement = document.getElementById('profileCount');
        
        container.innerHTML = '';
        
        if (profiles.length === 0) {
            container.innerHTML = '<div style="color: rgba(255,255,255,0.6); text-align: center; padding: 20px;">Aucun utilisateur</div>';
            countElement.textContent = '0 utilisateur';
            return;
        }
        
        const onlineCount = profiles.filter(p => p.is_online).length;
        countElement.textContent = `${profiles.length} utilisateur${profiles.length > 1 ? 's' : ''} (${onlineCount} en ligne)`;
        
        profiles.forEach(profile => {
            const item = document.createElement('div');
            item.className = 'profile-item';
            
            const photoDiv = document.createElement('div');
            photoDiv.className = 'profile-photo';
            
            if (profile.photo_url) {
                const img = document.createElement('img');
                img.src = profile.photo_url;
                img.alt = profile.prenom;
                photoDiv.appendChild(img);
            } else {
                photoDiv.textContent = profile.prenom ? profile.prenom[0].toUpperCase() : 'ðŸ‘¤';
            }
            
            const statusDot = document.createElement('div');
            statusDot.className = 'status-dot ' + (profile.is_online ? 'online' : 'offline');
            photoDiv.appendChild(statusDot);
            
            const infoDiv = document.createElement('div');
            infoDiv.className = 'profile-info';
            
            const nameSpan = document.createElement('div');
            nameSpan.className = 'profile-name';
            nameSpan.textContent = profile.prenom || 'Anonyme';
            
            const statusText = document.createElement('div');
            statusText.className = 'profile-status-text';
            statusText.textContent = profile.is_online ? 'En ligne' : 'Hors ligne';
            
            infoDiv.appendChild(nameSpan);
            infoDiv.appendChild(statusText);
            
            item.appendChild(photoDiv);
            item.appendChild(infoDiv);
            container.appendChild(item);
        });
    }

    setInterval(loadProfiles, 5000);
    loadProfiles();

    document.getElementById('toggleProfileSidebar').addEventListener('click', () => {
        document.getElementById('profileSidebar').classList.toggle('open');
    });

    function createParticles() {
        const container = document.getElementById('particles');
        for (let i = 0; i < 40; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 20 + 's';
            particle.style.animationDuration = (Math.random() * 15 + 15) + 's';
            container.appendChild(particle);
        }
    }

    document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.body.className = '';
            document.body.style.backgroundImage = '';
            document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.body.classList.add('theme-' + btn.dataset.theme);
        });
    });

    document.getElementById('customBgInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                document.body.className = 'custom-bg';
                document.body.style.backgroundImage = 'url(' + event.target.result + ')';
                document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
            };
            reader.readAsDataURL(file);
        }
    });

    function addMessage(author, text) {
        const container = document.getElementById('messagesArea');
        const time = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        const msg = document.createElement('div');
        msg.className = 'message';
        
        let avatarHTML = '<div class="message-avatar">';
        if (author === currentUserPrenom && currentUserPhoto) {
            avatarHTML += `<img src="${currentUserPhoto}" alt="${author}">`;
        } else {
            const profile = profiles.find(p => p.prenom === author);
            if (profile && profile.photo_url) {
                avatarHTML += `<img src="${profile.photo_url}" alt="${author}">`;
            } else {
                avatarHTML += author[0].toUpperCase();
            }
        }
        avatarHTML += '</div>';
        
        msg.innerHTML = avatarHTML +
                      '<div class="message-content">' +
                      '<div class="message-author">' + author + '</div>' +
                      '<div class="message-text">' + text + '</div>' +
                      '<div class="message-time">' + time + '</div>' +
                      '</div>';
        container.appendChild(msg);
        container.scrollTop = container.scrollHeight;
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        if (input.value.trim()) {
            addMessage(currentUserPrenom, input.value.trim());
            input.value = '';
        }
    }

    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendMessage();
    });

    createParticles();
    addMessage('BubbleChat', `Bienvenue ${currentUserPrenom} ! ðŸŽ‰`);
</script>
```

</body>
</html>

<!DOCTYPE html>

<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BubbleChat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; min-height: 100vh; position: relative; overflow-x: hidden; transition: background 0.8s ease; }
        body.theme-zen      { background: linear-gradient(135deg,#e0f7fa,#b2ebf2,#80deea); }
        body.theme-plage    { background: linear-gradient(135deg,#ffd89b,#f4a460,#19547b); }
        body.theme-foret    { background: linear-gradient(135deg,#134e5e,#3a7e6f,#71b280); }
        body.theme-futuriste{ background: linear-gradient(135deg,#667eea,#764ba2); }
        body.theme-bonbon   { background: linear-gradient(135deg,#ffecd2,#fcb69f,#ff9a9e); }
        body.theme-bar      { background: linear-gradient(135deg,#2c003e,#4b0082,#8b008b); }
        body.theme-chasse   { background: linear-gradient(135deg,#3e2723,#5d4037,#795548); }
        body.theme-aquarium { background: linear-gradient(135deg,#00416a,#1976d2 33%,#4caf50 66%,#ffe000); }
        body.custom-bg      { background-size:cover!important; background-position:center!important; background-attachment:fixed!important; }

```
    .particles { position:fixed; inset:0; pointer-events:none; z-index:0; }
    .particle  { position:absolute; width:3px; height:3px; background:rgba(255,255,255,.5); border-radius:50%; animation:float 20s infinite ease-in-out; }
    @keyframes float { 0%,100%{transform:translateY(0) translateX(0);opacity:0} 10%{opacity:1} 90%{opacity:1} 100%{transform:translateY(-100vh) translateX(50px);opacity:0} }

    .app-wrapper { position:relative; z-index:1; max-width:1500px; margin:0 auto; padding:20px; min-height:100vh; display:flex; flex-direction:column; gap:20px; }

    .chat-header { background:rgba(255,255,255,.05); backdrop-filter:blur(10px); border-radius:20px; padding:14px 28px; border:1px solid rgba(255,255,255,.15); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; }
    .theme-selector { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .theme-label    { color:white; font-weight:600; text-shadow:0 2px 5px rgba(0,0,0,.3); }
    .theme-options  { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .theme-btn { width:45px; height:45px; border-radius:50%; border:3px solid rgba(255,255,255,.5); cursor:pointer; transition:all .3s; flex-shrink:0; }
    .theme-btn:hover  { transform:scale(1.15); border-color:white; }
    .theme-btn.active { border-color:white; box-shadow:0 0 0 4px rgba(255,255,255,.3); }

    .theme-btn-custom { width:45px; height:45px; border-radius:50%; border:3px solid rgba(255,255,255,.5); background:linear-gradient(135deg,#fff,#ccc); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:20px; transition:all .3s; position:relative; flex-shrink:0; }
    .theme-btn-custom:hover { transform:scale(1.15); border-color:white; }
    .theme-btn-custom input[type=file] { position:absolute; opacity:0; width:100%; height:100%; cursor:pointer; }

    .user-profile-photo { width:45px; height:45px; border-radius:50%; border:3px solid rgba(255,255,255,.6); overflow:hidden; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,#ff6b9d,#c06fff); font-size:20px; color:white; cursor:pointer; transition:all .3s; flex-shrink:0; vertical-align:middle; position:relative; top:0; }
    .user-profile-photo:hover { transform:scale(1.15); }
    .user-profile-photo img { width:100%; height:100%; object-fit:cover; }

    .toggle-sidebar-btn { position:fixed; top:50%; left:20px; transform:translateY(-50%); z-index:300; background:linear-gradient(135deg,#ff6b9d,#c06fff); border:none; border-radius:16px; padding:16px 20px; color:white; font-weight:700; cursor:pointer; transition:all .4s cubic-bezier(.34,1.56,.64,1); display:flex; flex-direction:column; align-items:center; gap:8px; animation:neonPulse 2s ease-in-out infinite; }
    @keyframes neonPulse { 0%,100%{ box-shadow:0 0 20px rgba(255,107,157,.6),0 0 40px rgba(192,111,255,.4),0 8px 25px rgba(0,0,0,.3); } 50%{ box-shadow:0 0 35px rgba(255,107,157,.9),0 0 65px rgba(192,111,255,.6),0 8px 25px rgba(0,0,0,.3); } }
    .toggle-sidebar-btn:hover { transform:translateY(-50%) scale(1.1); }
    .toggle-icon { font-size:28px; }
    .toggle-text { font-size:12px; text-transform:uppercase; letter-spacing:1px; }

    .body-columns { display:flex; gap:20px; flex:1; min-height:0; }

    .users-panel { width:340px; flex-shrink:0; background:rgba(255,255,255,.05); backdrop-filter:blur(10px); border-radius:20px; border:1px solid rgba(255,255,255,.15); padding:24px 16px; display:flex; flex-direction:column; gap:16px; overflow-y:auto; max-height:calc(100vh - 160px); transition:width .4s cubic-bezier(.4,0,.2,1), min-width .4s, opacity .4s, padding .4s, border .4s; }
    .users-panel.hidden { width:0; min-width:0; padding-left:0; padding-right:0; opacity:0; pointer-events:none; border:none; overflow:hidden; }

    .users-panel-header { color:white; font-weight:700; font-size:20px; text-align:center; padding-bottom:16px; border-bottom:2px solid rgba(255,255,255,.15); }
    .users-panel-count  { font-size:13px; opacity:.7; font-weight:400; margin-top:6px; }
    .user-list { display:flex; flex-direction:column; gap:12px; }

    .user-item { display:flex; align-items:center; gap:14px; padding:14px 16px; border-radius:18px; cursor:pointer; background:rgba(255,255,255,.08); border:2px solid rgba(255,255,255,.15); transition:all .3s; position:relative; }
    .user-item:hover  { border-color:rgba(255,107,157,.5); transform:translateX(8px); background:rgba(255,255,255,.15); }
    .user-item.active { border-color:rgba(255,107,157,.8); background:rgba(255,107,157,.2); box-shadow:0 6px 25px rgba(255,107,157,.4); transform:translateX(8px); }

    .user-avatar { width:52px; height:52px; border-radius:50%; background:linear-gradient(135deg,#ff6b9d,#c06fff); border:3px solid rgba(255,255,255,.4); overflow:hidden; flex-shrink:0; position:relative; display:flex; align-items:center; justify-content:center; font-size:22px; color:white; font-weight:700; }
    .user-avatar img { width:100%; height:100%; object-fit:cover; }
    .status-dot { position:absolute; bottom:2px; right:2px; width:14px; height:14px; border-radius:50%; border:3px solid rgba(255,255,255,.9); }
    .status-dot.online  { background:#4caf50; animation:pulse-online 2s infinite; }
    .status-dot.offline { background:#999; }
    @keyframes pulse-online { 0%,100%{box-shadow:0 0 12px #4caf50} 50%{box-shadow:0 0 22px #4caf50} }

    .user-info { flex:1; min-width:0; }
    .user-name { color:white; font-weight:700; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .user-status-txt { font-size:13px; margin-top:4px; font-weight:600; }
    .user-status-txt.online  { color:#4caf50; }
    .user-status-txt.offline { color:rgba(255,255,255,.5); }

    .notif-badge { position:absolute; top:10px; right:10px; background:linear-gradient(135deg,#ff6b9d,#ff3060); color:white; font-size:12px; font-weight:900; border-radius:14px; min-width:24px; height:24px; display:flex; align-items:center; justify-content:center; padding:0 8px; animation:badgePop .5s cubic-bezier(.34,1.56,.64,1); }
    @keyframes badgePop { from{transform:scale(0) rotate(-15deg)} to{transform:scale(1)} }

    .right-panel { flex:1; display:flex; flex-direction:column; min-width:0; background:rgba(255,255,255,.05); backdrop-filter:blur(10px); border-radius:20px; border:1px solid rgba(255,255,255,.15); overflow:hidden; transition:flex .4s; }

    .wizz-btn { padding:10px 20px; background:linear-gradient(135deg,#ffd700,#ff8c00); border:none; border-radius:12px; color:white; font-weight:700; cursor:pointer; transition:all .3s; font-size:14px; }
    .wizz-btn:hover { transform:translateY(-2px); }
    @keyframes wizz { 0%,100%{transform:translate(0,0)} 15%{transform:translate(-10px,-10px) rotate(-5deg)} 30%{transform:translate(10px,10px) rotate(5deg)} 45%{transform:translate(-8px,8px) rotate(-4deg)} 60%{transform:translate(8px,-8px) rotate(4deg)} 80%{transform:translate(-4px,4px) rotate(-2deg)} }
    .wizzing { animation:wizz .55s ease-in-out; }

    .chat-panel-header { background:rgba(255,255,255,.08); padding:20px 28px; border-bottom:2px solid rgba(255,255,255,.15); display:flex; align-items:center; gap:18px; }
    .chat-panel-header-avatar { width:50px; height:50px; border-radius:50%; border:3px solid rgba(255,107,157,.6); overflow:hidden; display:flex; align-items:center; justify-content:center; font-size:24px; color:white; background:linear-gradient(135deg,#ff6b9d,#c06fff); flex-shrink:0; }
    .chat-panel-header-avatar img { width:100%; height:100%; object-fit:cover; }
    .chat-panel-header-info { flex:1; }
    .chat-panel-header-name   { color:white; font-weight:700; font-size:19px; }
    .chat-panel-header-status { font-size:14px; margin-top:4px; font-weight:600; }
    .chat-panel-header-status.online  { color:#4caf50; }
    .chat-panel-header-status.offline { color:rgba(255,255,255,.6); }

    .messages-area { flex:1; padding:28px; overflow-y:auto; display:flex; flex-direction:column; gap:14px; }

    .message { background:rgba(255,255,255,.12); padding:16px 22px; border-radius:18px; color:white; animation:slideIn .4s ease; display:flex; gap:16px; align-items:flex-start; border:1px solid rgba(255,255,255,.1); }
    @keyframes slideIn { from{opacity:0;transform:translateY(15px)} to{opacity:1;transform:translateY(0)} }
    .message-avatar { width:46px; height:46px; border-radius:50%; overflow:hidden; flex-shrink:0; background:linear-gradient(135deg,#ff6b9d,#c06fff); display:flex; align-items:center; justify-content:center; font-size:20px; border:3px solid rgba(255,255,255,.4); color:white; font-weight:700; }
    .message-avatar img { width:100%; height:100%; object-fit:cover; }
    .message-content { flex:1; }
    .message-author { font-weight:700; margin-bottom:8px; font-size:15px; }
    .message-text   { font-size:15px; line-height:1.6; }
    .message-time   { font-size:12px; opacity:.7; text-align:right; margin-top:8px; }

    .pm-msg-wrap { display:flex; flex-direction:column; margin-bottom:10px; max-width:70%; }
    .pm-msg-wrap.sent     { align-self:flex-end;   align-items:flex-end; }
    .pm-msg-wrap.received { align-self:flex-start; align-items:flex-start; }
    .pm-msg { padding:14px 20px; border-radius:20px; font-size:15px; color:white; line-height:1.6; word-break:break-word; animation:msgPop .3s cubic-bezier(.34,1.56,.64,1); }
    @keyframes msgPop { from{opacity:0;transform:scale(.9)} to{opacity:1;transform:scale(1)} }
    .pm-msg.sent     { border-bottom-right-radius:5px; box-shadow:0 6px 25px rgba(192,111,255,.35); }
    .pm-msg.received { background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.15); border-bottom-left-radius:5px; }
    .pm-msg-meta { font-size:11px; opacity:.65; margin-top:6px; display:flex; align-items:center; gap:5px; }
    .pm-tick.read { color:#64b5f6; opacity:1!important; }
    .pm-empty { text-align:center; color:rgba(255,255,255,.5); font-size:15px; padding:80px 24px; line-height:2.2; }
    .pm-empty-icon { font-size:56px; display:block; margin-bottom:16px; }

    .input-area { background:rgba(255,255,255,.08); padding:20px 28px; border-top:2px solid rgba(255,255,255,.15); display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
    .message-input { flex:1; min-width:200px; padding:16px 22px; background:rgba(255,255,255,.15); border:2px solid rgba(255,255,255,.2); border-radius:18px; color:white; font-size:15px; transition:all .3s; }
    .message-input:focus { outline:none; background:rgba(255,255,255,.25); border-color:rgba(255,255,255,.4); }
    .message-input::placeholder { color:rgba(255,255,255,.6); }
    .send-btn { padding:16px 36px; background:linear-gradient(135deg,#ff6b9d,#c06fff); border:none; border-radius:18px; color:white; font-size:16px; font-weight:700; cursor:pointer; transition:all .3s; box-shadow:0 6px 25px rgba(192,111,255,.5); white-space:nowrap; }
    .send-btn:hover  { transform:translateY(-3px); }
    .send-btn:active { transform:scale(.97); }

    .bubble-color-row { display:flex; align-items:center; gap:12px; width:100%; margin-top:4px; flex-wrap:wrap; }
    .bubble-color-label { color:rgba(255,255,255,.75); font-size:14px; font-weight:600; white-space:nowrap; }
    .bubble-color-swatches { display:flex; gap:10px; flex-wrap:wrap; }
    .color-swatch { width:30px; height:30px; border-radius:50%; border:3px solid rgba(255,255,255,.4); cursor:pointer; transition:all .25s; }
    .color-swatch:hover  { transform:scale(1.25); border-color:white; }
    .color-swatch.active { border-color:white; box-shadow:0 0 0 4px rgba(255,255,255,.3); transform:scale(1.2); }
    .color-swatch-custom { width:30px; height:30px; border-radius:50%; border:3px solid rgba(255,255,255,.4); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:13px; background:rgba(255,255,255,.1); transition:all .25s; position:relative; overflow:hidden; }
    .color-swatch-custom:hover { transform:scale(1.25); border-color:white; }
    .color-swatch-custom input[type=color] { position:absolute; opacity:0; width:100%; height:100%; cursor:pointer; }

    .pm-toast { position:fixed; bottom:30px; right:30px; z-index:3000; background:rgba(10,3,24,.97); border:2px solid rgba(255,107,157,.6); border-radius:18px; padding:18px 24px; color:white; font-size:15px; box-shadow:0 15px 45px rgba(0,0,0,.7); cursor:pointer; max-width:300px; backdrop-filter:blur(25px); animation:toastIn .5s cubic-bezier(.34,1.56,.64,1); transition:opacity .4s; }
    @keyframes toastIn { from{opacity:0;transform:translateY(20px) scale(.9)} to{opacity:1;transform:scale(1)} }
    .pm-toast-name { font-weight:700; color:#ff6b9d; margin-bottom:6px; }
    .pm-toast-text { opacity:.8; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .users-panel::-webkit-scrollbar, .messages-area::-webkit-scrollbar { width:7px; }
    .users-panel::-webkit-scrollbar-track, .messages-area::-webkit-scrollbar-track { background:rgba(255,255,255,.05); border-radius:10px; }
    .users-panel::-webkit-scrollbar-thumb  { background:rgba(255,255,255,.2); border-radius:10px; }
    .messages-area::-webkit-scrollbar-thumb { background:linear-gradient(135deg,#ff6b9d,#c06fff); border-radius:10px; }

    @media (max-width:900px) {
        .users-panel { width:260px; }
        .toggle-sidebar-btn { left:10px; padding:12px 14px; }
        .toggle-text { display:none; }
    }
    @media (max-width:600px) {
        .app-wrapper { padding:10px; gap:10px; }
        .chat-header { padding:10px 14px; }
        .theme-label { display:none; }
        .theme-btn, .theme-btn-custom, .user-profile-photo { width:36px; height:36px; font-size:16px; }
        .toggle-sidebar-btn { left:6px; padding:10px 12px; border-radius:12px; }
        .toggle-icon { font-size:20px; }
        .chat-panel-header { padding:14px 16px; }
        .messages-area { padding:16px; }
        .input-area { padding:14px 16px; gap:10px; }
        .message-input { min-width:0; padding:12px 16px; font-size:14px; }
        .send-btn { padding:12px 20px; font-size:14px; }
        .pm-msg-wrap { max-width:90%; }
        .users-panel { position:fixed; top:0; left:0; height:100%; z-index:200; max-height:100vh; border-radius:0 20px 20px 0; width:280px; transform:translateX(0); transition:transform .4s cubic-bezier(.4,0,.2,1), opacity .4s; }
        .users-panel.hidden { transform:translateX(-100%); width:280px; opacity:0; pointer-events:none; }
    }
</style>
```

</head>
<body class="theme-futuriste">
<div class="particles" id="particles"></div>

<div class="app-wrapper">
    <div class="chat-header">
        <div class="theme-selector">
            <span class="theme-label">Th√®me :</span>
            <div class="theme-options">
                <div class="theme-btn" data-theme="zen"       style="background:linear-gradient(135deg,#e0f7fa,#80deea)"  title="Zen"></div>
                <div class="theme-btn" data-theme="plage"     style="background:linear-gradient(135deg,#ffd89b,#19547b)"  title="Plage"></div>
                <div class="theme-btn" data-theme="foret"     style="background:linear-gradient(135deg,#134e5e,#71b280)"  title="For√™t"></div>
                <div class="theme-btn active" data-theme="futuriste" style="background:linear-gradient(135deg,#667eea,#764ba2)" title="Futuriste"></div>
                <div class="theme-btn" data-theme="bonbon"    style="background:linear-gradient(135deg,#ffecd2,#ff9a9e)"  title="Bonbon"></div>
                <div class="theme-btn" data-theme="bar"       style="background:linear-gradient(135deg,#2c003e,#8b008b)"  title="Bar"></div>
                <div class="theme-btn" data-theme="chasse"    style="background:linear-gradient(135deg,#3e2723,#795548)"  title="Chasse"></div>
                <div class="theme-btn" data-theme="aquarium"  style="background:linear-gradient(135deg,#00416a,#ffe000)"  title="Aquarium"></div>
                <div class="theme-btn-custom" title="Photo personnalis√©e">üì∑<input type="file" id="customBgInput" accept="image/*"></div>
                <div class="user-profile-photo" id="userProfilePhoto" title="Mon profil">üí¨</div>
            </div>
        </div>
    </div>

```
<button class="toggle-sidebar-btn" id="toggleSidebar">
    <span class="toggle-icon" id="toggleIcon">üë•</span>
    <span class="toggle-text"  id="toggleText">Profils</span>
</button>

<div class="body-columns">
    <div class="users-panel" id="usersPanel">
        <div class="users-panel-header">
            üí¨ Conversations
            <div class="users-panel-count" id="profileCount">Chargement...</div>
        </div>
        <div class="user-list">
            <div class="user-item active" id="publicChatBtn">
                <div class="user-avatar">üåê</div>
                <div class="user-info">
                    <div class="user-name">Chat g√©n√©ral</div>
                    <div class="user-status-txt online">‚óè Public</div>
                </div>
            </div>
        </div>
        <div class="user-list" id="profileList"></div>
    </div>

    <div class="right-panel" id="rightPanel">
        <div class="chat-panel-header">
            <div class="chat-panel-header-avatar" id="chatHeaderAvatar">üåê</div>
            <div class="chat-panel-header-info">
                <div class="chat-panel-header-name"   id="chatHeaderName">Chat g√©n√©ral</div>
                <div class="chat-panel-header-status online" id="chatHeaderStatus">‚óè Public</div>
            </div>
            <button class="wizz-btn" id="wizzBtn" style="display:none;">‚ö° WIZZ!</button>
        </div>
        <div class="messages-area" id="messagesArea"></div>
        <div class="input-area">
            <input type="text" class="message-input" id="messageInput" placeholder="Tapez votre message...">
            <button class="send-btn" id="sendBtn">Envoyer üöÄ</button>
            <div class="bubble-color-row" id="bubbleColorPicker" style="display:none;">
                <span class="bubble-color-label">üé® Mes bulles :</span>
                <div class="bubble-color-swatches" id="colorSwatches"></div>
                <div class="color-swatch-custom" title="Couleur libre">‚úèÔ∏è<input type="color" id="customColorInput"></div>
            </div>
        </div>
    </div>
</div>
```

</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// ‚îÄ‚îÄ FIX Safari/iPhone : console.log au lieu de console.error pour √©viter DataCloneError ‚îÄ‚îÄ
function logErr(label, err) {
    try {
        const msg = (err && (err.message || err.details || err.hint)) ? (err.message || err.details || err.hint) : String(err);
        const code = (err && err.code) ? err.code : '';
        console.log('ERR ' + label + ' [' + code + '] ' + msg);
    } catch(e) {
        console.log('ERR ' + label + ' (d√©tail non disponible)');
    }
}

const supabase = createClient(
    'https://eeikriwrwuynwpzodbbt.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlaWtyaXdyd3V5bndwem9kYmJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NzQ3NjYsImV4cCI6MjA4NjE1MDc2Nn0.MJ6CSmrttEWcrdfy5C7nP4sE_pe19sGNE-WasASPDNc'
);

/* ‚ïê‚ïê FIX : g√©n√©rer un fingerprint si absent ‚ïê‚ïê */
function getOrCreateFingerprint() {
    let fp = localStorage.getItem('browserFingerprint');
    if (!fp) {
        // G√©n√©rer un ID al√©atoire unique
        fp = Math.random().toString(36).slice(2) + Date.now().toString(36);
        localStorage.setItem('browserFingerprint', fp);
    }
    return fp;
}

/* ‚ïê‚ïê UTILISATEUR COURANT ‚ïê‚ïê */
let currentUserPhoto    = null;
const currentUserPrenom = localStorage.getItem('prenom') || 'Invit√©';
const fingerprint       = getOrCreateFingerprint();
const currentUniqueId   = currentUserPrenom + '_' + fingerprint;
const savedPhotoUrl     = localStorage.getItem('userPhotoUrl') || localStorage.getItem('tempPhotoPreview');

console.log('BubbleChat ‚Äì ' + currentUserPrenom + ' | ID: ' + currentUniqueId);

(function initPhoto() {
    const el = document.getElementById('userProfilePhoto');
    if (savedPhotoUrl) { el.innerHTML = '<img src="' + savedPhotoUrl + '" alt="Profil">'; currentUserPhoto = savedPhotoUrl; }
    else el.textContent = 'üí¨';
})();

/* ‚ïê‚ïê TOGGLE SIDEBAR ‚ïê‚ïê */
let sidebarVisible = true;
const isMobile = function() { return window.innerWidth <= 600; };

document.getElementById('toggleSidebar').addEventListener('click', function() {
    sidebarVisible = !sidebarVisible;
    document.getElementById('usersPanel').classList.toggle('hidden', !sidebarVisible);
    document.getElementById('toggleIcon').textContent = sidebarVisible ? 'üë•' : 'üí¨';
    document.getElementById('toggleText').textContent  = sidebarVisible ? 'Profils' : 'Chat';
});

document.addEventListener('click', function(e) {
    if (isMobile() && sidebarVisible) {
        var panel     = document.getElementById('usersPanel');
        var toggle    = document.getElementById('toggleSidebar');
        var rightPane = document.getElementById('rightPanel');
        if (!panel.contains(e.target) && !toggle.contains(e.target) && !rightPane.contains(e.target)) {
            sidebarVisible = false;
            panel.classList.add('hidden');
            document.getElementById('toggleIcon').textContent = 'üí¨';
            document.getElementById('toggleText').textContent  = 'Chat';
        }
    }
});

/* ‚ïê‚ïê √âTAT GLOBAL ‚ïê‚ïê */
var currentChatType   = 'public';
var currentChatUser   = null;
var profiles          = [];
var pmBadges          = {};
var lastPublicMsgTime = null; // FIX UUID : on utilise created_at
var lastPMId          = 0;
var pmPollInterval    = null;
var lastInboxId       = 0;

/* ‚ïê‚ïê COULEUR BULLES ‚ïê‚ïê */
var PRESETS = [
    { l:'Rose/Violet', v:'linear-gradient(135deg,#ff6b9d,#c06fff)' },
    { l:'Bleu',        v:'linear-gradient(135deg,#2196f3,#03a9f4)' },
    { l:'Vert',        v:'linear-gradient(135deg,#43e97b,#38f9d7)' },
    { l:'Orange',      v:'linear-gradient(135deg,#f7971e,#ffd200)' },
    { l:'Rouge',       v:'linear-gradient(135deg,#f44336,#e91e63)' },
    { l:'Indigo',      v:'linear-gradient(135deg,#5c6bc0,#7c4dff)' },
    { l:'Cyan',        v:'linear-gradient(135deg,#00bcd4,#26c6da)'  },
    { l:'Noir',        v:'linear-gradient(135deg,#2d2d2d,#555)'     },
];
var myBubbleStyle = localStorage.getItem('myBubbleStyle') || PRESETS[0].v;

function buildColorSwatches() {
    var c = document.getElementById('colorSwatches');
    c.innerHTML = '';
    PRESETS.forEach(function(p) {
        var sw = document.createElement('div');
        sw.className = 'color-swatch' + (myBubbleStyle === p.v ? ' active' : '');
        sw.style.background = p.v;
        sw.title = p.l;
        sw.addEventListener('click', function() {
            c.querySelectorAll('.color-swatch').forEach(function(s) { s.classList.remove('active'); });
            sw.classList.add('active');
            myBubbleStyle = p.v;
            localStorage.setItem('myBubbleStyle', p.v);
            document.querySelectorAll('.pm-msg.sent').forEach(function(b) { b.style.background = p.v; });
        });
        c.appendChild(sw);
    });
}
buildColorSwatches();

document.getElementById('customColorInput').addEventListener('input', function(e) {
    var hex = e.target.value;
    document.querySelectorAll('.color-swatch').forEach(function(s) { s.classList.remove('active'); });
    myBubbleStyle = hex;
    localStorage.setItem('myBubbleStyle', hex);
    document.querySelectorAll('.pm-msg.sent').forEach(function(b) { b.style.background = hex; });
});

/* ‚ïê‚ïê STATUT EN LIGNE ‚ïê‚ïê */
async function setOnlineStatus(online) {
    try {
        await supabase.from('profiles').update({ is_online: online, last_seen: new Date().toISOString() }).eq('unique_id', currentUniqueId);
    } catch(e) { console.log('setOnlineStatus err'); }
}
setOnlineStatus(true);
setInterval(function() { setOnlineStatus(true); }, 30000);
window.addEventListener('beforeunload', function() { setOnlineStatus(false); });
document.addEventListener('visibilitychange', function() { setOnlineStatus(!document.hidden); });

/* ‚ïê‚ïê PROFILS ‚ïê‚ïê */
async function loadProfiles() {
    try {
        var res = await supabase
            .from('profiles')
            .select('unique_id, prenom, photo_url, is_online, last_seen')
            .order('is_online', { ascending: false })
            .order('prenom',    { ascending: true });

        if (res.error) { console.log('ERR Profils: ' + res.error.message); return; }

        profiles = (res.data || [])
            .filter(function(p) { return p.unique_id !== currentUniqueId; })
            .map(function(p) { return {
                unique_id: p.unique_id || '',
                prenom:    p.prenom    || 'Anonyme',
                photo_url: p.photo_url || null,
                is_online: !!p.is_online
            }; });
        renderProfiles();
    } catch(e) { console.log('ERR loadProfiles exception'); }
}

function renderProfiles() {
    var container = document.getElementById('profileList');
    var countEl   = document.getElementById('profileCount');
    container.innerHTML = '';

    var onlineCount = profiles.filter(function(p) { return p.is_online; }).length;
    countEl.textContent = profiles.length + ' utilisateur' + (profiles.length > 1 ? 's' : '') + ' ¬∑ ' + onlineCount + ' en ligne';

    profiles.forEach(function(profile) {
        var item = document.createElement('div');
        item.className = 'user-item' + (currentChatType === 'private' && currentChatUser && currentChatUser.unique_id === profile.unique_id ? ' active' : '');
        item.dataset.uid = profile.unique_id;

        var av = document.createElement('div');
        av.className = 'user-avatar';
        av.innerHTML = profile.photo_url ? '<img src="' + profile.photo_url + '" alt="' + esc(profile.prenom) + '">' : profile.prenom[0].toUpperCase();
        var dot = document.createElement('div');
        dot.className = 'status-dot ' + (profile.is_online ? 'online' : 'offline');
        av.appendChild(dot);

        var info = document.createElement('div');
        info.className = 'user-info';
        info.innerHTML = '<div class="user-name">' + esc(profile.prenom) + '</div><div class="user-status-txt ' + (profile.is_online ? 'online' : 'offline') + '">' + (profile.is_online ? '‚óè En ligne' : '‚óè Hors ligne') + '</div>';

        item.appendChild(av);
        item.appendChild(info);

        var unread = pmBadges[profile.unique_id] || 0;
        if (unread > 0) {
            var badge = document.createElement('div');
            badge.className = 'notif-badge';
            badge.textContent = unread > 99 ? '99+' : unread;
            item.appendChild(badge);
        }

        item.addEventListener('click', function() {
            switchToPrivateChat(profile);
            if (isMobile()) {
                sidebarVisible = false;
                document.getElementById('usersPanel').classList.add('hidden');
                document.getElementById('toggleIcon').textContent = 'üí¨';
                document.getElementById('toggleText').textContent  = 'Chat';
            }
        });
        container.appendChild(item);
    });
}

setInterval(loadProfiles, 5000);
loadProfiles();

/* ‚ïê‚ïê INBOX POLLING ‚ïê‚ïê */
async function pollInbox() {
    try {
        var res = await supabase
            .from('private_messages')
            .select('id, sender_unique_id, message')
            .eq('receiver_unique_id', currentUniqueId)
            .eq('is_read', false)
            .gt('id', lastInboxId)
            .order('id', { ascending: true });

        if (res.error) { console.log('ERR Inbox: ' + res.error.message); return; }
        if (!res.data || !res.data.length) return;

        res.data.forEach(function(msg) {
            if (msg.id > lastInboxId) lastInboxId = msg.id;
            var sid = msg.sender_unique_id;
            if (!(currentChatType === 'private' && currentChatUser && currentChatUser.unique_id === sid)) {
                pmBadges[sid] = (pmBadges[sid] || 0) + 1;
                renderProfiles();
                showToast(msg, sid);
            }
        });
    } catch(e) { console.log('ERR pollInbox exception'); }
}
setInterval(pollInbox, 3000);

function showToast(msg, senderId) {
    var sender = profiles.find(function(p) { return p.unique_id === senderId; });
    var name   = sender ? sender.prenom : 'Quelqu\'un';
    var toast  = document.createElement('div');
    toast.className = 'pm-toast';
    toast.innerHTML = '<div class="pm-toast-name">üíå ' + esc(name) + '</div><div class="pm-toast-text">' + esc(msg.message) + '</div>';
    toast.addEventListener('click', function() {
        var prof = profiles.find(function(p) { return p.unique_id === senderId; });
        if (prof) switchToPrivateChat(prof);
        toast.remove();
    });
    document.body.appendChild(toast);
    setTimeout(function() { toast.style.opacity = '0'; setTimeout(function() { toast.remove(); }, 400); }, 5000);
}

/* ‚ïê‚ïê WIZZ ‚ïê‚ïê */
document.getElementById('wizzBtn').addEventListener('click', async function() {
    if (!currentChatUser) return;
    document.getElementById('rightPanel').classList.add('wizzing');
    setTimeout(function() { document.getElementById('rightPanel').classList.remove('wizzing'); }, 600);
    try {
        await supabase.from('private_messages').insert({ sender_unique_id: currentUniqueId, receiver_unique_id: currentChatUser.unique_id, message: '‚ö° WIZZ !', is_read: false });
    } catch(e) { console.log('ERR Wizz'); }
});

/* ‚ïê‚ïê CHAT PUBLIC ‚ïê‚ïê
   FIX : on compare par created_at (string ISO) et non par id (UUID) */
async function loadPublicMessages() {
    try {
        var query = supabase
            .from('messages')
            .select('id, prenom, message, created_at, photo_url')
            .is('to_user', null)
            .order('created_at', { ascending: true })
            .limit(60);

        if (lastPublicMsgTime) {
            query = query.gt('created_at', lastPublicMsgTime);
        }

        var res = await query;
        if (res.error) { console.log('ERR Messages publics: ' + res.error.message); return; }
        if (!res.data || !res.data.length) return;

        if (!lastPublicMsgTime) {
            document.getElementById('messagesArea').innerHTML = '';
        }

        res.data.forEach(function(msg) {
            if (!lastPublicMsgTime || msg.created_at > lastPublicMsgTime) {
                lastPublicMsgTime = msg.created_at;
            }
            if (currentChatType === 'public') {
                renderPublicMessage({ author: msg.prenom || 'Anonyme', text: msg.message, photo: msg.photo_url, time: fmtTime(msg.created_at) });
            }
        });
    } catch(e) { console.log('ERR loadPublicMessages exception'); }
}

function renderPublicMessage(opts) {
    var area = document.getElementById('messagesArea');
    var el   = document.createElement('div');
    el.className = 'message';

    var av = document.createElement('div');
    av.className = 'message-avatar';
    av.innerHTML = opts.photo ? '<img src="' + opts.photo + '" alt="' + esc(opts.author) + '">' : (opts.author ? opts.author[0] : '?').toUpperCase();

    var content = document.createElement('div');
    content.className = 'message-content';
    content.innerHTML = '<div class="message-author">' + esc(opts.author) + '</div><div class="message-text">' + esc(opts.text) + '</div><div class="message-time">' + opts.time + '</div>';

    el.appendChild(av);
    el.appendChild(content);
    area.appendChild(el);
    area.scrollTop = area.scrollHeight;
}

async function sendPublicMessage(text) {
    renderPublicMessage({ author: currentUserPrenom, text: text, photo: currentUserPhoto, time: fmtTime(new Date().toISOString()) });
    try {
        var res = await supabase.from('messages').insert({ prenom: currentUserPrenom, message: text, photo_url: currentUserPhoto || null, to_user: null }).select('created_at').single();
        if (res.error) { console.log('ERR Envoi public: ' + res.error.message); return; }
        if (res.data && res.data.created_at && (!lastPublicMsgTime || res.data.created_at > lastPublicMsgTime)) {
            lastPublicMsgTime = res.data.created_at;
        }
    } catch(e) { console.log('ERR sendPublicMessage exception'); }
}

setInterval(loadPublicMessages, 2500);

/* ‚ïê‚ïê CHANGEMENT DE VUE ‚ïê‚ïê */
function setHeader(avatarHtml, name, statusTxt, isOnline, showWizz) {
    document.getElementById('chatHeaderAvatar').innerHTML = avatarHtml;
    document.getElementById('chatHeaderName').textContent = name;
    var st = document.getElementById('chatHeaderStatus');
    st.className  = 'chat-panel-header-status ' + (isOnline ? 'online' : 'offline');
    st.textContent = statusTxt;
    document.getElementById('wizzBtn').style.display = showWizz ? 'block' : 'none';
}

function switchToPublicChat() {
    if (pmPollInterval) { clearInterval(pmPollInterval); pmPollInterval = null; }
    currentChatType   = 'public';
    currentChatUser   = null;
    lastPublicMsgTime = null;

    setHeader('üåê', 'Chat g√©n√©ral', '‚óè Public', true, false);
    document.getElementById('bubbleColorPicker').style.display = 'none';
    document.querySelectorAll('.user-item').forEach(function(i) { i.classList.remove('active'); });
    document.getElementById('publicChatBtn').classList.add('active');
    document.getElementById('messagesArea').innerHTML = '';
    loadPublicMessages();
}

function switchToPrivateChat(profile) {
    if (pmPollInterval) { clearInterval(pmPollInterval); pmPollInterval = null; }
    currentChatType = 'private';
    currentChatUser = profile;
    lastPMId        = 0;
    pmBadges[profile.unique_id] = 0;

    var avHtml = profile.photo_url
        ? '<img src="' + profile.photo_url + '" alt="' + esc(profile.prenom) + '">'
        : profile.prenom[0].toUpperCase();
    setHeader(avHtml, profile.prenom, profile.is_online ? 'üü¢ En ligne' : 'üî¥ Hors ligne', profile.is_online, true);

    document.getElementById('bubbleColorPicker').style.display = 'flex';
    document.querySelectorAll('.user-item').forEach(function(i) { i.classList.remove('active'); });
    document.querySelectorAll('.user-item[data-uid="' + profile.unique_id + '"]').forEach(function(i) { i.classList.add('active'); });
    document.getElementById('publicChatBtn').classList.remove('active');

    loadPMHistory(profile.unique_id);
    markAllRead(profile.unique_id);
    document.querySelectorAll('.notif-badge').forEach(function(b) {
        var item = b.closest('.user-item');
        if (item && item.dataset.uid === profile.unique_id) b.remove();
    });
    pmPollInterval = setInterval(function() { pollNewPMs(profile.unique_id); }, 2500);
}

document.getElementById('publicChatBtn').addEventListener('click', function() {
    switchToPublicChat();
    if (isMobile()) {
        sidebarVisible = false;
        document.getElementById('usersPanel').classList.add('hidden');
        document.getElementById('toggleIcon').textContent = 'üí¨';
        document.getElementById('toggleText').textContent  = 'Chat';
    }
});

/* ‚ïê‚ïê MESSAGES PRIV√âS ‚ïê‚ïê */
async function loadPMHistory(otherId) {
    var area = document.getElementById('messagesArea');
    area.innerHTML = '<div class="pm-empty"><span class="pm-empty-icon">üí¨</span>Chargement...</div>';

    try {
        var res = await supabase
            .from('private_messages')
            .select('id, sender_unique_id, message, created_at, is_read')
            .or('and(sender_unique_id.eq.' + currentUniqueId + ',receiver_unique_id.eq.' + otherId + '),and(sender_unique_id.eq.' + otherId + ',receiver_unique_id.eq.' + currentUniqueId + ')')
            .order('created_at', { ascending: true })
            .limit(150);

        if (res.error) { console.log('ERR Historique MP: ' + res.error.message); area.innerHTML = '<div class="pm-empty"><span class="pm-empty-icon">‚ö†Ô∏è</span>Erreur chargement</div>'; return; }

        area.innerHTML = '';
        if (!res.data || !res.data.length) {
            area.innerHTML = '<div class="pm-empty"><span class="pm-empty-icon">üíå</span>Aucun message</div>';
            return;
        }

        res.data.forEach(function(msg) {
            if (msg.id > lastPMId) lastPMId = msg.id;
            appendPMBubble({ id: msg.id, text: msg.message, fromMe: msg.sender_unique_id === currentUniqueId, time: fmtTime(msg.created_at), is_read: msg.is_read });
        });
        area.scrollTop = area.scrollHeight;
    } catch(e) { console.log('ERR loadPMHistory exception'); }
}

function buildBubble(opts) {
    var wrap = document.createElement('div');
    wrap.className  = 'pm-msg-wrap ' + (opts.fromMe ? 'sent' : 'received');
    wrap.dataset.msgId = opts.id;

    var bubble = document.createElement('div');
    bubble.className = 'pm-msg ' + (opts.fromMe ? 'sent' : 'received');
    if (opts.fromMe) bubble.style.background = myBubbleStyle;

    var tick = opts.fromMe ? '<span class="pm-tick ' + (opts.is_read ? 'read' : '') + '">' + (opts.is_read ? '‚úì‚úì' : '‚úì') + '</span>' : '';
    bubble.innerHTML = esc(opts.text) + '<div class="pm-msg-meta">' + opts.time + ' ' + tick + '</div>';
    wrap.appendChild(bubble);
    return wrap;
}

function appendPMBubble(msg) {
    var area = document.getElementById('messagesArea');
    var empty = area.querySelector('.pm-empty');
    if (empty) empty.remove();
    area.appendChild(buildBubble(msg));
    area.scrollTop = area.scrollHeight;
}

async function sendPM() {
    if (!currentChatUser) return;
    var input = document.getElementById('messageInput');
    var text  = input.value.trim();
    if (!text) return;
    input.value = '';

    var tempId = 'tmp-' + Date.now();
    appendPMBubble({ id: tempId, text: text, fromMe: true, time: fmtTime(new Date().toISOString()), is_read: false });

    try {
        var res = await supabase.from('private_messages').insert({ sender_unique_id: currentUniqueId, receiver_unique_id: currentChatUser.unique_id, message: text, is_read: false }).select('id').single();
        if (res.error) { console.log('ERR Envoi MP: ' + res.error.message); var el2 = document.querySelector('[data-msg-id="' + tempId + '"]'); if (el2) el2.remove(); input.value = text; return; }
        var el = document.querySelector('[data-msg-id="' + tempId + '"]');
        if (el && res.data) { el.dataset.msgId = res.data.id; if (res.data.id > lastPMId) lastPMId = res.data.id; }
    } catch(e) { console.log('ERR sendPM exception'); }
}

async function pollNewPMs(otherId) {
    if (currentChatType !== 'private' || !currentChatUser || currentChatUser.unique_id !== otherId) return;
    try {
        var res = await supabase
            .from('private_messages')
            .select('id, message, created_at, is_read')
            .eq('sender_unique_id',   otherId)
            .eq('receiver_unique_id', currentUniqueId)
            .gt('id', lastPMId)
            .order('id', { ascending: true });

        if (res.error || !res.data || !res.data.length) return;

        res.data.forEach(function(msg) {
            if (msg.id > lastPMId) lastPMId = msg.id;
            appendPMBubble({ id: msg.id, text: msg.message, fromMe: false, time: fmtTime(msg.created_at), is_read: false });
            markRead(msg.id);
        });
        if (res.data.some(function(m) { return m.message === '‚ö° WIZZ !'; })) {
            document.getElementById('rightPanel').classList.add('wizzing');
            setTimeout(function() { document.getElementById('rightPanel').classList.remove('wizzing'); }, 600);
        }
    } catch(e) { console.log('ERR pollNewPMs exception'); }
}

async function markRead(id) {
    try { await supabase.from('private_messages').update({ is_read: true }).eq('id', id); } catch(e) {}
}
async function markAllRead(senderId) {
    try { await supabase.from('private_messages').update({ is_read: true }).eq('receiver_unique_id', currentUniqueId).eq('sender_unique_id', senderId).eq('is_read', false); } catch(e) {}
}

/* ‚ïê‚ïê ENVOI UNIFI√â ‚ïê‚ïê */
function sendMessage() {
    var input = document.getElementById('messageInput');
    var text  = input.value.trim();
    if (!text) return;
    if (currentChatType === 'public') { sendPublicMessage(text); input.value = ''; }
    else sendPM();
}
document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('messageInput').addEventListener('keypress', function(e) { if (e.key === 'Enter') sendMessage(); });

/* ‚ïê‚ïê TH√àMES ‚ïê‚ïê */
document.querySelectorAll('.theme-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        document.body.className = ''; document.body.style.backgroundImage = '';
        document.querySelectorAll('.theme-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        document.body.classList.add('theme-' + btn.dataset.theme);
    });
});
document.getElementById('customBgInput').addEventListener('change', function(e) {
    var file = e.target.files[0]; if (!file) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
        document.body.className = 'custom-bg';
        document.body.style.backgroundImage = 'url(' + ev.target.result + ')';
        document.querySelectorAll('.theme-btn').forEach(function(b) { b.classList.remove('active'); });
    };
    reader.readAsDataURL(file);
});

/* ‚ïê‚ïê PARTICULES ‚ïê‚ïê */
(function() {
    var c = document.getElementById('particles');
    for (var i = 0; i < 40; i++) {
        var p = document.createElement('div');
        p.className = 'particle';
        p.style.left = (Math.random() * 100) + '%';
        p.style.animationDelay    = (Math.random() * 20) + 's';
        p.style.animationDuration = (Math.random() * 15 + 15) + 's';
        c.appendChild(p);
    }
})();

/* ‚ïê‚ïê UTILS ‚ïê‚ïê */
function esc(s) {
    return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function fmtTime(iso) {
    if (!iso) return '';
    var d = new Date(iso), now = new Date();
    var hm = d.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
    return d.toDateString() === now.toDateString() ? hm : d.toLocaleDateString('fr-FR', { day:'2-digit', month:'2-digit' }) + ' ' + hm;
}

/* ‚ïê‚ïê INIT ‚ïê‚ïê */
switchToPublicChat();
</script>

</body>
</html>

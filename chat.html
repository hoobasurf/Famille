<!DOCTYPE html>

<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BubbleChat</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#764ba2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BubbleChat">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; min-height: 100vh; position: relative; overflow-x: hidden; transition: background 0.8s ease; }
        body.theme-zen      { background: linear-gradient(135deg,#e0f7fa,#b2ebf2,#80deea); }
        body.theme-plage    { background: linear-gradient(135deg,#ffd89b,#f4a460,#19547b); }
        body.theme-foret    { background: linear-gradient(135deg,#134e5e,#3a7e6f,#71b280); }
        body.theme-futuriste{ background: linear-gradient(135deg,#667eea,#764ba2); }
        body.theme-bonbon   { background: linear-gradient(135deg,#ffecd2,#fcb69f,#ff9a9e); }
        body.theme-bar      { background: linear-gradient(135deg,#2c003e,#4b0082,#8b008b); }
        body.theme-chasse   { background: linear-gradient(135deg,#3e2723,#5d4037,#795548); }
        body.theme-aquarium { background: linear-gradient(135deg,#00416a,#1976d2 33%,#4caf50 66%,#ffe000); }
        body.custom-bg      { background-size:cover!important; background-position:center!important; background-attachment:fixed!important; }

```
    .particles { position:fixed; inset:0; pointer-events:none; z-index:0; }
    .particle  { position:absolute; width:3px; height:3px; background:rgba(255,255,255,.5); border-radius:50%; animation:float 20s infinite ease-in-out; }
    @keyframes float { 0%,100%{transform:translateY(0) translateX(0);opacity:0} 10%{opacity:1} 90%{opacity:1} 100%{transform:translateY(-100vh) translateX(50px);opacity:0} }

    .app-wrapper { position:relative; z-index:1; max-width:1500px; margin:0 auto; padding:20px; min-height:100vh; display:flex; flex-direction:column; gap:20px; }

    .chat-header { background:rgba(255,255,255,.05); backdrop-filter:blur(10px); border-radius:20px; padding:14px 28px; border:1px solid rgba(255,255,255,.15); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; }
    .theme-selector { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
    .theme-label    { color:white; font-weight:600; text-shadow:0 2px 5px rgba(0,0,0,.3); }
    .theme-options  { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .theme-btn { width:45px; height:45px; border-radius:50%; border:3px solid rgba(255,255,255,.5); cursor:pointer; transition:all .3s; flex-shrink:0; }
    .theme-btn:hover  { transform:scale(1.15); border-color:white; }
    .theme-btn.active { border-color:white; box-shadow:0 0 0 4px rgba(255,255,255,.3); }

    .theme-btn-custom { width:45px; height:45px; border-radius:50%; border:3px solid rgba(255,255,255,.5); background:linear-gradient(135deg,#fff,#ccc); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:20px; transition:all .3s; position:relative; flex-shrink:0; }
    .theme-btn-custom:hover { transform:scale(1.15); border-color:white; }
    .theme-btn-custom input[type=file] { position:absolute; opacity:0; width:100%; height:100%; cursor:pointer; }

    .user-profile-photo { width:45px; height:45px; border-radius:50%; border:3px solid rgba(255,255,255,.6); overflow:hidden; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,#ff6b9d,#c06fff); font-size:20px; color:white; cursor:pointer; transition:all .3s; flex-shrink:0; vertical-align:middle; position:relative; top:0; }
    .user-profile-photo:hover { transform:scale(1.15); }
    .user-profile-photo img { width:100%; height:100%; object-fit:cover; }

    .notif-toggle-btn { width:45px; height:45px; border-radius:50%; border:3px solid rgba(255,255,255,.5); background:rgba(255,255,255,.1); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:20px; transition:all .3s; flex-shrink:0; }
    .notif-toggle-btn:hover { transform:scale(1.15); border-color:white; }
    .notif-toggle-btn.active { border-color:#4caf50; box-shadow:0 0 0 4px rgba(76,175,80,.3); background:rgba(76,175,80,.2); }
    .notif-toggle-btn.denied { border-color:#f44336; background:rgba(244,67,54,.2); }

    .toggle-sidebar-btn { position:fixed; top:50%; left:20px; transform:translateY(-50%); z-index:300; background:linear-gradient(135deg,#ff6b9d,#c06fff); border:none; border-radius:16px; padding:16px 20px; color:white; font-weight:700; cursor:pointer; transition:all .4s cubic-bezier(.34,1.56,.64,1); display:flex; flex-direction:column; align-items:center; gap:8px; animation:neonPulse 2s ease-in-out infinite; }
    @keyframes neonPulse { 0%,100%{ box-shadow:0 0 20px rgba(255,107,157,.6),0 0 40px rgba(192,111,255,.4),0 8px 25px rgba(0,0,0,.3); } 50%{ box-shadow:0 0 35px rgba(255,107,157,.9),0 0 65px rgba(192,111,255,.6),0 8px 25px rgba(0,0,0,.3); } }
    .toggle-sidebar-btn:hover { transform:translateY(-50%) scale(1.1); }
    .toggle-icon { font-size:28px; }
    .toggle-text { font-size:12px; text-transform:uppercase; letter-spacing:1px; }

    .body-columns { display:flex; gap:20px; flex:1; min-height:0; }

    .users-panel { width:340px; flex-shrink:0; background:rgba(255,255,255,.05); backdrop-filter:blur(10px); border-radius:20px; border:1px solid rgba(255,255,255,.15); padding:24px 16px; display:flex; flex-direction:column; gap:16px; overflow-y:auto; max-height:calc(100vh - 160px); transition:width .4s cubic-bezier(.4,0,.2,1), min-width .4s, opacity .4s, padding .4s, border .4s; }
    .users-panel.hidden { width:0; min-width:0; padding-left:0; padding-right:0; opacity:0; pointer-events:none; border:none; overflow:hidden; }

    .users-panel-header { color:white; font-weight:700; font-size:20px; text-align:center; padding-bottom:16px; border-bottom:2px solid rgba(255,255,255,.15); }
    .users-panel-count  { font-size:13px; opacity:.7; font-weight:400; margin-top:6px; }
    .user-list { display:flex; flex-direction:column; gap:12px; }

    .user-item { display:flex; align-items:center; gap:14px; padding:14px 16px; border-radius:18px; cursor:pointer; background:rgba(255,255,255,.08); border:2px solid rgba(255,255,255,.15); transition:all .3s; position:relative; }
    .user-item:hover  { border-color:rgba(255,107,157,.5); transform:translateX(8px); background:rgba(255,255,255,.15); }
    .user-item.active { border-color:rgba(255,107,157,.8); background:rgba(255,107,157,.2); box-shadow:0 6px 25px rgba(255,107,157,.4); transform:translateX(8px); }

    .user-avatar { width:52px; height:52px; border-radius:50%; background:linear-gradient(135deg,#ff6b9d,#c06fff); border:3px solid rgba(255,255,255,.4); overflow:hidden; flex-shrink:0; position:relative; display:flex; align-items:center; justify-content:center; font-size:22px; color:white; font-weight:700; }
    .user-avatar img { width:100%; height:100%; object-fit:cover; }
    .status-dot { position:absolute; bottom:2px; right:2px; width:14px; height:14px; border-radius:50%; border:3px solid rgba(255,255,255,.9); }
    .status-dot.online  { background:#4caf50; animation:pulse-online 2s infinite; }
    .status-dot.offline { background:#999; }
    @keyframes pulse-online { 0%,100%{box-shadow:0 0 12px #4caf50} 50%{box-shadow:0 0 22px #4caf50} }

    .user-info { flex:1; min-width:0; }
    .user-name { color:white; font-weight:700; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .user-status-txt { font-size:13px; margin-top:4px; font-weight:600; }
    .user-status-txt.online  { color:#4caf50; }
    .user-status-txt.offline { color:rgba(255,255,255,.5); }

    .notif-badge { position:absolute; top:10px; right:10px; background:linear-gradient(135deg,#ff6b9d,#ff3060); color:white; font-size:12px; font-weight:900; border-radius:14px; min-width:24px; height:24px; display:flex; align-items:center; justify-content:center; padding:0 8px; animation:badgePop .5s cubic-bezier(.34,1.56,.64,1); }
    @keyframes badgePop { from{transform:scale(0) rotate(-15deg)} to{transform:scale(1)} }

    .right-panel { flex:1; display:flex; flex-direction:column; min-width:0; background:rgba(255,255,255,.05); backdrop-filter:blur(10px); border-radius:20px; border:1px solid rgba(255,255,255,.15); overflow:hidden; transition:flex .4s; }

    .wizz-btn { padding:10px 20px; background:linear-gradient(135deg,#ffd700,#ff8c00); border:none; border-radius:12px; color:white; font-weight:700; cursor:pointer; transition:all .3s; font-size:14px; }
    .wizz-btn:hover { transform:translateY(-2px); }
    @keyframes wizz { 0%,100%{transform:translate(0,0)} 15%{transform:translate(-10px,-10px) rotate(-5deg)} 30%{transform:translate(10px,10px) rotate(5deg)} 45%{transform:translate(-8px,8px) rotate(-4deg)} 60%{transform:translate(8px,-8px) rotate(4deg)} 80%{transform:translate(-4px,4px) rotate(-2deg)} }
    .wizzing { animation:wizz .55s ease-in-out; }

    .chat-panel-header { background:rgba(255,255,255,.08); padding:20px 28px; border-bottom:2px solid rgba(255,255,255,.15); display:flex; align-items:center; gap:18px; flex-wrap:wrap; }
    .chat-panel-header-avatar { width:50px; height:50px; border-radius:50%; border:3px solid rgba(255,107,157,.6); overflow:hidden; display:flex; align-items:center; justify-content:center; font-size:24px; color:white; background:linear-gradient(135deg,#ff6b9d,#c06fff); flex-shrink:0; }
    .chat-panel-header-avatar img { width:100%; height:100%; object-fit:cover; }
    .chat-panel-header-info { flex:1; }
    .chat-panel-header-name   { color:white; font-weight:700; font-size:19px; }
    .chat-panel-header-status { font-size:14px; margin-top:4px; font-weight:600; }
    .chat-panel-header-status.online  { color:#4caf50; }
    .chat-panel-header-status.offline { color:rgba(255,255,255,.6); }

    /* ‚ïê‚ïê BOUTON VISIO HEADER ‚ïê‚ïê */
    .visio-btn-header {
        padding:10px 20px;
        background:linear-gradient(135deg,#ff6b9d,#c06fff);
        border:none;
        border-radius:12px;
        color:white;
        font-weight:700;
        cursor:pointer;
        transition:all .3s;
        font-size:14px;
        align-items:center;
        gap:6px;
        box-shadow:0 4px 15px rgba(192,111,255,.4);
        display:none;
    }
    .visio-btn-header:hover {
        transform:translateY(-2px);
        box-shadow:0 6px 20px rgba(192,111,255,.6);
    }
    .visio-btn-header.visible {
        display:flex;
    }

    .messages-area { flex:1; padding:28px; overflow-y:auto; display:flex; flex-direction:column; gap:14px; }

    .message { background:rgba(255,255,255,.12); padding:16px 22px; border-radius:18px; color:white; animation:slideIn .4s ease; display:flex; gap:16px; align-items:flex-start; border:1px solid rgba(255,255,255,.1); }
    @keyframes slideIn { from{opacity:0;transform:translateY(15px)} to{opacity:1;transform:translateY(0)} }
    .message-avatar { width:46px; height:46px; border-radius:50%; overflow:hidden; flex-shrink:0; background:linear-gradient(135deg,#ff6b9d,#c06fff); display:flex; align-items:center; justify-content:center; font-size:20px; border:3px solid rgba(255,255,255,.4); color:white; font-weight:700; }
    .message-avatar img { width:100%; height:100%; object-fit:cover; }
    .message-content { flex:1; }
    .message-author { font-weight:700; margin-bottom:8px; font-size:15px; }
    .message-text   { font-size:15px; line-height:1.6; }
    .message-time   { font-size:12px; opacity:.7; text-align:right; margin-top:8px; }

    .pm-msg-wrap { display:flex; flex-direction:column; margin-bottom:10px; max-width:70%; }
    .pm-msg-wrap.sent     { align-self:flex-end;   align-items:flex-end; }
    .pm-msg-wrap.received { align-self:flex-start; align-items:flex-start; }
    .pm-msg { padding:14px 20px; border-radius:20px; font-size:15px; color:white; line-height:1.6; word-break:break-word; animation:msgPop .3s cubic-bezier(.34,1.56,.64,1); }
    @keyframes msgPop { from{opacity:0;transform:scale(.9)} to{opacity:1;transform:scale(1)} }
    .pm-msg.sent     { border-bottom-right-radius:5px; box-shadow:0 6px 25px rgba(192,111,255,.35); }
    .pm-msg.received { background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.15); border-bottom-left-radius:5px; }
    .pm-msg-meta { font-size:11px; opacity:.65; margin-top:6px; display:flex; align-items:center; gap:5px; }
    .pm-tick.read { color:#64b5f6; opacity:1!important; }
    .pm-empty { text-align:center; color:rgba(255,255,255,.5); font-size:15px; padding:80px 24px; line-height:2.2; }
    .pm-empty-icon { font-size:56px; display:block; margin-bottom:16px; }

    .input-area { background:rgba(255,255,255,.08); padding:20px 28px; border-top:2px solid rgba(255,255,255,.15); display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
    .message-input { flex:1; min-width:200px; padding:16px 22px; background:rgba(255,255,255,.15); border:2px solid rgba(255,255,255,.2); border-radius:18px; color:white; font-size:15px; transition:all .3s; }
    .message-input:focus { outline:none; background:rgba(255,255,255,.25); border-color:rgba(255,255,255,.4); }
    .message-input::placeholder { color:rgba(255,255,255,.6); }
    .send-btn { padding:16px 36px; background:linear-gradient(135deg,#ff6b9d,#c06fff); border:none; border-radius:18px; color:white; font-size:16px; font-weight:700; cursor:pointer; transition:all .3s; box-shadow:0 6px 25px rgba(192,111,255,.5); white-space:nowrap; }
    .send-btn:hover  { transform:translateY(-3px); }
    .send-btn:active { transform:scale(.97); }

    .bubble-color-row { display:flex; align-items:center; gap:12px; width:100%; margin-top:4px; flex-wrap:wrap; }
    .bubble-color-label { color:rgba(255,255,255,.75); font-size:14px; font-weight:600; white-space:nowrap; }
    .bubble-color-swatches { display:flex; gap:10px; flex-wrap:wrap; }
    .color-swatch { width:30px; height:30px; border-radius:50%; border:3px solid rgba(255,255,255,.4); cursor:pointer; transition:all .25s; }
    .color-swatch:hover  { transform:scale(1.25); border-color:white; }
    .color-swatch.active { border-color:white; box-shadow:0 0 0 4px rgba(255,255,255,.3); transform:scale(1.2); }
    .color-swatch-custom { width:30px; height:30px; border-radius:50%; border:3px solid rgba(255,255,255,.4); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:13px; background:rgba(255,255,255,.1); transition:all .25s; position:relative; overflow:hidden; }
    .color-swatch-custom:hover { transform:scale(1.25); border-color:white; }
    .color-swatch-custom input[type=color] { position:absolute; opacity:0; width:100%; height:100%; cursor:pointer; }

    .pm-toast { position:fixed; bottom:30px; right:30px; z-index:3000; background:rgba(10,3,24,.97); border:2px solid rgba(255,107,157,.6); border-radius:18px; padding:18px 24px; color:white; font-size:15px; box-shadow:0 15px 45px rgba(0,0,0,.7); cursor:pointer; max-width:300px; backdrop-filter:blur(25px); animation:toastIn .5s cubic-bezier(.34,1.56,.64,1); transition:opacity .4s; }
    @keyframes toastIn { from{opacity:0;transform:translateY(20px) scale(.9)} to{opacity:1;transform:scale(1)} }
    .pm-toast-name { font-weight:700; color:#ff6b9d; margin-bottom:6px; }
    .pm-toast-text { opacity:.8; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       VISIO JITSI - MODAL PRINCIPAL
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    /* Overlay sombre derri√®re le modal (s'efface en mode PiP) */
    #visioOverlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.7);
        backdrop-filter: blur(8px);
        z-index: 9000;
        display: none;
        align-items: center;
        justify-content: center;
    }
    #visioOverlay.open       { display: flex; }
    #visioOverlay.pip-mode   { background: transparent; backdrop-filter: none; pointer-events: none; }

    /* Le container draggable du modal */
    #visioContainer {
        position: fixed;
        z-index: 9999;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 25px 80px rgba(0,0,0,.6), 0 0 0 1px rgba(255,255,255,.15);
        display: none;
        flex-direction: column;
        background: #0d0d1a;

        /* Taille plein modal par d√©faut (centr√©) */
        width: 88vw;
        max-width: 1100px;
        height: 82vh;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        transition: box-shadow .3s;
    }
    #visioContainer.open { display: flex; }

    /* Mode Picture-in-Picture : petit coin bas-droite */
    #visioContainer.pip {
        width: 360px;
        height: 260px;
        top: auto;
        left: auto;
        bottom: 24px;
        right: 24px;
        transform: none;
        border-radius: 16px;
        cursor: move;
        box-shadow: 0 12px 50px rgba(0,0,0,.8), 0 0 0 2px rgba(255,107,157,.4);
    }
    #visioContainer.pip #visioIframeWrap { flex: 1; }
    #visioContainer.pip #visioToolbar    { padding: 8px 12px; }
    #visioContainer.pip .vt-label       { display: none; }
    #visioContainer.pip .vt-btn span    { display: none; }
    #visioContainer.pip .vt-btn         { padding: 6px 10px; font-size: 16px; }
    #visioContainer.pip #visioTitleBar  { padding: 8px 12px; }
    #visioContainer.pip #visioRoomInfo  { display: none; }

    /* Mode plein √©cran */
    #visioContainer.fullscreen {
        width: 100vw;
        height: 100vh;
        top: 0; left: 0;
        transform: none;
        border-radius: 0;
        max-width: none;
    }

    /* Barre de titre du modal visio */
    #visioTitleBar {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 20px;
        background: linear-gradient(90deg, rgba(255,107,157,.15), rgba(192,111,255,.15));
        border-bottom: 1px solid rgba(255,255,255,.1);
        user-select: none;
        flex-shrink: 0;
    }
    #visioTitleBar .vtb-icon { font-size: 22px; }
    #visioTitleBar .vtb-title {
        flex: 1;
        color: white;
        font-weight: 700;
        font-size: 16px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #visioRoomInfo {
        font-size: 12px;
        color: rgba(255,255,255,.5);
        font-weight: 400;
        margin-top: 2px;
    }

    /* Boutons de fen√™tre (macOS style) */
    .vtb-win-btns { display:flex; gap:8px; }
    .vtb-win-btn  {
        width: 16px; height: 16px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        transition: opacity .2s, transform .2s;
        font-size: 10px;
        display: flex; align-items: center; justify-content: center;
        color: transparent;
        font-weight: 900;
    }
    .vtb-win-btn:hover { opacity: .85; transform: scale(1.15); color: rgba(0,0,0,.6); }
    .vtb-win-btn.close  { background: #ff5f57; }
    .vtb-win-btn.mini   { background: #febc2e; }
    .vtb-win-btn.full   { background: #28c840; }

    /* Zone de l'iframe Jitsi */
    #visioIframeWrap {
        flex: 1;
        position: relative;
        background: #000;
    }
    #visioIframe {
        width: 100%;
        height: 100%;
        border: none;
        display: block;
    }

    /* Banni√®re de chargement */
    #visioLoading {
        position: absolute;
        inset: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 20px;
        background: #0d0d1a;
        color: white;
        z-index: 2;
        transition: opacity .5s;
    }
    #visioLoading.hide { opacity: 0; pointer-events: none; }
    .vl-spinner {
        width: 56px; height: 56px;
        border: 4px solid rgba(255,255,255,.1);
        border-top-color: #ff6b9d;
        border-radius: 50%;
        animation: spin .9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .vl-text { font-size: 15px; color: rgba(255,255,255,.7); }
    .vl-room {
        font-size: 13px;
        color: rgba(255,107,157,.8);
        font-weight: 600;
        letter-spacing: 1px;
        background: rgba(255,107,157,.1);
        padding: 6px 14px;
        border-radius: 20px;
        border: 1px solid rgba(255,107,157,.3);
    }

    /* Barre d'outils du bas */
    #visioToolbar {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 20px;
        background: rgba(0,0,0,.5);
        border-top: 1px solid rgba(255,255,255,.08);
        flex-wrap: wrap;
        flex-shrink: 0;
    }
    .vt-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        background: rgba(255,255,255,.08);
        border: 1px solid rgba(255,255,255,.15);
        border-radius: 10px;
        color: white;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all .25s;
        white-space: nowrap;
    }
    .vt-btn:hover { background: rgba(255,255,255,.15); transform: translateY(-1px); }
    .vt-btn.active {
        background: linear-gradient(135deg, rgba(255,107,157,.3), rgba(192,111,255,.3));
        border-color: rgba(255,107,157,.5);
    }
    .vt-btn.danger {
        background: rgba(239,68,68,.15);
        border-color: rgba(239,68,68,.3);
    }
    .vt-btn.danger:hover {
        background: rgba(239,68,68,.3);
        box-shadow: 0 4px 15px rgba(239,68,68,.3);
    }
    .vt-btn .vt-icon { font-size: 18px; }
    .vt-label { flex: 1; }

    /* Lien d'invitation */
    #visioInviteBox {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 0;
    }
    #visioInviteInput {
        flex: 1;
        padding: 8px 12px;
        background: rgba(255,255,255,.08);
        border: 1px solid rgba(255,255,255,.15);
        border-radius: 8px;
        color: white;
        font-size: 12px;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #visioInviteInput:focus { outline: none; border-color: rgba(255,107,157,.5); }
    #visioCopyBtn {
        padding: 8px 14px;
        background: linear-gradient(135deg,#ff6b9d,#c06fff);
        border: none;
        border-radius: 8px;
        color: white;
        font-size: 13px;
        font-weight: 700;
        cursor: pointer;
        white-space: nowrap;
        transition: all .25s;
    }
    #visioCopyBtn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(192,111,255,.4); }
    #visioCopyBtn.copied {
        background: linear-gradient(135deg,#43e97b,#38f9d7);
    }

    /* Toast copi√© */
    .copy-toast {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(67,233,123,.9);
        color: white;
        font-weight: 700;
        padding: 10px 24px;
        border-radius: 30px;
        font-size: 14px;
        z-index: 99999;
        pointer-events: none;
        animation: toastPop .3s ease;
    }
    @keyframes toastPop { from{opacity:0;transform:translateX(-50%) translateY(10px)} to{opacity:1;transform:translateX(-50%) translateY(0)} }

    /* Drag handle visuel en mode PiP */
    #visioContainer.pip::before {
        content: '‚†ø';
        position: absolute;
        top: 6px;
        left: 50%;
        transform: translateX(-50%);
        color: rgba(255,255,255,.3);
        font-size: 14px;
        letter-spacing: 2px;
        pointer-events: none;
        z-index: 10;
    }

    /* Scrollbars */
    .users-panel::-webkit-scrollbar, .messages-area::-webkit-scrollbar { width:7px; }
    .users-panel::-webkit-scrollbar-track, .messages-area::-webkit-scrollbar-track { background:rgba(255,255,255,.05); border-radius:10px; }
    .users-panel::-webkit-scrollbar-thumb  { background:rgba(255,255,255,.2); border-radius:10px; }
    .messages-area::-webkit-scrollbar-thumb { background:linear-gradient(135deg,#ff6b9d,#c06fff); border-radius:10px; }

    @media (max-width:900px) {
        .users-panel { width:260px; }
        .toggle-sidebar-btn { left:10px; padding:12px 14px; }
        .toggle-text { display:none; }
        #visioContainer { width:96vw; height:75vh; }
        #visioContainer.pip { width:280px; height:200px; bottom:16px; right:16px; }
    }
    @media (max-width:600px) {
        .app-wrapper { padding:10px; gap:10px; }
        .chat-header { padding:10px 14px; }
        .theme-label { display:none; }
        .theme-btn, .theme-btn-custom, .user-profile-photo, .notif-toggle-btn { width:36px; height:36px; font-size:16px; }
        .toggle-sidebar-btn { left:6px; padding:10px 12px; border-radius:12px; }
        .toggle-icon { font-size:20px; }
        .chat-panel-header { padding:14px 16px; }
        .messages-area { padding:16px; }
        .input-area { padding:14px 16px; gap:10px; }
        .message-input { min-width:0; padding:12px 16px; font-size:14px; }
        .send-btn { padding:12px 20px; font-size:14px; }
        .pm-msg-wrap { max-width:90%; }
        .users-panel { position:fixed; top:0; left:0; height:100%; z-index:200; max-height:100vh; border-radius:0 20px 20px 0; width:280px; transform:translateX(0); transition:transform .4s cubic-bezier(.4,0,.2,1), opacity .4s; }
        .users-panel.hidden { transform:translateX(-100%); width:280px; opacity:0; pointer-events:none; }
        #visioContainer.pip { width:240px; height:180px; }
        #visioToolbar { gap:6px; padding:8px 12px; }
        .vt-btn { padding:7px 10px; font-size:13px; }
        .vt-btn span { display:none; }
    }
</style>
```

</head>
<body class="theme-futuriste">
<div class="particles" id="particles"></div>

<div class="app-wrapper">
    <div class="chat-header">
        <div class="theme-selector">
            <span class="theme-label">Th√®me :</span>
            <div class="theme-options">
                <div class="theme-btn" data-theme="zen"       style="background:linear-gradient(135deg,#e0f7fa,#80deea)"  title="Zen"></div>
                <div class="theme-btn" data-theme="plage"     style="background:linear-gradient(135deg,#ffd89b,#19547b)"  title="Plage"></div>
                <div class="theme-btn" data-theme="foret"     style="background:linear-gradient(135deg,#134e5e,#71b280)"  title="For√™t"></div>
                <div class="theme-btn active" data-theme="futuriste" style="background:linear-gradient(135deg,#667eea,#764ba2)" title="Futuriste"></div>
                <div class="theme-btn" data-theme="bonbon"    style="background:linear-gradient(135deg,#ffecd2,#ff9a9e)"  title="Bonbon"></div>
                <div class="theme-btn" data-theme="bar"       style="background:linear-gradient(135deg,#2c003e,#8b008b)"  title="Bar"></div>
                <div class="theme-btn" data-theme="chasse"    style="background:linear-gradient(135deg,#3e2723,#795548)"  title="Chasse"></div>
                <div class="theme-btn" data-theme="aquarium"  style="background:linear-gradient(135deg,#00416a,#ffe000)"  title="Aquarium"></div>
                <div class="theme-btn-custom" title="Photo personnalis√©e">üì∑<input type="file" id="customBgInput" accept="image/*"></div>
                <div class="notif-toggle-btn" id="notifBtn" title="Activer les notifications">üîî</div>
                <div class="user-profile-photo" id="userProfilePhoto" title="Mon profil">üí¨</div>
            </div>
        </div>
    </div>

```
<button class="toggle-sidebar-btn" id="toggleSidebar">
    <span class="toggle-icon" id="toggleIcon">üë•</span>
    <span class="toggle-text"  id="toggleText">Profils</span>
</button>

<div class="body-columns">
    <div class="users-panel" id="usersPanel">
        <div class="users-panel-header">
            üí¨ Conversations
            <div class="users-panel-count" id="profileCount">Chargement...</div>
        </div>
        <div class="user-list">
            <div class="user-item active" id="publicChatBtn">
                <div class="user-avatar">üåê</div>
                <div class="user-info">
                    <div class="user-name">Chat g√©n√©ral</div>
                    <div class="user-status-txt online">‚óè Public</div>
                </div>
            </div>
        </div>
        <div class="user-list" id="profileList"></div>
    </div>

    <div class="right-panel" id="rightPanel">
        <div class="chat-panel-header">
            <div class="chat-panel-header-avatar" id="chatHeaderAvatar">üåê</div>
            <div class="chat-panel-header-info">
                <div class="chat-panel-header-name"   id="chatHeaderName">Chat g√©n√©ral</div>
                <div class="chat-panel-header-status online" id="chatHeaderStatus">‚óè Public</div>
            </div>
            <!-- BOUTON VISIO - visible pour tout le monde (priv√© ET public) -->
            <button class="visio-btn-header visible" id="visioBtn">üìπ <span>Visio</span></button>
            <button class="wizz-btn" id="wizzBtn" style="display:none;">‚ö° WIZZ!</button>
        </div>
        <div class="messages-area" id="messagesArea"></div>
        <div class="input-area">
            <input type="text" class="message-input" id="messageInput" placeholder="Tapez votre message...">
            <button class="send-btn" id="sendBtn">Envoyer üöÄ</button>
            <div class="bubble-color-row" id="bubbleColorPicker" style="display:none;">
                <span class="bubble-color-label">üé® Mes bulles :</span>
                <div class="bubble-color-swatches" id="colorSwatches"></div>
                <div class="color-swatch-custom" title="Couleur libre">‚úèÔ∏è<input type="color" id="customColorInput"></div>
            </div>
        </div>
    </div>
</div>
```

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     VISIO JITSI MEET - MODAL DRAGGABLE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- Overlay (fond sombre) -->

<div id="visioOverlay"></div>

<!-- Container principal de la visio -->

<div id="visioContainer">

```
<!-- Barre de titre -->
<div id="visioTitleBar" id="visioDragHandle">
    <span class="vtb-icon">üìπ</span>
    <div style="flex:1;min-width:0;">
        <div class="vtb-title" id="visioTitleText">Visio en cours</div>
        <div id="visioRoomInfo">Salle : chargement...</div>
    </div>
    <!-- Boutons style macOS -->
    <div class="vtb-win-btns">
        <button class="vtb-win-btn close"  id="visioCloseBtn"  title="Fermer">‚úï</button>
        <button class="vtb-win-btn mini"   id="visioPipBtn"    title="R√©duire (PiP)">‚àí</button>
        <button class="vtb-win-btn full"   id="visioFullBtn"   title="Plein √©cran">+</button>
    </div>
</div>

<!-- Zone Jitsi -->
<div id="visioIframeWrap">
    <!-- Ecran de chargement -->
    <div id="visioLoading">
        <div class="vl-spinner"></div>
        <div class="vl-text">Connexion √† la salle...</div>
        <div class="vl-room" id="visioLoadingRoom">‚Äî</div>
        <div style="color:rgba(255,255,255,.4);font-size:12px;text-align:center;max-width:260px;line-height:1.8;">
            Jitsi Meet s'ouvre directement ici.<br>Aucun lien externe, aucune redirection.
        </div>
    </div>
    <!-- L'iframe Jitsi sera inject√©e ici -->
</div>

<!-- Barre d'outils -->
<div id="visioToolbar">
    <!-- Lien d'invitation -->
    <div id="visioInviteBox">
        <input id="visioInviteInput" readonly placeholder="Lien d'invitation..." />
        <button id="visioCopyBtn">üìã Copier</button>
    </div>
    <!-- Bouton PiP -->
    <button class="vt-btn" id="visioToolPip">
        <span class="vt-icon">üìå</span>
        <span>R√©duire</span>
    </button>
    <!-- Bouton plein √©cran -->
    <button class="vt-btn" id="visioToolFull">
        <span class="vt-icon">‚õ∂</span>
        <span>Plein √©cran</span>
    </button>
    <!-- Raccrocher -->
    <button class="vt-btn danger" id="visioToolHangup">
        <span class="vt-icon">üìû</span>
        <span>Raccrocher</span>
    </button>
</div>
```

</div>

<audio id="notifSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2ozHTh/rt3fwpFkOTyLs+Psu5hqS0ybtO3yvKF1V1mhue7yuqJzV1qiue/yuqJ0WVmiuu/zuqJ0WVqiuu/zuqJ0WVqiuu/zuqJ0WVqiuu/zuqJ0WVqiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu8=" type="audio/wav">
</audio>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

function logErr(label, err) {
    try {
        var msg = (err && (err.message || err.details || err.hint)) ? (err.message || err.details || err.hint) : String(err);
        console.log('ERR ' + label + ': ' + msg);
    } catch(e) { console.log('ERR ' + label); }
}

const supabase = createClient(
    'https://eeikriwrwuynwpzodbbt.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlaWtyaXdyd3V5bndwem9kYmJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NzQ3NjYsImV4cCI6MjA4NjE1MDc2Nn0.MJ6CSmrttEWcrdfy5C7nP4sE_pe19sGNE-WasASPDNc'
);

/* ‚ïê‚ïê FINGERPRINT ‚ïê‚ïê */
function getOrCreateFingerprint() {
    var fp = localStorage.getItem('browserFingerprint');
    if (!fp) {
        fp = Math.random().toString(36).slice(2) + Date.now().toString(36);
        localStorage.setItem('browserFingerprint', fp);
    }
    return fp;
}

/* ‚ïê‚ïê UTILISATEUR COURANT ‚ïê‚ïê */
var currentUserPhoto    = null;
var currentUserPrenom   = localStorage.getItem('prenom') || 'Invit√©';
var fingerprint         = getOrCreateFingerprint();
var currentUniqueId     = currentUserPrenom + '_' + fingerprint;
var savedPhotoUrl       = localStorage.getItem('userPhotoUrl') || localStorage.getItem('tempPhotoPreview');

(function initPhoto() {
    var el = document.getElementById('userProfilePhoto');
    if (savedPhotoUrl) { el.innerHTML = '<img src="' + savedPhotoUrl + '" alt="Profil">'; currentUserPhoto = savedPhotoUrl; }
    else el.textContent = 'üí¨';
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SYST√àME VISIO JITSI MEET
   - Salle unique par conversation (pr√©nom1_pr√©nom2)
   - 100% dans la page, aucun lien externe
   - Draggable en mode PiP
   - Plein √©cran, r√©ductible
   - Gratuit, illimit√©, multi-participants
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

var visioState = {
    open:       false,
    pip:        false,
    fullscreen: false,
    roomName:   null,
    dragging:   false,
    dragOffX:   0,
    dragOffY:   0
};

var elOverlay   = document.getElementById('visioOverlay');
var elContainer = document.getElementById('visioContainer');
var elIframeWrap= document.getElementById('visioIframeWrap');
var elLoading   = document.getElementById('visioLoading');
var elTitleBar  = document.getElementById('visioTitleBar');
var elTitleText = document.getElementById('visioTitleText');
var elRoomInfo  = document.getElementById('visioRoomInfo');
var elLoadRoom  = document.getElementById('visioLoadingRoom');
var elInvite    = document.getElementById('visioInviteInput');
var elCopyBtn   = document.getElementById('visioCopyBtn');

/* G√©n√®re un nom de salle stable √† partir de la conversation */
function buildRoomName(chatType, otherPrenom) {
    var prefix = 'BubbleChat';
    if (chatType === 'public') return prefix + 'General';
    var names = [currentUserPrenom.toLowerCase(), (otherPrenom || 'user').toLowerCase()].sort();
    return prefix + names[0].replace(/[^a-z0-9]/g,'') + names[1].replace(/[^a-z0-9]/g,'');
}

var jitsiApi = null; // instance Jitsi External API

/* Charge le script Jitsi External API si pas encore charg√© */
function loadJitsiScript(cb) {
    if (window.JitsiMeetExternalAPI) { cb(); return; }
    var s = document.createElement('script');
    s.src = 'https://meet.jit.si/external_api.js';
    s.onload  = cb;
    s.onerror = function() { console.error('Impossible de charger Jitsi'); };
    document.head.appendChild(s);
}

/* Ouvre la visio ‚Äî entr√©e directe, z√©ro √©cran interm√©diaire */
function openVisio(chatType, otherPrenom) {
    var roomName = buildRoomName(chatType, otherPrenom);
    visioState.roomName = roomName;
    visioState.open = true;
    visioState.pip  = false;
    visioState.fullscreen = false;

    // Affiche le container
    elOverlay.classList.add('open');
    elContainer.classList.add('open');
    elContainer.classList.remove('pip', 'fullscreen');

    // Reset position centr√©e
    elContainer.style.bottom = '';
    elContainer.style.right  = '';
    elContainer.style.top    = '50%';
    elContainer.style.left   = '50%';
    elContainer.style.transform = 'translate(-50%, -50%)';
    elContainer.style.width  = '';
    elContainer.style.height = '';

    // Titre
    var titleLabel = chatType === 'public' ? 'Visio ‚Äî Chat g√©n√©ral' : 'Visio avec ' + (otherPrenom || 'utilisateur');
    elTitleText.textContent = titleLabel;
    elRoomInfo.textContent  = 'Salle : ' + roomName;
    elLoadRoom.textContent  = roomName;

    // Lien d'invitation
    var inviteUrl = 'https://meet.jit.si/' + roomName;
    elInvite.value = inviteUrl;

    // Loader visible
    elLoading.classList.remove('hide');

    // Nettoie l'ancienne instance
    if (jitsiApi) { try { jitsiApi.dispose(); } catch(e){} jitsiApi = null; }
    elIframeWrap.querySelectorAll('iframe, div[id^="jitsiConference"]').forEach(function(el){ el.remove(); });

    // Lance Jitsi via External API (entr√©e instantan√©e)
    loadJitsiScript(function() {
        try {
            jitsiApi = new window.JitsiMeetExternalAPI('meet.jit.si', {
                roomName: roomName,
                parentNode: elIframeWrap,
                width: '100%',
                height: '100%',
                userInfo: {
                    displayName: currentUserPrenom || 'Invit√©'
                },
                configOverwrite: {
                    prejoinPageEnabled:        false,   // ‚Üê PAS d'√©cran de pr√©nom
                    prejoinConfig:             { enabled: false },
                    startWithAudioMuted:       false,
                    startWithVideoMuted:       false,
                    disableDeepLinking:        true,
                    disableInviteFunctions:    false,
                    enableWelcomePage:         false,
                    disableThirdPartyRequests: false,
                    defaultLanguage:           'fr',
                    toolbarButtons: [
                        'microphone','camera','desktop',
                        'fullscreen','hangup','chat',
                        'raisehand','tileview','videoquality'
                    ]
                },
                interfaceConfigOverwrite: {
                    SHOW_JITSI_WATERMARK:          false,
                    SHOW_WATERMARK_FOR_GUESTS:     false,
                    SHOW_BRAND_WATERMARK:          false,
                    SHOW_CHROME_EXTENSION_BANNER:  false,
                    MOBILE_APP_PROMO:              false,
                    HIDE_INVITE_MORE_HEADER:       false,
                    TOOLBAR_BUTTONS: [
                        'microphone','camera','desktop',
                        'fullscreen','hangup','chat',
                        'raisehand','tileview','videoquality'
                    ]
                }
            });

            // Masque le loader d√®s que la conf√©rence est pr√™te
            jitsiApi.addEventListener('videoConferenceJoined', function() {
                elLoading.classList.add('hide');
            });
            // Fallback : masque apr√®s 4s quoi qu'il arrive
            setTimeout(function() { elLoading.classList.add('hide'); }, 4000);

            // Si l'utilisateur raccroche depuis Jitsi ‚Üí ferme le modal
            jitsiApi.addEventListener('readyToClose', function() { closeVisio(); });

        } catch(err) {
            console.error('Jitsi API error:', err);
            elLoading.classList.add('hide');
        }
    });

    document.body.style.overflow = 'hidden';
}

/* Ferme la visio et coupe cam√©ra/micro */
function closeVisio() {
    visioState.open = false;
    visioState.pip  = false;
    visioState.fullscreen = false;

    elOverlay.classList.remove('open', 'pip-mode');
    elContainer.classList.remove('open', 'pip', 'fullscreen');

    // Dispose l'API Jitsi ‚Üí coupe proprement cam√©ra et micro
    if (jitsiApi) {
        try { jitsiApi.dispose(); } catch(e) {}
        jitsiApi = null;
    }
    // Nettoie tout r√©sidu DOM
    elIframeWrap.querySelectorAll('iframe, div').forEach(function(el) {
        if (el.id !== 'visioLoading') el.remove();
    });
    elLoading.classList.remove('hide');

    document.body.style.overflow = '';
    resetContainerPos();
}

/* Mode Picture-in-Picture */
function togglePip() {
    if (!visioState.open) return;
    visioState.pip = !visioState.pip;

    if (visioState.pip) {
        visioState.fullscreen = false;
        elContainer.classList.add('pip');
        elContainer.classList.remove('fullscreen');
        elOverlay.classList.add('pip-mode');
        // Position PiP fixe (CSS g√®re bottom/right)
        elContainer.style.transform = 'none';
        elContainer.style.top   = 'auto';
        elContainer.style.left  = 'auto';
        elContainer.style.width  = '';
        elContainer.style.height = '';
    } else {
        elContainer.classList.remove('pip');
        elOverlay.classList.remove('pip-mode');
        resetContainerPos();
    }
    document.body.style.overflow = visioState.pip ? '' : 'hidden';
}

/* Mode plein √©cran */
function toggleFullscreen() {
    if (!visioState.open) return;
    visioState.fullscreen = !visioState.fullscreen;

    if (visioState.fullscreen) {
        visioState.pip = false;
        elContainer.classList.add('fullscreen');
        elContainer.classList.remove('pip');
        elOverlay.classList.remove('pip-mode');
        elContainer.style.transform = 'none';
        elContainer.style.top    = '0';
        elContainer.style.left   = '0';
        elContainer.style.width  = '100vw';
        elContainer.style.height = '100vh';
        document.body.style.overflow = 'hidden';
    } else {
        elContainer.classList.remove('fullscreen');
        resetContainerPos();
        document.body.style.overflow = 'hidden';
    }
}

function resetContainerPos() {
    elContainer.style.bottom = '';
    elContainer.style.right  = '';
    elContainer.style.top    = '50%';
    elContainer.style.left   = '50%';
    elContainer.style.transform = 'translate(-50%, -50%)';
    elContainer.style.width  = '';
    elContainer.style.height = '';
}

/* Copier le lien d'invitation */
elCopyBtn.addEventListener('click', function() {
    navigator.clipboard.writeText(elInvite.value).then(function() {
        elCopyBtn.classList.add('copied');
        elCopyBtn.textContent = '‚úì Copi√© !';
        var toast = document.createElement('div');
        toast.className = 'copy-toast';
        toast.textContent = '‚úÖ Lien copi√© ‚Äî partagez-le pour inviter !';
        document.body.appendChild(toast);
        setTimeout(function() { toast.remove(); }, 2500);
        setTimeout(function() {
            elCopyBtn.classList.remove('copied');
            elCopyBtn.textContent = 'üìã Copier';
        }, 2500);
    }).catch(function() {
        elInvite.select();
        document.execCommand('copy');
    });
});

/* Boutons de la barre de titre */
document.getElementById('visioCloseBtn').addEventListener('click', closeVisio);
document.getElementById('visioPipBtn').addEventListener('click', togglePip);
document.getElementById('visioFullBtn').addEventListener('click', toggleFullscreen);

/* Boutons de la toolbar */
document.getElementById('visioToolPip').addEventListener('click', togglePip);
document.getElementById('visioToolFull').addEventListener('click', toggleFullscreen);
document.getElementById('visioToolHangup').addEventListener('click', closeVisio);

/* Bouton Visio dans le header du chat */
document.getElementById('visioBtn').addEventListener('click', function() {
    var chatType   = currentChatType;
    var otherPrenom = (currentChatType === 'private' && currentChatUser) ? currentChatUser.prenom : null;
    openVisio(chatType, otherPrenom);
});

/* Overlay click = ferme si non PiP */
elOverlay.addEventListener('click', function(e) {
    if (e.target === elOverlay && !visioState.pip) closeVisio();
});

/* ‚ïê‚ïê DRAG (mode PiP uniquement) ‚ïê‚ïê */
elContainer.addEventListener('mousedown', startDrag);
elContainer.addEventListener('touchstart', startDrag, { passive: true });
document.addEventListener('mousemove', onDrag);
document.addEventListener('touchmove', onDrag, { passive: false });
document.addEventListener('mouseup', stopDrag);
document.addEventListener('touchend', stopDrag);

function startDrag(e) {
    if (!visioState.pip) return;
    // Ne pas d√©clencher si clic sur bouton
    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.closest('button') || e.target.closest('input')) return;
    visioState.dragging = true;
    var rect = elContainer.getBoundingClientRect();
    var cx = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
    var cy = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
    visioState.dragOffX = cx - rect.left;
    visioState.dragOffY = cy - rect.top;
    elContainer.style.cursor = 'grabbing';
}

function onDrag(e) {
    if (!visioState.dragging || !visioState.pip) return;
    if (e.type === 'touchmove') e.preventDefault();
    var cx = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
    var cy = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
    var x = cx - visioState.dragOffX;
    var y = cy - visioState.dragOffY;
    // Contraindre dans la fen√™tre
    var w = elContainer.offsetWidth;
    var h = elContainer.offsetHeight;
    x = Math.max(0, Math.min(window.innerWidth  - w, x));
    y = Math.max(0, Math.min(window.innerHeight - h, y));
    elContainer.style.left   = x + 'px';
    elContainer.style.top    = y + 'px';
    elContainer.style.right  = 'auto';
    elContainer.style.bottom = 'auto';
    elContainer.style.transform = 'none';
}

function stopDrag() {
    visioState.dragging = false;
    elContainer.style.cursor = '';
}

/* Touche Echap = sortir plein √©cran ou fermer */
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (visioState.fullscreen) toggleFullscreen();
        else if (visioState.open && !visioState.pip) closeVisio();
    }
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SYST√àME DE NOTIFICATIONS PUSH
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var swRegistration = null;
var notifGranted   = false;

async function registerSW() {
    if (!('serviceWorker' in navigator)) return;
    try {
        swRegistration = await navigator.serviceWorker.register('/sw.js');
        updateNotifBtn();
    } catch(e) {}
}

async function requestNotifPermission() {
    if (!('Notification' in window)) {
        alert('Votre navigateur ne supporte pas les notifications.\nSur iPhone : installez l\'app via "Ajouter √† l\'√©cran d\'accueil" dans Safari.');
        return;
    }
    if (Notification.permission === 'granted') { notifGranted = true; updateNotifBtn(); return; }
    if (Notification.permission === 'denied')  { alert('Notifications bloqu√©es.\nVeuillez les autoriser dans les r√©glages de votre navigateur.'); return; }
    try {
        var result = await Notification.requestPermission();
        notifGranted = (result === 'granted');
        updateNotifBtn();
        if (notifGranted) sendPushNotif('BubbleChat üí¨', 'Notifications activ√©es ! üéâ', 'üåê');
    } catch(e) {}
}

function updateNotifBtn() {
    var btn = document.getElementById('notifBtn');
    if (!btn) return;
    var perm = ('Notification' in window) ? Notification.permission : 'unsupported';
    if (perm === 'granted')      { btn.textContent = 'üîî'; btn.classList.add('active'); btn.classList.remove('denied'); btn.title = 'Notifications activ√©es'; notifGranted = true; }
    else if (perm === 'denied')  { btn.textContent = 'üîï'; btn.classList.add('denied'); btn.classList.remove('active'); btn.title = 'Notifications bloqu√©es'; }
    else                         { btn.textContent = 'üîî'; btn.classList.remove('active','denied'); btn.title = 'Activer les notifications'; }
}

function sendPushNotif(title, body, senderPhoto) {
    try { var a = document.getElementById('notifSound'); if (a) { a.currentTime=0; a.play().catch(function(){}); } } catch(e) {}
    if (!document.hidden) return;
    if (!notifGranted) return;
    if (swRegistration && swRegistration.active) {
        swRegistration.active.postMessage({ type:'NEW_MESSAGE', title, body, icon:senderPhoto||'/icon-192.png', tag:'bubblechat-'+Date.now(), url:'/chat.html' });
    } else {
        try { new Notification(title, { body, icon:'/icon-192.png', badge:'/icon-192.png', vibrate:[200,100,200] }); } catch(e) {}
    }
}

document.getElementById('notifBtn').addEventListener('click', requestNotifPermission);
registerSW();
updateNotifBtn();

/* ‚ïê‚ïê TOGGLE SIDEBAR ‚ïê‚ïê */
var sidebarVisible = true;
var isMobile = function() { return window.innerWidth <= 600; };

document.getElementById('toggleSidebar').addEventListener('click', function() {
    sidebarVisible = !sidebarVisible;
    document.getElementById('usersPanel').classList.toggle('hidden', !sidebarVisible);
    document.getElementById('toggleIcon').textContent = sidebarVisible ? 'üë•' : 'üí¨';
    document.getElementById('toggleText').textContent  = sidebarVisible ? 'Profils' : 'Chat';
});

document.addEventListener('click', function(e) {
    if (isMobile() && sidebarVisible) {
        var panel     = document.getElementById('usersPanel');
        var toggle    = document.getElementById('toggleSidebar');
        var rightPane = document.getElementById('rightPanel');
        if (!panel.contains(e.target) && !toggle.contains(e.target) && !rightPane.contains(e.target)) {
            sidebarVisible = false;
            panel.classList.add('hidden');
            document.getElementById('toggleIcon').textContent = 'üí¨';
            document.getElementById('toggleText').textContent  = 'Chat';
        }
    }
});

/* ‚ïê‚ïê √âTAT GLOBAL ‚ïê‚ïê */
var currentChatType   = 'public';
var currentChatUser   = null;
var profiles          = [];
var pmBadges          = {};
var lastPublicMsgTime = null;
var lastPMId          = 0;
var pmPollInterval    = null;
var lastInboxId       = 0;

/* ‚ïê‚ïê COULEUR BULLES ‚ïê‚ïê */
var PRESETS = [
    { l:'Rose/Violet', v:'linear-gradient(135deg,#ff6b9d,#c06fff)' },
    { l:'Bleu',        v:'linear-gradient(135deg,#2196f3,#03a9f4)' },
    { l:'Vert',        v:'linear-gradient(135deg,#43e97b,#38f9d7)' },
    { l:'Orange',      v:'linear-gradient(135deg,#f7971e,#ffd200)' },
    { l:'Rouge',       v:'linear-gradient(135deg,#f44336,#e91e63)' },
    { l:'Indigo',      v:'linear-gradient(135deg,#5c6bc0,#7c4dff)' },
    { l:'Cyan',        v:'linear-gradient(135deg,#00bcd4,#26c6da)'  },
    { l:'Noir',        v:'linear-gradient(135deg,#2d2d2d,#555)'     },
];
var myBubbleStyle = localStorage.getItem('myBubbleStyle') || PRESETS[0].v;

function buildColorSwatches() {
    var c = document.getElementById('colorSwatches');
    c.innerHTML = '';
    PRESETS.forEach(function(p) {
        var sw = document.createElement('div');
        sw.className = 'color-swatch' + (myBubbleStyle === p.v ? ' active' : '');
        sw.style.background = p.v;
        sw.title = p.l;
        sw.addEventListener('click', function() {
            c.querySelectorAll('.color-swatch').forEach(function(s) { s.classList.remove('active'); });
            sw.classList.add('active');
            myBubbleStyle = p.v;
            localStorage.setItem('myBubbleStyle', p.v);
            document.querySelectorAll('.pm-msg.sent').forEach(function(b) { b.style.background = p.v; });
        });
        c.appendChild(sw);
    });
}
buildColorSwatches();

document.getElementById('customColorInput').addEventListener('input', function(e) {
    var hex = e.target.value;
    document.querySelectorAll('.color-swatch').forEach(function(s) { s.classList.remove('active'); });
    myBubbleStyle = hex;
    localStorage.setItem('myBubbleStyle', hex);
    document.querySelectorAll('.pm-msg.sent').forEach(function(b) { b.style.background = hex; });
});

/* ‚ïê‚ïê STATUT EN LIGNE ‚ïê‚ïê */
async function setOnlineStatus(online) {
    try { await supabase.from('profiles').update({ is_online: online, last_seen: new Date().toISOString() }).eq('unique_id', currentUniqueId); } catch(e) {}
}
setOnlineStatus(true);
setInterval(function() { setOnlineStatus(true); }, 30000);
window.addEventListener('beforeunload', function() { setOnlineStatus(false); });
document.addEventListener('visibilitychange', function() { setOnlineStatus(!document.hidden); });

/* ‚ïê‚ïê PROFILS ‚ïê‚ïê */
async function loadProfiles() {
    try {
        var res = await supabase.from('profiles').select('unique_id, prenom, photo_url, is_online, last_seen').order('is_online', { ascending: false }).order('prenom', { ascending: true });
        if (res.error) return;
        profiles = (res.data || []).filter(function(p) { return p.unique_id !== currentUniqueId; }).map(function(p) { return { unique_id: p.unique_id||'', prenom: p.prenom||'Anonyme', photo_url: p.photo_url||null, is_online: !!p.is_online }; });
        renderProfiles();
    } catch(e) {}
}

function renderProfiles() {
    var container = document.getElementById('profileList');
    var countEl   = document.getElementById('profileCount');
    container.innerHTML = '';
    var onlineCount = profiles.filter(function(p) { return p.is_online; }).length;
    countEl.textContent = profiles.length + ' utilisateur' + (profiles.length > 1 ? 's' : '') + ' ¬∑ ' + onlineCount + ' en ligne';
    profiles.forEach(function(profile) {
        var item = document.createElement('div');
        item.className = 'user-item' + (currentChatType === 'private' && currentChatUser && currentChatUser.unique_id === profile.unique_id ? ' active' : '');
        item.dataset.uid = profile.unique_id;
        var av = document.createElement('div');
        av.className = 'user-avatar';
        av.innerHTML = profile.photo_url ? '<img src="' + profile.photo_url + '" alt="' + esc(profile.prenom) + '">' : profile.prenom[0].toUpperCase();
        var dot = document.createElement('div');
        dot.className = 'status-dot ' + (profile.is_online ? 'online' : 'offline');
        av.appendChild(dot);
        var info = document.createElement('div');
        info.className = 'user-info';
        info.innerHTML = '<div class="user-name">' + esc(profile.prenom) + '</div><div class="user-status-txt ' + (profile.is_online ? 'online' : 'offline') + '">' + (profile.is_online ? '‚óè En ligne' : '‚óè Hors ligne') + '</div>';
        item.appendChild(av);
        item.appendChild(info);
        var unread = pmBadges[profile.unique_id] || 0;
        if (unread > 0) { var badge = document.createElement('div'); badge.className='notif-badge'; badge.textContent=unread>99?'99+':unread; item.appendChild(badge); }
        item.addEventListener('click', function() {
            switchToPrivateChat(profile);
            if (isMobile()) { sidebarVisible=false; document.getElementById('usersPanel').classList.add('hidden'); document.getElementById('toggleIcon').textContent='üí¨'; document.getElementById('toggleText').textContent='Chat'; }
        });
        container.appendChild(item);
    });
}

setInterval(loadProfiles, 5000);
loadProfiles();

/* ‚ïê‚ïê INBOX POLLING ‚ïê‚ïê */
async function pollInbox() {
    try {
        var res = await supabase.from('private_messages').select('id, sender_unique_id, message').eq('receiver_unique_id', currentUniqueId).eq('is_read', false).gt('id', lastInboxId).order('id', { ascending: true });
        if (res.error || !res.data || !res.data.length) return;
        res.data.forEach(function(msg) {
            if (msg.id > lastInboxId) lastInboxId = msg.id;
            var sid = msg.sender_unique_id;
            if (!(currentChatType === 'private' && currentChatUser && currentChatUser.unique_id === sid)) {
                pmBadges[sid] = (pmBadges[sid] || 0) + 1;
                renderProfiles();
                showToast(msg, sid);
                var sender = profiles.find(function(p) { return p.unique_id === sid; });
                sendPushNotif('üíå ' + (sender ? sender.prenom : 'Quelqu\'un'), msg.message === '‚ö° WIZZ !' ? '‚ö° WIZZ !' : msg.message, sender ? sender.photo_url : null);
            }
        });
    } catch(e) {}
}
setInterval(pollInbox, 3000);

function showToast(msg, senderId) {
    var sender = profiles.find(function(p) { return p.unique_id === senderId; });
    var name   = sender ? sender.prenom : 'Quelqu\'un';
    var toast  = document.createElement('div');
    toast.className = 'pm-toast';
    toast.innerHTML = '<div class="pm-toast-name">üíå ' + esc(name) + '</div><div class="pm-toast-text">' + esc(msg.message) + '</div>';
    toast.addEventListener('click', function() { var prof = profiles.find(function(p) { return p.unique_id === senderId; }); if (prof) switchToPrivateChat(prof); toast.remove(); });
    document.body.appendChild(toast);
    setTimeout(function() { toast.style.opacity='0'; setTimeout(function() { toast.remove(); }, 400); }, 5000);
}

/* ‚ïê‚ïê WIZZ ‚ïê‚ïê */
document.getElementById('wizzBtn').addEventListener('click', async function() {
    if (!currentChatUser) return;
    document.getElementById('rightPanel').classList.add('wizzing');
    setTimeout(function() { document.getElementById('rightPanel').classList.remove('wizzing'); }, 600);
    try { await supabase.from('private_messages').insert({ sender_unique_id: currentUniqueId, receiver_unique_id: currentChatUser.unique_id, message: '‚ö° WIZZ !', is_read: false }); } catch(e) {}
});

/* ‚ïê‚ïê CHAT PUBLIC ‚ïê‚ïê */
async function loadPublicMessages() {
    try {
        var query = supabase.from('messages').select('id, prenom, message, created_at, photo_url').is('to_user', null).order('created_at', { ascending: true }).limit(60);
        if (lastPublicMsgTime) query = query.gt('created_at', lastPublicMsgTime);
        var res = await query;
        if (res.error || !res.data || !res.data.length) return;
        var isFirst = !lastPublicMsgTime;
        if (isFirst) document.getElementById('messagesArea').innerHTML = '';
        res.data.forEach(function(msg) {
            if (!lastPublicMsgTime || msg.created_at > lastPublicMsgTime) lastPublicMsgTime = msg.created_at;
            if (currentChatType === 'public') {
                var isNew = !isFirst && msg.prenom !== currentUserPrenom;
                renderPublicMessage({ author: msg.prenom||'Anonyme', text: msg.message, photo: msg.photo_url, time: fmtTime(msg.created_at) });
                if (isNew) sendPushNotif('üåê ' + (msg.prenom||'Anonyme'), msg.message, msg.photo_url||'/icon-192.png');
            }
        });
    } catch(e) {}
}

function renderPublicMessage(opts) {
    var area = document.getElementById('messagesArea');
    var el = document.createElement('div');
    el.className = 'message';
    var av = document.createElement('div');
    av.className = 'message-avatar';
    av.innerHTML = opts.photo ? '<img src="' + opts.photo + '" alt="' + esc(opts.author) + '">' : (opts.author ? opts.author[0] : '?').toUpperCase();
    var content = document.createElement('div');
    content.className = 'message-content';
    content.innerHTML = '<div class="message-author">' + esc(opts.author) + '</div><div class="message-text">' + esc(opts.text) + '</div><div class="message-time">' + opts.time + '</div>';
    el.appendChild(av); el.appendChild(content);
    area.appendChild(el);
    area.scrollTop = area.scrollHeight;
}

async function sendPublicMessage(text) {
    renderPublicMessage({ author: currentUserPrenom, text: text, photo: currentUserPhoto, time: fmtTime(new Date().toISOString()) });
    try {
        var res = await supabase.from('messages').insert({ prenom: currentUserPrenom, message: text, photo_url: currentUserPhoto||null, to_user: null }).select('created_at').single();
        if (!res.error && res.data && res.data.created_at && (!lastPublicMsgTime || res.data.created_at > lastPublicMsgTime)) lastPublicMsgTime = res.data.created_at;
    } catch(e) {}
}

setInterval(loadPublicMessages, 2500);

/* ‚ïê‚ïê CHANGEMENT DE VUE ‚ïê‚ïê */
function setHeader(avatarHtml, name, statusTxt, isOnline, showWizz) {
    document.getElementById('chatHeaderAvatar').innerHTML = avatarHtml;
    document.getElementById('chatHeaderName').textContent = name;
    var st = document.getElementById('chatHeaderStatus');
    st.className  = 'chat-panel-header-status ' + (isOnline ? 'online' : 'offline');
    st.textContent = statusTxt;
    document.getElementById('wizzBtn').style.display = showWizz ? 'block' : 'none';
    // Le bouton visio reste toujours visible
}

function switchToPublicChat() {
    if (pmPollInterval) { clearInterval(pmPollInterval); pmPollInterval = null; }
    currentChatType   = 'public';
    currentChatUser   = null;
    lastPublicMsgTime = null;
    setHeader('üåê', 'Chat g√©n√©ral', '‚óè Public', true, false);
    document.getElementById('bubbleColorPicker').style.display = 'none';
    document.querySelectorAll('.user-item').forEach(function(i) { i.classList.remove('active'); });
    document.getElementById('publicChatBtn').classList.add('active');
    document.getElementById('messagesArea').innerHTML = '';
    loadPublicMessages();
}

function switchToPrivateChat(profile) {
    if (pmPollInterval) { clearInterval(pmPollInterval); pmPollInterval = null; }
    currentChatType = 'private';
    currentChatUser = profile;
    lastPMId        = 0;
    pmBadges[profile.unique_id] = 0;
    var avHtml = profile.photo_url ? '<img src="' + profile.photo_url + '" alt="' + esc(profile.prenom) + '">' : profile.prenom[0].toUpperCase();
    setHeader(avHtml, profile.prenom, profile.is_online ? 'üü¢ En ligne' : 'üî¥ Hors ligne', profile.is_online, true);
    document.getElementById('bubbleColorPicker').style.display = 'flex';
    document.querySelectorAll('.user-item').forEach(function(i) { i.classList.remove('active'); });
    document.querySelectorAll('.user-item[data-uid="' + profile.unique_id + '"]').forEach(function(i) { i.classList.add('active'); });
    document.getElementById('publicChatBtn').classList.remove('active');
    loadPMHistory(profile.unique_id);
    markAllRead(profile.unique_id);
    document.querySelectorAll('.notif-badge').forEach(function(b) { var item = b.closest('.user-item'); if (item && item.dataset.uid === profile.unique_id) b.remove(); });
    pmPollInterval = setInterval(function() { pollNewPMs(profile.unique_id); }, 2500);
}

document.getElementById('publicChatBtn').addEventListener('click', function() {
    switchToPublicChat();
    if (isMobile()) { sidebarVisible=false; document.getElementById('usersPanel').classList.add('hidden'); document.getElementById('toggleIcon').textContent='üí¨'; document.getElementById('toggleText').textContent='Chat'; }
});

/* ‚ïê‚ïê MESSAGES PRIV√âS ‚ïê‚ïê */
async function loadPMHistory(otherId) {
    var area = document.getElementById('messagesArea');
    area.innerHTML = '<div class="pm-empty"><span class="pm-empty-icon">üí¨</span>Chargement...</div>';
    try {
        var res = await supabase.from('private_messages').select('id, sender_unique_id, message, created_at, is_read').or('and(sender_unique_id.eq.' + currentUniqueId + ',receiver_unique_id.eq.' + otherId + '),and(sender_unique_id.eq.' + otherId + ',receiver_unique_id.eq.' + currentUniqueId + ')').order('created_at', { ascending: true }).limit(150);
        if (res.error) { area.innerHTML = '<div class="pm-empty"><span class="pm-empty-icon">‚ö†Ô∏è</span>Erreur chargement</div>'; return; }
        area.innerHTML = '';
        if (!res.data || !res.data.length) { area.innerHTML = '<div class="pm-empty"><span class="pm-empty-icon">üíå</span>Aucun message</div>'; return; }
        res.data.forEach(function(msg) { if (msg.id > lastPMId) lastPMId = msg.id; appendPMBubble({ id: msg.id, text: msg.message, fromMe: msg.sender_unique_id === currentUniqueId, time: fmtTime(msg.created_at), is_read: msg.is_read }); });
        area.scrollTop = area.scrollHeight;
    } catch(e) {}
}

function appendPMBubble(msg) {
    var area  = document.getElementById('messagesArea');
    var empty = area.querySelector('.pm-empty');
    if (empty) empty.remove();
    var wrap = document.createElement('div');
    wrap.className = 'pm-msg-wrap ' + (msg.fromMe ? 'sent' : 'received');
    wrap.dataset.msgId = msg.id;
    var bubble = document.createElement('div');
    bubble.className = 'pm-msg ' + (msg.fromMe ? 'sent' : 'received');
    if (msg.fromMe) bubble.style.background = myBubbleStyle;
    var tick = msg.fromMe ? '<span class="pm-tick ' + (msg.is_read ? 'read' : '') + '">' + (msg.is_read ? '‚úì‚úì' : '‚úì') + '</span>' : '';
    bubble.innerHTML = esc(msg.text) + '<div class="pm-msg-meta">' + msg.time + ' ' + tick + '</div>';
    wrap.appendChild(bubble);
    area.appendChild(wrap);
    area.scrollTop = area.scrollHeight;
}

async function sendPM() {
    if (!currentChatUser) return;
    var input = document.getElementById('messageInput');
    var text  = input.value.trim();
    if (!text) return;
    input.value = '';
    var tempId = 'tmp-' + Date.now();
    appendPMBubble({ id: tempId, text: text, fromMe: true, time: fmtTime(new Date().toISOString()), is_read: false });
    try {
        var res = await supabase.from('private_messages').insert({ sender_unique_id: currentUniqueId, receiver_unique_id: currentChatUser.unique_id, message: text, is_read: false }).select('id').single();
        if (res.error) { var el2 = document.querySelector('[data-msg-id="' + tempId + '"]'); if (el2) el2.remove(); input.value = text; return; }
        var el = document.querySelector('[data-msg-id="' + tempId + '"]');
        if (el && res.data) { el.dataset.msgId = res.data.id; if (res.data.id > lastPMId) lastPMId = res.data.id; }
    } catch(e) {}
}

async function pollNewPMs(otherId) {
    if (currentChatType !== 'private' || !currentChatUser || currentChatUser.unique_id !== otherId) return;
    try {
        var res = await supabase.from('private_messages').select('id, message, created_at, is_read').eq('sender_unique_id', otherId).eq('receiver_unique_id', currentUniqueId).gt('id', lastPMId).order('id', { ascending: true });
        if (res.error || !res.data || !res.data.length) return;
        res.data.forEach(function(msg) { if (msg.id > lastPMId) lastPMId = msg.id; appendPMBubble({ id: msg.id, text: msg.message, fromMe: false, time: fmtTime(msg.created_at), is_read: false }); markRead(msg.id); });
        if (res.data.some(function(m) { return m.message === '‚ö° WIZZ !'; })) { document.getElementById('rightPanel').classList.add('wizzing'); setTimeout(function() { document.getElementById('rightPanel').classList.remove('wizzing'); }, 600); }
    } catch(e) {}
}

async function markRead(id) { try { await supabase.from('private_messages').update({ is_read: true }).eq('id', id); } catch(e) {} }
async function markAllRead(senderId) { try { await supabase.from('private_messages').update({ is_read: true }).eq('receiver_unique_id', currentUniqueId).eq('sender_unique_id', senderId).eq('is_read', false); } catch(e) {} }

/* ‚ïê‚ïê ENVOI UNIFI√â ‚ïê‚ïê */
function sendMessage() {
    var input = document.getElementById('messageInput');
    var text  = input.value.trim();
    if (!text) return;
    if (currentChatType === 'public') { sendPublicMessage(text); input.value = ''; }
    else sendPM();
}
document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('messageInput').addEventListener('keypress', function(e) { if (e.key === 'Enter') sendMessage(); });

/* ‚ïê‚ïê TH√àMES ‚ïê‚ïê */
document.querySelectorAll('.theme-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        document.body.className = ''; document.body.style.backgroundImage = '';
        document.querySelectorAll('.theme-btn').forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        document.body.classList.add('theme-' + btn.dataset.theme);
    });
});
document.getElementById('customBgInput').addEventListener('change', function(e) {
    var file = e.target.files[0]; if (!file) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
        document.body.className = 'custom-bg';
        document.body.style.backgroundImage = 'url(' + ev.target.result + ')';
        document.querySelectorAll('.theme-btn').forEach(function(b) { b.classList.remove('active'); });
    };
    reader.readAsDataURL(file);
});

/* ‚ïê‚ïê PARTICULES ‚ïê‚ïê */
(function() {
    var c = document.getElementById('particles');
    for (var i = 0; i < 40; i++) {
        var p = document.createElement('div');
        p.className = 'particle';
        p.style.left = (Math.random() * 100) + '%';
        p.style.animationDelay    = (Math.random() * 20) + 's';
        p.style.animationDuration = (Math.random() * 15 + 15) + 's';
        c.appendChild(p);
    }
})();

/* ‚ïê‚ïê UTILS ‚ïê‚ïê */
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function fmtTime(iso) {
    if (!iso) return '';
    var d = new Date(iso), now = new Date();
    var hm = d.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
    return d.toDateString() === now.toDateString() ? hm : d.toLocaleDateString('fr-FR', { day:'2-digit', month:'2-digit' }) + ' ' + hm;
}

/* ‚ïê‚ïê INIT ‚ïê‚ïê */
switchToPublicChat();
</script>

</body>
</html>

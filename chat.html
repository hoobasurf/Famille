<!DOCTYPE html>

<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BubbleChat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

body {
font-family: ‚ÄòSegoe UI‚Äô, Tahoma, Geneva, Verdana, sans-serif;
min-height: 100vh;
position: relative;
overflow-x: hidden;
transition: background 0.8s ease;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* Th√®mes */
body.theme-zen { background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 50%, #80deea 100%); }
body.theme-plage { background: linear-gradient(135deg, #ffd89b 0%, #f4a460 50%, #19547b 100%); }
body.theme-foret { background: linear-gradient(135deg, #134e5e 0%, #3a7e6f 50%, #71b280 100%); }
body.theme-futuriste { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
body.theme-bonbon { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ff9a9e 100%); }

/* Particules */
.particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
.particle { position: absolute; width: 3px; height: 3px; background: rgba(255, 255, 255, 0.5); border-radius: 50%; animation: float 20s infinite ease-in-out; }
@keyframes float { 0%, 100% { transform: translateY(0) translateX(0); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-100vh) translateX(50px); opacity: 0; } }

/* Container */
.chat-container { position: relative; max-width: 1200px; margin: 0 auto; padding: 20px; min-height: 100vh; z-index: 1; }

/* Header - PLUS TRANSPARENT */
.chat-header { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(30px); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.2); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
.header-left { display: flex; align-items: center; gap: 15px; }
.user-avatar { width: 50px; height: 50px; border-radius: 50%; border: 3px solid rgba(255, 255, 255, 0.5); object-fit: cover; background: rgba(255, 255, 255, 0.1); display: flex; align-items: center; justify-content: center; font-size: 24px; }
.user-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
.chat-title { font-size: 28px; font-weight: bold; color: white; text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3); }
.header-right { display: flex; gap: 10px; align-items: center; }
.logout-btn { padding: 10px 20px; background: rgba(255, 255, 255, 0.1); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 12px; color: white; cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
.logout-btn:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }

/* Th√®mes */
.theme-selector { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.theme-label { color: white; font-weight: 600; text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); }
.theme-options { display: flex; gap: 8px; flex-wrap: wrap; }
.theme-btn { width: 45px; height: 45px; border-radius: 50%; border: 3px solid rgba(255, 255, 255, 0.4); cursor: pointer; transition: all 0.3s ease; }
.theme-btn:hover { transform: scale(1.15); border-color: white; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3); }
.theme-btn.active { border-color: white; box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.3); }

/* Conversation priv√©e */
.conversation-title { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(30px); border-radius: 15px; padding: 15px 20px; margin-bottom: 15px; border: 1px solid rgba(255, 255, 255, 0.2); display: flex; align-items: center; justify-content: space-between; }
.conversation-info { display: flex; align-items: center; gap: 12px; }
.conversation-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.5); object-fit: cover; background: rgba(255, 255, 255, 0.1); font-size: 20px; display: flex; align-items: center; justify-content: center; }
.conversation-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
.conversation-name { color: white; font-weight: 600; font-size: 18px; text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); }
.back-to-general { padding: 8px 16px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 10px; color: white; cursor: pointer; font-size: 14px; transition: all 0.3s ease; }
.back-to-general:hover { background: rgba(255, 255, 255, 0.2); }

/* Messages - PLUS TRANSPARENT */
.messages-area { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(30px); border-radius: 20px; padding: 20px; height: 500px; overflow-y: auto; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.2); }
.message { background: rgba(255, 255, 255, 0.1); padding: 12px 18px; border-radius: 15px; margin-bottom: 12px; color: white; animation: slideIn 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.15); }
@keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.message-author { font-weight: bold; margin-bottom: 5px; font-size: 14px; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3); display: flex; align-items: center; gap: 8px; }
.message-author-avatar { width: 24px; height: 24px; border-radius: 50%; border: 2px solid rgba(255, 255, 255, 0.5); object-fit: cover; }
.message-text { font-size: 16px; }
.message-time { font-size: 11px; opacity: 0.7; text-align: right; margin-top: 5px; }

/* Input - PLUS TRANSPARENT */
.input-area { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(30px); border-radius: 20px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.2); display: flex; gap: 10px; }
.message-input { flex: 1; padding: 15px 20px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 15px; color: white; font-size: 16px; transition: all 0.3s ease; }
.message-input:focus { outline: none; background: rgba(255, 255, 255, 0.15); border-color: rgba(255, 255, 255, 0.4); }
.message-input::placeholder { color: rgba(255, 255, 255, 0.6); }
.send-btn { padding: 15px 35px; background: linear-gradient(135deg, #ff6b9d 0%, #c06fff 100%); border: none; border-radius: 15px; color: white; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 20px rgba(192, 111, 255, 0.4); }
.send-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 30px rgba(192, 111, 255, 0.6); }

/* Sidebar - PLUS TRANSPARENT */
#profileSidebar { position: fixed; left: 0; top: 0; width: 280px; height: 100vh; background: rgba(0, 0, 0, 0.15); backdrop-filter: blur(30px); padding: 20px; overflow-y: auto; z-index: 100; transform: translateX(-100%); transition: transform 0.3s ease; border-right: 1px solid rgba(255, 255, 255, 0.15); }
#profileSidebar.open { transform: translateX(0); }
.sidebar-header { margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; }
.sidebar-title { color: white; font-weight: 600; font-size: 18px; text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3); padding-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
.create-group-btn { padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 12px; color: white; cursor: pointer; font-weight: 600; text-align: center; transition: all 0.3s ease; }
.create-group-btn:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }

#toggleProfileSidebar { position: fixed; left: 20px; top: 20px; width: 50px; height: 50px; background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1000; font-size: 22px; transition: all 0.3s ease; color: white; }
#toggleProfileSidebar:hover { background: rgba(255, 255, 255, 0.15); transform: scale(1.05); }

.profile-list { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
.profile-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; transition: all 0.3s; cursor: pointer; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); }
.profile-item:hover { background: rgba(255, 255, 255, 0.15); transform: translateX(5px); }
.profile-item.active { background: rgba(255, 255, 255, 0.2); border-color: rgba(255, 255, 255, 0.3); }
.profile-photo { width: 42px; height: 42px; border-radius: 50%; background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.4); overflow: hidden; flex-shrink: 0; position: relative; display: flex; align-items: center; justify-content: center; font-size: 20px; }
.profile-photo img { width: 100%; height: 100%; object-fit: cover; }
.status-dot { position: absolute; bottom: -1px; right: -1px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid rgba(0, 0, 0, 0.3); }
.status-dot.online { background: #4caf50; box-shadow: 0 0 8px #4caf50; }
.status-dot.offline { background: #f44336; }
.profile-name { color: white; font-weight: 600; font-size: 14px; text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4); flex: 1; }

/* Scrollbars */
.messages-area::-webkit-scrollbar, #profileSidebar::-webkit-scrollbar { width: 6px; }
.messages-area::-webkit-scrollbar-track, #profileSidebar::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 10px; }
.messages-area::-webkit-scrollbar-thumb, #profileSidebar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }

@media (max-width: 768px) {
.chat-header { flex-direction: column; align-items: flex-start; }
.theme-selector { width: 100%; }
#profileSidebar { width: 250px; }
}
</style>

</head>
<body class="theme-futuriste">
    <div id="toggleProfileSidebar">üë•</div>

```
<div id="profileSidebar">
    <div class="sidebar-header">
        <div class="sidebar-title">üí¨ Conversations</div>
        <button class="create-group-btn" id="createGroupBtn">‚ûï Cr√©er un groupe</button>
    </div>
    <div class="profile-list" id="profileList"></div>
</div>

<div class="particles" id="particles"></div>

<div class="chat-container">
    <div class="chat-header">
        <div class="header-left">
            <div class="user-avatar" id="currentUserAvatar">üë§</div>
            <div class="chat-title" id="chatTitle">Chat G√©n√©ral</div>
        </div>
        <div class="header-right">
            <div class="theme-selector">
                <span class="theme-label">Th√®me :</span>
                <div class="theme-options">
                    <div class="theme-btn" data-theme="zen" style="background: linear-gradient(135deg, #e0f7fa 0%, #80deea 100%);" title="Zen"></div>
                    <div class="theme-btn" data-theme="plage" style="background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);" title="Plage"></div>
                    <div class="theme-btn" data-theme="foret" style="background: linear-gradient(135deg, #134e5e 0%, #71b280 100%);" title="For√™t"></div>
                    <div class="theme-btn active" data-theme="futuriste" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" title="Futuriste"></div>
                    <div class="theme-btn" data-theme="bonbon" style="background: linear-gradient(135deg, #ffecd2 0%, #ff9a9e 100%);" title="Bonbon"></div>
                </div>
            </div>
            <button class="logout-btn" id="logoutBtn">üö™ D√©connexion</button>
        </div>
    </div>

    <div class="conversation-title" id="conversationTitle" style="display: none;">
        <div class="conversation-info">
            <div class="conversation-avatar" id="conversationAvatar">üë§</div>
            <div class="conversation-name" id="conversationName"></div>
        </div>
        <button class="back-to-general" id="backToGeneral">‚Üê Chat G√©n√©ral</button>
    </div>

    <div class="messages-area" id="messagesArea"></div>

    <div class="input-area">
        <input type="text" class="message-input" id="messageInput" placeholder="Tapez votre message...">
        <button class="send-btn" id="sendBtn">Envoyer üöÄ</button>
    </div>
</div>
```

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://eeikriwrwuynwpzodbbt.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlaWtyaXdyd3V5bndwem9kYmJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NzQ3NjYsImV4cCI6MjA4NjE1MDc2Nn0.MJ6CSmrttEWcrdfy5C7nP4sE_pe19sGNE-WasASPDNc"
);

const currentUser = localStorage.getItem('prenom');
const userPhotoUrl = localStorage.getItem('userPhotoUrl');
let currentConversation = 'general'; // 'general' ou nom d'utilisateur
let profiles = {};

if (!currentUser) {
  window.location.href = 'index.html';
}

// Afficher photo utilisateur actuel
const currentUserAvatar = document.getElementById('currentUserAvatar');
if (userPhotoUrl) {
  currentUserAvatar.innerHTML = `<img src="${userPhotoUrl}" alt="${currentUser}">`;
}

// Particules
function createParticles() {
  const container = document.getElementById('particles');
  for(let i = 0; i < 30; i++) {
    const particle = document.createElement('div');
    particle.className = 'particle';
    particle.style.left = Math.random() * 100 + '%';
    particle.style.animationDelay = Math.random() * 20 + 's';
    particle.style.animationDuration = (Math.random() * 10 + 15) + 's';
    container.appendChild(particle);
  }
}
createParticles();

// Toggle sidebar
document.getElementById('toggleProfileSidebar').onclick = () => {
  document.getElementById('profileSidebar').classList.toggle('open');
};

// Th√®mes
document.querySelectorAll('.theme-btn').forEach(btn => {
  btn.onclick = () => {
    const theme = btn.dataset.theme;
    document.body.className = 'theme-' + theme;
    document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    localStorage.setItem('theme', theme);
  };
});

const savedTheme = localStorage.getItem('theme');
if (savedTheme) {
  document.body.className = 'theme-' + savedTheme;
  document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`[data-theme="${savedTheme}"]`)?.classList.add('active');
}

// Charger profils
async function loadProfiles() {
  const { data } = await supabase.from('profiles').select('*');
  const list = document.getElementById('profileList');
  list.innerHTML = '';
  
  if (data) {
    data.forEach(profile => {
      if (profile.prenom === currentUser) return; // Ne pas afficher soi-m√™me
      
      profiles[profile.prenom] = profile;
      
      const item = document.createElement('div');
      item.className = 'profile-item';
      item.onclick = () => openPrivateConversation(profile.prenom);
      
      const photo = document.createElement('div');
      photo.className = 'profile-photo';
      if (profile.photo_url) {
        photo.innerHTML = `<img src="${profile.photo_url}" alt="${profile.prenom}">`;
      } else {
        photo.textContent = profile.prenom[0].toUpperCase();
      }
      
      const dot = document.createElement('div');
      dot.className = `status-dot ${profile.is_online ? 'online' : 'offline'}`;
      photo.appendChild(dot);
      
      const name = document.createElement('div');
      name.className = 'profile-name';
      name.textContent = profile.prenom;
      
      item.appendChild(photo);
      item.appendChild(name);
      list.appendChild(item);
    });
  }
}

// Conversation priv√©e
function openPrivateConversation(username) {
  currentConversation = username;
  document.getElementById('profileSidebar').classList.remove('open');
  
  const profile = profiles[username];
  document.getElementById('conversationTitle').style.display = 'flex';
  document.getElementById('conversationName').textContent = username;
  
  const avatar = document.getElementById('conversationAvatar');
  if (profile?.photo_url) {
    avatar.innerHTML = `<img src="${profile.photo_url}" alt="${username}">`;
  } else {
    avatar.textContent = username[0].toUpperCase();
  }
  
  document.getElementById('chatTitle').textContent = `Chat avec ${username}`;
  document.getElementById('messagesArea').innerHTML = '';
  
  // Marquer comme actif
  document.querySelectorAll('.profile-item').forEach(item => {
    item.classList.remove('active');
    if (item.querySelector('.profile-name').textContent === username) {
      item.classList.add('active');
    }
  });
  
  loadMessages();
}

// Retour au chat g√©n√©ral
document.getElementById('backToGeneral').onclick = () => {
  currentConversation = 'general';
  document.getElementById('conversationTitle').style.display = 'none';
  document.getElementById('chatTitle').textContent = 'Chat G√©n√©ral';
  document.getElementById('messagesArea').innerHTML = '';
  document.querySelectorAll('.profile-item').forEach(item => {
    item.classList.remove('active');
  });
  loadMessages();
};

// Charger messages
async function loadMessages() {
  const { data } = await supabase
    .from('messages')
    .select('*')
    .order('created_at', { ascending: true })
    .limit(100);
  
  const area = document.getElementById('messagesArea');
  area.innerHTML = '';
  
  if (data) {
    data.forEach(msg => {
      // Filtrer selon la conversation actuelle
      if (currentConversation !== 'general') {
        // Messages priv√©s : afficher uniquement ceux entre currentUser et currentConversation
        const isRelevant = (msg.prenom === currentUser && msg.to_user === currentConversation) ||
                          (msg.prenom === currentConversation && msg.to_user === currentUser);
        if (!isRelevant) return;
      } else {
        // Chat g√©n√©ral : ne pas afficher les messages priv√©s
        if (msg.to_user) return;
      }
      
      displayMessage(msg);
    });
  }
  
  area.scrollTop = area.scrollHeight;
}

function displayMessage(msg) {
  const area = document.getElementById('messagesArea');
  const div = document.createElement('div');
  div.className = 'message';
  
  const profile = profiles[msg.prenom];
  let authorHTML = '<div class="message-author">';
  
  if (profile?.photo_url) {
    authorHTML += `<img src="${profile.photo_url}" class="message-author-avatar" alt="${msg.prenom}">`;
  }
  
  authorHTML += `${msg.prenom}</div>`;
  
  div.innerHTML = `
    ${authorHTML}
    <div class="message-text">${msg.message}</div>
    <div class="message-time">${new Date(msg.created_at).toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'})}</div>
  `;
  
  area.appendChild(div);
  area.scrollTop = area.scrollHeight;
}

// Envoyer message
async function sendMessage() {
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  if (!text) return;
  
  const messageData = {
    prenom: currentUser,
    message: text
  };
  
  // Si conversation priv√©e, ajouter le destinataire
  if (currentConversation !== 'general') {
    messageData.to_user = currentConversation;
  }
  
  await supabase.from('messages').insert([messageData]);
  input.value = '';
}

document.getElementById('sendBtn').onclick = sendMessage;
document.getElementById('messageInput').onkeypress = (e) => {
  if (e.key === 'Enter') sendMessage();
};

// Realtime
supabase
  .channel('messages')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'messages' }, (payload) => {
    if (payload.eventType === 'INSERT') {
      const msg = payload.new;
      
      // Afficher si pertinent pour la conversation actuelle
      if (currentConversation === 'general') {
        if (!msg.to_user) displayMessage(msg);
      } else {
        const isRelevant = (msg.prenom === currentUser && msg.to_user === currentConversation) ||
                          (msg.prenom === currentConversation && msg.to_user === currentUser);
        if (isRelevant) displayMessage(msg);
      }
    }
  })
  .subscribe();

supabase
  .channel('profiles')
  .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, () => {
    loadProfiles();
  })
  .subscribe();

// D√©connexion
document.getElementById('logoutBtn').onclick = async () => {
  await supabase.from('profiles').update({ is_online: false }).eq('prenom', currentUser);
  localStorage.removeItem('prenom');
  localStorage.removeItem('userPhotoUrl');
  window.location.href = 'index.html';
};

// Cr√©er groupe (placeholder)
document.getElementById('createGroupBtn').onclick = () => {
  alert('üöß Fonctionnalit√© en d√©veloppement !\nLes groupes seront bient√¥t disponibles.');
};

// Marquer comme en ligne
await supabase.from('profiles').update({ is_online: true }).eq('prenom', currentUser);

// Charger donn√©es initiales
await loadProfiles();
await loadMessages();

// D√©connexion au fermeture de la page
window.addEventListener('beforeunload', async () => {
  await supabase.from('profiles').update({ is_online: false }).eq('prenom', currentUser);
});
</script>

</body>
</html>

<!DOCTYPE html>

<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BubbleChat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            min-height: 100vh; 
            position: relative; 
            overflow-x: hidden; 
            transition: background 0.8s ease; 
        }
        body.theme-zen { background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 50%, #80deea 100%); }
        body.theme-plage { background: linear-gradient(135deg, #ffd89b 0%, #f4a460 50%, #19547b 100%); }
        body.theme-foret { background: linear-gradient(135deg, #134e5e 0%, #3a7e6f 50%, #71b280 100%); }
        body.theme-futuriste { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        body.theme-bonbon { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ff9a9e 100%); }
        body.theme-bar { background: linear-gradient(135deg, #2c003e 0%, #4b0082 50%, #8b008b 100%); }
        body.theme-chasse { background: linear-gradient(135deg, #3e2723 0%, #5d4037 50%, #795548 100%); }
        body.theme-aquarium { background: linear-gradient(135deg, #00416a 0%, #1976d2 33%, #4caf50 66%, #ffe000 100%); }
        body.custom-bg { background-size: cover !important; background-position: center !important; background-attachment: fixed !important; }

```
    .particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
    .particle { position: absolute; width: 3px; height: 3px; background: rgba(255,255,255,0.5); border-radius: 50%; animation: float 20s infinite ease-in-out; }
    @keyframes float { 0%,100% { transform: translateY(0) translateX(0); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-100vh) translateX(50px); opacity: 0; } }

    /* ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ */
    .app-wrapper { 
        position: relative; 
        z-index: 1; 
        max-width: 1500px; 
        margin: 0 auto; 
        padding: 20px; 
        min-height: 100vh; 
        display: flex; 
        flex-direction: column; 
        gap: 20px; 
    }

    /* ‚îÄ‚îÄ HEADER - 5% OPACIT√â (95% FOND VISIBLE) ‚îÄ‚îÄ */
    .chat-header { 
        background: rgba(255,255,255,0.05); 
        backdrop-filter: blur(10px); 
        border-radius: 20px; 
        padding: 20px 28px; 
        border: 1px solid rgba(255,255,255,0.15); 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        flex-wrap: wrap; 
        gap: 18px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    .theme-selector { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .theme-label { color: white; font-weight: 600; text-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    .theme-options { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .theme-btn { width: 45px; height: 45px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.5); cursor: pointer; transition: all 0.3s ease; }
    .theme-btn:hover { transform: scale(1.15); border-color: white; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
    .theme-btn.active { border-color: white; box-shadow: 0 0 0 4px rgba(255,255,255,0.3); }
    .theme-btn-custom { width: 45px; height: 45px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.5); background: linear-gradient(135deg, #fff 0%, #ccc 100%); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all 0.3s ease; position: relative; }
    .theme-btn-custom:hover { transform: scale(1.15); border-color: white; }
    .theme-btn-custom input[type="file"] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
    .user-profile-photo { width: 45px; height: 45px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.6); overflow: hidden; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #ff6b9d 0%, #c06fff 100%); font-size: 20px; color: white; box-shadow: 0 4px 15px rgba(255,107,157,0.4); transition: all 0.3s ease; cursor: pointer; }
    .user-profile-photo:hover { transform: scale(1.15); }
    .user-profile-photo img { width: 100%; height: 100%; object-fit: cover; }

    /* ‚îÄ‚îÄ TOGGLE BUTTON N√âON ‚îÄ‚îÄ */
    .toggle-sidebar-btn {
        position: fixed;
        top: 50%;
        left: 20px;
        transform: translateY(-50%);
        z-index: 300;
        background: linear-gradient(135deg, #ff6b9d, #c06fff);
        border: none;
        border-radius: 16px;
        padding: 16px 20px;
        color: white;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        box-shadow: 
            0 0 20px rgba(255,107,157,0.6),
            0 0 40px rgba(192,111,255,0.4),
            0 8px 25px rgba(0,0,0,0.3);
        animation: neonPulse 2s ease-in-out infinite;
    }
    
    @keyframes neonPulse {
        0%, 100% {
            box-shadow: 
                0 0 20px rgba(255,107,157,0.6),
                0 0 40px rgba(192,111,255,0.4),
                0 8px 25px rgba(0,0,0,0.3);
        }
        50% {
            box-shadow: 
                0 0 30px rgba(255,107,157,0.8),
                0 0 60px rgba(192,111,255,0.6),
                0 0 80px rgba(255,107,157,0.4),
                0 8px 25px rgba(0,0,0,0.3);
        }
    }
    
    .toggle-sidebar-btn:hover {
        transform: translateY(-50%) scale(1.1);
        box-shadow: 
            0 0 40px rgba(255,107,157,0.9),
            0 0 80px rgba(192,111,255,0.7),
            0 0 100px rgba(255,107,157,0.5),
            0 12px 35px rgba(0,0,0,0.4);
    }
    
    .toggle-icon {
        font-size: 28px;
        filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3));
    }
    
    .toggle-text {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
        text-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    /* ‚îÄ‚îÄ TWO-COLUMN BODY ‚îÄ‚îÄ */
    .body-columns { 
        display: flex; 
        gap: 20px; 
        flex: 1; 
        min-height: 0; 
        position: relative;
    }

    /* ‚îÄ‚îÄ LEFT SIDEBAR - 5% OPACIT√â (95% FOND VISIBLE) ‚îÄ‚îÄ */
    .users-panel { 
        width: 340px; 
        flex-shrink: 0; 
        background: rgba(255,255,255,0.05); 
        backdrop-filter: blur(10px); 
        border-radius: 20px; 
        border: 1px solid rgba(255,255,255,0.15); 
        padding: 24px 16px; 
        display: flex; 
        flex-direction: column; 
        gap: 16px; 
        overflow-y: auto; 
        max-height: calc(100vh - 160px);
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .users-panel.hidden {
        transform: translateX(-120%);
        opacity: 0;
        pointer-events: none;
    }
    
    .users-panel-header { 
        color: white; 
        font-weight: 700; 
        font-size: 20px; 
        text-align: center; 
        padding-bottom: 16px; 
        border-bottom: 2px solid rgba(255,255,255,0.15); 
        text-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .users-panel-count { 
        font-size: 13px; 
        opacity: 0.7; 
        font-weight: 400; 
        margin-top: 6px; 
    }
    
    .user-list { 
        display: flex; 
        flex-direction: column; 
        gap: 12px; 
    }

    .user-item { 
        display: flex; 
        align-items: center; 
        gap: 14px; 
        padding: 14px 16px; 
        border-radius: 18px; 
        cursor: pointer; 
        background: rgba(255,255,255,0.08); 
        border: 2px solid rgba(255,255,255,0.15); 
        transition: all 0.3s ease; 
        position: relative;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .user-item:hover { 
        border-color: rgba(255,107,157,0.5); 
        transform: translateX(8px); 
        background: rgba(255,255,255,0.15);
        box-shadow: 0 4px 20px rgba(255,107,157,0.2);
    }
    
    .user-item.active { 
        border-color: rgba(255,107,157,0.8); 
        background: rgba(255,107,157,0.2); 
        box-shadow: 0 6px 25px rgba(255,107,157,0.4);
        transform: translateX(8px);
    }

    .user-avatar { 
        width: 52px; 
        height: 52px; 
        border-radius: 50%; 
        background: linear-gradient(135deg, #ff6b9d, #c06fff); 
        border: 3px solid rgba(255,255,255,0.4); 
        overflow: hidden; 
        flex-shrink: 0; 
        position: relative; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        font-size: 22px; 
        color: white; 
        font-weight: 700;
        box-shadow: 0 4px 15px rgba(255,107,157,0.3);
    }
    
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
    
    .status-dot { 
        position: absolute; 
        bottom: 2px; 
        right: 2px; 
        width: 14px; 
        height: 14px; 
        border-radius: 50%; 
        border: 3px solid rgba(255,255,255,0.9); 
    }
    
    .status-dot.online { 
        background: #4caf50; 
        animation: pulse-online 2s infinite; 
        box-shadow: 0 0 12px #4caf50;
    }
    
    .status-dot.offline { 
        background: #999; 
    }
    
    @keyframes pulse-online { 
        0%,100% { box-shadow: 0 0 12px #4caf50; } 
        50% { box-shadow: 0 0 20px #4caf50, 0 0 30px #4caf50; } 
    }

    .user-info { flex: 1; min-width: 0; }
    
    .user-name { 
        color: white; 
        font-weight: 700; 
        font-size: 16px; 
        white-space: nowrap; 
        overflow: hidden; 
        text-overflow: ellipsis; 
        text-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    
    .user-status-txt { 
        font-size: 13px; 
        margin-top: 4px; 
        font-weight: 600;
    }
    
    .user-status-txt.online { 
        color: #4caf50; 
        text-shadow: 0 1px 4px rgba(76,175,80,0.5);
    }
    
    .user-status-txt.offline { 
        color: rgba(255,255,255,0.5); 
    }

    .notif-badge { 
        position: absolute; 
        top: 10px; 
        right: 10px; 
        background: linear-gradient(135deg, #ff6b9d, #ff3060); 
        color: white; 
        font-size: 12px; 
        font-weight: 900; 
        border-radius: 14px; 
        min-width: 24px; 
        height: 24px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        padding: 0 8px; 
        box-shadow: 0 3px 12px rgba(255,64,64,0.7); 
        animation: badgePop 0.5s cubic-bezier(.34,1.56,.64,1); 
    }
    
    @keyframes badgePop { 
        from { transform: scale(0) rotate(-15deg); } 
        to { transform: scale(1); } 
    }

    /* ‚îÄ‚îÄ RIGHT PANEL - 5% OPACIT√â (95% FOND VISIBLE) ‚îÄ‚îÄ */
    .right-panel { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        min-width: 0; 
        background: rgba(255,255,255,0.05); 
        backdrop-filter: blur(10px); 
        border-radius: 20px; 
        border: 1px solid rgba(255,255,255,0.15); 
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    /* WIZZ Button */
    .wizz-btn {
        padding: 10px 20px;
        background: linear-gradient(135deg, #ffd700, #ff8c00);
        border: none;
        border-radius: 12px;
        color: white;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(255,215,0,0.4);
        font-size: 14px;
    }
    .wizz-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255,215,0,0.6);
    }

    /* WIZZ Animation */
    @keyframes wizz {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        10% { transform: translate(-10px, -10px) rotate(-5deg); }
        20% { transform: translate(10px, 10px) rotate(5deg); }
        30% { transform: translate(-10px, 10px) rotate(-5deg); }
        40% { transform: translate(10px, -10px) rotate(5deg); }
        50% { transform: translate(-5px, -5px) rotate(-3deg); }
        60% { transform: translate(5px, 5px) rotate(3deg); }
        70% { transform: translate(-5px, 5px) rotate(-3deg); }
        80% { transform: translate(5px, -5px) rotate(3deg); }
        90% { transform: translate(-2px, -2px) rotate(-1deg); }
    }

    .wizzing {
        animation: wizz 0.5s ease-in-out;
    }

    /* Chat Header */
    .chat-panel-header {
        background: rgba(255,255,255,0.08);
        padding: 20px 28px;
        border-bottom: 2px solid rgba(255,255,255,0.15);
        display: flex;
        align-items: center;
        gap: 18px;
    }
    
    .chat-panel-header-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 3px solid rgba(255,107,157,0.6);
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        background: linear-gradient(135deg, #ff6b9d, #c06fff);
        flex-shrink: 0;
        box-shadow: 0 4px 15px rgba(255,107,157,0.3);
    }
    
    .chat-panel-header-avatar img { width: 100%; height: 100%; object-fit: cover; }
    
    .chat-panel-header-info { flex: 1; }
    
    .chat-panel-header-name {
        color: white;
        font-weight: 700;
        font-size: 19px;
        text-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    
    .chat-panel-header-status {
        font-size: 14px;
        margin-top: 4px;
        font-weight: 600;
    }
    
    .chat-panel-header-status.online { 
        color: #4caf50; 
        text-shadow: 0 1px 4px rgba(76,175,80,0.5);
    }
    
    .chat-panel-header-status.offline { 
        color: rgba(255,255,255,0.6); 
    }

    /* Messages Area */
    .messages-area {
        flex: 1;
        padding: 28px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 14px;
    }

    /* Public Messages */
    .message {
        background: rgba(255,255,255,0.12);
        padding: 16px 22px;
        border-radius: 18px;
        color: white;
        animation: slideIn 0.4s ease;
        display: flex;
        gap: 16px;
        align-items: flex-start;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        border: 1px solid rgba(255,255,255,0.1);
    }
    
    @keyframes slideIn {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .message-avatar {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
        background: linear-gradient(135deg, #ff6b9d 0%, #c06fff 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        border: 3px solid rgba(255,255,255,0.4);
        color: white;
        font-weight: 700;
        box-shadow: 0 4px 15px rgba(255,107,157,0.3);
    }
    
    .message-avatar img { width: 100%; height: 100%; object-fit: cover; }
    
    .message-content { flex: 1; }
    
    .message-author {
        font-weight: 700;
        margin-bottom: 8px;
        font-size: 15px;
        text-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    
    .message-text { 
        font-size: 15px; 
        line-height: 1.6;
        text-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    
    .message-time {
        font-size: 12px;
        opacity: 0.7;
        text-align: right;
        margin-top: 8px;
    }

    /* PM Bubbles */
    .pm-msg-wrap {
        display: flex;
        flex-direction: column;
        margin-bottom: 10px;
        max-width: 70%;
    }
    
    .pm-msg-wrap.sent {
        align-self: flex-end;
        align-items: flex-end;
    }
    
    .pm-msg-wrap.received {
        align-self: flex-start;
        align-items: flex-start;
    }
    
    .pm-msg {
        padding: 14px 20px;
        border-radius: 20px;
        font-size: 15px;
        color: white;
        line-height: 1.6;
        word-break: break-word;
        animation: msgPop 0.35s cubic-bezier(.34,1.56,.64,1);
        text-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    
    @keyframes msgPop {
        from { opacity: 0; transform: scale(0.92); }
        to { opacity: 1; transform: scale(1); }
    }
    
    .pm-msg.sent {
        background: linear-gradient(135deg, #ff6b9d, #c06fff);
        border-bottom-right-radius: 6px;
        box-shadow: 0 6px 25px rgba(192,111,255,0.4);
    }
    
    .pm-msg.received {
        background: rgba(255,255,255,0.15);
        border: 1px solid rgba(255,255,255,0.15);
        border-bottom-left-radius: 6px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    
    .pm-msg-meta {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 6px;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .pm-tick.read { color: #64b5f6; opacity: 1 !important; }

    .pm-empty {
        text-align: center;
        color: rgba(255,255,255,0.5);
        font-size: 15px;
        padding: 80px 24px;
        line-height: 2.2;
    }
    
    .pm-empty-icon {
        font-size: 56px;
        display: block;
        margin-bottom: 16px;
        filter: drop-shadow(0 4px 12px rgba(0,0,0,0.2));
    }

    /* Input Area */
    .input-area {
        background: rgba(255,255,255,0.08);
        padding: 20px 28px;
        border-top: 2px solid rgba(255,255,255,0.15);
        display: flex;
        gap: 14px;
        align-items: center;
        flex-wrap: wrap;
    }

    .message-input {
        flex: 1;
        min-width: 280px;
        padding: 16px 22px;
        background: rgba(255,255,255,0.15);
        border: 2px solid rgba(255,255,255,0.2);
        border-radius: 18px;
        color: white;
        font-size: 15px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .message-input:focus {
        outline: none;
        background: rgba(255,255,255,0.25);
        border-color: rgba(255,255,255,0.4);
        box-shadow: 0 4px 20px rgba(255,107,157,0.2);
    }
    
    .message-input::placeholder { 
        color: rgba(255,255,255,0.6); 
        font-weight: 500;
    }
    
    .send-btn {
        padding: 16px 36px;
        background: linear-gradient(135deg, #ff6b9d 0%, #c06fff 100%);
        border: none;
        border-radius: 18px;
        color: white;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 6px 25px rgba(192,111,255,0.5);
        white-space: nowrap;
    }
    
    .send-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 35px rgba(192,111,255,0.7);
    }
    
    .send-btn:active { transform: scale(0.97); }

    /* Bubble Color Picker */
    .bubble-color-row {
        display: flex;
        align-items: center;
        gap: 14px;
        width: 100%;
        margin-top: 10px;
    }
    
    .bubble-color-label {
        color: rgba(255,255,255,0.7);
        font-size: 14px;
        font-weight: 600;
        white-space: nowrap;
    }
    
    .bubble-color-swatches {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .color-swatch {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 3px solid rgba(255,255,255,0.4);
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .color-swatch:hover {
        transform: scale(1.25);
        border-color: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .color-swatch.active {
        border-color: white;
        box-shadow: 0 0 0 4px rgba(255,255,255,0.3);
        transform: scale(1.2);
    }

    /* Toast Notifications */
    .pm-toast {
        position: fixed;
        bottom: 35px;
        right: 35px;
        z-index: 3000;
        background: rgba(10,3,24,0.97);
        border: 2px solid rgba(255,107,157,0.6);
        border-radius: 18px;
        padding: 18px 24px;
        color: white;
        font-size: 15px;
        box-shadow: 0 15px 45px rgba(0,0,0,0.7);
        cursor: pointer;
        max-width: 320px;
        backdrop-filter: blur(25px);
        animation: toastIn 0.5s cubic-bezier(.34,1.56,.64,1);
    }
    
    @keyframes toastIn {
        from { opacity: 0; transform: translateY(25px) scale(0.9); }
        to { opacity: 1; transform: scale(1); }
    }
    
    .pm-toast-name {
        font-weight: 700;
        color: #ff6b9d;
        margin-bottom: 8px;
        font-size: 15px;
    }
    
    .pm-toast-text {
        opacity: 0.85;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Scrollbars */
    .users-panel::-webkit-scrollbar,
    .messages-area::-webkit-scrollbar {
        width: 8px;
    }
    
    .users-panel::-webkit-scrollbar-track,
    .messages-area::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.05);
        border-radius: 10px;
    }
    
    .users-panel::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.2);
        border-radius: 10px;
    }
    
    .messages-area::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #ff6b9d, #c06fff);
        border-radius: 10px;
    }

    @media (max-width: 768px) {
        .users-panel {
            width: 300px;
        }
        .toggle-sidebar-btn {
            left: 10px;
            padding: 12px 16px;
        }
    }
</style>
```

</head>
<body class="theme-futuriste">
<div class="particles" id="particles"></div>

<div class="app-wrapper">
    <!-- HEADER -->
    <div class="chat-header">
        <div class="theme-selector">
            <span class="theme-label">Th√®me :</span>
            <div class="theme-options">
                <div class="theme-btn" data-theme="zen" style="background:linear-gradient(135deg,#e0f7fa,#80deea)" title="Zen"></div>
                <div class="theme-btn" data-theme="plage" style="background:linear-gradient(135deg,#ffd89b,#19547b)" title="Plage"></div>
                <div class="theme-btn" data-theme="foret" style="background:linear-gradient(135deg,#134e5e,#71b280)" title="For√™t"></div>
                <div class="theme-btn active" data-theme="futuriste" style="background:linear-gradient(135deg,#667eea,#764ba2)" title="Futuriste"></div>
                <div class="theme-btn" data-theme="bonbon" style="background:linear-gradient(135deg,#ffecd2,#ff9a9e)" title="Bonbon"></div>
                <div class="theme-btn" data-theme="bar" style="background:linear-gradient(135deg,#2c003e,#8b008b)" title="Bar"></div>
                <div class="theme-btn" data-theme="chasse" style="background:linear-gradient(135deg,#3e2723,#795548)" title="Chasse"></div>
                <div class="theme-btn" data-theme="aquarium" style="background:linear-gradient(135deg,#00416a,#ffe000)" title="Aquarium"></div>
                <div class="theme-btn-custom" title="Photo personnalis√©e">üì∑<input type="file" id="customBgInput" accept="image/*"></div>
                <div class="user-profile-photo" id="userProfilePhoto" title="Mon profil">üí¨</div>
            </div>
        </div>
    </div>

```
<!-- TOGGLE BUTTON N√âON -->
<button class="toggle-sidebar-btn" id="toggleSidebar">
    <span class="toggle-icon" id="toggleIcon">üë•</span>
    <span class="toggle-text" id="toggleText">Profils</span>
</button>

<!-- TWO COLUMNS -->
<div class="body-columns">
    <!-- LEFT SIDEBAR -->
    <div class="users-panel" id="usersPanel">
        <div class="users-panel-header">
            üí¨ Conversations
            <div class="users-panel-count" id="profileCount">Chargement...</div>
        </div>
        <div class="user-list">
            <!-- Chat g√©n√©ral -->
            <div class="user-item active" id="publicChatBtn">
                <div class="user-avatar">üåê</div>
                <div class="user-info">
                    <div class="user-name">Chat g√©n√©ral</div>
                    <div class="user-status-txt online">‚óè Public</div>
                </div>
            </div>
        </div>
        <div class="user-list" id="profileList"></div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="right-panel" id="rightPanel">
        <!-- Dynamic Header -->
        <div class="chat-panel-header">
            <div class="chat-panel-header-avatar" id="chatHeaderAvatar">üåê</div>
            <div class="chat-panel-header-info">
                <div class="chat-panel-header-name" id="chatHeaderName">Chat g√©n√©ral</div>
                <div class="chat-panel-header-status online" id="chatHeaderStatus">‚óè Public</div>
            </div>
            <button class="wizz-btn" id="wizzBtn" style="display:none;">‚ö° WIZZ!</button>
        </div>

        <!-- Messages Area -->
        <div class="messages-area" id="messagesArea"></div>

        <!-- Input Area -->
        <div class="input-area">
            <input type="text" class="message-input" id="messageInput" placeholder="Tapez votre message...">
            <button class="send-btn" id="sendBtn">Envoyer üöÄ</button>
            <!-- Bubble color picker (only for PM) -->
            <div class="bubble-color-row" id="bubbleColorPicker" style="display: none;">
                <span class="bubble-color-label">üé® Mes bulles :</span>
                <div class="bubble-color-swatches" id="colorSwatches"></div>
            </div>
        </div>
    </div>
</div>
```

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
    'https://eeikriwrwuynwpzodbbt.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlaWtyaXdyd3V5bndwem9kYmJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NzQ3NjYsImV4cCI6MjA4NjE1MDc2Nn0.MJ6CSmrttEWcrdfy5C7nP4sE_pe19sGNE-WasASPDNc'
);

console.log('‚úÖ Application d√©marr√©e');

// Request notification permission
if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CURRENT USER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let currentUserPhoto = null;
const currentUserPrenom = localStorage.getItem('prenom') || 'Invit√©';
const fingerprint = localStorage.getItem('browserFingerprint') || '';
const currentUniqueId = fingerprint ? `${currentUserPrenom}_${fingerprint}` : null;
const savedPhotoUrl = localStorage.getItem('userPhotoUrl') || localStorage.getItem('tempPhotoPreview');

console.log('üë§ Utilisateur:', currentUserPrenom, 'ID:', currentUniqueId);

(function initPhoto() {
    const el = document.getElementById('userProfilePhoto');
    if (savedPhotoUrl) {
        el.innerHTML = `<img src="${savedPhotoUrl}" alt="Profil">`;
        currentUserPhoto = savedPhotoUrl;
    } else {
        el.textContent = 'üí¨';
    }
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SIDEBAR TOGGLE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let sidebarVisible = true;
const toggleBtn = document.getElementById('toggleSidebar');
const usersPanel = document.getElementById('usersPanel');

toggleBtn.addEventListener('click', () => {
    sidebarVisible = !sidebarVisible;
    if (sidebarVisible) {
        usersPanel.classList.remove('hidden');
        document.getElementById('toggleIcon').textContent = 'üë•';
        document.getElementById('toggleText').textContent = 'Profils';
    } else {
        usersPanel.classList.add('hidden');
        document.getElementById('toggleIcon').textContent = 'üí¨';
        document.getElementById('toggleText').textContent = 'Chat';
    }
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   STATE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let currentChatType = 'public';
let currentChatUser = null;
let profiles = [];
const pmBadges = {};
let lastPublicMsgId = 0;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BUBBLE COLOR
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const BUBBLE_PRESETS = [
    { label: 'Rose/Violet', value: 'linear-gradient(135deg,#ff6b9d,#c06fff)' },
    { label: 'Bleu', value: 'linear-gradient(135deg,#2196f3,#03a9f4)' },
    { label: 'Vert', value: 'linear-gradient(135deg,#43e97b,#38f9d7)' },
    { label: 'Orange', value: 'linear-gradient(135deg,#f7971e,#ffd200)' },
    { label: 'Rouge', value: 'linear-gradient(135deg,#f44336,#e91e63)' },
    { label: 'Indigo', value: 'linear-gradient(135deg,#5c6bc0,#7c4dff)' },
    { label: 'Cyan', value: 'linear-gradient(135deg,#00bcd4,#26c6da)' },
    { label: 'Noir', value: 'linear-gradient(135deg,#2d2d2d,#555)' },
];

let myBubbleStyle = localStorage.getItem('myBubbleStyle') || BUBBLE_PRESETS[0].value;

function buildColorSwatches() {
    const container = document.getElementById('colorSwatches');
    container.innerHTML = '';
    BUBBLE_PRESETS.forEach(preset => {
        const sw = document.createElement('div');
        sw.className = 'color-swatch' + (myBubbleStyle === preset.value ? ' active' : '');
        sw.style.background = preset.value;
        sw.title = preset.label;
        sw.addEventListener('click', () => {
            container.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
            sw.classList.add('active');
            myBubbleStyle = preset.value;
            localStorage.setItem('myBubbleStyle', preset.value);
            document.querySelectorAll('.pm-msg.sent').forEach(b => b.style.background = preset.value);
        });
        container.appendChild(sw);
    });
}
buildColorSwatches();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ONLINE STATUS - FIX OFFLINE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function setOnlineStatus(online) {
    if (!currentUniqueId) return;
    try {
        await supabase.from('profiles')
            .update({ 
                is_online: online, 
                last_seen: new Date().toISOString() 
            })
            .eq('unique_id', currentUniqueId);
    } catch (err) {
        console.error('Erreur mise √† jour statut:', err);
    }
}

// Set online on load
setOnlineStatus(true);

// Keep online every 30s
setInterval(() => setOnlineStatus(true), 30000);

// Set offline on page unload
window.addEventListener('beforeunload', () => {
    // Use sendBeacon for reliable offline status
    const data = JSON.stringify({
        unique_id: currentUniqueId,
        is_online: false,
        last_seen: new Date().toISOString()
    });
    
    navigator.sendBeacon(
        `https://eeikriwrwuynwpzodbbt.supabase.co/rest/v1/profiles?unique_id=eq.${currentUniqueId}`,
        new Blob([data], { type: 'application/json' })
    );
});

// Set offline on page hide (mobile)
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        setOnlineStatus(false);
    } else {
        setOnlineStatus(true);
    }
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   WIZZ MSN FEATURE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const wizzBtn = document.getElementById('wizzBtn');

async function sendWizz() {
    if (!currentChatUser || !currentUniqueId) return;
    
    try {
        // Save wizz in DB
        await supabase.from('private_messages').insert({
            sender_unique_id: currentUniqueId,
            receiver_unique_id: currentChatUser.unique_id,
            message: '‚ö° WIZZ!',
            is_read: false,
            is_wizz: true
        });
        
        // Animate locally
        document.getElementById('rightPanel').classList.add('wizzing');
        setTimeout(() => {
            document.getElementById('rightPanel').classList.remove('wizzing');
        }, 500);
        
    } catch (err) {
        console.error('Erreur envoi wizz:', err);
    }
}

wizzBtn.addEventListener('click', sendWizz);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   NOTIFICATIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showNotification(title, body) {
    if ('Notification' in window && Notification.permission === 'granted') {
        const notification = new Notification(title, {
            body: body,
            icon: savedPhotoUrl || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">üí¨</text></svg>',
            badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">üí¨</text></svg>',
            tag: 'bubblechat-message',
            requireInteraction: false
        });
        
        notification.onclick = () => {
            window.focus();
            notification.close();
        };
        
        setTimeout(() => notification.close(), 5000);
    }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LOAD PROFILES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function loadProfiles() {
    try {
        const { data, error } = await supabase
            .from('profiles')
            .select('unique_id, prenom, photo_url, is_online, last_seen')
            .order('is_online', { ascending: false })
            .order('prenom', { ascending: true });

        if (error) throw error;

        profiles = (data || []).filter(p => p.unique_id !== currentUniqueId).map(p => ({
            unique_id: p.unique_id || '',
            prenom: p.prenom || 'Anonyme',
            photo_url: p.photo_url || null,
            is_online: !!p.is_online
        }));

        renderProfiles();
    } catch (err) {
        console.error('Erreur chargement profils:', err);
        document.getElementById('profileCount').textContent = 'Erreur';
    }
}

function renderProfiles() {
    const container = document.getElementById('profileList');
    const countEl = document.getElementById('profileCount');
    container.innerHTML = '';

    const onlineCount = profiles.filter(p => p.is_online).length;
    countEl.textContent = `${profiles.length} utilisateur${profiles.length > 1 ? 's' : ''} ¬∑ ${onlineCount} en ligne`;

    profiles.forEach(profile => {
        const item = document.createElement('div');
        item.className = 'user-item';
        if (currentChatType === 'private' && currentChatUser?.unique_id === profile.unique_id) {
            item.classList.add('active');
        }
        item.dataset.uniqueId = profile.unique_id;

        const av = document.createElement('div');
        av.className = 'user-avatar';
        if (profile.photo_url) {
            av.innerHTML = `<img src="${profile.photo_url}" alt="${escHtml(profile.prenom)}">`;
        } else {
            av.textContent = (profile.prenom[0] || '?').toUpperCase();
        }
        const dot = document.createElement('div');
        dot.className = 'status-dot ' + (profile.is_online ? 'online' : 'offline');
        av.appendChild(dot);

        const info = document.createElement('div');
        info.className = 'user-info';
        info.innerHTML = `
            <div class="user-name">${escHtml(profile.prenom)}</div>
            <div class="user-status-txt ${profile.is_online ? 'online' : 'offline'}">
                ${profile.is_online ? '‚óè En ligne' : '‚óè Hors ligne'}
            </div>
        `;

        item.appendChild(av);
        item.appendChild(info);

        const unread = pmBadges[profile.unique_id] || 0;
        if (unread > 0) {
            const badge = document.createElement('div');
            badge.className = 'notif-badge';
            badge.textContent = unread > 99 ? '99+' : unread;
            item.appendChild(badge);
        }

        item.addEventListener('click', () => {
            switchToPrivateChat(profile);
            if (window.innerWidth <= 768) {
                sidebarVisible = false;
                usersPanel.classList.add('hidden');
            }
        });
        container.appendChild(item);
    });
}

setInterval(loadProfiles, 5000);
loadProfiles();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PUBLIC CHAT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function loadPublicMessages() {
    try {
        const { data, error } = await supabase
            .from('public_messages')
            .select('id, author, message, photo_url, created_at')
            .gt('id', lastPublicMsgId)
            .order('created_at', { ascending: true })
            .limit(50);

        if (error) throw error;

        if (data && data.length > 0) {
            data.forEach(msg => {
                if (msg.id > lastPublicMsgId) lastPublicMsgId = msg.id;
                if (currentChatType === 'public') {
                    renderPublicMessage({
                        author: msg.author,
                        text: msg.message,
                        photo: msg.photo_url,
                        time: fmtTime(msg.created_at)
                    });
                }
            });
        }
    } catch (err) {
        console.error('Erreur chargement messages publics:', err);
    }
}

function renderPublicMessage(msg) {
    const container = document.getElementById('messagesArea');
    const msgEl = document.createElement('div');
    msgEl.className = 'message';

    const av = document.createElement('div');
    av.className = 'message-avatar';
    if (msg.photo) {
        av.innerHTML = `<img src="${msg.photo}" alt="${escHtml(msg.author)}">`;
    } else {
        av.textContent = (msg.author[0] || '?').toUpperCase();
    }

    const content = document.createElement('div');
    content.className = 'message-content';
    content.innerHTML = `
        <div class="message-author">${escHtml(msg.author)}</div>
        <div class="message-text">${escHtml(msg.text)}</div>
        <div class="message-time">${msg.time}</div>
    `;

    msgEl.appendChild(av);
    msgEl.appendChild(content);
    container.appendChild(msgEl);
    container.scrollTop = container.scrollHeight;
}

async function sendPublicMessage(text) {
    try {
        const time = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        
        renderPublicMessage({
            author: currentUserPrenom,
            text: text,
            photo: currentUserPhoto,
            time: time
        });

        const { data, error } = await supabase
            .from('public_messages')
            .insert({
                author: currentUserPrenom,
                message: text,
                photo_url: currentUserPhoto
            })
            .select()
            .single();

        if (error) throw error;
        if (data && data.id > lastPublicMsgId) lastPublicMsgId = data.id;
    } catch (err) {
        console.error('Erreur envoi message public:', err);
    }
}

setInterval(loadPublicMessages, 2000);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SWITCH CHAT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function switchToPublicChat() {
    currentChatType = 'public';
    currentChatUser = null;

    document.getElementById('chatHeaderAvatar').innerHTML = 'üåê';
    document.getElementById('chatHeaderName').textContent = 'Chat g√©n√©ral';
    document.getElementById('chatHeaderStatus').className = 'chat-panel-header-status online';
    document.getElementById('chatHeaderStatus').textContent = '‚óè Public';
    wizzBtn.style.display = 'none';

    document.querySelectorAll('.user-item').forEach(i => i.classList.remove('active'));
    document.getElementById('publicChatBtn').classList.add('active');

    document.getElementById('bubbleColorPicker').style.display = 'none';

    const area = document.getElementById('messagesArea');
    area.innerHTML = '';
    loadPublicMessages();
}

function switchToPrivateChat(profile) {
    currentChatType = 'private';
    currentChatUser = profile;

    pmBadges[profile.unique_id] = 0;

    const av = document.getElementById('chatHeaderAvatar');
    if (profile.photo_url) {
        av.innerHTML = `<img src="${profile.photo_url}" alt="${escHtml(profile.prenom)}">`;
    } else {
        av.textContent = (profile.prenom[0] || '?').toUpperCase();
    }
    document.getElementById('chatHeaderName').textContent = profile.prenom;
    const statusEl = document.getElementById('chatHeaderStatus');
    statusEl.className = 'chat-panel-header-status ' + (profile.is_online ? 'online' : 'offline');
    statusEl.textContent = profile.is_online ? 'üü¢ En ligne' : 'üî¥ Hors ligne';
    wizzBtn.style.display = 'block';

    document.querySelectorAll('.user-item').forEach(i => i.classList.remove('active'));
    document.querySelectorAll(`.user-item[data-unique-id="${profile.unique_id}"]`).forEach(i => {
        i.classList.add('active');
    });

    document.getElementById('bubbleColorPicker').style.display = 'flex';

    loadPMHistory(profile.unique_id);
    startPMPolling(profile.unique_id);
    markAllRead(profile.unique_id);
    renderProfiles();
}

document.getElementById('publicChatBtn').addEventListener('click', () => {
    switchToPublicChat();
    if (window.innerWidth <= 768) {
        sidebarVisible = false;
        usersPanel.classList.add('hidden');
    }
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PRIVATE MESSAGES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let pmPollInterval = null;
let lastPMId = 0;

async function loadPMHistory(otherUserId) {
    const area = document.getElementById('messagesArea');
    area.innerHTML = '<div class="pm-empty"><span class="pm-empty-icon">üí¨</span>Chargement...</div>';

    if (!currentUniqueId) {
        area.innerHTML = '<div class="pm-empty"><span class="pm-empty-icon">‚ö†Ô∏è</span>Connexion requise</div>';
        return;
    }

    try {
        const { data, error } = await supabase
            .from('private_messages')
            .select('id, sender_unique_id, message, created_at, is_read, is_wizz')
            .or(
                `and(sender_unique_id.eq.${currentUniqueId},receiver_unique_id.eq.${otherUserId}),` +
                `and(sender_unique_id.eq.${otherUserId},receiver_unique_id.eq.${currentUniqueId})`
            )
            .order('created_at', { ascending: true })
            .limit(100);

        if (error) throw error;

        area.innerHTML = '';
        if (!data || data.length === 0) {
            area.innerHTML = '<div class="pm-empty"><span class="pm-empty-icon">üíå</span>Aucun message<br><span style="font-size:12px;opacity:0.6">Soyez le premier √† √©crire !</span></div>';
            lastPMId = 0;
            return;
        }

        data.forEach(msg => {
            const fromMe = msg.sender_unique_id === currentUniqueId;
            if (msg.id > lastPMId) lastPMId = msg.id;
            
            // Check for wizz
            if (msg.is_wizz && !fromMe) {
                document.getElementById('rightPanel').classList.add('wizzing');
                setTimeout(() => {
                    document.getElementById('rightPanel').classList.remove('wizzing');
                }, 500);
            }
            
            appendPMBubble({
                id: msg.id,
                text: msg.message,
                fromMe,
                time: fmtTime(msg.created_at),
                is_read: msg.is_read
            });
        });

        area.scrollTop = area.scrollHeight;
    } catch (err) {
        console.error('Erreur chargement PM:', err);
        area.innerHTML = '<div class="pm-empty"><span class="pm-empty-icon">‚ö†Ô∏è</span>Erreur</div>';
    }
}

function appendPMBubble(msg) {
    const area = document.getElementById('messagesArea');
    area.querySelector('.pm-empty')?.remove();

    const wrap = document.createElement('div');
    wrap.className = 'pm-msg-wrap ' + (msg.fromMe ? 'sent' : 'received');
    wrap.dataset.msgId = msg.id;

    const bubble = document.createElement('div');
    bubble.className = 'pm-msg ' + (msg.fromMe ? 'sent' : 'received');
    if (msg.fromMe) {
        bubble.style.background = myBubbleStyle;
    }

    const tick = msg.fromMe ? `<span class="pm-tick ${msg.is_read ? 'read' : ''}">${msg.is_read ? '‚úì‚úì' : '‚úì'}</span>` : '';

    bubble.innerHTML = `
        ${escHtml(msg.text)}
        <div class="pm-msg-meta">${msg.time} ${tick}</div>
    `;

    wrap.appendChild(bubble);
    area.appendChild(wrap);
    area.scrollTop = area.scrollHeight;
}

async function sendPM() {
    if (!currentChatUser || !currentUniqueId) return;

    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if (!text) return;

    input.value = '';

    const tempId = 'tmp-' + Date.now();
    appendPMBubble({
        id: tempId,
        text,
        fromMe: true,
        time: fmtTime(new Date().toISOString()),
        is_read: false
    });

    try {
        const { data, error } = await supabase.from('private_messages').insert({
            sender_unique_id: currentUniqueId,
            receiver_unique_id: currentChatUser.unique_id,
            message: text,
            is_read: false,
            is_wizz: false
        }).select().single();

        if (error) throw error;
        if (data) {
            const el = document.querySelector(`[data-msg-id="${tempId}"]`);
            if (el) el.dataset.msgId = data.id;
            if (data.id > lastPMId) lastPMId = data.id;
        }
    } catch (err) {
        console.error('Erreur envoi PM:', err);
        document.querySelector(`[data-msg-id="${tempId}"]`)?.remove();
        input.value = text;
        alert('Erreur envoi message');
    }
}

async function pollNewPMs(otherUserId) {
    if (!currentUniqueId || currentChatType !== 'private' || currentChatUser?.unique_id !== otherUserId) return;

    try {
        const { data, error } = await supabase
            .from('private_messages')
            .select('id, sender_unique_id, message, created_at, is_read, is_wizz')
            .eq('sender_unique_id', otherUserId)
            .eq('receiver_unique_id', currentUniqueId)
            .gt('id', lastPMId)
            .order('created_at', { ascending: true });

        if (error) throw error;

        if (data && data.length > 0) {
            data.forEach(msg => {
                if (msg.id > lastPMId) lastPMId = msg.id;
                
                // Show notification
                const sender = profiles.find(p => p.unique_id === otherUserId);
                showNotification(
                    `üí¨ ${sender?.prenom || 'Quelqu\'un'}`,
                    msg.message
                );
                
                // Wizz animation
                if (msg.is_wizz) {
                    document.getElementById('rightPanel').classList.add('wizzing');
                    setTimeout(() => {
                        document.getElementById('rightPanel').classList.remove('wizzing');
                    }, 500);
                }
                
                appendPMBubble({
                    id: msg.id,
                    text: msg.message,
                    fromMe: false,
                    time: fmtTime(msg.created_at),
                    is_read: false
                });
                markRead(msg.id);
            });
        }
    } catch (err) {
        console.error('Erreur poll PM:', err);
    }
}

function startPMPolling(otherUserId) {
    if (pmPollInterval) clearInterval(pmPollInterval);
    pmPollInterval = setInterval(() => pollNewPMs(otherUserId), 2000);
}

async function markRead(msgId) {
    try {
        await supabase.from('private_messages')
            .update({ is_read: true })
            .eq('id', msgId);
    } catch (err) {
        console.error('Erreur markRead:', err);
    }
}

async function markAllRead(senderUniqueId) {
    if (!currentUniqueId) return;
    try {
        await supabase.from('private_messages')
            .update({ is_read: true })
            .eq('receiver_unique_id', currentUniqueId)
            .eq('sender_unique_id', senderUniqueId)
            .eq('is_read', false);
    } catch (err) {
        console.error('Erreur markAllRead:', err);
    }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SEND MESSAGE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function sendMessage() {
    if (currentChatType === 'public') {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        if (!text) return;
        sendPublicMessage(text);
        input.value = '';
    } else {
        sendPM();
    }
}

document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('messageInput').addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMessage();
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   THEMES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
document.querySelectorAll('.theme-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.body.className = '';
        document.body.style.backgroundImage = '';
        document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.body.classList.add('theme-' + btn.dataset.theme);
    });
});

document.getElementById('customBgInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        document.body.className = 'custom-bg';
        document.body.style.backgroundImage = `url(${ev.target.result})`;
        document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
    };
    reader.readAsDataURL(file);
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PARTICLES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(function() {
    const c = document.getElementById('particles');
    for (let i = 0; i < 40; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = Math.random() * 100 + '%';
        p.style.animationDelay = Math.random() * 20 + 's';
        p.style.animationDuration = (Math.random() * 15 + 15) + 's';
        c.appendChild(p);
    }
})();

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   UTILS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function fmtTime(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    const today = new Date();
    const hm = d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    return d.toDateString() === today.toDateString()
        ? hm
        : d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' }) + ' ' + hm;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
console.log('üöÄ Initialisation...');
switchToPublicChat();
</script>

</body>
</html>

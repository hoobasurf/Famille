<!DOCTYPE html>

<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BubbleChat</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#764ba2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BubbleChat">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; min-height: 100vh; position: relative; overflow-x: hidden; transition: background 0.8s ease; }
        body.theme-zen      { background: linear-gradient(135deg,#e0f7fa,#b2ebf2,#80deea); }
        body.theme-plage    { background: linear-gradient(135deg,#ffd89b,#f4a460,#19547b); }
        body.theme-foret    { background: linear-gradient(135deg,#134e5e,#3a7e6f,#71b280); }
        body.theme-futuriste{ background: linear-gradient(135deg,#667eea,#764ba2); }
        body.theme-bonbon   { background: linear-gradient(135deg,#ffecd2,#fcb69f,#ff9a9e); }
        body.theme-bar      { background: linear-gradient(135deg,#2c003e,#4b0082,#8b008b); }
        body.theme-chasse   { background: linear-gradient(135deg,#3e2723,#5d4037,#795548); }
        body.theme-aquarium { background: linear-gradient(135deg,#00416a,#1976d2 33%,#4caf50 66%,#ffe000); }
        body.custom-bg      { background-size:cover!important; background-position:center!important; background-attachment:fixed!important; }
        .particles { position:fixed; inset:0; pointer-events:none; z-index:0; }
        .particle  { position:absolute; width:3px; height:3px; background:rgba(255,255,255,.5); border-radius:50%; animation:float 20s infinite ease-in-out; }
        @keyframes float { 0%,100%{transform:translateY(0) translateX(0);opacity:0} 10%{opacity:1} 90%{opacity:1} 100%{transform:translateY(-100vh) translateX(50px);opacity:0} }
        .app-wrapper { position:relative; z-index:1; max-width:1500px; margin:0 auto; padding:20px; min-height:100vh; display:flex; flex-direction:column; gap:20px; }
        .chat-header { background:rgba(255,255,255,.05); backdrop-filter:blur(10px); border-radius:20px; padding:14px 28px; border:1px solid rgba(255,255,255,.15); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:12px; }
        .theme-selector { display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
        .theme-label    { color:white; font-weight:600; text-shadow:0 2px 5px rgba(0,0,0,.3); }
        .theme-options  { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
        .theme-btn { width:45px; height:45px; border-radius:50%; border:3px solid rgba(255,255,255,.5); cursor:pointer; transition:all .3s; flex-shrink:0; }
        .theme-btn:hover  { transform:scale(1.15); border-color:white; }
        .theme-btn.active { border-color:white; box-shadow:0 0 0 4px rgba(255,255,255,.3); }
        .theme-btn-custom { width:45px; height:45px; border-radius:50%; border:3px solid rgba(255,255,255,.5); background:linear-gradient(135deg,#fff,#ccc); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:20px; transition:all .3s; position:relative; flex-shrink:0; }
        .theme-btn-custom:hover { transform:scale(1.15); border-color:white; }
        .theme-btn-custom input[type=file] { position:absolute; opacity:0; width:100%; height:100%; cursor:pointer; }
        .user-profile-photo { width:45px; height:45px; border-radius:50%; border:3px solid rgba(255,255,255,.6); overflow:hidden; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,#ff6b9d,#c06fff); font-size:20px; color:white; cursor:pointer; transition:all .3s; flex-shrink:0; vertical-align:middle; position:relative; top:0; }
        .user-profile-photo:hover { transform:scale(1.15); }
        .user-profile-photo img { width:100%; height:100%; object-fit:cover; }
        .notif-toggle-btn { width:45px; height:45px; border-radius:50%; border:3px solid rgba(255,255,255,.5); background:rgba(255,255,255,.1); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:20px; transition:all .3s; flex-shrink:0; }
        .notif-toggle-btn:hover { transform:scale(1.15); border-color:white; }
        .notif-toggle-btn.active { border-color:#4caf50; box-shadow:0 0 0 4px rgba(76,175,80,.3); background:rgba(76,175,80,.2); }
        .notif-toggle-btn.denied { border-color:#f44336; background:rgba(244,67,54,.2); }
        /* â•â• BOUTONS ARCADE & MUR â•â• */
        .attach-btn { width:45px; height:45px; border-radius:50%; background:rgba(255,255,255,.1); border:2px solid rgba(255,255,255,.2); color:white; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .3s; position:relative; flex-shrink:0; }
        .attach-btn:hover { background:rgba(255,255,255,.2); transform:scale(1.1); }
        .attach-btn input[type=file] { position:absolute; opacity:0; width:100%; height:100%; cursor:pointer; }
        .wall-btn { width:45px; height:45px; border-radius:50%; border:3px solid rgba(30,144,255,.7); background:linear-gradient(135deg,rgba(30,144,255,.25),rgba(70,130,180,.25)); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:22px; transition:all .3s; flex-shrink:0; text-decoration:none; box-shadow:0 0 14px rgba(30,144,255,.35); }
        .wall-btn:hover { transform:scale(1.18); border-color:#1e90ff; box-shadow:0 0 28px rgba(30,144,255,.7); }
        /* â•â• BOUTON ARCADE â•â• */
        .arcade-btn { width:45px; height:45px; border-radius:50%; border:3px solid rgba(255,215,0,.7); background:linear-gradient(135deg,rgba(255,107,157,.25),rgba(192,111,255,.25)); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:22px; transition:all .3s; flex-shrink:0; text-decoration:none; box-shadow:0 0 14px rgba(255,215,0,.35); }
        .arcade-btn:hover { transform:scale(1.18); border-color:#ffd700; box-shadow:0 0 28px rgba(255,215,0,.7),0 0 10px rgba(255,107,157,.5); background:linear-gradient(135deg,rgba(255,107,157,.4),rgba(192,111,255,.4)); }
        .toggle-sidebar-btn { position:fixed; top:50%; left:20px; transform:translateY(-50%); z-index:300; background:linear-gradient(135deg,#ff6b9d,#c06fff); border:none; border-radius:16px; padding:16px 20px; color:white; font-weight:700; cursor:pointer; transition:all .4s cubic-bezier(.34,1.56,.64,1); display:flex; flex-direction:column; align-items:center; gap:8px; animation:neonPulse 2s ease-in-out infinite; }
        @keyframes neonPulse { 0%,100%{ box-shadow:0 0 20px rgba(255,107,157,.6),0 0 40px rgba(192,111,255,.4),0 8px 25px rgba(0,0,0,.3); } 50%{ box-shadow:0 0 35px rgba(255,107,157,.9),0 0 65px rgba(192,111,255,.6),0 8px 25px rgba(0,0,0,.3); } }
        .toggle-sidebar-btn:hover { transform:translateY(-50%) scale(1.1); }
        .toggle-icon { font-size:28px; }
        .toggle-text { font-size:12px; text-transform:uppercase; letter-spacing:1px; }
        .body-columns { display:flex; gap:20px; flex:1; min-height:0; }
        .users-panel { width:340px; flex-shrink:0; background:rgba(255,255,255,.05); backdrop-filter:blur(10px); border-radius:20px; border:1px solid rgba(255,255,255,.15); padding:24px 16px; display:flex; flex-direction:column; gap:16px; overflow-y:auto; max-height:calc(100vh - 160px); transition:width .4s cubic-bezier(.4,0,.2,1), min-width .4s, opacity .4s, padding .4s, border .4s; }
        .users-panel.hidden { width:0; min-width:0; padding-left:0; padding-right:0; opacity:0; pointer-events:none; border:none; overflow:hidden; }
        .users-panel-header { color:white; font-weight:700; font-size:20px; text-align:center; padding-bottom:16px; border-bottom:2px solid rgba(255,255,255,.15); }
        .users-panel-count  { font-size:13px; opacity:.7; font-weight:400; margin-top:6px; }
        .user-list { display:flex; flex-direction:column; gap:12px; }
        .user-item { display:flex; align-items:center; gap:14px; padding:14px 16px; border-radius:18px; cursor:pointer; background:rgba(255,255,255,.08); border:2px solid rgba(255,255,255,.15); transition:all .3s; position:relative; }
        .user-item:hover  { border-color:rgba(255,107,157,.5); transform:translateX(8px); background:rgba(255,255,255,.15); }
        .user-item.active { border-color:rgba(255,107,157,.8); background:rgba(255,107,157,.2); box-shadow:0 6px 25px rgba(255,107,157,.4); transform:translateX(8px); }
        .user-avatar { width:52px; height:52px; border-radius:50%; background:linear-gradient(135deg,#ff6b9d,#c06fff); border:3px solid rgba(255,255,255,.4); overflow:hidden; flex-shrink:0; position:relative; display:flex; align-items:center; justify-content:center; font-size:22px; color:white; font-weight:700; }
        .user-avatar img { width:100%; height:100%; object-fit:cover; }
        .status-dot { position:absolute; bottom:2px; right:2px; width:14px; height:14px; border-radius:50%; border:3px solid rgba(255,255,255,.9); }
        .status-dot.online  { background:#4caf50; animation:pulse-online 2s infinite; }
        .status-dot.offline { background:#999; }
        @keyframes pulse-online { 0%,100%{box-shadow:0 0 12px #4caf50} 50%{box-shadow:0 0 22px #4caf50} }
        .user-info { flex:1; min-width:0; }
        .user-name { color:white; font-weight:700; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .user-status-txt { font-size:13px; margin-top:4px; font-weight:600; }
        .user-status-txt.online  { color:#4caf50; }
        .user-status-txt.offline { color:rgba(255,255,255,.5); }
        .notif-badge { position:absolute; top:10px; right:10px; background:linear-gradient(135deg,#ff6b9d,#ff3060); color:white; font-size:12px; font-weight:900; border-radius:14px; min-width:24px; height:24px; display:flex; align-items:center; justify-content:center; padding:0 8px; animation:badgePop .5s cubic-bezier(.34,1.56,.64,1); }
        @keyframes badgePop { from{transform:scale(0) rotate(-15deg)} to{transform:scale(1)} }
        .right-panel { flex:1; display:flex; flex-direction:column; min-width:0; background:rgba(255,255,255,.05); backdrop-filter:blur(10px); border-radius:20px; border:1px solid rgba(255,255,255,.15); overflow:hidden; transition:flex .4s; }
        .wizz-btn { padding:10px 20px; background:linear-gradient(135deg,#ffd700,#ff8c00); border:none; border-radius:12px; color:white; font-weight:700; cursor:pointer; transition:all .3s; font-size:14px; }
        .wizz-btn:hover { transform:translateY(-2px); }
        @keyframes wizz { 0%,100%{transform:translate(0,0)} 15%{transform:translate(-10px,-10px) rotate(-5deg)} 30%{transform:translate(10px,10px) rotate(5deg)} 45%{transform:translate(-8px,8px) rotate(-4deg)} 60%{transform:translate(8px,-8px) rotate(4deg)} 80%{transform:translate(-4px,4px) rotate(-2deg)} }
        .wizzing { animation:wizz .55s ease-in-out; }
        .chat-panel-header { background:rgba(255,255,255,.08); padding:20px 28px; border-bottom:2px solid rgba(255,255,255,.15); display:flex; align-items:center; gap:18px; flex-wrap:wrap; }
        .chat-panel-header-avatar { width:50px; height:50px; border-radius:50%; border:3px solid rgba(255,107,157,.6); overflow:hidden; display:flex; align-items:center; justify-content:center; font-size:24px; color:white; background:linear-gradient(135deg,#ff6b9d,#c06fff); flex-shrink:0; }
        .chat-panel-header-avatar img { width:100%; height:100%; object-fit:cover; }
        .chat-panel-header-info { flex:1; }
        .chat-panel-header-name   { color:white; font-weight:700; font-size:19px; }
        .chat-panel-header-status { font-size:14px; margin-top:4px; font-weight:600; }
        .chat-panel-header-status.online  { color:#4caf50; }
        .chat-panel-header-status.offline { color:rgba(255,255,255,.6); }
        .visio-btn-header { padding:10px 20px; background:linear-gradient(135deg,#ff6b9d,#c06fff); border:none; border-radius:12px; color:white; font-weight:700; cursor:pointer; transition:all .3s; font-size:14px; align-items:center; gap:6px; box-shadow:0 4px 15px rgba(192,111,255,.4); display:none; }
        .visio-btn-header:hover { transform:translateY(-2px); box-shadow:0 6px 20px rgba(192,111,255,.6); }
        .visio-btn-header.visible { display:flex; }
        .messages-area { flex:1; padding:28px; overflow-y:auto; display:flex; flex-direction:column; gap:14px; }
        .message { background:rgba(255,255,255,.12); padding:16px 22px; border-radius:18px; color:white; animation:slideIn .4s ease; display:flex; gap:16px; align-items:flex-start; border:1px solid rgba(255,255,255,.1); }
        @keyframes slideIn { from{opacity:0;transform:translateY(15px)} to{opacity:1;transform:translateY(0)} }
        .message-avatar { width:46px; height:46px; border-radius:50%; overflow:hidden; flex-shrink:0; background:linear-gradient(135deg,#ff6b9d,#c06fff); display:flex; align-items:center; justify-content:center; font-size:20px; border:3px solid rgba(255,255,255,.4); color:white; font-weight:700; }
        .message-avatar img { width:100%; height:100%; object-fit:cover; }
        .message-content { flex:1; }
        .message-author { font-weight:700; margin-bottom:8px; font-size:15px; }
        .message-text   { font-size:15px; line-height:1.6; }
        .message-time   { font-size:12px; opacity:.7; text-align:right; margin-top:8px; }
        .pm-msg-wrap { display:flex; flex-direction:column; margin-bottom:10px; max-width:70%; }
        .pm-msg-wrap.sent     { align-self:flex-end;   align-items:flex-end; }
        .pm-msg-wrap.received { align-self:flex-start; align-items:flex-start; }
        .pm-msg { padding:14px 20px; border-radius:20px; font-size:15px; color:white; line-height:1.6; word-break:break-word; animation:msgPop .3s cubic-bezier(.34,1.56,.64,1); }
        @keyframes msgPop { from{opacity:0;transform:scale(.9)} to{opacity:1;transform:scale(1)} }
        .pm-msg.sent     { border-bottom-right-radius:5px; box-shadow:0 6px 25px rgba(192,111,255,.35); }
        .pm-msg.received { background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.15); border-bottom-left-radius:5px; }
        .pm-msg-meta { font-size:11px; opacity:.65; margin-top:6px; display:flex; align-items:center; gap:5px; }
        .pm-tick.read { color:#64b5f6; opacity:1!important; }
        .pm-empty { text-align:center; color:rgba(255,255,255,.5); font-size:15px; padding:80px 24px; line-height:2.2; }
        .pm-empty-icon { font-size:56px; display:block; margin-bottom:16px; }
        .input-area { background:rgba(255,255,255,.08); padding:20px 28px; border-top:2px solid rgba(255,255,255,.15); display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
        .message-input { flex:1; min-width:200px; padding:16px 22px; background:rgba(255,255,255,.15); border:2px solid rgba(255,255,255,.2); border-radius:18px; color:white; font-size:15px; transition:all .3s; }
        .message-input:focus { outline:none; background:rgba(255,255,255,.25); border-color:rgba(255,255,255,.4); }
        .message-input::placeholder { color:rgba(255,255,255,.6); }
        .send-btn { padding:16px 36px; background:linear-gradient(135deg,#ff6b9d,#c06fff); border:none; border-radius:18px; color:white; font-size:16px; font-weight:700; cursor:pointer; transition:all .3s; box-shadow:0 6px 25px rgba(192,111,255,.5); white-space:nowrap; }
        .send-btn:hover  { transform:translateY(-3px); }
        .send-btn:active { transform:scale(.97); }
        .bubble-color-row { display:flex; align-items:center; gap:12px; width:100%; margin-top:4px; flex-wrap:wrap; }
        .bubble-color-label { color:rgba(255,255,255,.75); font-size:14px; font-weight:600; white-space:nowrap; }
        .bubble-color-swatches { display:flex; gap:10px; flex-wrap:wrap; }
        .color-swatch { width:30px; height:30px; border-radius:50%; border:3px solid rgba(255,255,255,.4); cursor:pointer; transition:all .25s; }
        .color-swatch:hover  { transform:scale(1.25); border-color:white; }
        .color-swatch.active { border-color:white; box-shadow:0 0 0 4px rgba(255,255,255,.3); transform:scale(1.2); }
        .color-swatch-custom { width:30px; height:30px; border-radius:50%; border:3px solid rgba(255,255,255,.4); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:13px; background:rgba(255,255,255,.1); transition:all .25s; position:relative; overflow:hidden; }
        .color-swatch-custom:hover { transform:scale(1.25); border-color:white; }
        .color-swatch-custom input[type=color] { position:absolute; opacity:0; width:100%; height:100%; cursor:pointer; }
        .pm-toast { position:fixed; bottom:30px; right:30px; z-index:3000; background:rgba(10,3,24,.97); border:2px solid rgba(255,107,157,.6); border-radius:18px; padding:18px 24px; color:white; font-size:15px; box-shadow:0 15px 45px rgba(0,0,0,.7); cursor:pointer; max-width:300px; backdrop-filter:blur(25px); animation:toastIn .5s cubic-bezier(.34,1.56,.64,1); transition:opacity .4s; }
        @keyframes toastIn { from{opacity:0;transform:translateY(20px) scale(.9)} to{opacity:1;transform:scale(1)} }
        .pm-toast-name { font-weight:700; color:#ff6b9d; margin-bottom:6px; }
        .pm-toast-text { opacity:.8; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        #visioOverlay { position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);z-index:9000;display:none; }
        #visioOverlay.open { display:block; }
        #visioOverlay.pip-mode { background:transparent;backdrop-filter:none;pointer-events:none; }
        #visioContainer { position:fixed;z-index:9999;border-radius:20px;overflow:hidden;box-shadow:0 25px 80px rgba(0,0,0,.7),0 0 0 1px rgba(255,255,255,.12);display:none;flex-direction:column;background:#0d0d1a;width:88vw;max-width:1100px;height:82vh;top:50%;left:50%;transform:translate(-50%,-50%); }
        #visioContainer.open { display:flex; }
        #visioContainer.pip { width:320px;height:240px;top:auto;left:auto;bottom:22px;right:22px;transform:none;border-radius:16px;cursor:move;box-shadow:0 12px 50px rgba(0,0,0,.9),0 0 0 2px rgba(255,107,157,.5); }
        #visioContainer.fullscreen { width:100vw;height:100vh;top:0;left:0;transform:none;border-radius:0;max-width:none; }
        #visioContainer.pip #visioRoomInfo { display:none; }
        #visioContainer.pip .vt-btn span:last-child { display:none; }
        #visioContainer.pip .vt-btn { padding:5px 9px;font-size:15px; }
        #visioContainer.pip #visioTitleBar { padding:6px 10px; }
        #visioContainer.pip #visioToolbar { padding:6px 10px;gap:6px; }
        #visioTitleBar { display:flex;align-items:center;gap:10px;padding:11px 16px;background:linear-gradient(90deg,rgba(255,107,157,.1),rgba(192,111,255,.1));border-bottom:1px solid rgba(255,255,255,.07);user-select:none;flex-shrink:0; }
        .vtb-icon  { font-size:18px; }
        .vtb-title { flex:1;color:white;font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
        .vtb-win-btns { display:flex;gap:6px; }
        .vtb-win-btn { width:14px;height:14px;border-radius:50%;border:none;cursor:pointer;transition:opacity .2s,transform .2s;display:flex;align-items:center;justify-content:center;color:transparent;font-size:8px;font-weight:900; }
        .vtb-win-btn:hover { opacity:.8;transform:scale(1.2);color:rgba(0,0,0,.5); }
        .vtb-win-btn.close { background:#ff5f57; }
        .vtb-win-btn.mini  { background:#febc2e; }
        .vtb-win-btn.full  { background:#28c840; }
        #visioIframeWrap { flex:1;position:relative;background:#000;overflow:hidden; }
        #visioToolbar { display:flex;align-items:center;gap:8px;padding:9px 14px;background:rgba(0,0,0,.65);border-top:1px solid rgba(255,255,255,.06);flex-wrap:wrap;flex-shrink:0; }
        .vt-btn { display:flex;align-items:center;gap:5px;padding:7px 13px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.13);border-radius:9px;color:white;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap; }
        .vt-btn:hover  { background:rgba(255,255,255,.16);transform:translateY(-1px); }
        .vt-btn.active { background:linear-gradient(135deg,rgba(255,107,157,.3),rgba(192,111,255,.3));border-color:rgba(255,107,157,.5); }
        .vt-btn.danger { background:rgba(239,68,68,.15);border-color:rgba(239,68,68,.3); }
        .vt-btn.danger:hover { background:rgba(239,68,68,.3); }
        .vt-icon { font-size:16px; }
        .users-panel::-webkit-scrollbar, .messages-area::-webkit-scrollbar { width:7px; }
        .users-panel::-webkit-scrollbar-track, .messages-area::-webkit-scrollbar-track { background:rgba(255,255,255,.05); border-radius:10px; }
        .users-panel::-webkit-scrollbar-thumb  { background:rgba(255,255,255,.2); border-radius:10px; }
        .messages-area::-webkit-scrollbar-thumb { background:linear-gradient(135deg,#ff6b9d,#c06fff); border-radius:10px; }
        @media (max-width:900px) {
            .users-panel { width:260px; }
            .toggle-sidebar-btn { left:10px; padding:12px 14px; }
            .toggle-text { display:none; }
            #visioContainer { width:96vw; height:75vh; }
            #visioContainer.pip { width:280px; height:200px; bottom:16px; right:16px; }
        }
        @media (max-width:600px) {
            .app-wrapper { padding:10px; gap:10px; }
            .chat-header { padding:10px 14px; }
            .theme-label { display:none; }
            .theme-btn, .theme-btn-custom, .user-profile-photo, .notif-toggle-btn, .arcade-btn, .wall-btn, .attach-btn { width:36px; height:36px; font-size:16px; }
            .toggle-sidebar-btn { left:6px; padding:10px 12px; border-radius:12px; }
            .toggle-icon { font-size:20px; }
            .chat-panel-header { padding:14px 16px; }
            .messages-area { padding:16px; }
            .input-area { padding:14px 16px; gap:10px; }
            .message-input { min-width:0; padding:12px 16px; font-size:14px; }
            .send-btn { padding:12px 20px; font-size:14px; }
            .pm-msg-wrap { max-width:90%; }
            .users-panel { position:fixed; top:0; left:0; height:100%; z-index:200; max-height:100vh; border-radius:0 20px 20px 0; width:280px; transform:translateX(0); transition:transform .4s cubic-bezier(.4,0,.2,1), opacity .4s; }
            .users-panel.hidden { transform:translateX(-100%); width:280px; opacity:0; pointer-events:none; }
            #visioContainer.pip { width:240px; height:180px; }
            #visioToolbar { gap:6px; padding:8px 12px; }
            .vt-btn { padding:7px 10px; font-size:13px; }
            .vt-btn span { display:none; }
        }
    </style>
</head>
<body class="theme-futuriste">
<div class="particles" id="particles"></div>
<div class="app-wrapper">
    <div class="chat-header">
        <div class="theme-selector">
            <span class="theme-label">ThÃ¨me :</span>
            <div class="theme-options">
                <div class="theme-btn" data-theme="zen"       style="background:linear-gradient(135deg,#e0f7fa,#80deea)"  title="Zen"></div>
                <div class="theme-btn" data-theme="plage"     style="background:linear-gradient(135deg,#ffd89b,#19547b)"  title="Plage"></div>
                <div class="theme-btn" data-theme="foret"     style="background:linear-gradient(135deg,#134e5e,#71b280)"  title="ForÃªt"></div>
                <div class="theme-btn active" data-theme="futuriste" style="background:linear-gradient(135deg,#667eea,#764ba2)" title="Futuriste"></div>
                <div class="theme-btn" data-theme="bonbon"    style="background:linear-gradient(135deg,#ffecd2,#ff9a9e)"  title="Bonbon"></div>
                <div class="theme-btn" data-theme="bar"       style="background:linear-gradient(135deg,#2c003e,#8b008b)"  title="Bar"></div>
                <div class="theme-btn" data-theme="chasse"    style="background:linear-gradient(135deg,#3e2723,#795548)"  title="Chasse"></div>
                <div class="theme-btn" data-theme="aquarium"  style="background:linear-gradient(135deg,#00416a,#ffe000)"  title="Aquarium"></div>
                <div class="theme-btn-custom" title="Photo personnalisÃ©e">ğŸ“·<input type="file" id="customBgInput" accept="image/*"></div>
                <a href="arcade.html" class="arcade-btn" title="ğŸ•¹ï¸ Arcade â€” Jeux">ğŸ•¹ï¸</a>
                <a href="wall.html" class="wall-btn" title="ğŸ“° Mur â€” Publications">ğŸ“°</a>
                <div class="notif-toggle-btn" id="notifBtn" title="Activer les notifications">ğŸ””</div>
                <div class="user-profile-photo" id="userProfilePhoto" title="Mon profil">ğŸ’¬</div>
            </div>
        </div>
    </div>
    <button class="toggle-sidebar-btn" id="toggleSidebar">
        <span class="toggle-icon" id="toggleIcon">ğŸ‘¥</span>
        <span class="toggle-text"  id="toggleText">Profils</span>
    </button>
    <div class="body-columns">
        <div class="users-panel" id="usersPanel">
            <div class="users-panel-header">
                ğŸ’¬ Conversations
                <div class="users-panel-count" id="profileCount">Chargement...</div>
            </div>
            <div class="user-list">
                <div class="user-item active" id="publicChatBtn">
                    <div class="user-avatar">ğŸŒ</div>
                    <div class="user-info">
                        <div class="user-name">Chat gÃ©nÃ©ral</div>
                        <div class="user-status-txt online">â— Public</div>
                    </div>
                </div>
            </div>
            <div class="user-list" id="profileList"></div>
        </div>
        <div class="right-panel" id="rightPanel">
            <div class="chat-panel-header">
                <div class="chat-panel-header-avatar" id="chatHeaderAvatar">ğŸŒ</div>
                <div class="chat-panel-header-info">
                    <div class="chat-panel-header-name"   id="chatHeaderName">Chat gÃ©nÃ©ral</div>
                    <div class="chat-panel-header-status online" id="chatHeaderStatus">â— Public</div>
                </div>
                <button class="visio-btn-header visible" id="visioBtn">ğŸ“¹ <span>Visio</span></button>
                <button class="wizz-btn" id="wizzBtn" style="display:none;">âš¡ WIZZ!</button>
            </div>
            <div class="messages-area" id="messagesArea"></div>
            <div class="input-area">
                <div class="attach-btn" title="ğŸ“ Joindre fichier/image">ğŸ“<input type="file" id="fileInput" accept="image/*,video/*,.pdf,.doc,.docx,.txt" multiple></div>
                <input type="text" class="message-input" id="messageInput" placeholder="Tapez votre message...">
                <button class="send-btn" id="sendBtn">Envoyer ğŸš€</button>
                <div class="bubble-color-row" id="bubbleColorPicker" style="display:none;">
                    <span class="bubble-color-label">ğŸ¨ Mes bulles :</span>
                    <div class="bubble-color-swatches" id="colorSwatches"></div>
                    <div class="color-swatch-custom" title="Couleur libre">âœï¸<input type="color" id="customColorInput"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="visioOverlay"></div>
<div id="visioContainer">
    <div id="visioTitleBar">
        <span class="vtb-icon">ğŸ“¹</span>
        <div style="flex:1;min-width:0;">
            <div class="vtb-title" id="visioTitleText">Visio</div>
            <div id="visioRoomInfo" style="font-size:12px;color:rgba(255,255,255,.4);"></div>
        </div>
        <div class="vtb-win-btns">
            <button class="vtb-win-btn close" id="visioCloseBtn" title="Fermer">âœ•</button>
            <button class="vtb-win-btn mini"  id="visioPipBtn"   title="RÃ©duire">âˆ’</button>
            <button class="vtb-win-btn full"  id="visioFullBtn"  title="Plein Ã©cran">+</button>
        </div>
    </div>
    <div id="visioIframeWrap"></div>
    <div id="visioToolbar"></div>
</div>
<audio id="notifSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2ozHTh/rt3fwpFkOTyLs+Psu5hqS0ybtO3yvKF1V1mhue7yuqJzV1qiue/yuqJ0WVmiuu/zuqJ0WVqiuu/zuqJ0WVqiuu/zuqJ0WVqiuu/zuqJ0WVqiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu/zuaF0WFuiuu8=" type="audio/wav">
</audio>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabase=createClient('https://eeikriwrwuynwpzodbbt.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlaWtyaXdyd3V5bndwem9kYmJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NzQ3NjYsImV4cCI6MjA4NjE1MDc2Nn0.MJ6CSmrttEWcrdfy5C7nP4sE_pe19sGNE-WasASPDNc');

/* â”€â”€ UPLOAD FICHIERS â”€â”€ */
var _fi=document.getElementById(â€˜fileInputâ€™); if(_fi) _fi.addEventListener(â€˜changeâ€™,async function(e){
var files=e.target.files; if(!files||!files.length)return;
for(var file of files){
if(file.size>5*1024*1024){alert(â€˜Fichier trop volumineux (max 5MB): â€˜+file.name);continue;}
try{
var fileName=Date.now()+â€™*â€™+file.name.replace(/[^a-zA-Z0-9.*-]/g,â€™â€™);
var up=await supabase.storage.from(â€˜chat-filesâ€™).upload(fileName,file,{cacheControl:â€˜3600â€™,upsert:false});
if(up.error){alert(â€˜Erreur upload: â€˜+up.error.message);continue;}
var urlData=supabase.storage.from(â€˜chat-filesâ€™).getPublicUrl(fileName);
var fileUrl=urlData.data.publicUrl;
var isImage=file.type.startsWith(â€˜image/â€™);
var text=isImage?(â€™[IMAGE]â€™+fileUrl):(â€™[FILE]â€™+file.name+â€™|â€™+fileUrl);
if(currentChatType===â€˜publicâ€™){await sendPublicMessage(text);}
else{await sendPMDirect(text);}
}catch(err){}
}
e.target.value=â€™â€™;
});

function formatMsg(text){
if(text.startsWith(â€™[IMAGE]â€™)){var url=text.replace(â€™[IMAGE]â€™,â€™â€™);return â€˜<img src="'+esc(url)+'" alt="Image" style="max-width:100%;border-radius:12px;margin-top:8px;">â€™;}
if(text.startsWith(â€™[FILE]â€™)){var parts=text.replace(â€™[FILE]â€™,â€™â€™).split(â€™|â€™);var name=parts[0]||â€˜Fichierâ€™;var url=parts[1]||â€™â€™;return â€˜ğŸ“ <a href="'+esc(url)+'" target="_blank" style="color:#64b5f6;">â€™+esc(name)+â€™</a>â€™;}
return esc(text);
}

/* â”€â”€ FINGERPRINT / IDENTITÃ‰ â”€â”€ */
function getOrCreateFingerprint(){var fp=localStorage.getItem(â€˜browserFingerprintâ€™);if(!fp){fp=Math.random().toString(36).slice(2)+Date.now().toString(36);localStorage.setItem(â€˜browserFingerprintâ€™,fp);}return fp;}
var currentUserPhoto=null;
var currentUserPrenom=localStorage.getItem(â€˜prenomâ€™)||â€˜Inviteâ€™;
var fingerprint=getOrCreateFingerprint();
var currentUniqueId=currentUserPrenom+â€™*â€™+fingerprint;
var savedPhotoUrl=localStorage.getItem(â€˜userPhotoUrlâ€™)||localStorage.getItem(â€˜tempPhotoPreviewâ€™);
(function(){var el=document.getElementById(â€˜userProfilePhotoâ€™);if(savedPhotoUrl){el.innerHTML=â€™<img src="'+savedPhotoUrl+'" alt="Profil">â€™;currentUserPhoto=savedPhotoUrl;}else el.textContent=â€˜ğŸ’¬â€™;})();

/* â”€â”€ VISIO â”€â”€ */
var elOverlay=document.getElementById(â€˜visioOverlayâ€™);
var elContainer=document.getElementById(â€˜visioContainerâ€™);
var elIframeWrap=document.getElementById(â€˜visioIframeWrapâ€™);
var elTitleText=document.getElementById(â€˜visioTitleTextâ€™);
var elRoomInfo=document.getElementById(â€˜visioRoomInfoâ€™);
var vidLocal=null,vidRemote=null;
var visioState={open:false,pip:false,fullscreen:false,dragging:false,dragOffX:0,dragOffY:0,roomId:null,isCaller:false,micOn:true,camOn:true};
var pc=null,localStream=null,sigPollInt=null;
var ICE_SERVERS={iceServers:[{urls:â€˜stun:stun.l.google.com:19302â€™},{urls:â€˜stun:stun1.l.google.com:19302â€™}]};
function buildRoomId(chatType,otherUniqueId){if(chatType===â€˜publicâ€™)return â€˜public_generalâ€™;var ids=[currentUniqueId,otherUniqueId||â€™â€™].sort();return â€™priv*â€™+ids[0].replace(/[^a-z0-9_]/gi,â€™â€™)+â€™*â€™+ids[1].replace(/[^a-z0-9*]/gi,â€™â€™);}
function buildVideoElements(){elIframeWrap.innerHTML=â€™â€™;vidRemote=document.createElement(â€˜videoâ€™);vidRemote.autoplay=true;vidRemote.playsInline=true;vidRemote.style.cssText=â€˜position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000;â€™;vidLocal=document.createElement(â€˜videoâ€™);vidLocal.autoplay=true;vidLocal.playsInline=true;vidLocal.muted=true;vidLocal.style.cssText=â€˜position:absolute;bottom:14px;right:14px;width:28%;max-width:200px;border-radius:12px;border:2px solid rgba(255,255,255,.3);object-fit:cover;aspect-ratio:4/3;z-index:2;background:#111;box-shadow:0 4px 20px rgba(0,0,0,.5);â€™;var waiting=document.createElement(â€˜divâ€™);waiting.id=â€˜visioWaitingâ€™;waiting.style.cssText=â€˜position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;background:rgba(0,0,0,.7);color:white;font-size:16px;z-index:3;transition:opacity .5s;â€™;waiting.innerHTML=â€™<div style="font-size:52px;">ğŸ“¹</div><div id="visioWaitingText" style="font-weight:600;">Camera en coursâ€¦</div>â€™;elIframeWrap.appendChild(vidRemote);elIframeWrap.appendChild(vidLocal);elIframeWrap.appendChild(waiting);}
function buildToolbar(){var tb=document.getElementById(â€˜visioToolbarâ€™);tb.innerHTML=â€™â€™;tb.style.display=â€˜flexâ€™;var btnMic=document.createElement(â€˜buttonâ€™);btnMic.className=â€˜vt-btn activeâ€™;btnMic.innerHTML=â€™<span class="vt-icon">ğŸ¤</span><span>Micro</span>â€™;btnMic.onclick=function(){visioState.micOn=!visioState.micOn;if(localStream)localStream.getAudioTracks().forEach(function(t){t.enabled=visioState.micOn;});btnMic.classList.toggle(â€˜activeâ€™,visioState.micOn);btnMic.querySelector(â€™.vt-iconâ€™).textContent=visioState.micOn?â€˜ğŸ¤â€™:â€˜ğŸ”‡â€™;};var btnCam=document.createElement(â€˜buttonâ€™);btnCam.className=â€˜vt-btn activeâ€™;btnCam.innerHTML=â€™<span class="vt-icon">ğŸ“¹</span><span>Camera</span>â€™;btnCam.onclick=function(){visioState.camOn=!visioState.camOn;if(localStream)localStream.getVideoTracks().forEach(function(t){t.enabled=visioState.camOn;});btnCam.classList.toggle(â€˜activeâ€™,visioState.camOn);btnCam.querySelector(â€™.vt-iconâ€™).textContent=visioState.camOn?â€˜ğŸ“¹â€™:â€˜ğŸš«â€™;};var btnPip=document.createElement(â€˜buttonâ€™);btnPip.className=â€˜vt-btnâ€™;btnPip.innerHTML=â€™<span class="vt-icon">ğŸ“Œ</span><span>Reduire</span>â€™;btnPip.onclick=togglePip;var btnFull=document.createElement(â€˜buttonâ€™);btnFull.className=â€˜vt-btnâ€™;btnFull.innerHTML=â€™<span class="vt-icon">â›¶</span><span>Plein ecran</span>â€™;btnFull.onclick=toggleFullscreen;var btnHang=document.createElement(â€˜buttonâ€™);btnHang.className=â€˜vt-btn dangerâ€™;btnHang.innerHTML=â€™<span class="vt-icon">ğŸ“</span><span>Raccrocher</span>â€™;btnHang.onclick=closeVisio;[btnMic,btnCam,btnPip,btnFull,btnHang].forEach(function(b){tb.appendChild(b);});}
async function sendSignal(roomId,type,payload){try{await supabase.from(â€˜visio_signalsâ€™).insert({room_id:roomId,sender_id:currentUniqueId,type:type,payload:JSON.stringify(payload),created_at:new Date().toISOString()});}catch(e){}}
var lastSigTime=null;
async function pollSignals(roomId){if(!visioState.open||visioState.roomId!==roomId)return;try{var q=supabase.from(â€˜visio_signalsâ€™).select(â€™*â€™).eq(â€˜room_idâ€™,roomId).neq(â€˜sender_idâ€™,currentUniqueId).order(â€˜created_atâ€™,{ascending:true});if(lastSigTime)q=q.gt(â€˜created_atâ€™,lastSigTime);var res=await q;if(res.error||!res.data||!res.data.length)return;for(var i=0;i<res.data.length;i++){var sig=res.data[i];if(sig.created_at>(lastSigTime||â€™â€™))lastSigTime=sig.created_at;await handleSignal(sig.type,JSON.parse(sig.payload||â€™{}â€™));}}catch(e){}}
async function handleSignal(type,payload){if(!pc&&type!==â€˜offerâ€™&&type!==â€˜inviteâ€™)return;if(type===â€˜inviteâ€™){showVisioInvite(payload.fromName,payload.roomId);return;}if(type===â€˜offerâ€™){if(!pc)await setupPC(visioState.roomId,false);await pc.setRemoteDescription(new RTCSessionDescription(payload));var answer=await pc.createAnswer();await pc.setLocalDescription(answer);await sendSignal(visioState.roomId,â€˜answerâ€™,answer);hideWaiting();return;}if(type===â€˜answerâ€™){await pc.setRemoteDescription(new RTCSessionDescription(payload));hideWaiting();return;}if(type===â€˜iceâ€™){try{await pc.addIceCandidate(new RTCIceCandidate(payload));}catch(e){}return;}if(type===â€˜byeâ€™){closeVisio();return;}}
async function setupPC(roomId,isCaller){pc=new RTCPeerConnection(ICE_SERVERS);if(localStream)localStream.getTracks().forEach(function(t){pc.addTrack(t,localStream);});pc.ontrack=function(e){if(vidRemote&&e.streams&&e.streams[0]){vidRemote.srcObject=e.streams[0];hideWaiting();}};pc.onicecandidate=function(e){if(e.candidate)sendSignal(roomId,â€˜iceâ€™,e.candidate.toJSON());};pc.onconnectionstatechange=function(){if(pc&&(pc.connectionState===â€˜disconnectedâ€™||pc.connectionState===â€˜failedâ€™))setWaitingText(â€˜Connexion perdueâ€¦â€™);};if(isCaller){var offer=await pc.createOffer({offerToReceiveAudio:true,offerToReceiveVideo:true});await pc.setLocalDescription(offer);await sendSignal(roomId,â€˜offerâ€™,offer);}}
function hideWaiting(){var w=document.getElementById(â€˜visioWaitingâ€™);if(w){w.style.opacity=â€˜0â€™;setTimeout(function(){w.style.display=â€˜noneâ€™;},500);}}
function setWaitingText(txt){var el=document.getElementById(â€˜visioWaitingTextâ€™);if(el)el.textContent=txt;var w=document.getElementById(â€˜visioWaitingâ€™);if(w){w.style.display=â€˜flexâ€™;w.style.opacity=â€˜1â€™;}}
function showVisioInvite(fromName,roomId){var existing=document.getElementById(â€˜visioInviteToastâ€™);if(existing)existing.remove();var toast=document.createElement(â€˜divâ€™);toast.id=â€˜visioInviteToastâ€™;toast.style.cssText=â€˜position:fixed;bottom:30px;left:50%;transform:translateX(-50%);z-index:9999;background:rgba(10,3,24,.97);border:2px solid rgba(255,107,157,.7);border-radius:18px;padding:20px 28px;color:white;text-align:center;box-shadow:0 15px 50px rgba(0,0,0,.8);â€™;toast.innerHTML=â€™<div style="font-size:28px;margin-bottom:8px;">ğŸ“¹</div><div style="font-weight:700;font-size:16px;margin-bottom:4px;">â€™+esc(fromName)+â€™ t'appelle</div><div style="display:flex;gap:12px;margin-top:14px;justify-content:center;"><button id="visioAcceptBtn" style="padding:10px 24px;background:linear-gradient(135deg,#43e97b,#38f9d7);border:none;border-radius:12px;color:white;font-weight:700;font-size:15px;cursor:pointer;">âœ… Rejoindre</button><button id="visioDenyBtn" style="padding:10px 24px;background:rgba(239,68,68,.3);border:1px solid rgba(239,68,68,.5);border-radius:12px;color:white;font-weight:700;font-size:15px;cursor:pointer;">âŒ Refuser</button></div>â€™;document.body.appendChild(toast);document.getElementById(â€˜visioAcceptBtnâ€™).onclick=function(){toast.remove();visioState.roomId=roomId;lastSigTime=null;openVisioRoom(roomId,fromName,false);};document.getElementById(â€˜visioDenyBtnâ€™).onclick=function(){toast.remove();};setTimeout(function(){if(toast.parentNode)toast.remove();},30000);}
async function openVisio(chatType,otherUser){var roomId=buildRoomId(chatType,otherUser?otherUser.unique_id:null);var label=chatType===â€˜publicâ€™?â€˜Chat generalâ€™:(otherUser?otherUser.prenom:â€˜Visioâ€™);lastSigTime=null;if(chatType===â€˜privateâ€™&&otherUser)await sendSignal(roomId,â€˜inviteâ€™,{fromName:currentUserPrenom,roomId:roomId});openVisioRoom(roomId,label,true);}
async function openVisioRoom(roomId,label,isCaller){visioState.open=true;visioState.pip=false;visioState.fullscreen=false;visioState.roomId=roomId;visioState.isCaller=isCaller;visioState.micOn=true;visioState.camOn=true;elOverlay.classList.add(â€˜openâ€™);elContainer.classList.add(â€˜openâ€™);elContainer.classList.remove(â€˜pipâ€™,â€˜fullscreenâ€™);resetContainerPos();elTitleText.textContent=label;elRoomInfo.textContent=isCaller?â€˜Appel en coursâ€¦â€™:â€˜Connexionâ€¦â€™;buildVideoElements();buildToolbar();try{localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});vidLocal.srcObject=localStream;setWaitingText(isCaller?â€˜En attenteâ€¦â€™:â€˜Connexion en coursâ€¦â€™);}catch(e){setWaitingText(â€˜Camera indisponibleâ€™);return;}await setupPC(roomId,isCaller);if(sigPollInt)clearInterval(sigPollInt);sigPollInt=setInterval(function(){pollSignals(roomId);},1500);document.body.style.overflow=â€˜hiddenâ€™;}
function closeVisio(){visioState.open=false;visioState.pip=false;visioState.fullscreen=false;if(visioState.roomId)sendSignal(visioState.roomId,â€˜byeâ€™,{});if(sigPollInt){clearInterval(sigPollInt);sigPollInt=null;}if(pc){try{pc.close();}catch(e){}pc=null;}if(localStream){localStream.getTracks().forEach(function(t){t.stop();});localStream=null;}elOverlay.classList.remove(â€˜openâ€™,â€˜pip-modeâ€™);elContainer.classList.remove(â€˜openâ€™,â€˜pipâ€™,â€˜fullscreenâ€™);elIframeWrap.innerHTML=â€™â€™;document.getElementById(â€˜visioToolbarâ€™).innerHTML=â€™â€™;document.body.style.overflow=â€™â€™;resetContainerPos();}
function togglePip(){if(!visioState.open)return;visioState.pip=!visioState.pip;if(visioState.pip){visioState.fullscreen=false;elContainer.classList.add(â€˜pipâ€™);elContainer.classList.remove(â€˜fullscreenâ€™);elOverlay.classList.add(â€˜pip-modeâ€™);elContainer.style.transform=â€˜noneâ€™;elContainer.style.top=â€˜autoâ€™;elContainer.style.left=â€˜autoâ€™;elContainer.style.width=â€™â€™;elContainer.style.height=â€™â€™;}else{elContainer.classList.remove(â€˜pipâ€™);elOverlay.classList.remove(â€˜pip-modeâ€™);resetContainerPos();}document.body.style.overflow=visioState.pip?â€™â€™:â€˜hiddenâ€™;}
function toggleFullscreen(){if(!visioState.open)return;visioState.fullscreen=!visioState.fullscreen;if(visioState.fullscreen){visioState.pip=false;elContainer.classList.add(â€˜fullscreenâ€™);elContainer.classList.remove(â€˜pipâ€™);elOverlay.classList.remove(â€˜pip-modeâ€™);elContainer.style.transform=â€˜noneâ€™;elContainer.style.top=â€˜0â€™;elContainer.style.left=â€˜0â€™;elContainer.style.width=â€˜100vwâ€™;elContainer.style.height=â€˜100vhâ€™;document.body.style.overflow=â€˜hiddenâ€™;}else{elContainer.classList.remove(â€˜fullscreenâ€™);resetContainerPos();document.body.style.overflow=â€˜hiddenâ€™;}}
function resetContainerPos(){elContainer.style.bottom=â€™â€™;elContainer.style.right=â€™â€™;elContainer.style.top=â€˜50%â€™;elContainer.style.left=â€˜50%â€™;elContainer.style.transform=â€˜translate(-50%, -50%)â€™;elContainer.style.width=â€™â€™;elContainer.style.height=â€™â€™;}
elContainer.addEventListener(â€˜mousedownâ€™,startDrag);elContainer.addEventListener(â€˜touchstartâ€™,startDrag,{passive:true});document.addEventListener(â€˜mousemoveâ€™,onDrag);document.addEventListener(â€˜touchmoveâ€™,onDrag,{passive:false});document.addEventListener(â€˜mouseupâ€™,stopDrag);document.addEventListener(â€˜touchendâ€™,stopDrag);
function startDrag(e){if(!visioState.pip)return;if(e.target.tagName===â€˜BUTTONâ€™||e.target.tagName===â€˜VIDEOâ€™||e.target.closest(â€˜buttonâ€™))return;visioState.dragging=true;var rect=elContainer.getBoundingClientRect();var cx=e.type===â€˜touchstartâ€™?e.touches[0].clientX:e.clientX;var cy=e.type===â€˜touchstartâ€™?e.touches[0].clientY:e.clientY;visioState.dragOffX=cx-rect.left;visioState.dragOffY=cy-rect.top;}
function onDrag(e){if(!visioState.dragging||!visioState.pip)return;if(e.type===â€˜touchmoveâ€™)e.preventDefault();var cx=e.type===â€˜touchmoveâ€™?e.touches[0].clientX:e.clientX;var cy=e.type===â€˜touchmoveâ€™?e.touches[0].clientY:e.clientY;var x=Math.max(0,Math.min(window.innerWidth-elContainer.offsetWidth,cx-visioState.dragOffX));var y=Math.max(0,Math.min(window.innerHeight-elContainer.offsetHeight,cy-visioState.dragOffY));elContainer.style.left=x+â€˜pxâ€™;elContainer.style.top=y+â€˜pxâ€™;elContainer.style.right=â€˜autoâ€™;elContainer.style.bottom=â€˜autoâ€™;elContainer.style.transform=â€˜noneâ€™;}
function stopDrag(){visioState.dragging=false;}
document.getElementById(â€˜visioBtnâ€™).addEventListener(â€˜clickâ€™,function(){openVisio(currentChatType,currentChatType===â€˜privateâ€™?currentChatUser:null);});
elOverlay.addEventListener(â€˜clickâ€™,function(e){if(e.target===elOverlay&&!visioState.pip)closeVisio();});
document.getElementById(â€˜visioCloseBtnâ€™).addEventListener(â€˜clickâ€™,closeVisio);
document.getElementById(â€˜visioPipBtnâ€™).addEventListener(â€˜clickâ€™,togglePip);
document.getElementById(â€˜visioFullBtnâ€™).addEventListener(â€˜clickâ€™,toggleFullscreen);
var inviteCheckInt=setInterval(async function(){if(visioState.open)return;try{var cutoff=new Date(Date.now()-40000).toISOString();var res=await supabase.from(â€˜visio_signalsâ€™).select(â€™*â€™).neq(â€˜sender_idâ€™,currentUniqueId).eq(â€˜typeâ€™,â€˜inviteâ€™).gte(â€˜created_atâ€™,cutoff).order(â€˜created_atâ€™,{ascending:false}).limit(1);if(!res.data||!res.data.length)return;var sig=res.data[0];var p=JSON.parse(sig.payload||â€™{}â€™);if(p.roomId&&p.roomId.includes(currentUniqueId.replace(/[^a-z0-9_]/gi,â€™â€™))){showVisioInvite(p.fromName||â€˜Quelquunâ€™,p.roomId);clearInterval(inviteCheckInt);}}catch(e){}},3000);
document.addEventListener(â€˜keydownâ€™,function(e){if(e.key===â€˜Escapeâ€™){if(visioState.fullscreen)toggleFullscreen();else if(visioState.open&&!visioState.pip)closeVisio();}});

/* â”€â”€ NOTIFICATIONS â”€â”€ */
var swRegistration=null,notifGranted=false;
async function registerSW(){if(!(â€˜serviceWorkerâ€™ in navigator))return;try{swRegistration=await navigator.serviceWorker.register(â€™/sw.jsâ€™);updateNotifBtn();}catch(e){}}
async function requestNotifPermission(){if(!(â€˜Notificationâ€™ in window)){alert(â€˜Votre navigateur ne supporte pas les notifications.â€™);return;}if(Notification.permission===â€˜grantedâ€™){notifGranted=true;updateNotifBtn();return;}if(Notification.permission===â€˜deniedâ€™){alert(â€˜Notifications bloquees. Veuillez les autoriser dans les reglages.â€™);return;}try{var result=await Notification.requestPermission();notifGranted=(result===â€˜grantedâ€™);updateNotifBtn();if(notifGranted)sendPushNotif(â€˜BubbleChatâ€™,â€˜Notifications activees !â€™,â€˜ğŸŒâ€™);}catch(e){}}
function updateNotifBtn(){var btn=document.getElementById(â€˜notifBtnâ€™);if(!btn)return;var perm=(â€˜Notificationâ€™ in window)?Notification.permission:â€˜unsupportedâ€™;if(perm===â€˜grantedâ€™){btn.textContent=â€˜ğŸ””â€™;btn.classList.add(â€˜activeâ€™);btn.classList.remove(â€˜deniedâ€™);btn.title=â€˜Notifications activeesâ€™;notifGranted=true;}else if(perm===â€˜deniedâ€™){btn.textContent=â€˜ğŸ”•â€™;btn.classList.add(â€˜deniedâ€™);btn.classList.remove(â€˜activeâ€™);btn.title=â€˜Notifications bloqueesâ€™;}else{btn.textContent=â€˜ğŸ””â€™;btn.classList.remove(â€˜activeâ€™,â€˜deniedâ€™);btn.title=â€˜Activer les notificationsâ€™;}}
function sendPushNotif(title,body,senderPhoto){try{var a=document.getElementById(â€˜notifSoundâ€™);if(a){a.currentTime=0;a.play().catch(function(){});}}catch(e){}if(!document.hidden)return;if(!notifGranted)return;if(swRegistration&&swRegistration.active){swRegistration.active.postMessage({type:â€˜NEW_MESSAGEâ€™,title:title,body:body,icon:senderPhoto||â€™/icon-192.pngâ€™,tag:â€˜bubblechat-â€™+Date.now(),url:â€™/chat.htmlâ€™});}else{try{new Notification(title,{body:body,icon:â€™/icon-192.pngâ€™,badge:â€™/icon-192.pngâ€™,vibrate:[200,100,200]});}catch(e){}}}
document.getElementById(â€˜notifBtnâ€™).addEventListener(â€˜clickâ€™,requestNotifPermission);
registerSW();updateNotifBtn();

/* â”€â”€ SIDEBAR â”€â”€ */
var sidebarVisible=true;
var isMobile=function(){return window.innerWidth<=600;};
document.getElementById(â€˜toggleSidebarâ€™).addEventListener(â€˜clickâ€™,function(e){
e.stopPropagation();
sidebarVisible=!sidebarVisible;
document.getElementById(â€˜usersPanelâ€™).classList.toggle(â€˜hiddenâ€™,!sidebarVisible);
document.getElementById(â€˜toggleIconâ€™).textContent=sidebarVisible?â€˜ğŸ‘¥â€™:â€˜ğŸ’¬â€™;
document.getElementById(â€˜toggleTextâ€™).textContent=sidebarVisible?â€˜Profilsâ€™:â€˜Chatâ€™;
});
/* â”€â”€ FIX CRITIQUE : ferme sidebar mobile seulement si clic HORS panel ET HORS toggleBtn â”€â”€ */
/* sidebar se ferme via toggle uniquement */

/* â”€â”€ Ã‰TAT GLOBAL â”€â”€ */
var currentChatType=â€˜publicâ€™,currentChatUser=null,profiles=[],pmBadges={},lastPublicMsgTime=null,lastPMId=0,pmPollInterval=null,lastInboxId=0;

/* â”€â”€ COULEURS BULLES â”€â”€ */
var PRESETS=[{l:â€˜Rose/Violetâ€™,v:â€˜linear-gradient(135deg,#ff6b9d,#c06fff)â€™},{l:â€˜Bleuâ€™,v:â€˜linear-gradient(135deg,#2196f3,#03a9f4)â€™},{l:â€˜Vertâ€™,v:â€˜linear-gradient(135deg,#43e97b,#38f9d7)â€™},{l:â€˜Orangeâ€™,v:â€˜linear-gradient(135deg,#f7971e,#ffd200)â€™},{l:â€˜Rougeâ€™,v:â€˜linear-gradient(135deg,#f44336,#e91e63)â€™},{l:â€˜Indigoâ€™,v:â€˜linear-gradient(135deg,#5c6bc0,#7c4dff)â€™},{l:â€˜Cyanâ€™,v:â€˜linear-gradient(135deg,#00bcd4,#26c6da)â€™},{l:â€˜Noirâ€™,v:â€˜linear-gradient(135deg,#2d2d2d,#555)â€™}];
var myBubbleStyle=localStorage.getItem(â€˜myBubbleStyleâ€™)||PRESETS[0].v;
function buildColorSwatches(){var c=document.getElementById(â€˜colorSwatchesâ€™);c.innerHTML=â€™â€™;PRESETS.forEach(function(p){var sw=document.createElement(â€˜divâ€™);sw.className=â€˜color-swatchâ€™+(myBubbleStyle===p.v?â€™ activeâ€™:â€™â€™);sw.style.background=p.v;sw.title=p.l;sw.addEventListener(â€˜clickâ€™,function(){c.querySelectorAll(â€™.color-swatchâ€™).forEach(function(s){s.classList.remove(â€˜activeâ€™);});sw.classList.add(â€˜activeâ€™);myBubbleStyle=p.v;localStorage.setItem(â€˜myBubbleStyleâ€™,p.v);document.querySelectorAll(â€™.pm-msg.sentâ€™).forEach(function(b){b.style.background=p.v;});});c.appendChild(sw);});}
buildColorSwatches();
document.getElementById(â€˜customColorInputâ€™).addEventListener(â€˜inputâ€™,function(e){var hex=e.target.value;document.querySelectorAll(â€™.color-swatchâ€™).forEach(function(s){s.classList.remove(â€˜activeâ€™);});myBubbleStyle=hex;localStorage.setItem(â€˜myBubbleStyleâ€™,hex);document.querySelectorAll(â€™.pm-msg.sentâ€™).forEach(function(b){b.style.background=hex;});});

/* â”€â”€ STATUT EN LIGNE â”€â”€ */
async function setOnlineStatus(online){try{await supabase.from(â€˜profilesâ€™).update({is_online:online,last_seen:new Date().toISOString()}).eq(â€˜unique_idâ€™,currentUniqueId);}catch(e){}}
setOnlineStatus(true);setInterval(function(){setOnlineStatus(true);},30000);
window.addEventListener(â€˜beforeunloadâ€™,function(){setOnlineStatus(false);});
document.addEventListener(â€˜visibilitychangeâ€™,function(){setOnlineStatus(!document.hidden);});

/* â”€â”€ PROFILS â”€â”€ */
async function loadProfiles(){try{var res=await supabase.from(â€˜profilesâ€™).select(â€˜unique_id, prenom, photo_url, is_online, last_seenâ€™).order(â€˜is_onlineâ€™,{ascending:false}).order(â€˜prenomâ€™,{ascending:true});if(res.error)return;profiles=(res.data||[]).filter(function(p){return p.unique_id!==currentUniqueId;}).map(function(p){return{unique_id:p.unique_id||â€™â€™,prenom:p.prenom||â€˜Anonymeâ€™,photo_url:p.photo_url||null,is_online:!!p.is_online};});renderProfiles();}catch(e){}}
function renderProfiles(){var container=document.getElementById(â€˜profileListâ€™);var countEl=document.getElementById(â€˜profileCountâ€™);container.innerHTML=â€™â€™;var onlineCount=profiles.filter(function(p){return p.is_online;}).length;countEl.textContent=profiles.length+â€™ utilisateurâ€™+(profiles.length>1?â€˜sâ€™:â€™â€™)+â€™ Â· â€˜+onlineCount+â€™ en ligneâ€™;profiles.forEach(function(profile){var item=document.createElement(â€˜divâ€™);item.className=â€˜user-itemâ€™+(currentChatType===â€˜privateâ€™&&currentChatUser&&currentChatUser.unique_id===profile.unique_id?â€™ activeâ€™:â€™â€™);item.dataset.uid=profile.unique_id;var av=document.createElement(â€˜divâ€™);av.className=â€˜user-avatarâ€™;av.innerHTML=profile.photo_url?â€™<img src="'+profile.photo_url+'" alt="'+esc(profile.prenom)+'">â€™:profile.prenom[0].toUpperCase();var dot=document.createElement(â€˜divâ€™);dot.className=â€˜status-dot â€˜+(profile.is_online?â€˜onlineâ€™:â€˜offlineâ€™);av.appendChild(dot);var info=document.createElement(â€˜divâ€™);info.className=â€˜user-infoâ€™;info.innerHTML=â€™<div class="user-name">â€™+esc(profile.prenom)+â€™</div><div class="user-status-txt '+(profile.is_online?'online':'offline')+'">â€™+(profile.is_online?â€˜â— En ligneâ€™:â€˜â— Hors ligneâ€™)+â€™</div>â€™;item.appendChild(av);item.appendChild(info);var unread=pmBadges[profile.unique_id]||0;if(unread>0){var badge=document.createElement(â€˜divâ€™);badge.className=â€˜notif-badgeâ€™;badge.textContent=unread>99?â€˜99+â€™:unread;item.appendChild(badge);}item.addEventListener(â€˜clickâ€™,function(e){e.stopPropagation();switchToPrivateChat(profile);if(isMobile()){sidebarVisible=false;document.getElementById(â€˜usersPanelâ€™).classList.add(â€˜hiddenâ€™);document.getElementById(â€˜toggleIconâ€™).textContent=â€˜ğŸ’¬â€™;document.getElementById(â€˜toggleTextâ€™).textContent=â€˜Chatâ€™;}});container.appendChild(item);});}
setInterval(loadProfiles,5000);loadProfiles();

/* â”€â”€ INBOX POLLING â”€â”€ */
async function pollInbox(){try{var res=await supabase.from(â€˜private_messagesâ€™).select(â€˜id, sender_unique_id, messageâ€™).eq(â€˜receiver_unique_idâ€™,currentUniqueId).eq(â€˜is_readâ€™,false).gt(â€˜idâ€™,lastInboxId).order(â€˜idâ€™,{ascending:true});if(res.error||!res.data||!res.data.length)return;res.data.forEach(function(msg){if(msg.id>lastInboxId)lastInboxId=msg.id;var sid=msg.sender_unique_id;if(!(currentChatType===â€˜privateâ€™&&currentChatUser&&currentChatUser.unique_id===sid)){pmBadges[sid]=(pmBadges[sid]||0)+1;renderProfiles();showPMToast(msg,sid);var sender=profiles.find(function(p){return p.unique_id===sid;});sendPushNotif(â€˜ğŸ’Œ â€˜+(sender?sender.prenom:â€˜Quelquunâ€™),msg.message===â€˜âš¡ WIZZ !â€™?â€˜âš¡ WIZZ !â€™:msg.message,sender?sender.photo_url:null);}});}catch(e){}}
setInterval(pollInbox,3000);
function showPMToast(msg,senderId){var sender=profiles.find(function(p){return p.unique_id===senderId;});var name=sender?sender.prenom:â€˜Quelquunâ€™;var toast=document.createElement(â€˜divâ€™);toast.className=â€˜pm-toastâ€™;toast.innerHTML=â€™<div class="pm-toast-name">ğŸ’Œ â€˜+esc(name)+â€™</div><div class="pm-toast-text">â€™+esc(msg.message)+â€™</div>â€™;toast.addEventListener(â€˜clickâ€™,function(){var prof=profiles.find(function(p){return p.unique_id===senderId;});if(prof)switchToPrivateChat(prof);toast.remove();});document.body.appendChild(toast);setTimeout(function(){toast.style.opacity=â€˜0â€™;setTimeout(function(){toast.remove();},400);},5000);}

/* â”€â”€ WIZZ â”€â”€ */
document.getElementById(â€˜wizzBtnâ€™).addEventListener(â€˜clickâ€™,async function(){if(!currentChatUser)return;document.getElementById(â€˜rightPanelâ€™).classList.add(â€˜wizzingâ€™);setTimeout(function(){document.getElementById(â€˜rightPanelâ€™).classList.remove(â€˜wizzingâ€™);},600);try{await supabase.from(â€˜private_messagesâ€™).insert({sender_unique_id:currentUniqueId,receiver_unique_id:currentChatUser.unique_id,message:â€˜âš¡ WIZZ !â€™,is_read:false});}catch(e){}});

/* â”€â”€ CHAT PUBLIC â”€â”€ */
async function loadPublicMessages(){try{var query=supabase.from(â€˜messagesâ€™).select(â€˜id, prenom, message, created_at, photo_urlâ€™).is(â€˜to_userâ€™,null).order(â€˜created_atâ€™,{ascending:true}).limit(60);if(lastPublicMsgTime)query=query.gt(â€˜created_atâ€™,lastPublicMsgTime);var res=await query;if(res.error||!res.data||!res.data.length)return;var isFirst=!lastPublicMsgTime;if(isFirst)document.getElementById(â€˜messagesAreaâ€™).innerHTML=â€™â€™;res.data.forEach(function(msg){if(!lastPublicMsgTime||msg.created_at>lastPublicMsgTime)lastPublicMsgTime=msg.created_at;if(currentChatType===â€˜publicâ€™){var isNew=!isFirst&&msg.prenom!==currentUserPrenom;renderPublicMessage({author:msg.prenom||â€˜Anonymeâ€™,text:msg.message,photo:msg.photo_url,time:fmtTime(msg.created_at)});if(isNew)sendPushNotif(â€˜ğŸŒ â€˜+(msg.prenom||â€˜Anonymeâ€™),msg.message,msg.photo_url||â€™/icon-192.pngâ€™);}});}catch(e){}}
function renderPublicMessage(opts){var area=document.getElementById(â€˜messagesAreaâ€™);var el=document.createElement(â€˜divâ€™);el.className=â€˜messageâ€™;var av=document.createElement(â€˜divâ€™);av.className=â€˜message-avatarâ€™;av.innerHTML=opts.photo?â€™<img src="'+opts.photo+'" alt="'+esc(opts.author)+'">â€™:(opts.author?opts.author[0]:â€™?â€™).toUpperCase();var content=document.createElement(â€˜divâ€™);content.className=â€˜message-contentâ€™;content.innerHTML=â€™<div class="message-author">â€™+esc(opts.author)+â€™</div><div class="message-text">â€™+formatMsg(opts.text)+â€™</div><div class="message-time">â€™+opts.time+â€™</div>â€™;el.appendChild(av);el.appendChild(content);area.appendChild(el);area.scrollTop=area.scrollHeight;}
async function sendPublicMessage(text){renderPublicMessage({author:currentUserPrenom,text:text,photo:currentUserPhoto,time:fmtTime(new Date().toISOString())});try{var res=await supabase.from(â€˜messagesâ€™).insert({prenom:currentUserPrenom,message:text,photo_url:currentUserPhoto||null,to_user:null}).select(â€˜created_atâ€™).single();if(!res.error&&res.data&&res.data.created_at&&(!lastPublicMsgTime||res.data.created_at>lastPublicMsgTime))lastPublicMsgTime=res.data.created_at;}catch(e){}}
setInterval(loadPublicMessages,2500);

/* â”€â”€ VUES â”€â”€ */
function setHeader(avatarHtml,name,statusTxt,isOnline,showWizz){document.getElementById(â€˜chatHeaderAvatarâ€™).innerHTML=avatarHtml;document.getElementById(â€˜chatHeaderNameâ€™).textContent=name;var st=document.getElementById(â€˜chatHeaderStatusâ€™);st.className=â€˜chat-panel-header-status â€˜+(isOnline?â€˜onlineâ€™:â€˜offlineâ€™);st.textContent=statusTxt;document.getElementById(â€˜wizzBtnâ€™).style.display=showWizz?â€˜blockâ€™:â€˜noneâ€™;}
function switchToPublicChat(){if(pmPollInterval){clearInterval(pmPollInterval);pmPollInterval=null;}currentChatType=â€˜publicâ€™;currentChatUser=null;lastPublicMsgTime=null;setHeader(â€˜ğŸŒâ€™,â€˜Chat generalâ€™,â€˜â— Publicâ€™,true,false);document.getElementById(â€˜bubbleColorPickerâ€™).style.display=â€˜noneâ€™;document.querySelectorAll(â€™.user-itemâ€™).forEach(function(i){i.classList.remove(â€˜activeâ€™);});document.getElementById(â€˜publicChatBtnâ€™).classList.add(â€˜activeâ€™);document.getElementById(â€˜messagesAreaâ€™).innerHTML=â€™â€™;loadPublicMessages();}
function switchToPrivateChat(profile){if(pmPollInterval){clearInterval(pmPollInterval);pmPollInterval=null;}currentChatType=â€˜privateâ€™;currentChatUser=profile;lastPMId=0;pmBadges[profile.unique_id]=0;var avHtml=profile.photo_url?â€™<img src="'+profile.photo_url+'" alt="'+esc(profile.prenom)+'">â€™:profile.prenom[0].toUpperCase();setHeader(avHtml,profile.prenom,profile.is_online?â€˜ğŸŸ¢ En ligneâ€™:â€˜ğŸ”´ Hors ligneâ€™,profile.is_online,true);document.getElementById(â€˜bubbleColorPickerâ€™).style.display=â€˜flexâ€™;document.querySelectorAll(â€™.user-itemâ€™).forEach(function(i){i.classList.remove(â€˜activeâ€™);});document.querySelectorAll(â€™.user-item[data-uid=â€â€™+profile.unique_id+â€™â€]â€™).forEach(function(i){i.classList.add(â€˜activeâ€™);});document.getElementById(â€˜publicChatBtnâ€™).classList.remove(â€˜activeâ€™);loadPMHistory(profile.unique_id);markAllRead(profile.unique_id);document.querySelectorAll(â€™.notif-badgeâ€™).forEach(function(b){var item=b.closest(â€™.user-itemâ€™);if(item&&item.dataset.uid===profile.unique_id)b.remove();});pmPollInterval=setInterval(function(){pollNewPMs(profile.unique_id);},2500);}
document.getElementById(â€˜publicChatBtnâ€™).addEventListener(â€˜clickâ€™,function(e){e.stopPropagation();switchToPublicChat();if(isMobile()){sidebarVisible=false;document.getElementById(â€˜usersPanelâ€™).classList.add(â€˜hiddenâ€™);document.getElementById(â€˜toggleIconâ€™).textContent=â€˜ğŸ’¬â€™;document.getElementById(â€˜toggleTextâ€™).textContent=â€˜Chatâ€™;}});

/* â”€â”€ MESSAGES PRIVES â”€â”€ */
async function loadPMHistory(otherId){var area=document.getElementById(â€˜messagesAreaâ€™);area.innerHTML=â€™<div class="pm-empty"><span class="pm-empty-icon">ğŸ’¬</span>Chargementâ€¦</div>â€™;try{var res=await supabase.from(â€˜private_messagesâ€™).select(â€˜id, sender_unique_id, message, created_at, is_readâ€™).or(â€˜and(sender_unique_id.eq.â€™+currentUniqueId+â€™,receiver_unique_id.eq.â€™+otherId+â€™),and(sender_unique_id.eq.â€™+otherId+â€™,receiver_unique_id.eq.â€™+currentUniqueId+â€™)â€™).order(â€˜created_atâ€™,{ascending:true}).limit(150);if(res.error){area.innerHTML=â€™<div class="pm-empty"><span class="pm-empty-icon">âš ï¸</span>Erreur chargement</div>â€™;return;}area.innerHTML=â€™â€™;if(!res.data||!res.data.length){area.innerHTML=â€™<div class="pm-empty"><span class="pm-empty-icon">ğŸ’Œ</span>Aucun message</div>â€™;return;}res.data.forEach(function(msg){if(msg.id>lastPMId)lastPMId=msg.id;appendPMBubble({id:msg.id,text:msg.message,fromMe:msg.sender_unique_id===currentUniqueId,time:fmtTime(msg.created_at),is_read:msg.is_read});});area.scrollTop=area.scrollHeight;}catch(e){}}
function appendPMBubble(msg){var area=document.getElementById(â€˜messagesAreaâ€™);var empty=area.querySelector(â€™.pm-emptyâ€™);if(empty)empty.remove();var wrap=document.createElement(â€˜divâ€™);wrap.className=â€˜pm-msg-wrap â€˜+(msg.fromMe?â€˜sentâ€™:â€˜receivedâ€™);wrap.dataset.msgId=msg.id;var bubble=document.createElement(â€˜divâ€™);bubble.className=â€˜pm-msg â€˜+(msg.fromMe?â€˜sentâ€™:â€˜receivedâ€™);if(msg.fromMe)bubble.style.background=myBubbleStyle;var tick=msg.fromMe?â€™<span class="pm-tick '+(msg.is_read?'read':'')+'">â€™+(msg.is_read?â€˜âœ“âœ“â€™:â€˜âœ“â€™)+â€™</span>â€™:â€™â€™;bubble.innerHTML=formatMsg(msg.text)+â€™<div class="pm-msg-meta">â€™+msg.time+â€™ â€˜+tick+â€™</div>â€™;wrap.appendChild(bubble);area.appendChild(wrap);area.scrollTop=area.scrollHeight;}
async function sendPM(){if(!currentChatUser)return;var input=document.getElementById(â€˜messageInputâ€™);var text=input.value.trim();if(!text)return;input.value=â€™â€™;var tempId=â€˜tmp-â€™+Date.now();appendPMBubble({id:tempId,text:text,fromMe:true,time:fmtTime(new Date().toISOString()),is_read:false});try{var res=await supabase.from(â€˜private_messagesâ€™).insert({sender_unique_id:currentUniqueId,receiver_unique_id:currentChatUser.unique_id,message:text,is_read:false}).select(â€˜idâ€™).single();if(res.error){var el2=document.querySelector(â€™[data-msg-id=â€â€™+tempId+â€™â€]â€™);if(el2)el2.remove();input.value=text;return;}var el=document.querySelector(â€™[data-msg-id=â€â€™+tempId+â€™â€]â€™);if(el&&res.data){el.dataset.msgId=res.data.id;if(res.data.id>lastPMId)lastPMId=res.data.id;}}catch(e){}}
async function sendPMDirect(text){if(!currentChatUser)return;var tempId=â€˜tmp-â€™+Date.now();appendPMBubble({id:tempId,text:text,fromMe:true,time:fmtTime(new Date().toISOString()),is_read:false});try{var res=await supabase.from(â€˜private_messagesâ€™).insert({sender_unique_id:currentUniqueId,receiver_unique_id:currentChatUser.unique_id,message:text,is_read:false}).select(â€˜idâ€™).single();if(!res.error&&res.data){var el=document.querySelector(â€™[data-msg-id=â€â€™+tempId+â€™â€]â€™);if(el)el.dataset.msgId=res.data.id;}}catch(e){}}
async function pollNewPMs(otherId){if(currentChatType!==â€˜privateâ€™||!currentChatUser||currentChatUser.unique_id!==otherId)return;try{var res=await supabase.from(â€˜private_messagesâ€™).select(â€˜id, message, created_at, is_readâ€™).eq(â€˜sender_unique_idâ€™,otherId).eq(â€˜receiver_unique_idâ€™,currentUniqueId).gt(â€˜idâ€™,lastPMId).order(â€˜idâ€™,{ascending:true});if(res.error||!res.data||!res.data.length)return;res.data.forEach(function(msg){if(msg.id>lastPMId)lastPMId=msg.id;appendPMBubble({id:msg.id,text:msg.message,fromMe:false,time:fmtTime(msg.created_at),is_read:false});markRead(msg.id);});if(res.data.some(function(m){return m.message===â€˜âš¡ WIZZ !â€™;})){document.getElementById(â€˜rightPanelâ€™).classList.add(â€˜wizzingâ€™);setTimeout(function(){document.getElementById(â€˜rightPanelâ€™).classList.remove(â€˜wizzingâ€™);},600);}}catch(e){}}
async function markRead(id){try{await supabase.from(â€˜private_messagesâ€™).update({is_read:true}).eq(â€˜idâ€™,id);}catch(e){}}
async function markAllRead(senderId){try{await supabase.from(â€˜private_messagesâ€™).update({is_read:true}).eq(â€˜receiver_unique_idâ€™,currentUniqueId).eq(â€˜sender_unique_idâ€™,senderId).eq(â€˜is_readâ€™,false);}catch(e){}}

/* â”€â”€ ENVOI â”€â”€ */
function sendMessage(){var input=document.getElementById(â€˜messageInputâ€™);var text=input.value.trim();if(!text)return;if(currentChatType===â€˜publicâ€™){sendPublicMessage(text);input.value=â€™â€™;}else sendPM();}
document.getElementById(â€˜sendBtnâ€™).addEventListener(â€˜clickâ€™,sendMessage);
document.getElementById(â€˜messageInputâ€™).addEventListener(â€˜keypressâ€™,function(e){if(e.key===â€˜Enterâ€™)sendMessage();});

/* â”€â”€ THEMES â”€â”€ */
document.querySelectorAll(â€™.theme-btnâ€™).forEach(function(btn){btn.addEventListener(â€˜clickâ€™,function(){document.body.className=â€™â€™;document.body.style.backgroundImage=â€™â€™;document.querySelectorAll(â€™.theme-btnâ€™).forEach(function(b){b.classList.remove(â€˜activeâ€™);});btn.classList.add(â€˜activeâ€™);document.body.classList.add(â€˜theme-â€™+btn.dataset.theme);});});
document.getElementById(â€˜customBgInputâ€™).addEventListener(â€˜changeâ€™,function(e){var file=e.target.files[0];if(!file)return;var reader=new FileReader();reader.onload=function(ev){document.body.className=â€˜custom-bgâ€™;document.body.style.backgroundImage=â€˜url(â€™+ev.target.result+â€™)â€™;document.querySelectorAll(â€™.theme-btnâ€™).forEach(function(b){b.classList.remove(â€˜activeâ€™);});};reader.readAsDataURL(file);});

/* â”€â”€ PARTICULES â”€â”€ */
(function(){var c=document.getElementById(â€˜particlesâ€™);for(var i=0;i<40;i++){var p=document.createElement(â€˜divâ€™);p.className=â€˜particleâ€™;p.style.left=(Math.random()*100)+â€™%â€™;p.style.animationDelay=(Math.random()*20)+â€˜sâ€™;p.style.animationDuration=(Math.random()*15+15)+â€˜sâ€™;c.appendChild(p);}})();

/* â”€â”€ UTILS â”€â”€ */
function esc(s){return String(s||â€™â€™).replace(/&/g,â€™&â€™).replace(/</g,â€™<â€™).replace(/>/g,â€™>â€™).replace(/â€/g,â€™"â€™);}
function fmtTime(iso){if(!iso)return â€˜â€™;var d=new Date(iso),now=new Date();var hm=d.toLocaleTimeString(â€˜fr-FRâ€™,{hour:â€˜2-digitâ€™,minute:â€˜2-digitâ€™});return d.toDateString()===now.toDateString()?hm:d.toLocaleDateString(â€˜fr-FRâ€™,{day:â€˜2-digitâ€™,month:â€˜2-digitâ€™})+â€™ â€™+hm;}
switchToPublicChat();
</script>

</body>
</html>

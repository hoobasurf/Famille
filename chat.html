<!DOCTYPE html>

<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BubbleChat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; min-height: 100vh; position: relative; overflow-x: hidden; transition: background 0.8s ease; }
        body.theme-zen { background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 50%, #80deea 100%); }
        body.theme-plage { background: linear-gradient(135deg, #ffd89b 0%, #f4a460 50%, #19547b 100%); }
        body.theme-foret { background: linear-gradient(135deg, #134e5e 0%, #3a7e6f 50%, #71b280 100%); }
        body.theme-futuriste { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        body.theme-bonbon { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ff9a9e 100%); }
        body.theme-bar { background: linear-gradient(135deg, #2c003e 0%, #4b0082 50%, #8b008b 100%); }
        body.theme-chasse { background: linear-gradient(135deg, #3e2723 0%, #5d4037 50%, #795548 100%); }
        body.theme-aquarium { background: linear-gradient(135deg, #00416a 0%, #1976d2 33%, #4caf50 66%, #ffe000 100%); }
        body.custom-bg { background-size: cover !important; background-position: center !important; background-attachment: fixed !important; }

```
    .particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
    .particle { position: absolute; width: 3px; height: 3px; background: rgba(255,255,255,0.5); border-radius: 50%; animation: float 20s infinite ease-in-out; }
    @keyframes float { 0%,100% { transform: translateY(0) translateX(0); opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { transform: translateY(-100vh) translateX(50px); opacity: 0; } }

    /* â”€â”€ MAIN LAYOUT â”€â”€ */
    .app-wrapper { position: relative; z-index: 1; max-width: 1300px; margin: 0 auto; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; gap: 20px; }

    /* â”€â”€ HEADER â”€â”€ */
    .chat-header { background: rgba(255,255,255,0.05); backdrop-filter: blur(30px); border-radius: 20px; padding: 18px 24px; border: 1px solid rgba(255,255,255,0.2); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
    .theme-selector { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .theme-label { color: white; font-weight: 600; text-shadow: 0 2px 5px rgba(0,0,0,0.3); }
    .theme-options { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .theme-btn { width: 45px; height: 45px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.5); cursor: pointer; transition: all 0.3s ease; }
    .theme-btn:hover { transform: scale(1.15); border-color: white; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
    .theme-btn.active { border-color: white; box-shadow: 0 0 0 4px rgba(255,255,255,0.3); }
    .theme-btn-custom { width: 45px; height: 45px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.5); background: linear-gradient(135deg, #fff 0%, #ccc 100%); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: all 0.3s ease; position: relative; }
    .theme-btn-custom:hover { transform: scale(1.15); border-color: white; }
    .theme-btn-custom input[type="file"] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
    .user-profile-photo { width: 45px; height: 45px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.6); overflow: hidden; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #ff6b9d 0%, #c06fff 100%); font-size: 20px; color: white; box-shadow: 0 4px 15px rgba(255,107,157,0.4); transition: all 0.3s ease; cursor: pointer; }
    .user-profile-photo:hover { transform: scale(1.15); }
    .user-profile-photo img { width: 100%; height: 100%; object-fit: cover; }

    /* â”€â”€ TWO-COLUMN BODY â”€â”€ */
    .body-columns { display: flex; gap: 20px; flex: 1; min-height: 0; }

    /* â”€â”€ LEFT SIDEBAR (users list) â”€â”€ */
    .users-panel { width: 280px; flex-shrink: 0; background: rgba(255,255,255,0.05); backdrop-filter: blur(30px); border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); padding: 18px 12px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; max-height: calc(100vh - 160px); }
    .users-panel-header { color: white; font-weight: 700; font-size: 17px; text-align: center; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.15); }
    .users-panel-count { font-size: 12px; opacity: 0.6; font-weight: 400; margin-top: 4px; }
    .user-list { display: flex; flex-direction: column; gap: 8px; }

    .user-item { display: flex; align-items: center; gap: 11px; padding: 11px 12px; border-radius: 15px; cursor: pointer; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.07); transition: all 0.25s ease; position: relative; overflow: hidden; }
    .user-item::after { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255,107,157,0.12), rgba(192,111,255,0.12)); opacity: 0; transition: opacity 0.2s; border-radius: 14px; pointer-events: none; }
    .user-item:hover { border-color: rgba(255,107,157,0.35); transform: translateX(4px); }
    .user-item:hover::after { opacity: 1; }
    .user-item.active { border-color: rgba(255,107,157,0.6); background: rgba(255,107,157,0.12); }
    .user-item.active::after { opacity: 1; }

    .user-avatar { width: 44px; height: 44px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.25); overflow: hidden; flex-shrink: 0; position: relative; display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; }
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .status-dot { position: absolute; bottom: 1px; right: 1px; width: 11px; height: 11px; border-radius: 50%; border: 2px solid transparent; }
    .status-dot.online { background: #4caf50; animation: pulse-online 2s infinite; border-color: rgba(0,0,0,0.3); }
    .status-dot.offline { background: #555; border-color: rgba(0,0,0,0.3); }
    @keyframes pulse-online { 0%,100% { box-shadow: 0 0 6px #4caf50; } 50% { box-shadow: 0 0 14px #4caf50; } }

    .user-info { flex: 1; min-width: 0; }
    .user-name { color: white; font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-status-txt { font-size: 11px; margin-top: 2px; }
    .user-status-txt.online { color: #4caf50; }
    .user-status-txt.offline { color: rgba(255,255,255,0.4); }

    .notif-badge { position: absolute; top: 7px; right: 7px; background: linear-gradient(135deg, #ff6b9d, #ff3060); color: white; font-size: 10px; font-weight: 800; border-radius: 10px; min-width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; padding: 0 4px; box-shadow: 0 2px 8px rgba(255,64,64,0.5); animation: badgePop 0.35s cubic-bezier(.34,1.56,.64,1); }
    @keyframes badgePop { from { transform: scale(0) rotate(-15deg); } to { transform: scale(1); } }

    /* â”€â”€ RIGHT PANEL â”€â”€ */
    .right-panel { flex: 1; display: flex; flex-direction: column; gap: 0; min-width: 0; }

    /* â”€â”€ PUBLIC CHAT â”€â”€ */
    #publicChatPanel { display: flex; flex-direction: column; gap: 0; height: 100%; }
    #publicChatPanel .messages-area { flex: 1; }
    
    /* â”€â”€ PRIVATE CHAT â”€â”€ */
    #pmPanel { display: none; flex-direction: column; height: 100%; }
    #pmPanel.active { display: flex; }

    /* PM header */
    .pm-chat-header { background: rgba(255,255,255,0.05); backdrop-filter: blur(30px); border-radius: 20px 20px 0 0; padding: 16px 20px; border: 1px solid rgba(255,255,255,0.2); border-bottom: none; display: flex; align-items: center; gap: 14px; }
    .pm-chat-header-avatar { width: 42px; height: 42px; border-radius: 50%; border: 2px solid rgba(255,107,157,0.5); overflow: hidden; display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; background: linear-gradient(135deg, #ff6b9d, #c06fff); flex-shrink: 0; }
    .pm-chat-header-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .pm-chat-header-info { flex: 1; }
    .pm-chat-header-name { color: white; font-weight: 700; font-size: 16px; }
    .pm-chat-header-status { font-size: 12px; margin-top: 2px; }
    .pm-chat-header-status.online { color: #4caf50; }
    .pm-chat-header-status.offline { color: rgba(255,255,255,0.4); }
    .pm-back-btn { padding: 8px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; color: white; font-size: 13px; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
    .pm-back-btn:hover { background: rgba(255,255,255,0.2); }

    /* messages areas */
    .messages-area { background: rgba(255,255,255,0.05); backdrop-filter: blur(30px); padding: 20px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.2); flex: 1; min-height: 0; height: 0; }
    #publicChatPanel .messages-area { border-radius: 20px; margin-bottom: 16px; }
    #pmPanel .pm-messages-area { border-radius: 0; border-top: none; border-bottom: none; }

    .message { background: rgba(255,255,255,0.08); padding: 12px 18px; border-radius: 15px; margin-bottom: 12px; color: white; animation: slideIn 0.3s ease; display: flex; gap: 12px; align-items: flex-start; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .message-avatar { width: 40px; height: 40px; border-radius: 50%; overflow: hidden; flex-shrink: 0; background: linear-gradient(135deg, #ff6b9d 0%, #c06fff 100%); display: flex; align-items: center; justify-content: center; font-size: 18px; border: 2px solid rgba(255,255,255,0.3); }
    .message-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .message-content { flex: 1; }
    .message-author { font-weight: bold; margin-bottom: 5px; font-size: 14px; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
    .message-text { font-size: 16px; }
    .message-time { font-size: 11px; opacity: 0.7; text-align: right; margin-top: 5px; }

    /* PM bubbles */
    .pm-msg-wrap { display: flex; flex-direction: column; margin-bottom: 8px; }
    .pm-msg-wrap.sent { align-items: flex-end; }
    .pm-msg-wrap.received { align-items: flex-start; }
    .pm-msg { max-width: 72%; padding: 10px 15px 7px; border-radius: 18px; font-size: 15px; color: white; line-height: 1.5; word-break: break-word; animation: msgPop 0.25s cubic-bezier(.34,1.56,.64,1); }
    @keyframes msgPop { from { opacity: 0; transform: scale(0.92); } to { opacity: 1; transform: scale(1); } }
    .pm-msg.sent { border-bottom-right-radius: 4px; box-shadow: 0 4px 18px rgba(192,111,255,0.25); }
    .pm-msg.received { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); border-bottom-left-radius: 4px; }
    .pm-msg-meta { font-size: 10px; opacity: 0.5; margin-top: 4px; display: flex; align-items: center; gap: 4px; justify-content: flex-end; }
    .pm-msg-wrap.received .pm-msg-meta { justify-content: flex-start; }
    .pm-tick.read { color: #64b5f6; opacity: 1 !important; }

    .pm-empty { text-align: center; color: rgba(255,255,255,0.3); font-size: 13px; padding: 50px 20px; line-height: 2; }
    .pm-empty-icon { font-size: 40px; display: block; margin-bottom: 10px; }
    .pm-loading { text-align: center; color: rgba(255,255,255,0.3); font-size: 13px; padding: 40px; }

    /* â”€â”€ INPUT AREAS â”€â”€ */
    .input-area { background: rgba(255,255,255,0.05); backdrop-filter: blur(30px); border-radius: 20px; padding: 16px 20px; border: 1px solid rgba(255,255,255,0.2); display: flex; gap: 10px; align-items: center; }
    #pmPanel .input-area { border-radius: 0 0 20px 20px; border-top: none; flex-direction: column; gap: 10px; }
    #pmPanel .input-row { display: flex; gap: 10px; width: 100%; align-items: center; }

    .message-input { flex: 1; padding: 14px 20px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 15px; color: white; font-size: 16px; transition: all 0.3s ease; }
    .message-input:focus { outline: none; background: rgba(255,255,255,0.18); border-color: rgba(255,255,255,0.5); }
    .message-input::placeholder { color: rgba(255,255,255,0.6); }
    .send-btn { padding: 14px 30px; background: linear-gradient(135deg, #ff6b9d 0%, #c06fff 100%); border: none; border-radius: 15px; color: white; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 5px 20px rgba(192,111,255,0.4); white-space: nowrap; }
    .send-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 30px rgba(192,111,255,0.6); }
    .send-btn:active { transform: scale(0.97); }

    /* â”€â”€ BUBBLE COLOR PICKER â”€â”€ */
    .bubble-color-row { display: flex; align-items: center; gap: 10px; width: 100%; }
    .bubble-color-label { color: rgba(255,255,255,0.55); font-size: 12px; white-space: nowrap; }
    .bubble-color-swatches { display: flex; gap: 7px; flex-wrap: wrap; }
    .color-swatch { width: 26px; height: 26px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
    .color-swatch:hover { transform: scale(1.2); border-color: white; }
    .color-swatch.active { border-color: white; box-shadow: 0 0 0 3px rgba(255,255,255,0.3); transform: scale(1.1); }
    .color-swatch-custom { width: 26px; height: 26px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 13px; transition: all 0.2s; position: relative; background: rgba(255,255,255,0.1); overflow: hidden; }
    .color-swatch-custom:hover { transform: scale(1.2); border-color: white; }
    .color-swatch-custom input[type="color"] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

    /* TOAST */
    .pm-toast { position: fixed; bottom: 24px; right: 24px; z-index: 3000; background: rgba(10,3,24,0.97); border: 1px solid rgba(255,107,157,0.4); border-radius: 16px; padding: 14px 18px; color: white; font-size: 14px; box-shadow: 0 12px 40px rgba(0,0,0,0.5); cursor: pointer; max-width: 280px; backdrop-filter: blur(20px); animation: toastIn 0.4s cubic-bezier(.34,1.56,.64,1); transition: opacity 0.4s; }
    @keyframes toastIn { from { opacity: 0; transform: translateY(20px) scale(0.9); } to { opacity: 1; transform: scale(1); } }
    .pm-toast-name { font-weight: 700; color: #ff6b9d; margin-bottom: 4px; font-size: 13px; }
    .pm-toast-text { opacity: 0.75; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* scrollbars */
    .users-panel::-webkit-scrollbar, .messages-area::-webkit-scrollbar, .pm-messages-area::-webkit-scrollbar { width: 5px; }
    .users-panel::-webkit-scrollbar-track, .messages-area::-webkit-scrollbar-track, .pm-messages-area::-webkit-scrollbar-track { background: transparent; }
    .users-panel::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 10px; }
    .messages-area::-webkit-scrollbar-thumb, .pm-messages-area::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #ff6b9d, #c06fff); border-radius: 10px; }

    @media (max-width: 768px) {
        .body-columns { flex-direction: column; }
        .users-panel { width: 100%; max-height: 220px; flex-direction: row; flex-wrap: nowrap; overflow-x: auto; overflow-y: hidden; padding: 12px; }
        .user-list { flex-direction: row; gap: 8px; }
        .user-item { min-width: 140px; }
        .chat-header { flex-direction: column; align-items: flex-start; }
    }
</style>
```

</head>
<body class="theme-futuriste">
<div class="particles" id="particles"></div>

<div class="app-wrapper">

```
<!-- HEADER -->
<div class="chat-header">
    <div class="theme-selector">
        <span class="theme-label">ThÃ¨me :</span>
        <div class="theme-options">
            <div class="theme-btn" data-theme="zen" style="background:linear-gradient(135deg,#e0f7fa,#80deea)" title="Zen"></div>
            <div class="theme-btn" data-theme="plage" style="background:linear-gradient(135deg,#ffd89b,#19547b)" title="Plage"></div>
            <div class="theme-btn" data-theme="foret" style="background:linear-gradient(135deg,#134e5e,#71b280)" title="ForÃªt"></div>
            <div class="theme-btn active" data-theme="futuriste" style="background:linear-gradient(135deg,#667eea,#764ba2)" title="Futuriste"></div>
            <div class="theme-btn" data-theme="bonbon" style="background:linear-gradient(135deg,#ffecd2,#ff9a9e)" title="Bonbon"></div>
            <div class="theme-btn" data-theme="bar" style="background:linear-gradient(135deg,#2c003e,#8b008b)" title="Bar"></div>
            <div class="theme-btn" data-theme="chasse" style="background:linear-gradient(135deg,#3e2723,#795548)" title="Chasse"></div>
            <div class="theme-btn" data-theme="aquarium" style="background:linear-gradient(135deg,#00416a,#ffe000)" title="Aquarium"></div>
            <div class="theme-btn-custom" title="Photo personnalisÃ©e">ğŸ“·<input type="file" id="customBgInput" accept="image/*"></div>
            <div class="user-profile-photo" id="userProfilePhoto" title="Mon profil">ğŸ’¬</div>
        </div>
    </div>
</div>

<!-- TWO COLUMNS -->
<div class="body-columns">

    <!-- LEFT: users -->
    <div class="users-panel" id="usersPanel">
        <div class="users-panel-header">
            ğŸ’¬ Utilisateurs
            <div class="users-panel-count" id="profileCount">Chargement...</div>
        </div>
        <!-- "Chat gÃ©nÃ©ral" entry -->
        <div class="user-list">
            <div class="user-item active" id="publicChatBtn" title="Chat gÃ©nÃ©ral">
                <div class="user-avatar" style="background:linear-gradient(135deg,#ff6b9d,#c06fff);">ğŸŒ</div>
                <div class="user-info">
                    <div class="user-name">Chat gÃ©nÃ©ral</div>
                    <div class="user-status-txt online">â— Public</div>
                </div>
            </div>
        </div>
        <div class="user-list" id="profileList"></div>
    </div>

    <!-- RIGHT: chat zone -->
    <div class="right-panel">

        <!-- PUBLIC CHAT -->
        <div id="publicChatPanel">
            <div class="messages-area" id="messagesArea"></div>
            <div class="input-area">
                <input type="text" class="message-input" id="messageInput" placeholder="Tapez votre message...">
                <button class="send-btn" id="sendBtn">Envoyer ğŸš€</button>
            </div>
        </div>

        <!-- PRIVATE CHAT -->
        <div id="pmPanel">
            <div class="pm-chat-header">
                <div class="pm-chat-header-avatar" id="pmHeaderAvatar">ğŸ‘¤</div>
                <div class="pm-chat-header-info">
                    <div class="pm-chat-header-name" id="pmHeaderName">Utilisateur</div>
                    <div class="pm-chat-header-status offline" id="pmHeaderStatus">ğŸ”´ Hors ligne</div>
                </div>
                <button class="pm-back-btn" id="pmBackBtn">â† Chat gÃ©nÃ©ral</button>
            </div>
            <div class="messages-area pm-messages-area" id="pmMessagesArea"></div>
            <div class="input-area">
                <div class="input-row">
                    <input type="text" class="message-input" id="pmInput" placeholder="Message privÃ©..." maxlength="1000">
                    <button class="send-btn" id="pmSend">Envoyer ğŸš€</button>
                </div>
                <!-- BUBBLE COLOR PICKER -->
                <div class="bubble-color-row">
                    <span class="bubble-color-label">ğŸ¨ Couleur de mes bulles :</span>
                    <div class="bubble-color-swatches" id="colorSwatches"></div>
                    <div class="color-swatch-custom" title="Couleur personnalisÃ©e">âœï¸<input type="color" id="customColorInput"></div>
                </div>
            </div>
        </div>

    </div>
</div>
```

</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
    'https://eeikriwrwuynwpzodbbt.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlaWtyaXdyd3V5bndwem9kYmJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NzQ3NjYsImV4cCI6MjA4NjE1MDc2Nn0.MJ6CSmrttEWcrdfy5C7nP4sE_pe19sGNE-WasASPDNc'
);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CURRENT USER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentUserPhoto = null;
const currentUserPrenom = localStorage.getItem('prenom') || 'InvitÃ©';
const fingerprint      = localStorage.getItem('browserFingerprint') || '';
const currentUniqueId  = fingerprint ? `${currentUserPrenom}_${fingerprint}` : null;
const savedPhotoUrl    = localStorage.getItem('userPhotoUrl') || localStorage.getItem('tempPhotoPreview');

(function initPhoto() {
    const el = document.getElementById('userProfilePhoto');
    if (savedPhotoUrl) { el.innerHTML = `<img src="${savedPhotoUrl}" alt="Profil">`; currentUserPhoto = savedPhotoUrl; }
    else el.textContent = 'ğŸ’¬';
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUBBLE COLOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const BUBBLE_PRESETS = [
    { label: 'Rose/Violet (dÃ©faut)', value: 'linear-gradient(135deg,#ff6b9d,#c06fff)' },
    { label: 'Bleu', value: 'linear-gradient(135deg,#2196f3,#03a9f4)' },
    { label: 'Vert', value: 'linear-gradient(135deg,#43e97b,#38f9d7)' },
    { label: 'Orange', value: 'linear-gradient(135deg,#f7971e,#ffd200)' },
    { label: 'Rouge', value: 'linear-gradient(135deg,#f44336,#e91e63)' },
    { label: 'Indigo', value: 'linear-gradient(135deg,#5c6bc0,#7c4dff)' },
    { label: 'Cyan', value: 'linear-gradient(135deg,#00bcd4,#26c6da)' },
    { label: 'Noir mat', value: 'linear-gradient(135deg,#2d2d2d,#555)' },
];

let myBubbleStyle = localStorage.getItem('myBubbleStyle') || BUBBLE_PRESETS[0].value;

function applyBubbleStyle(style) {
    myBubbleStyle = style;
    localStorage.setItem('myBubbleStyle', style);
    // Met Ã  jour toutes les bulles existantes de l'utilisateur
    document.querySelectorAll('.pm-msg.sent').forEach(b => b.style.background = style);
}

function buildColorSwatches() {
    const container = document.getElementById('colorSwatches');
    container.innerHTML = '';
    BUBBLE_PRESETS.forEach(preset => {
        const sw = document.createElement('div');
        sw.className = 'color-swatch' + (myBubbleStyle === preset.value ? ' active' : '');
        sw.style.background = preset.value;
        sw.title = preset.label;
        sw.addEventListener('click', () => {
            container.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
            sw.classList.add('active');
            applyBubbleStyle(preset.value);
        });
        container.appendChild(sw);
    });
}
buildColorSwatches();

document.getElementById('customColorInput').addEventListener('input', e => {
    const hex = e.target.value;
    const style = hex;
    document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
    applyBubbleStyle(style);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ONLINE STATUS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function setOnlineStatus(online) {
    if (!currentUniqueId) return;
    await supabase.from('profiles')
        .update({ is_online: online, last_seen: new Date().toISOString() })
        .eq('unique_id', currentUniqueId);
}
setOnlineStatus(true);
setInterval(() => setOnlineStatus(true), 30000);
window.addEventListener('beforeunload', () => setOnlineStatus(false));

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROFILES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let profiles = [];
const pmBadges = {};

async function loadProfiles() {
    const { data, error } = await supabase
        .from('profiles')
        .select('unique_id, prenom, photo_url, is_online, last_seen')
        .order('is_online', { ascending: false })
        .order('prenom',    { ascending: true });

    if (error) { document.getElementById('profileCount').textContent = 'Erreur DB'; return; }
    profiles = (data || []).map(p => ({
        unique_id: p.unique_id || '',
        prenom:    p.prenom    || '',
        photo_url: p.photo_url || null,
        is_online: !!p.is_online
    }));
    renderProfiles();
}

function renderProfiles() {
    const container = document.getElementById('profileList');
    const countEl   = document.getElementById('profileCount');
    container.innerHTML = '';

    const others = profiles.filter(p => p.unique_id !== currentUniqueId);
    const onlineCount = others.filter(p => p.is_online).length;
    countEl.textContent = `${others.length} utilisateur${others.length > 1 ? 's' : ''} Â· ${onlineCount} en ligne`;

    others.forEach(profile => {
        const item = document.createElement('div');
        item.className = 'user-item' + (pmCurrentProfile?.unique_id === profile.unique_id ? ' active' : '');
        item.title = `Message privÃ© avec ${profile.prenom || 'Anonyme'}`;

        // avatar
        const av = document.createElement('div');
        av.className = 'user-avatar';
        if (profile.photo_url) {
            const img = document.createElement('img');
            img.src = profile.photo_url; img.alt = profile.prenom;
            av.appendChild(img);
        } else {
            av.textContent = (profile.prenom || '?')[0].toUpperCase();
        }
        const dot = document.createElement('div');
        dot.className = 'status-dot ' + (profile.is_online ? 'online' : 'offline');
        av.appendChild(dot);

        // info
        const info = document.createElement('div');
        info.className = 'user-info';
        const nameEl = document.createElement('div');
        nameEl.className = 'user-name';
        nameEl.textContent = profile.prenom || 'Anonyme';
        const stEl = document.createElement('div');
        stEl.className = 'user-status-txt ' + (profile.is_online ? 'online' : 'offline');
        stEl.textContent = profile.is_online ? 'â— En ligne' : 'â— Hors ligne';
        info.appendChild(nameEl);
        info.appendChild(stEl);

        item.appendChild(av);
        item.appendChild(info);

        // badge
        const unread = pmBadges[profile.unique_id] || 0;
        if (unread > 0) {
            const badge = document.createElement('div');
            badge.className = 'notif-badge';
            badge.textContent = unread > 99 ? '99+' : unread;
            item.appendChild(badge);
        }

        item.addEventListener('click', () => openPM(profile));
        container.appendChild(item);
    });
}

setInterval(loadProfiles, 5000);
loadProfiles();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PANEL SWITCHING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let pmCurrentProfile = null;

function showPublicChat() {
    pmCurrentProfile = null;
    document.getElementById('publicChatPanel').style.display = 'flex';
    document.getElementById('pmPanel').classList.remove('active');
    document.getElementById('publicChatBtn').classList.add('active');
    document.querySelectorAll('#profileList .user-item').forEach(i => i.classList.remove('active'));
    if (pmConvChannel) { supabase.removeChannel(pmConvChannel); pmConvChannel = null; }
}

document.getElementById('publicChatBtn').addEventListener('click', showPublicChat);
document.getElementById('pmBackBtn').addEventListener('click', showPublicChat);

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REALTIME INBOX
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function subscribeInbox() {
    if (!currentUniqueId) return;
    supabase.channel('inbox-' + currentUniqueId)
        .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'private_messages',
            filter: `receiver_unique_id=eq.${currentUniqueId}`
        }, payload => {
            const msg = payload.new;
            const sid = msg.sender_unique_id;
            if (pmCurrentProfile && pmCurrentProfile.unique_id === sid) {
                appendPMBubble({ id: msg.id, text: msg.message, fromMe: false, time: fmtTime(msg.created_at), is_read: false });
                markRead(msg.id);
            } else {
                pmBadges[sid] = (pmBadges[sid] || 0) + 1;
                renderProfiles();
                showToast(msg, sid);
            }
        })
        .subscribe();
}
subscribeInbox();

function showToast(msg, senderId) {
    const sender = profiles.find(p => p.unique_id === senderId);
    const name = sender ? sender.prenom : 'Quelqu\'un';
    const toast = document.createElement('div');
    toast.className = 'pm-toast';
    toast.innerHTML = `<div class="pm-toast-name">ğŸ’Œ ${escHtml(name)}</div><div class="pm-toast-text">${escHtml(msg.message)}</div>`;
    toast.addEventListener('click', () => {
        const prof = profiles.find(p => p.unique_id === senderId);
        if (prof) openPM(prof);
        toast.remove();
    });
    document.body.appendChild(toast);
    setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 400); }, 4500);
}

async function markRead(id) {
    await supabase.from('private_messages').update({ is_read: true }).eq('id', id);
}
async function markAllRead(senderUniqueId) {
    if (!currentUniqueId) return;
    await supabase.from('private_messages')
        .update({ is_read: true })
        .eq('receiver_unique_id', currentUniqueId)
        .eq('sender_unique_id', senderUniqueId)
        .eq('is_read', false);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OPEN PM (inline)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let pmConvChannel = null;

async function openPM(profile) {
    pmCurrentProfile = profile;

    // badge off
    pmBadges[profile.unique_id] = 0;

    // switch panel
    document.getElementById('publicChatPanel').style.display = 'none';
    document.getElementById('pmPanel').classList.add('active');

    // active state in list
    document.getElementById('publicChatBtn').classList.remove('active');
    document.querySelectorAll('#profileList .user-item').forEach(i => i.classList.remove('active'));
    // re-render to reflect active + clear badge
    renderProfiles();

    // header
    const av = document.getElementById('pmHeaderAvatar');
    if (profile.photo_url) av.innerHTML = `<img src="${profile.photo_url}" alt="${escHtml(profile.prenom)}">`;
    else av.textContent = (profile.prenom || '?')[0].toUpperCase();
    document.getElementById('pmHeaderName').textContent = profile.prenom || 'Anonyme';
    const stEl = document.getElementById('pmHeaderStatus');
    stEl.className = 'pm-chat-header-status ' + (profile.is_online ? 'online' : 'offline');
    stEl.textContent = profile.is_online ? 'ğŸŸ¢ En ligne' : 'ğŸ”´ Hors ligne';

    // load messages
    document.getElementById('pmMessagesArea').innerHTML = '<div class="pm-loading">Chargement...</div>';
    document.getElementById('pmInput').focus();

    await fetchHistory(profile.unique_id);
    markAllRead(profile.unique_id);
    subscribeConv(profile.unique_id);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PM HISTORY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchHistory(otherId) {
    if (!currentUniqueId) { renderHistory([]); return; }
    const { data, error } = await supabase
        .from('private_messages')
        .select('id, sender_unique_id, message, created_at, is_read')
        .or(
            `and(sender_unique_id.eq.${currentUniqueId},receiver_unique_id.eq.${otherId}),` +
            `and(sender_unique_id.eq.${otherId},receiver_unique_id.eq.${currentUniqueId})`
        )
        .order('created_at', { ascending: true })
        .limit(150);

    if (error) { console.error(error); renderHistory([]); return; }
    renderHistory((data || []).map(m => ({
        id: m.id,
        text: m.message,
        fromMe: m.sender_unique_id === currentUniqueId,
        time: fmtTime(m.created_at),
        is_read: m.is_read
    })));
}

function renderHistory(messages) {
    const area = document.getElementById('pmMessagesArea');
    area.innerHTML = '';
    if (!messages.length) {
        area.innerHTML = `<div class="pm-empty"><span class="pm-empty-icon">ğŸ’Œ</span>Aucun message pour l'instant<br><span style="font-size:12px;opacity:0.5">Soyez le premier Ã  Ã©crire !</span></div>`;
        return;
    }
    messages.forEach(m => area.appendChild(buildBubble(m)));
    area.scrollTop = area.scrollHeight;
}

function buildBubble(msg) {
    const wrap = document.createElement('div');
    wrap.className = 'pm-msg-wrap ' + (msg.fromMe ? 'sent' : 'received');
    wrap.dataset.msgId = msg.id;

    const bubble = document.createElement('div');
    bubble.className = 'pm-msg ' + (msg.fromMe ? 'sent' : 'received');
    if (msg.fromMe) bubble.style.background = myBubbleStyle;

    let tick = msg.fromMe ? `<span class="pm-tick ${msg.is_read ? 'read' : ''}">${msg.is_read ? 'âœ“âœ“' : 'âœ“'}</span>` : '';
    bubble.innerHTML = `${escHtml(msg.text)}<div class="pm-msg-meta">${msg.time}${tick}</div>`;
    wrap.appendChild(bubble);
    return wrap;
}

function appendPMBubble(msg) {
    const area = document.getElementById('pmMessagesArea');
    area.querySelector('.pm-empty, .pm-loading')?.remove();
    area.appendChild(buildBubble(msg));
    area.scrollTop = area.scrollHeight;
}

function subscribeConv(otherId) {
    if (pmConvChannel) { supabase.removeChannel(pmConvChannel); pmConvChannel = null; }
    if (!currentUniqueId) return;
    pmConvChannel = supabase.channel(`conv-${[currentUniqueId, otherId].sort().join('-')}`)
        .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'private_messages',
            filter: `sender_unique_id=eq.${otherId}`
        }, payload => {
            const m = payload.new;
            if (m.receiver_unique_id !== currentUniqueId) return;
            appendPMBubble({ id: m.id, text: m.message, fromMe: false, time: fmtTime(m.created_at), is_read: false });
            markRead(m.id);
        })
        .subscribe();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEND PM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function sendPM() {
    if (!pmCurrentProfile || !currentUniqueId) return;
    const input = document.getElementById('pmInput');
    const text = input.value.trim();
    if (!text) return;
    input.value = '';

    const tempId = 'tmp-' + Date.now();
    appendPMBubble({ id: tempId, text, fromMe: true, time: fmtTime(new Date().toISOString()), is_read: false });

    const { data, error } = await supabase.from('private_messages').insert({
        sender_unique_id: currentUniqueId,
        receiver_unique_id: pmCurrentProfile.unique_id,
        message: text,
        is_read: false
    }).select().single();

    if (error) {
        console.error('Erreur envoi:', error);
        document.querySelector(`[data-msg-id="${tempId}"]`)?.remove();
        input.value = text;
    } else if (data) {
        const el = document.querySelector(`[data-msg-id="${tempId}"]`);
        if (el) el.dataset.msgId = data.id;
    }
}

document.getElementById('pmSend').addEventListener('click', sendPM);
document.getElementById('pmInput').addEventListener('keypress', e => { if (e.key === 'Enter') sendPM(); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PUBLIC CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function addMessage(author, text) {
    const container = document.getElementById('messagesArea');
    const time = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    const photo = author === currentUserPrenom ? currentUserPhoto : (profiles.find(p => p.prenom === author) || {}).photo_url;
    const av = photo ? `<img src="${photo}" alt="${escHtml(author)}">` : (author[0] || '?').toUpperCase();
    const msg = document.createElement('div');
    msg.className = 'message';
    msg.innerHTML = `<div class="message-avatar">${av}</div><div class="message-content"><div class="message-author">${escHtml(author)}</div><div class="message-text">${escHtml(text)}</div><div class="message-time">${time}</div></div>`;
    container.appendChild(msg);
    container.scrollTop = container.scrollHeight;
}
function sendMessage() {
    const input = document.getElementById('messageInput');
    if (input.value.trim()) { addMessage(currentUserPrenom, input.value.trim()); input.value = ''; }
}
document.getElementById('sendBtn').addEventListener('click', sendMessage);
document.getElementById('messageInput').addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEMES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.querySelectorAll('.theme-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.body.className = ''; document.body.style.backgroundImage = '';
        document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.body.classList.add('theme-' + btn.dataset.theme);
    });
});
document.getElementById('customBgInput').addEventListener('change', e => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        document.body.className = 'custom-bg';
        document.body.style.backgroundImage = `url(${ev.target.result})`;
        document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
    };
    reader.readAsDataURL(file);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PARTICLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function() {
    const c = document.getElementById('particles');
    for (let i = 0; i < 40; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        p.style.left = Math.random() * 100 + '%';
        p.style.animationDelay = Math.random() * 20 + 's';
        p.style.animationDuration = (Math.random() * 15 + 15) + 's';
        c.appendChild(p);
    }
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function fmtTime(iso) {
    if (!iso) return '';
    const d = new Date(iso), today = new Date();
    const hm = d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    return d.toDateString() === today.toDateString() ? hm
        : d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' }) + ' ' + hm;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
addMessage('BubbleChat', `Bienvenue ${currentUserPrenom} ! ğŸ‰  Cliquez sur un profil Ã  gauche pour lui Ã©crire en privÃ© âœ‰ï¸`);
// ensure public panel visible by default
document.getElementById('publicChatPanel').style.display = 'flex';
</script>

</body>
</html>

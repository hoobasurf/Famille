<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mur â€” BubbleChat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea, #764ba2); 
            min-height: 100vh; 
            padding: 20px;
            overflow-x: hidden;
        }
        .header {
            background: rgba(255,255,255,.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .header-title { color: white; font-size: 28px; font-weight: 700; display: flex; align-items: center; gap: 12px; }
        .header-actions { display: flex; gap: 12px; align-items: center; }
        .btn { padding: 12px 24px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; transition: all .3s; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(135deg, #ff6b9d, #c06fff); color: white; box-shadow: 0 4px 15px rgba(192,111,255,.4); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(192,111,255,.6); }
        .btn-primary:disabled { opacity: .6; cursor: not-allowed; transform: none; }
        .btn-secondary { background: rgba(255,255,255,.1); color: white; border: 2px solid rgba(255,255,255,.2); }
        .btn-secondary:hover { background: rgba(255,255,255,.2); transform: translateY(-2px); }
        .tabs { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab { padding: 14px 28px; background: rgba(255,255,255,.08); border: 2px solid rgba(255,255,255,.15); border-radius: 14px; color: white; font-weight: 600; cursor: pointer; transition: all .3s; font-size: 15px; }
        .tab:hover { background: rgba(255,255,255,.15); transform: translateY(-2px); }
        .tab.active { background: linear-gradient(135deg, rgba(255,107,157,.3), rgba(192,111,255,.3)); border-color: rgba(255,107,157,.6); box-shadow: 0 0 20px rgba(255,107,157,.4); }
        .profiles-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 24px; margin-bottom: 40px; }
        .profile-card { background: rgba(255,255,255,.05); backdrop-filter: blur(10px); border-radius: 18px; padding: 20px; border: 3px solid transparent; cursor: pointer; transition: all .4s cubic-bezier(.34,1.56,.64,1); position: relative; overflow: hidden; }
        .profile-card:hover { transform: translateY(-8px) scale(1.02); border-color: rgba(255,107,157,.8); box-shadow: 0 0 30px rgba(255,107,157,.6), 0 10px 40px rgba(0,0,0,.4); }
        .profile-card::before { content: ''; position: absolute; inset: -2px; border-radius: 18px; padding: 3px; background: linear-gradient(135deg, #ff6b9d, #c06fff, #64b5f6); -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; opacity: 0; transition: opacity .4s; }
        .profile-card:hover::before { opacity: 1; animation: neonPulse 2s ease-in-out infinite; }
        @keyframes neonPulse { 0%, 100% { opacity: .6; } 50% { opacity: 1; } }
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; margin: 0 auto 16px; background: linear-gradient(135deg, #ff6b9d, #c06fff); border: 4px solid rgba(255,255,255,.3); overflow: hidden; display: flex; align-items: center; justify-content: center; font-size: 48px; color: white; font-weight: 700; position: relative; }
        .profile-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .status-indicator { position: absolute; bottom: 5px; right: 5px; width: 20px; height: 20px; border-radius: 50%; border: 3px solid rgba(255,255,255,.9); }
        .status-indicator.online { background: #4caf50; animation: pulse 2s infinite; }
        .status-indicator.offline { background: #999; }
        @keyframes pulse { 0%, 100% { box-shadow: 0 0 8px #4caf50; } 50% { box-shadow: 0 0 18px #4caf50; } }
        .profile-name { color: white; font-weight: 700; font-size: 18px; text-align: center; margin-bottom: 8px; }
        .profile-posts-count { color: rgba(255,255,255,.6); font-size: 14px; text-align: center; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.85); backdrop-filter: blur(8px); z-index: 9999; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.open { display: flex; animation: fadeIn .3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal { background: rgba(20,20,30,.98); border-radius: 24px; width: 100%; max-width: 700px; max-height: 90vh; display: flex; flex-direction: column; border: 2px solid rgba(255,107,157,.3); box-shadow: 0 25px 80px rgba(0,0,0,.8); animation: slideUp .4s cubic-bezier(.34,1.56,.64,1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(50px) scale(.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .modal-header { padding: 24px 28px; border-bottom: 2px solid rgba(255,255,255,.1); display: flex; align-items: center; gap: 18px; flex-shrink: 0; }
        .modal-header-avatar { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #ff6b9d, #c06fff); overflow: hidden; border: 3px solid rgba(255,255,255,.3); display: flex; align-items: center; justify-content: center; font-size: 26px; color: white; font-weight: 700; }
        .modal-header-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .modal-header-info { flex: 1; }
        .modal-header-name { color: white; font-weight: 700; font-size: 22px; margin-bottom: 4px; }
        .modal-header-status { color: rgba(255,255,255,.6); font-size: 14px; }
        .modal-close { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,.1); border: 2px solid rgba(255,255,255,.2); color: white; font-size: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all .3s; }
        .modal-close:hover { background: rgba(255,255,255,.2); transform: rotate(90deg); }
        .modal-content { flex: 1; overflow-y: auto; padding: 24px 28px; }
        .modal-content::-webkit-scrollbar { width: 8px; }
        .modal-content::-webkit-scrollbar-track { background: rgba(255,255,255,.05); border-radius: 10px; }
        .modal-content::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #ff6b9d, #c06fff); border-radius: 10px; }
        .modal-footer { padding: 20px 28px; border-top: 2px solid rgba(255,255,255,.1); display: flex; gap: 12px; flex-shrink: 0; }
        .post-composer { background: rgba(255,255,255,.05); backdrop-filter: blur(10px); border-radius: 18px; padding: 20px 24px; margin-bottom: 24px; border: 2px solid rgba(255,255,255,.15); }
        .post-composer-input { width: 100%; background: rgba(255,255,255,.08); border: 2px solid rgba(255,255,255,.15); border-radius: 14px; padding: 14px 18px; color: white; font-size: 15px; resize: vertical; min-height: 80px; font-family: inherit; margin-bottom: 12px; }
        .post-composer-input:focus { outline: none; background: rgba(255,255,255,.12); border-color: rgba(255,107,157,.5); }
        .post-composer-input::placeholder { color: rgba(255,255,255,.5); }
        .post-composer-actions { display: flex; gap: 10px; align-items: center; }
        .post-composer-attach { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,.1); border: 2px solid rgba(255,255,255,.15); color: white; font-size: 18px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all .3s; position: relative; }
        .post-composer-attach:hover { background: rgba(255,255,255,.2); transform: scale(1.1); }
        .post-composer-attach input[type=file] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .publish-error { color: #ff6b9d; font-size: 13px; margin-top: 8px; padding: 8px 12px; background: rgba(255,107,157,.1); border-radius: 8px; border: 1px solid rgba(255,107,157,.3); display: none; }
        .post { background: rgba(255,255,255,.05); backdrop-filter: blur(10px); border-radius: 18px; padding: 20px 24px; margin-bottom: 20px; border: 2px solid rgba(255,255,255,.1); animation: slideIn .4s; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .post-header { display: flex; align-items: center; gap: 14px; margin-bottom: 16px; }
        .post-avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #ff6b9d, #c06fff); overflow: hidden; border: 3px solid rgba(255,255,255,.3); display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; font-weight: 700; flex-shrink: 0; }
        .post-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .post-author-info { flex: 1; }
        .post-author-name { color: white; font-weight: 700; font-size: 16px; }
        .post-time { color: rgba(255,255,255,.5); font-size: 13px; margin-top: 2px; }
        .post-content { color: white; font-size: 15px; line-height: 1.6; margin-bottom: 14px; white-space: pre-wrap; }
        .post-image { width: 100%; border-radius: 12px; margin-bottom: 14px; }
        .post-actions { display: flex; gap: 20px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,.1); }
        .post-action { display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,.7); font-size: 14px; font-weight: 600; cursor: pointer; transition: all .3s; padding: 8px 14px; border-radius: 10px; }
        .post-action:hover { background: rgba(255,255,255,.1); color: white; }
        .post-action.liked { color: #ff6b9d; }
        .post-action-icon { font-size: 18px; }
        .comments-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,.1); }
        .comment { display: flex; gap: 12px; margin-bottom: 14px; }
        .comment-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, #ff6b9d, #c06fff); overflow: hidden; border: 2px solid rgba(255,255,255,.3); display: flex; align-items: center; justify-content: center; font-size: 16px; color: white; font-weight: 700; flex-shrink: 0; }
        .comment-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .comment-content { flex: 1; background: rgba(255,255,255,.08); border-radius: 12px; padding: 10px 14px; }
        .comment-author { color: white; font-weight: 700; font-size: 14px; margin-bottom: 4px; }
        .comment-text { color: rgba(255,255,255,.9); font-size: 14px; line-height: 1.5; }
        .comment-time { color: rgba(255,255,255,.4); font-size: 12px; margin-top: 4px; }
        .comment-composer { display: flex; gap: 12px; margin-top: 12px; }
        .comment-input { flex: 1; background: rgba(255,255,255,.08); border: 2px solid rgba(255,255,255,.15); border-radius: 20px; padding: 10px 18px; color: white; font-size: 14px; }
        .comment-input:focus { outline: none; background: rgba(255,255,255,.12); border-color: rgba(255,107,157,.5); }
        .comment-input::placeholder { color: rgba(255,255,255,.5); }
        .empty-state { text-align: center; padding: 60px 20px; color: rgba(255,255,255,.5); }
        .empty-state-icon { font-size: 64px; margin-bottom: 16px; }
        .empty-state-text { font-size: 16px; line-height: 1.6; }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .header { padding: 16px 20px; }
            .header-title { font-size: 22px; }
            .profiles-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px; }
            .profile-avatar { width: 90px; height: 90px; font-size: 36px; }
            .modal { max-width: 100%; border-radius: 20px 20px 0 0; max-height: 85vh; }
            .modal-header, .modal-content, .modal-footer { padding: 16px 20px; }
            .btn { padding: 10px 18px; font-size: 13px; }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-title">ğŸ“° Mur</div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="window.location.href='chat.html'">ğŸ’¬ Chat</button>
            <button class="btn btn-secondary" onclick="window.location.href='arcade.html'">ğŸ•¹ï¸ Arcade</button>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" id="tabPublic">ğŸŒ Mur gÃ©nÃ©ral</div>
        <div class="tab" id="tabFriends">ğŸ‘¥ Mes amis</div>
    </div>

    <div class="profiles-grid" id="profilesGrid"></div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-header-avatar" id="modalAvatar">ğŸ’¬</div>
                <div class="modal-header-info">
                    <div class="modal-header-name" id="modalName">Utilisateur</div>
                    <div class="modal-header-status" id="modalStatus">Profil</div>
                </div>
                <div class="modal-close" onclick="closeModal()">Ã—</div>
            </div>
            <div class="modal-content" id="modalContent"></div>
            <div class="modal-footer">
                <button class="btn btn-primary" style="flex:1" onclick="goToChat()">ğŸ’¬ Envoyer un message</button>
                <button class="btn btn-secondary" onclick="closeModal()">Fermer</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        const supabase = createClient(
            'https://eeikriwrwuynwpzodbbt.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVlaWtyaXdyd3V5bndwem9kYmJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1NzQ3NjYsImV4cCI6MjA4NjE1MDc2Nn0.MJ6CSmrttEWcrdfy5C7nP4sE_pe19sGNE-WasASPDNc'
        );

        let currentUserPrenom = localStorage.getItem('prenom') || 'InvitÃ©';
        let currentUserPhoto  = localStorage.getItem('userPhotoUrl') || localStorage.getItem('tempPhotoPreview') || null;
        let fingerprint = localStorage.getItem('browserFingerprint');
        if (!fingerprint) {
            fingerprint = Math.random().toString(36).slice(2) + Date.now().toString(36);
            localStorage.setItem('browserFingerprint', fingerprint);
        }
        let currentUniqueId  = currentUserPrenom + '_' + fingerprint;
        let currentView      = 'public';
        let currentModalUser = null;

        // â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.getElementById('tabPublic').addEventListener('click', function () {
            currentView = 'public';
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            loadProfiles();
        });
        document.getElementById('tabFriends').addEventListener('click', function () {
            currentView = 'friends';
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            loadProfiles();
        });

        // â”€â”€ CHARGER PROFILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // FIX : 1 seule requÃªte pour compter les posts (au lieu de N)
        async function loadProfiles() {
            const grid = document.getElementById('profilesGrid');
            grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">â³</div><div class="empty-state-text">Chargement...</div></div>';
            try {
                const { data: profiles, error: profilesErr } = await supabase
                    .from('profiles')
                    .select('unique_id, prenom, photo_url, is_online')
                    .neq('unique_id', currentUniqueId)
                    .order('is_online', { ascending: false })
                    .order('prenom',    { ascending: true });

                if (profilesErr) throw profilesErr;
                if (!profiles || profiles.length === 0) {
                    grid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ‘¥</div><div class="empty-state-text">Aucun utilisateur trouvÃ©</div></div>';
                    return;
                }

                const authorIds = profiles.map(p => p.unique_id);
                const { data: postsRows } = await supabase
                    .from('wall_posts')
                    .select('wall_owner_id')
                    .in('wall_owner_id', authorIds)
                    .eq('is_public', currentView === 'public');

                const countsMap = {};
                (postsRows || []).forEach(r => {
                    countsMap[r.wall_owner_id] = (countsMap[r.wall_owner_id] || 0) + 1;
                });

                grid.innerHTML = '';
                profiles.forEach(profile => {
                    const count = countsMap[profile.unique_id] || 0;
                    const card  = document.createElement('div');
                    card.className = 'profile-card';
                    card.onclick   = () => openModal(profile);
                    const av = profile.photo_url
                        ? `<img src="${esc(profile.photo_url)}" alt="${esc(profile.prenom)}">`
                        : esc(profile.prenom[0].toUpperCase());
                    card.innerHTML = `
                        <div class="profile-avatar">
                            ${av}
                            <div class="status-indicator ${profile.is_online ? 'online' : 'offline'}"></div>
                        </div>
                        <div class="profile-name">${esc(profile.prenom)}</div>
                        <div class="profile-posts-count">${count} publication${count > 1 ? 's' : ''}</div>
                    `;
                    grid.appendChild(card);
                });
            } catch (err) {
                console.error('Erreur chargement profils:', err);
                grid.innerHTML = `<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><div class="empty-state-text">Erreur de chargement<br><small style="font-size:12px;opacity:.6">${esc(err.message)}</small></div></div>`;
            }
        }

        // â”€â”€ OUVRIR MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function openModal(user) {
            currentModalUser = user;
            const av = user.photo_url
                ? `<img src="${esc(user.photo_url)}" alt="${esc(user.prenom)}">`
                : esc(user.prenom[0].toUpperCase());
            document.getElementById('modalAvatar').innerHTML   = av;
            document.getElementById('modalName').textContent   = user.prenom;
            document.getElementById('modalStatus').textContent = currentView === 'public' ? 'Mur public' : 'Mur personnel';

            const composerHTML = currentView === 'public' ? `
                <div class="post-composer">
                    <textarea class="post-composer-input" id="postInput" placeholder="Ã‰crire sur le mur de ${esc(user.prenom)}â€¦"></textarea>
                    <div class="post-composer-actions">
                        <div class="post-composer-attach">ğŸ“·<input type="file" id="postImageInput" accept="image/*"></div>
                        <button class="btn btn-primary" id="publishBtn" onclick="window.publishPost()" style="flex:1">ğŸ“¤ Publier</button>
                    </div>
                    <div class="publish-error" id="publishError"></div>
                </div>
            ` : '';

            document.getElementById('modalContent').innerHTML = composerHTML +
                '<div id="postsContainer"><div class="empty-state"><div class="empty-state-icon">â³</div><div class="empty-state-text">Chargementâ€¦</div></div></div>';

            document.getElementById('modalOverlay').classList.add('open');
            document.body.style.overflow = 'hidden';
            await loadPosts(user.unique_id);
        }

        window.closeModal = function () {
            document.getElementById('modalOverlay').classList.remove('open');
            document.body.style.overflow = '';
            currentModalUser = null;
        };
        window.goToChat = function () {
            if (!currentModalUser) return;
            localStorage.setItem('openPrivateChat', currentModalUser.unique_id);
            window.location.href = 'chat.html';
        };

        // â”€â”€ CHARGER POSTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // FIX : filtre sur wall_owner_id + chargement groupÃ© des likes/commentaires
        async function loadPosts(ownerId) {
            const container = document.getElementById('postsContainer');
            if (!container) return;
            try {
                const { data: posts, error } = await supabase
                    .from('wall_posts')
                    .select('*')
                    .eq('wall_owner_id', ownerId)
                    .eq('is_public', currentView === 'public')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                if (!posts || posts.length === 0) {
                    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><div class="empty-state-text">Aucune publication</div></div>';
                    return;
                }

                const postIds = posts.map(p => p.id);
                const [{ data: allLikes }, { data: allComments }] = await Promise.all([
                    supabase.from('wall_likes').select('*').in('post_id', postIds),
                    supabase.from('wall_comments').select('*').in('post_id', postIds)
                ]);

                container.innerHTML = '';
                posts.forEach(post => {
                    const likes    = (allLikes    || []).filter(l => l.post_id === post.id);
                    const comments = (allComments || []).filter(c => c.post_id === post.id);
                    container.appendChild(renderPost(post, likes, comments));
                });
            } catch (err) {
                console.error('Erreur chargement posts:', err);
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">âš ï¸</div><div class="empty-state-text">Erreur de chargement<br><small style="font-size:12px;opacity:.6">${esc(err.message)}</small></div></div>`;
            }
        }

        // â”€â”€ RENDER POST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderPost(post, likes, comments) {
            const el = document.createElement('div');
            el.className = 'post';
            el.dataset.postId = post.id;
            const av = post.author_photo
                ? `<img src="${esc(post.author_photo)}" alt="${esc(post.author_name)}">`
                : esc((post.author_name || '?')[0].toUpperCase());
            const imgHTML  = post.image_url ? `<img src="${esc(post.image_url)}" alt="Image" class="post-image">` : '';
            const isLiked  = likes.some(l => l.user_id === currentUniqueId);
            el.innerHTML = `
                <div class="post-header">
                    <div class="post-avatar">${av}</div>
                    <div class="post-author-info">
                        <div class="post-author-name">${esc(post.author_name)}</div>
                        <div class="post-time">${formatTime(post.created_at)}</div>
                    </div>
                </div>
                <div class="post-content">${esc(post.content)}</div>
                ${imgHTML}
                <div class="post-actions">
                    <div class="post-action ${isLiked ? 'liked' : ''}" onclick="window.toggleLike(${post.id})">
                        <span class="post-action-icon">${isLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
                        <span id="likesCount-${post.id}">${likes.length}</span>
                    </div>
                    <div class="post-action" onclick="window.toggleComments(${post.id})">
                        <span class="post-action-icon">ğŸ’¬</span>
                        <span id="commentsCount-${post.id}">${comments.length}</span>
                    </div>
                </div>
                <div class="comments-section" id="comments-${post.id}" style="display:none;">
                    <div id="commentsList-${post.id}"></div>
                    <div class="comment-composer">
                        <input type="text" class="comment-input" id="commentInput-${post.id}"
                            placeholder="Ajouter un commentaireâ€¦"
                            onkeypress="if(event.key==='Enter') window.postComment(${post.id})">
                    </div>
                </div>
            `;
            return el;
        }

        // â”€â”€ PUBLIER POST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // FIX PRINCIPAL : wall_owner_id = currentModalUser (sur quel mur)
        //                 author_id     = currentUniqueId  (qui Ã©crit)
        window.publishPost = async function () {
            const input      = document.getElementById('postInput');
            const content    = input ? input.value.trim() : '';
            const imageInput = document.getElementById('postImageInput');
            const errorDiv   = document.getElementById('publishError');
            const publishBtn = document.getElementById('publishBtn');

            if (errorDiv) { errorDiv.style.display = 'none'; errorDiv.textContent = ''; }
            if (!content) { alert('Ã‰crivez quelque chose !'); return; }
            if (!currentModalUser) { alert('Aucun utilisateur sÃ©lectionnÃ©.'); return; }
            if (publishBtn) { publishBtn.disabled = true; publishBtn.textContent = 'â³ Publicationâ€¦'; }

            try {
                let imageUrl = null;
                if (imageInput && imageInput.files && imageInput.files[0]) {
                    const file     = imageInput.files[0];
                    const fileName = Date.now() + '_' + file.name.replace(/[^a-zA-Z0-9._-]/g, '');
                    const { error: upErr } = await supabase.storage.from('chat-files').upload(fileName, file);
                    if (!upErr) {
                        const { data: urlData } = supabase.storage.from('chat-files').getPublicUrl(fileName);
                        imageUrl = urlData.publicUrl;
                    }
                }

                const { error: insertErr } = await supabase.from('wall_posts').insert({
                    author_id:     currentUniqueId,
                    wall_owner_id: currentModalUser.unique_id,  // â† FIX
                    author_name:   currentUserPrenom,
                    author_photo:  currentUserPhoto || null,
                    content:       content,
                    image_url:     imageUrl,
                    is_public:     true
                });

                if (insertErr) throw insertErr;

                input.value = '';
                if (imageInput) imageInput.value = '';
                await loadPosts(currentModalUser.unique_id);

            } catch (err) {
                console.error('Erreur publication:', err);
                if (errorDiv) { errorDiv.textContent = 'âŒ ' + (err.message || 'Erreur inconnue'); errorDiv.style.display = 'block'; }
                else alert('Erreur lors de la publication : ' + (err.message || ''));
            } finally {
                if (publishBtn) { publishBtn.disabled = false; publishBtn.innerHTML = 'ğŸ“¤ Publier'; }
            }
        };

        // â”€â”€ TOGGLE LIKE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // FIX : .maybeSingle() au lieu de .single()
        window.toggleLike = async function (postId) {
            try {
                const { data: existing } = await supabase
                    .from('wall_likes').select('id')
                    .eq('post_id', postId).eq('user_id', currentUniqueId)
                    .maybeSingle();
                if (existing) {
                    await supabase.from('wall_likes').delete().eq('id', existing.id);
                } else {
                    await supabase.from('wall_likes').insert({ post_id: postId, user_id: currentUniqueId, user_name: currentUserPrenom });
                }
                if (currentModalUser) await loadPosts(currentModalUser.unique_id);
            } catch (err) { console.error('Erreur like:', err); }
        };

        // â”€â”€ TOGGLE COMMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.toggleComments = async function (postId) {
            const section = document.getElementById('comments-' + postId);
            const visible = section.style.display !== 'none';
            section.style.display = visible ? 'none' : 'block';
            if (!visible) await loadComments(postId);
        };

        // â”€â”€ CHARGER COMMENTAIRES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadComments(postId) {
            const container = document.getElementById('commentsList-' + postId);
            if (!container) return;
            try {
                const { data: comments, error } = await supabase
                    .from('wall_comments').select('*')
                    .eq('post_id', postId).order('created_at', { ascending: true });
                if (error) throw error;
                container.innerHTML = '';
                (comments || []).forEach(c => {
                    const el = document.createElement('div');
                    el.className = 'comment';
                    const av = c.author_photo
                        ? `<img src="${esc(c.author_photo)}" alt="${esc(c.author_name)}">`
                        : esc((c.author_name || '?')[0].toUpperCase());
                    el.innerHTML = `
                        <div class="comment-avatar">${av}</div>
                        <div class="comment-content">
                            <div class="comment-author">${esc(c.author_name)}</div>
                            <div class="comment-text">${esc(c.content)}</div>
                            <div class="comment-time">${formatTime(c.created_at)}</div>
                        </div>`;
                    container.appendChild(el);
                });
            } catch (err) { console.error('Erreur commentaires:', err); }
        }

        // â”€â”€ POSTER COMMENTAIRE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window.postComment = async function (postId) {
            const input   = document.getElementById('commentInput-' + postId);
            const content = input ? input.value.trim() : '';
            if (!content) return;
            try {
                const { error } = await supabase.from('wall_comments').insert({
                    post_id: postId, author_id: currentUniqueId,
                    author_name: currentUserPrenom, author_photo: currentUserPhoto || null, content
                });
                if (error) throw error;
                if (input) input.value = '';
                await loadComments(postId);
                const cnt = document.getElementById('commentsCount-' + postId);
                if (cnt) cnt.textContent = parseInt(cnt.textContent || '0') + 1;
            } catch (err) { console.error('Erreur commentaire:', err); }
        };

        // â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function esc(str) {
            return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }
        function formatTime(iso) {
            if (!iso) return '';
            const d = new Date(iso), diff = Date.now() - d;
            const m = Math.floor(diff/60000), h = Math.floor(diff/3600000), j = Math.floor(diff/86400000);
            if (m < 1)  return 'Ã€ l\'instant';
            if (m < 60) return m + ' min';
            if (h < 24) return h + ' h';
            if (j < 7)  return j + ' j';
            return d.toLocaleDateString('fr-FR', { day:'2-digit', month:'short' });
        }

        // â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        loadProfiles();
        document.getElementById('modalOverlay').addEventListener('click', e => { if (e.target === e.currentTarget) window.closeModal(); });
        document.addEventListener('keydown', e => { if (e.key === 'Escape') window.closeModal(); });
    </script>
</body>
</html>
